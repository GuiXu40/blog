<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>React系列二十一-Hook(二)高级使用</title>
      <link href="/blog/2020/12/17/React%E7%B3%BB%E5%88%97%E4%BA%8C%E5%8D%81%E4%B8%80-Hook-%E4%BA%8C-%E9%AB%98%E7%BA%A7%E4%BD%BF%E7%94%A8/"/>
      <url>/blog/2020/12/17/React%E7%B3%BB%E5%88%97%E4%BA%8C%E5%8D%81%E4%B8%80-Hook-%E4%BA%8C-%E9%AB%98%E7%BA%A7%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="Hook高级使用"><a href="#Hook高级使用" class="headerlink" title="Hook高级使用"></a>Hook高级使用</h2><h3 id="useReducer"><a href="#useReducer" class="headerlink" title="useReducer"></a>useReducer</h3><p>很多人看到useReducer的第一反应应该是redux的某个替代品，其实并不是。</p><p>useReducer仅仅是useState的一种替代方案：</p><ul><li>在某些场景下，如果state的处理逻辑比较复杂，我们可以通过useReducer来对其进行拆分；</li><li>或者这次修改的state需要依赖之前的state时，也可以使用；</li></ul><p>单独创建一个reducer/counter.js文件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">counterReducer</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">switch</span>(<span class="params">action.type</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;increment&quot;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;...state, <span class="attr">counter</span>: state.counter + <span class="number">1</span>&#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;decrement&quot;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;...state, <span class="attr">counter</span>: state.counter - <span class="number">1</span>&#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>home.js</p><a id="more"></a><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useReducer &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; counterReducer &#125; <span class="keyword">from</span> <span class="string">&#x27;../reducer/counter&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Home</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [state, dispatch] = useReducer(counterReducer, &#123;<span class="attr">counter</span>: <span class="number">100</span>&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;当前计数: &#123;state.counter&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> dispatch(&#123;<span class="attr">type</span>: <span class="string">&quot;increment&quot;</span>&#125;)&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> dispatch(&#123;<span class="attr">type</span>: <span class="string">&quot;decrement&quot;</span>&#125;)&#125;&gt;-<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们来看一下，如果我们创建另外一个profile.js也使用这个reducer函数，是否会进行数据的共享：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useReducer &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; counterReducer &#125; <span class="keyword">from</span> <span class="string">&#x27;../reducer/counter&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Profile</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [state, dispatch] = useReducer(counterReducer, &#123;<span class="attr">counter</span>: <span class="number">0</span>&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;当前计数: &#123;state.counter&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> dispatch(&#123;<span class="attr">type</span>: <span class="string">&quot;increment&quot;</span>&#125;)&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> dispatch(&#123;<span class="attr">type</span>: <span class="string">&quot;decrement&quot;</span>&#125;)&#125;&gt;-<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>数据是不会共享的，它们只是使用了相同的counterReducer的函数而已。</p><p><strong>所以，useReducer只是useState的一种替代品，并不能替代Redux。</strong></p><h3 id="useCallback"><a href="#useCallback" class="headerlink" title="useCallback"></a>useCallback</h3><p>useCallback实际的目的是为了进行性能的优化。</p><p>如何进行性能的优化呢？</p><ul><li>useCallback会返回一个函数的 memoized（记忆的） 值；</li><li>在依赖不变的情况下，多次定义的时候，返回的值是相同的；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> memoizedCallback = useCallback(</span><br><span class="line">  () =&gt; &#123;</span><br><span class="line">    doSomething(a, b);</span><br><span class="line">  &#125;,</span><br><span class="line">  [a, b]</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>我们来看下面一段很有趣的代码：</p><ul><li><p>increment1在每次函数组件重新渲染时，会返回相同的值；</p></li><li><p>increment2每次定义的都是不同的值；</p></li><li><p>问题：是否increment1会比increment2更加节省性能呢？</p></li><li><ul><li>事实上，经过一些测试，并没有更加节省内存，因为useCallback中还是会传入一个函数作为参数；</li><li>所以并不存在increment2每次创建新的函数，而increment1不需要创建新的函数这种性能优化；</li></ul></li><li><p>那么，为什么说useCallback是为了进行性能优化呢？</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; memo, useState, useCallback &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">CallbackHookDemo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> increment1 = useCallback(<span class="function"><span class="keyword">function</span> <span class="title">increment</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    setCount(count + <span class="number">1</span>);</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> increment2 = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    setCount(count + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;当前计数: &#123;count&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;button onClick=&#123;increment1&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &lt;button onClick=&#123;increment2&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们来对上面的代码进行改进：</p><ul><li>在下面的代码中，我们将回调函数传递给了子组件，在子组件中会进行调用；</li><li>在发生点击时，我们会发现接受increment1的子组件不会重新渲染，但是接受increment2的子组件会重新渲染；</li><li>所以useCallback最主要用于性能渲染的地方应该是和memo结合起来，决定子组件是否需要重新渲染；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; memo, useState, useCallback &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> CounterIncrement = memo(<span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;CounterIncrment被渲染:&quot;</span>, props.name);</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;props.increment&#125;</span>&gt;</span>+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">CallbackHookDemo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> increment1 = useCallback(<span class="function"><span class="keyword">function</span> <span class="title">increment</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    setCount(count + <span class="number">1</span>);</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> increment2 = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    setCount(count + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;当前计数: &#123;count&#125;&lt;/h2&gt;</span><br><span class="line">      &#123;<span class="comment">/* &lt;button onClick=&#123;increment1&#125;&gt;+1&lt;/button&gt;</span></span><br><span class="line"><span class="comment">      &lt;button onClick=&#123;increment2&#125;&gt;+1&lt;/button&gt; */</span>&#125;</span><br><span class="line">      &lt;CounterIncrement increment=&#123;increment1&#125; name=<span class="string">&quot;increment1&quot;</span>/&gt;</span><br><span class="line">      &lt;CounterIncrement increment=&#123;increment2&#125; name=<span class="string">&quot;increment2&quot;</span>/&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="useMemo"><a href="#useMemo" class="headerlink" title="useMemo"></a>useMemo</h3><p>useMemo实际的目的也是为了进行性能的优化。</p><p>如何进行性能的优化呢？</p><ul><li>useMemo返回的也是一个 memoized（记忆的） 值；</li><li>在依赖不变的情况下，多次定义的时候，返回的值是相同的；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> memoizedValue = useMemo(<span class="function">() =&gt;</span> computeExpensiveValue(a, b), [a, b]);</span><br></pre></td></tr></table></figure><p>我们来看一个案例：</p><ul><li>无论我们点击了是 <code>+1</code>还是 <code>切换</code> 案例都会重新计算一次；</li><li>事实上，我们只是希望在count发生变化时重新计算；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useMemo &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calcNum</span>(<span class="params">count</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> total = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">    total += i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;计算一遍&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> total</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">MemoHookDemo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">10</span>);</span><br><span class="line">  <span class="keyword">const</span> [isLogin, setIsLogin] = useState(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> total = calcNum(count);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;数字和: &#123;total&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setCount(count + <span class="number">1</span>)&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &#123;isLogin &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Coderwhy<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span>&#125;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setIsLogin(!isLogin)&#125;&gt;切换&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个时候，我们可以使用useMemo来进行性能的优化：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useMemo &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calcNum</span>(<span class="params">count</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> total = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">    total += i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;计算一遍&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> total</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">MemoHookDemo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">10</span>);</span><br><span class="line">  <span class="keyword">const</span> [isLogin, setIsLogin] = useState(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> total = useMemo(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> calcNum(count);</span><br><span class="line">  &#125;, [count]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;数字和: &#123;total&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setCount(count + <span class="number">1</span>)&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &#123;isLogin &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Coderwhy<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span>&#125;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setIsLogin(!isLogin)&#125;&gt;切换&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然，useMemo也可以用于子组件的性能优化：</p><ul><li>ShowCounter子组件依赖的是一个基本数据类型，所以在比较的时候只要值不变，那么就不会重新渲染；</li><li>ShowInfo接收的是一个对象，每次都会定义一个新的对象，所以我们需要通过useMemo来对其进行优化；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useMemo, memo &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calcNum</span>(<span class="params">count</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> total = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">    total += i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;计算一遍&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> total</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ShowCounter = memo(<span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;重新渲染&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Counter: &#123;props.total&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ShowInfo = memo(<span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;ShowInfo重新渲染&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>信息: &#123;props.info.name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">MemoHookDemo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">10</span>);</span><br><span class="line">  <span class="keyword">const</span> [isLogin, setIsLogin] = useState(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> total = useMemo(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> calcNum(count);</span><br><span class="line">  &#125;, [count]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> info = useMemo(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="attr">name</span>: <span class="string">&quot;why&quot;</span>&#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;数字和: &#123;total&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;ShowCounter total=&#123;total&#125; /&gt;</span><br><span class="line">      &lt;ShowInfo info=&#123;info&#125;/&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setCount(count + <span class="number">1</span>)&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &#123;isLogin &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Coderwhy<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span>&#125;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setIsLogin(!isLogin)&#125;&gt;切换&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="useRef"><a href="#useRef" class="headerlink" title="useRef"></a>useRef</h3><p>useRef返回一个ref对象，返回的ref对象在组件的整个生命周期保持不变。</p><p>最常用的ref是两种用法：</p><ul><li>用法一：引入DOM（或者组件，但是需要是class组件）元素；</li><li>用法二：保存一个数据，这个对象在整个生命周期中可以保存不变；</li></ul><p>用法一：引用DOM</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useRef &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">RefHookDemo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> inputRef = useRef();</span><br><span class="line">  <span class="keyword">const</span> titleRef = useRef();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleOperating = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    titleRef.current.innerHTML = <span class="string">&quot;我是coderwhy&quot;</span>;</span><br><span class="line">    inputRef.current.focus();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;input type=<span class="string">&quot;text&quot;</span> ref=&#123;inputRef&#125;/&gt;</span><br><span class="line">      &lt;h2 ref=&#123;titleRef&#125;&gt;默认内容&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> handleOperating()&#125;&gt;操作&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用法二：使用ref保存上一次的某一个值</p><ul><li>useRef可以想象成在ref对象中保存了一个.current的可变盒子；</li><li>useRef在组件重新渲染时，返回的依然是之前的ref对象，但是current是可以修改的；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useEffect, useRef &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> preValue = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">RefHookDemo02</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> countRef = useRef(count);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    countRef.current = count;</span><br><span class="line">  &#125;, [count]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;前一次的值: &#123;countRef.current&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;h2&gt;这一次的值: &#123;count&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setCount(count + <span class="number">1</span>)&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="useImperativeHandle"><a href="#useImperativeHandle" class="headerlink" title="useImperativeHandle"></a>useImperativeHandle</h3><p>useImperativeHandle并不是特别好理解，我们一点点来学习。</p><p>我们先来回顾一下ref和forwardRef结合使用：</p><ul><li>通过forwardRef可以将ref转发到子组件；</li><li>子组件拿到父组件中创建的ref，绑定到自己的某一个元素中；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useRef, forwardRef &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> HYInput = forwardRef(<span class="function"><span class="keyword">function</span> (<span class="params">props, ref</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">ref</span>=<span class="string">&#123;ref&#125;/</span>&gt;</span></span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">ForwardDemo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> inputRef = useRef();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;HYInput ref=&#123;inputRef&#125;/&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> inputRef.current.focus()&#125;&gt;聚焦&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的做法本身没有什么问题，但是我们是将子组件的DOM直接暴露给了父组件：</p><ul><li>直接暴露给父组件带来的问题是某些情况的不可控；</li><li>父组件可以拿到DOM后进行任意的操作；</li><li>但是，事实上在上面的案例中，我们只是希望父组件可以操作的focus，其他并不希望它随意操作；</li></ul><p>通过useImperativeHandle可以只暴露固定的操作：</p><ul><li>通过useImperativeHandle的Hook，将<code>传入的ref</code>和<code>useImperativeHandle第二个参数返回的对象</code>绑定到了一起；</li><li>所以在父组件中，使用 <code>inputRef.current</code>时，实际上使用的是<code>返回的对象</code>；</li><li>比如我调用了 <code>focus函数</code>，甚至可以调用 <code>printHello函数</code>；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useRef, forwardRef, useImperativeHandle &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> HYInput = forwardRef(<span class="function"><span class="keyword">function</span> (<span class="params">props, ref</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 创建组件内部的ref</span></span><br><span class="line">  <span class="keyword">const</span> inputRef = useRef();</span><br><span class="line"></span><br><span class="line">  useImperativeHandle(ref, <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    focus: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      inputRef.current.focus();</span><br><span class="line">    &#125;,</span><br><span class="line">    printHello: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;Hello World&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这里绑定的是组件内部的inputRef</span></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">ref</span>=<span class="string">&#123;inputRef&#125;/</span>&gt;</span></span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">ImperativeHandleHookForwardDemo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> inputRef = useRef();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;HYInput ref=&#123;inputRef&#125;/&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> inputRef.current.focus()&#125;&gt;聚焦&lt;/button&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> inputRef.current.printHello()&#125;&gt;Hello World&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="useLayoutEffect"><a href="#useLayoutEffect" class="headerlink" title="useLayoutEffect"></a>useLayoutEffect</h3><p>useLayoutEffect看起来和useEffect非常的相似，事实上他们也只有一点区别而已：</p><ul><li>useEffect会在渲染的内容更新到DOM上后执行，不会阻塞DOM的更新；</li><li>useLayoutEffect会在渲染的内容更新到DOM上之前执行，会阻塞DOM的更新；</li></ul><p>如果我们希望在某些操作发生之后再更新DOM，那么应该将这个操作放到useLayoutEffect。</p><p>我们来看下面的一段代码：</p><ul><li>这段代码在开发中会发生闪烁的现象；</li><li>因为我们先将count设置为了0，那么DOM会被更新，并且会执行一次useEffect中的回调函数；</li><li>在useEffect中我们发现count为0，又执行一次setCount操作，那么DOM会再次被更新，并且useEffect又会被执行一次；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useEffect, useState, useLayoutEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">EffectHookDemo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (count === <span class="number">0</span>) &#123;</span><br><span class="line">      setCount(<span class="built_in">Math</span>.random()*<span class="number">200</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [count]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;当前数字: &#123;count&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setCount(<span class="number">0</span>)&#125;&gt;随机数&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>事实上，我们上面的操作的目的是在count被设置为0时，随机另外一个数字：</p><ul><li>如果我们使用useLayoutEffect，那么会等到useLayoutEffect代码执行完毕后，再进行DOM的更新；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useEffect, useState, useLayoutEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">EffectHookDemo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  useLayoutEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (count === <span class="number">0</span>) &#123;</span><br><span class="line">      setCount(<span class="built_in">Math</span>.random()*<span class="number">200</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [count]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;当前数字: &#123;count&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setCount(<span class="number">0</span>)&#125;&gt;随机数&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="img">useEffect和useLayoutEffect对比</p><h2 id="自定义Hook"><a href="#自定义Hook" class="headerlink" title="自定义Hook"></a>自定义Hook</h2><h3 id="认识自定义hook"><a href="#认识自定义hook" class="headerlink" title="认识自定义hook"></a>认识自定义hook</h3><p><strong>自定义Hook本质上只是一种函数代码逻辑的抽取，严格意义上来说，它本身并不算React的特性。</strong></p><p>需求：所有的组件在创建和销毁时都进行打印</p><ul><li>组件被创建：打印 <code>组件被创建了</code>；</li><li>组件被销毁：打印 <code>组件被销毁了</code>；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">CustomHookDemo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;组件被创建了&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;组件被销毁了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;CustomHookDemo&lt;/h2&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是这样来做意味着所有的组件都需要有对应的逻辑：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Home</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;组件被创建了&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;组件被销毁了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Profile</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;组件被创建了&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;组件被销毁了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Profile<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如何可以对它们的逻辑进行抽取呢？</p><ul><li>我们可能希望抽取到一个函数中；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loggingLife</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;组件被创建了&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;组件被销毁了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是，抽取到这里调用之后，代码是报错的：</p><ul><li>原因是普通的函数中不能使用hook</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/21001" alt="图片"></p><p>那么，我们应该如何操作呢？</p><ul><li>非常简单，函数以特殊的方式命名，以 <code>use</code> 开头即可；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useLoggingLife</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;组件被创建了&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;组件被销毁了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然，自定义Hook可以有参数，也可以有返回值：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useLoggingLife</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;name&#125;</span>组件被创建了`</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;name&#125;</span>组件被销毁了`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="自定义Hook练习"><a href="#自定义Hook练习" class="headerlink" title="自定义Hook练习"></a>自定义Hook练习</h3><p>我们通过一些案例来练习一下自定义Hook。</p><p><strong>使用User、Token的Context</strong></p><p>比如多个组件都需要使用User和Token的Context：</p><ul><li>这段代码我们在每次使用user和token时都需要导入对应的Context，并且需要使用两次useContext；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useContext &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; UserContext, TokenContext &#125; <span class="keyword">from</span> <span class="string">&#x27;../App&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">CustomHookContextDemo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> user = useContext(UserContext);</span><br><span class="line">  <span class="keyword">const</span> token = useContext(TokenContext);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(user, token);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;CustomHookContextDemo&lt;/h2&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们可以抽取到一个自定义Hook中：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useUserToken</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> user = useContext(UserContext);</span><br><span class="line">  <span class="keyword">const</span> token = useContext(TokenContext);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [user, token];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>获取窗口滚动的位置</strong></p><p>在开发中，某些场景我们可能总是希望获取创建滚动的位置：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useEffect, useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">CustomScrollPositionHook</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [scrollPosition, setScrollPosition] = useState(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> handleScroll = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      setScrollPosition(<span class="built_in">window</span>.scrollY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">document</span>.addEventListener(<span class="string">&quot;scroll&quot;</span>, handleScroll);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">document</span>.removeEventListener(<span class="string">&quot;scroll&quot;</span>, handleScroll);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div style=&#123;&#123;<span class="attr">padding</span>: <span class="string">&quot;1000px 0&quot;</span>&#125;&#125;&gt;</span><br><span class="line">      &lt;h2 style=&#123;&#123;<span class="attr">position</span>: <span class="string">&quot;fixed&quot;</span>, <span class="attr">top</span>: <span class="number">0</span>, <span class="attr">left</span>: <span class="number">0</span>&#125;&#125;&gt;CustomScrollPositionHook: &#123;scrollPosition&#125;&lt;/h2&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是如果每一个组件都有对应这样的一个逻辑，那么就会存在很多的冗余代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function useScrollPosition() &#123;</span><br><span class="line">  const [scrollPosition, setScrollPosition] &#x3D; useState(0);</span><br><span class="line"></span><br><span class="line">  useEffect(() &#x3D;&gt; &#123;</span><br><span class="line">    const handleScroll &#x3D; () &#x3D;&gt; &#123;</span><br><span class="line">      setScrollPosition(window.scrollY);</span><br><span class="line">    &#125;</span><br><span class="line">    document.addEventListener(&quot;scroll&quot;, handleScroll);</span><br><span class="line"></span><br><span class="line">    return () &#x3D;&gt; &#123;</span><br><span class="line">      document.removeEventListener(&quot;scroll&quot;, handleScroll);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  return scrollPosition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>数据存储的localStorage</strong></p><p>在开发中，我们会有一些数据希望通过localStorage进行存储（当然，你可以根据自己的情况选择sessionStorage）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import React, &#123; useState, useEffect &#125; from &#39;react&#39;</span><br><span class="line"></span><br><span class="line">export default function CustomDataStoreHook() &#123;</span><br><span class="line">  const [name, setName] &#x3D; useState(() &#x3D;&gt; &#123;</span><br><span class="line">    return JSON.parse(window.localStorage.getItem(&quot;name&quot;))</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  useEffect(() &#x3D;&gt; &#123;</span><br><span class="line">    window.localStorage.setItem(&quot;name&quot;, JSON.stringify(name));</span><br><span class="line">  &#125;, [name])</span><br><span class="line"></span><br><span class="line">  return (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;CustomDataStoreHook: &#123;name&#125;&lt;&#x2F;h2&gt;</span><br><span class="line">      &lt;button onClick&#x3D;&#123;e &#x3D;&gt; setName(&quot;coderwhy&quot;)&#125;&gt;设置name&lt;&#x2F;button&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果每一个里面都有这样的逻辑，那么代码就会变得非常冗余：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function useLocalStorange(key) &#123;</span><br><span class="line">  const [data, setData] &#x3D; useState(() &#x3D;&gt; &#123;</span><br><span class="line">    return JSON.parse(window.localStorage.getItem(key))</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  useEffect(() &#x3D;&gt; &#123;</span><br><span class="line">    window.localStorage.setItem(key, JSON.stringify(data));</span><br><span class="line">  &#125;, [data]);</span><br><span class="line"></span><br><span class="line">  return [data, setData];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Hook原理分析"><a href="#Hook原理分析" class="headerlink" title="Hook原理分析"></a>Hook原理分析</h2><p>这里我主要分析一下useState的原理，因为本次教程是穿插讲解源码的，所以不会所有源码一一讲解。</p><h3 id="useState代码位置"><a href="#useState代码位置" class="headerlink" title="useState代码位置"></a>useState代码位置</h3><p>useState还是从React中导入的，所以我们可以先查看：</p><p>点到useState的源码中：</p><ul><li>useState本质上，是使用的dispatcher的useState；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/21002" alt="图片"></p><p>dispatcher来自另外的一个函数<code>resolveDispatcher</code>：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/21003" alt="图片"></p><p>运行的过程中，会赋值一个current的值是一个Dispatcher类型：</p><ul><li>Dispatcher来自于 <code>react-reconciler/src/ReactFiberHooks</code></li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/21004" alt="图片"></p><p>Dispatch类型的定义：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/21005" alt="图片">Dispatch类型的定义</p><p>这里的Dispatch仅仅是一个类型而已，我们赋值具体的值在不同的阶段是不同的：</p><ul><li>在挂载阶段：HooksDispatcherOnMount</li><li>在更新阶段：HooksDispatcherOnUpdate</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/21006" alt="图片"></p><p>挂载哪一个取决于renderWithHook函数：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/21007" alt="图片"></p><h3 id="HooksDispatcherOnMount"><a href="#HooksDispatcherOnMount" class="headerlink" title="HooksDispatcherOnMount"></a>HooksDispatcherOnMount</h3><p>HooksDispatcherOnMount对应的useState是mountState</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/21008" alt="图片"></p><p>mountState的源码：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/21009" alt="图片">mountState的源码</p><p>绑定的dispatchAction函数，事实上是将所有的action放到了queue的队列中：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/21010" alt="图片">dispatchAction函数</p><h3 id="HooksDispatcherOnUpdate"><a href="#HooksDispatcherOnUpdate" class="headerlink" title="HooksDispatcherOnUpdate"></a>HooksDispatcherOnUpdate</h3><p>HooksDispatcherOnUpdate对应的useState是updateState</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/21011" alt="图片"></p><p>updateState本质上会执行updateReducer：</p><ul><li>所有其实就更新阶段而言，useState本质上用的是updateReducer</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/21012" alt="图片"></p><p>updateReducer的源码如下：</p><p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="img"></p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/21013" alt="图片"></p><h2 id="Redux-Hooks"><a href="#Redux-Hooks" class="headerlink" title="Redux Hooks"></a>Redux Hooks</h2><p>在之前的redux开发中，为了让组件和redux结合起来，我们使用了react-redux中的connect：</p><ul><li>但是这种方式必须使用<code>高阶函数</code>结合返回的<code>高阶组件</code>；</li><li>并且必须编写：<code>mapStateToProps</code>和 <code>mapDispatchToProps</code>映射的函数；</li></ul><p>在Redux7.1开始，提供了Hook的方式，我们再也不需要编写connect以及对应的映射函数了</p><h3 id="useSelector使用"><a href="#useSelector使用" class="headerlink" title="useSelector使用"></a>useSelector使用</h3><p>useSelector的作用是将state映射到组件中：</p><ul><li>参数一：将state映射到需要的数据中；</li><li>参数二：可以进行比较来决定是否组件重新渲染；（后续讲解）</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result: any = useSelector(selector: <span class="built_in">Function</span>, equalityFn?: <span class="built_in">Function</span>)</span><br></pre></td></tr></table></figure><p>现在，我可以改进一下之前的Profile中使用redux的代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Profile</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;banners, recommends, counter&#125; = useSelector(<span class="function"><span class="params">state</span> =&gt;</span> (&#123;</span><br><span class="line">    banners: state.homeInfo.banners,</span><br><span class="line">    recommends: state.homeInfo.recommends</span><br><span class="line">  &#125;));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;Profile重新渲染&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;数字: &#123;counter&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;h1&gt;Banners&lt;/h1&gt;</span><br><span class="line">      &lt;ul&gt;</span><br><span class="line">        &#123;</span><br><span class="line">          banners.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;item.acm&#125;</span>&gt;</span>&#123;item.title&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &lt;/ul&gt;</span><br><span class="line">      &lt;h1&gt;Recommends&lt;/h1&gt;</span><br><span class="line">      &lt;ul&gt;</span><br><span class="line">        &#123;</span><br><span class="line">          recommends.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;item.acm&#125;</span>&gt;</span>&#123;item.title&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &lt;/ul&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是这段代码会有一个问题：</p><ul><li>当前我们的组件并不依赖counter，但是counter发生改变时，依然会引起Profile的重新渲染；</li></ul><p>原因是什么呢？</p><ul><li>useSelector默认会比较我们返回的两个对象是否相等；</li><li>如何比较呢？<code>const refEquality = (a, b) =&gt; a === b</code>；</li><li>也就是我们必须返回两个完全相等的对象才可以不引起重新渲染；</li></ul><p>这个时候，我们可以使用react-redux中给我们提供的 shallowEqual：</p><ul><li>这段代码的作用是避免不必要的重新渲染；</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const &#123;banners, recommends, counter&#125; &#x3D; useSelector(state &#x3D;&gt; (&#123;</span><br><span class="line">  banners: state.homeInfo.banners,</span><br><span class="line">  recommends: state.homeInfo.recommends</span><br><span class="line">&#125;), shallowEqual);</span><br></pre></td></tr></table></figure><p>当然，你也可以编写自己的比较函数，来决定是否重新渲染。</p><h3 id="useDispatch"><a href="#useDispatch" class="headerlink" title="useDispatch"></a>useDispatch</h3><p>useDispatch非常简单，就是直接获取dispatch函数，之后在组件中直接使用即可：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dispatch = useDispatch()</span><br></pre></td></tr></table></figure><p>直接使用dispatch：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> dispatch(subAction(<span class="number">1</span>))&#125;&gt;-<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">&lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> dispatch(subAction(<span class="number">5</span>))&#125;&gt;-<span class="number">5</span>&lt;/button&gt;</span><br></pre></td></tr></table></figure><p>我们还可以通过useStore来获取当前的store对象：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = useStore()</span><br></pre></td></tr></table></figure><p>在组件中可以使用store：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = useStore();</span><br><span class="line"><span class="built_in">console</span>.log(store.getState());</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列二十-Hook(一)基本使用</title>
      <link href="/blog/2020/12/17/React%E7%B3%BB%E5%88%97%E4%BA%8C%E5%8D%81-Hook-%E4%B8%80-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/"/>
      <url>/blog/2020/12/17/React%E7%B3%BB%E5%88%97%E4%BA%8C%E5%8D%81-Hook-%E4%B8%80-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="认识hook"><a href="#认识hook" class="headerlink" title="认识hook"></a>认识hook</h2><h3 id="为什么需要hook"><a href="#为什么需要hook" class="headerlink" title="为什么需要hook"></a>为什么需要hook</h3><p><em>Hook</em> 是 React 16.8 的新增特性，它可以让我们在不编写class的情况下使用state以及其他的React特性（比如生命周期）。</p><a id="more"></a><p>我们先来思考一下<code>class组件</code>相对于<code>函数式组件</code>有什么优势？比较常见的是下面的优势：</p><ul><li><p>class组件可以定义自己的state，用来保存组件自己内部的状态；</p></li><li><ul><li>函数式组件不可以，因为函数每次调用都会产生新的临时变量；</li></ul></li><li><p>class组件有自己的生命周期，我们可以在对应的生命周期中完成自己的逻辑；</p></li><li><ul><li>比如在<code>componentDidMount</code>中发送网络请求，并且该生命周期函数只会执行一次；</li><li>函数式组件在学习hooks之前，如果在函数中发送网络请求，意味着每次重新渲染都会重新发送一次网络请求；</li></ul></li><li><p>class组件可以在状态改变时只会重新执行render函数以及我们希望重新调用的生命周期函数componentDidUpdate等；</p></li><li><ul><li>函数式组件在重新渲染时，整个函数都会被执行，似乎没有什么地方可以只让它们调用一次；</li></ul></li></ul><p>所以，在Hook出现之前，对于上面这些情况我们通常都会编写class组件。</p><p><strong>但是class组件依然存在很多的问题：</strong></p><p><strong>复杂组件变得难以理解：</strong></p><ul><li>我们在最初编写一个class组件时，往往逻辑比较简单，并不会非常复杂。</li><li>但是随着业务的增多，我们的class组件会变得越来越复杂；</li><li>比如componentDidMount中，可能就会包含大量的逻辑代码：包括网络请求、一些事件的监听（还需要在componentWillUnmount中移除）；</li><li>而对于这样的class实际上非常难以拆分：因为它们的逻辑往往混在一起，强行拆分反而会造成过度设计，增加代码的复杂度；</li></ul><p><strong>难以理解的class：</strong></p><ul><li>很多人发现学习ES6的class是学习React的一个障碍。</li><li>比如在class中，我们必须搞清楚this的指向到底是谁，所以需要花很多的精力去学习this；</li><li>虽然我认为前端开发人员必须掌握this，但是依然处理起来非常麻烦；</li></ul><p><strong>组件复用状态很难</strong>：</p><ul><li>在前面为了一些状态的复用我们需要通过高阶组件或render props；</li><li>像我们之前学习的redux中connect或者react-router中的withRouter，这些高阶组件设计的目的就是为了状态的复用；</li><li>或者类似于Provider、Consumer来共享一些状态，但是多次使用Consumer时，我们的代码就会存在很多嵌套；</li><li>这些代码让我们不管是编写和设计上来说，都变得非常困难；</li></ul><p>Hook的出现，可以解决上面提到的这些问题；</p><p><strong>简单总结一下hooks：</strong></p><ul><li><strong>它可以让我们在不编写class的情况下使用state以及其他的React特性</strong>；</li><li>但是我们可以由此延伸出非常多的用法，来让我们前面所提到的问题得到解决；</li></ul><p>Hook的使用场景：</p><ul><li>Hook的出现基本可以代替我们之前所有使用class组件的地方（除了一些非常不常用的场景）；</li><li>但是如果是一个旧的项目，你并不需要直接将所有的代码重构为Hooks，因为它完全向下兼容，你可以渐进式的来使用它；</li><li>Hook只能在函数组件中使用，不能在类组件，或者函数组件之外的地方使用；</li></ul><p>这里有一个Dan Abramov文章中提到的class组件和函数式组件的对比图：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/20001" alt="图片"></p><h3 id="hooks的基本演练"><a href="#hooks的基本演练" class="headerlink" title="hooks的基本演练"></a>hooks的基本演练</h3><p>我们通过一个计数器案例，来对比一下class组件和函数式组件结合hooks的对比：</p><p>class组件实现：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Counter01</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      counter: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;当前计数: &#123;<span class="built_in">this</span>.state.counter&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.increment()&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.decrement()&#125;&gt;-<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">increment</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;<span class="attr">counter</span>: <span class="built_in">this</span>.state.counter + <span class="number">1</span>&#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">decrement</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;<span class="attr">counter</span>: <span class="built_in">this</span>.state.counter - <span class="number">1</span>&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数式组件实现：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Counter2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;当前计数: &#123;count&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setCount(count + <span class="number">1</span>)&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setCount(count - <span class="number">1</span>)&#125;&gt;-<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>你会发现上面的代码差异非常大：函数式组件结合hooks让整个代码变得非常简洁，并且再也不用考虑this相关的问题；</p><p>那么我们来研究一下核心的一段代码代表什么意思：</p><ul><li><p>useState来自react，需要从react中导入，它是一个hook；</p></li><li><ul><li>元素一：当前状态的值（第一调用为初始化值）；</li><li>元素二：设置状态值的函数；</li><li>参数：初始化值，如果不设置为undefined；</li><li>返回值：数组，包含两个元素；</li></ul></li><li><p>点击button按钮后，会完成两件事情：</p></li><li><ul><li>调用setCount，设置一个新的值；</li><li>组件重新渲染，并且根据新的值返回DOM结构；</li></ul></li><li><p>React在重新渲染时，会保留这个state状态，并不会每次都使用初始化值；</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// 等价于</span></span><br><span class="line"><span class="keyword">const</span> counter = useState(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">const</span> count = counter[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">const</span> setCount = counter[<span class="number">1</span>];</span><br></pre></td></tr></table></figure><p><strong>相信通过上面的一个简单案例，你已经会喜欢上Hook的使用了。</strong></p><p>Hook 就是 JavaScript 函数，这个函数可以帮助你 <code>钩入（hook into）</code> React State以及生命周期等特性；</p><p>但是使用它们会有两个额外的规则：</p><ul><li>只能在<strong>函数最外层</strong>调用 Hook。不要在循环、条件判断或者子函数中调用。</li><li>只能在 <strong>React 的函数组件</strong>中调用 Hook。不要在其他 JavaScript 函数中调用。（还有一个地方可以调用 Hook —— 就是自定义的 Hook 中，后面学习）。</li></ul><p>Tip：Hook指的类似于useState、useEffect这样的函数，Hooks是对这类函数的统称；</p><h2 id="hooks基础"><a href="#hooks基础" class="headerlink" title="hooks基础"></a>hooks基础</h2><h3 id="State-Hook"><a href="#State-Hook" class="headerlink" title="State Hook"></a>State Hook</h3><p>State Hook的API就是 <code>useState</code>，我们在前面已经进行了学习：</p><ul><li><p><strong><code>useState</code></strong>会帮助我们定义一个 <code>state变量</code>，<code>useState</code> 是一种新方法，它与 class 里面的 <code>this.state</code> 提供的功能完全相同。一般来说，在函数退出后变量就会”消失”，而 state 中的变量会被 React 保留。</p></li><li><p><strong><code>useState</code></strong>接受唯一一个参数，在第一次组件被调用时使用来作为初始化值。（如果没有传递参数，那么初始化值为undefined）。</p></li><li><p><strong><code>useState</code></strong>是一个数组，我们可以通过数组的解构，来完成赋值会非常方便。</p></li><li><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment</a></li></ul></li></ul><p>FAQ：为什么叫 <code>useState</code> 而不叫 <code>createState</code>?</p><ul><li>“Create” 可能不是很准确，因为 state 只在组件首次渲染的时候被创建。</li><li>在下一次重新渲染时，<code>useState</code> 返回给我们当前的 state。</li><li>如果每次都创建新的变量，它就不是 “state”了。</li><li>这也是 Hook 的名字<em>总是</em>以 <code>use</code> 开头的一个原因。</li></ul><p>当然，我们也可以在一个组件中定义多个变量和复杂变量（数组、对象）：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Home</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [age, setAge] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [names, setNames] = useState([<span class="string">&quot;abc&quot;</span>, <span class="string">&quot;cba&quot;</span>]);</span><br><span class="line">  <span class="keyword">const</span> [info, setInfo] = useState(&#123;<span class="attr">name</span>: <span class="string">&quot;why&quot;</span>, <span class="attr">age</span>: <span class="number">18</span>&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">addFriend</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    names.push(<span class="string">&quot;nba&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(names);</span><br><span class="line">    setNames(names);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;当前年龄: &#123;age&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setAge(age + <span class="number">1</span>)&#125;&gt;age+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &lt;h2&gt;朋友列表&lt;/h2&gt;</span><br><span class="line">      &lt;ul&gt;</span><br><span class="line">        &#123;</span><br><span class="line">          names.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;index&#125;</span>&gt;</span>&#123;item&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &lt;/ul&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setNames([...names, <span class="string">&quot;nba&quot;</span>])&#125;&gt;添加好友&lt;/button&gt;</span><br><span class="line">      &#123;<span class="comment">/* 思考: 这样的方式是否可以实现 */</span>&#125;</span><br><span class="line">      &lt;button onClick=&#123;addFriend&#125;&gt;添加好友&lt;/button&gt;</span><br><span class="line">      &lt;h2&gt;我的信息:&lt;/h2&gt;</span><br><span class="line">      &lt;div&gt;我的名字: &#123;info.name&#125;&lt;/div&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setInfo(&#123;...info, <span class="attr">name</span>: <span class="string">&quot;lilei&quot;</span>&#125;)&#125;&gt;修改名字&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Effect-Hook"><a href="#Effect-Hook" class="headerlink" title="Effect Hook"></a>Effect Hook</h3><p>目前我们已经通过hook在函数式组件中定义state，那么类似于生命周期这些呢？</p><ul><li>Effect Hook 可以让你来完成一些类似于class中生命周期的功能；</li><li>事实上，类似于网络请求、手动更新DOM、一些事件的监听，都是React更新DOM的一些副作用（Side Effects）；</li><li>所以对于完成这些功能的Hook被称之为 Effect Hook；</li></ul><h4 id="Effect基本使用"><a href="#Effect基本使用" class="headerlink" title="Effect基本使用"></a>Effect基本使用</h4><p>假如我们现在有一个需求：<strong>页面的title总是显示counter的数字</strong></p><p>使用class组件如何实现呢？</p><ul><li>我们会发现 <code>document.title</code> 的设置必须在两个生命周期中完成；</li><li>这是因为React的class组件并没有给我们提供一个统一的生命周期函数，可以让无论是否是第一次渲染都会执行的生命周期函数；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterTitle01</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      counter: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">document</span>.title = <span class="string">`当前计数: <span class="subst">$&#123;<span class="built_in">this</span>.state.counter&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentDidUpdate</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">document</span>.title = <span class="string">`当前计数: <span class="subst">$&#123;<span class="built_in">this</span>.state.counter&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;111&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;当前计数: &#123;<span class="built_in">this</span>.state.counter&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.increment()&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.decrement()&#125;&gt;-<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">increment</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;<span class="attr">counter</span>: <span class="built_in">this</span>.state.counter + <span class="number">1</span>&#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">decrement</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;<span class="attr">counter</span>: <span class="built_in">this</span>.state.counter - <span class="number">1</span>&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个时候，我们可以使用useEffect的Hook来完成：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">CounterTitle02</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">document</span>.title = <span class="string">`当前计数: <span class="subst">$&#123;count&#125;</span>`</span>;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;当前计数: &#123;count&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setCount(count + <span class="number">1</span>)&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setCount(count - <span class="number">1</span>)&#125;&gt;-<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>useEffect的解析：</strong></p><ul><li>通过useEffect的Hook，可以告诉React需要在渲染后执行某些操作；</li><li>useEffect要求我们传入一个<code>回调函数</code>，在React执行完更新DOM操作之后，就<code>会回调这个函数</code>；</li><li>默认情况下，无论是第一次渲染之后，还是每次更新之后，都会执行这个 <code>回调函数</code>；</li></ul><h4 id="需要清除Effect"><a href="#需要清除Effect" class="headerlink" title="需要清除Effect"></a>需要清除Effect</h4><p>在class组件的编写过程中，某些副作用的代码，我们需要在componentWillUnmount中进行清除：</p><ul><li>比如我们之前的事件总线或Redux中手动调用subscribe；</li><li>都需要在componentWillUnmount有对应的取消订阅；</li><li>Effect Hook通过什么方式来模拟componentWillUnmount呢？</li></ul><p>useEffect传入的<code>回调函数A本身</code>可以有一个返回值，这个返回值是<code>另外一个回调函数B</code>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type EffectCallback = <span class="function">() =&gt;</span> (<span class="keyword">void</span> | (<span class="function">() =&gt;</span> <span class="keyword">void</span> | <span class="literal">undefined</span>));</span><br></pre></td></tr></table></figure><p>我们可以这样来编写Effect Hook：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">EffectHookClear</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">document</span>.title = <span class="string">`当前计数: <span class="subst">$&#123;count&#125;</span>`</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;每次DOM更新时会回调&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;DOM被移除时会回调&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;当前计数: &#123;count&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setCount(count + <span class="number">1</span>)&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setCount(count - <span class="number">1</span>)&#125;&gt;-<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>为什么要在 effect 中返回一个函数？</strong></p><ul><li>这是 effect 可选的清除机制。每个 effect 都可以返回一个清除函数；</li><li>如此可以将添加和移除订阅的逻辑放在一起；</li><li>它们都属于 effect 的一部分；</li></ul><p><strong>React 何时清除 effect？</strong></p><ul><li>React 会在组件更新和卸载的时候执行清除操作；</li><li>正如之前学到的，effect 在每次渲染的时候都会执行；</li></ul><h4 id="使用多个Effect"><a href="#使用多个Effect" class="headerlink" title="使用多个Effect"></a>使用多个Effect</h4><p>使用Hook的其中一个目的就是解决class中生命周期经常将很多的逻辑放在一起的问题：</p><ul><li>比如网络请求、事件监听、手动修改DOM，这些往往都会放在componentDidMount中；</li></ul><p>使用Effect Hook，我们可以将它们分离到不同的useEffect中：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">MultiUseEffect</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;网络请求&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;修改DOM&quot;</span>);</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;事件监听&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;取消监听&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;MultiUseEffect&lt;/h2&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Hook 允许我们按照代码的用途分离它们，</strong> 而不是像生命周期函数那样：</p><ul><li>React 将按照 effect 声明的顺序依次调用组件中的<em>每一个</em> effect；</li></ul><h4 id="Effect性能优化"><a href="#Effect性能优化" class="headerlink" title="Effect性能优化"></a>Effect性能优化</h4><p>默认情况下，useEffect的回调函数会在每次渲染时都重新执行，但是这会导致两个问题：</p><ul><li>某些代码我们只是希望执行一次即可，类似于componentDidMount和componentWillUnmount中完成的事情；（比如网络请求、订阅和取消订阅）；</li><li>另外，多次执行也会导致一定的性能问题；</li></ul><p>我们如何决定useEffect在什么时候应该执行和什么时候不应该执行呢？</p><ul><li>useEffect实际上有两个参数：</li><li>参数一：执行的回调函数；</li><li>参数二：该useEffect在哪些state发生变化时，才重新执行；（受谁的影响）</li></ul><p>我们来看下面的一个案例：</p><ul><li>在这个案例中，我们修改show的值，是不会让useEffect重新被执行的；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">EffectPerformance</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [show, setShow] = useState(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;修改DOM&quot;</span>);</span><br><span class="line">  &#125;, [count])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;当前计数: &#123;count&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setCount(count + <span class="number">1</span>)&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> setShow(!show)&#125;&gt;切换&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是，如果一个函数我们不希望依赖任何的内容时，也可以传入一个空的数组 []：</p><ul><li>那么这里的两个回调函数分别对应的就是componentDidMount和componentWillUnmount生命周期函数了；</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">useEffect(() &#x3D;&gt; &#123;</span><br><span class="line">  console.log(&quot;监听事件&quot;);</span><br><span class="line"></span><br><span class="line">  return () &#x3D;&gt; &#123;</span><br><span class="line">    console.log(&quot;取消监听&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, [])</span><br></pre></td></tr></table></figure><h3 id="Context-Hook"><a href="#Context-Hook" class="headerlink" title="Context Hook"></a>Context Hook</h3><p>在之前的开发中，我们要在组件中使用共享的Context有两种方式：</p><ul><li>类组件可以通过 <code>类名.contextType = MyContext</code>方式，在类中获取context；</li><li>多个Context或者在函数式组件中通过 <code>MyContext.Consumer</code> 方式共享context；</li></ul><p>但是多个Context共享时的方式会存在大量的嵌套：</p><ul><li>Context Hook允许我们通过Hook来直接获取某个Context的值；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> value = useContext(MyContext);</span><br></pre></td></tr></table></figure><p>在App.js中使用Context</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; createContext &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ContextHook <span class="keyword">from</span> <span class="string">&#x27;./04_useContext使用/01_ContextHook&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> UserContext = createContext();</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ThemeContext = createContext();</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;UserContext.Provider value=&#123;&#123;<span class="attr">name</span>: <span class="string">&quot;why&quot;</span>, <span class="attr">age</span>: <span class="number">18</span>&#125;&#125;&gt;</span><br><span class="line">        &lt;ThemeContext.Provider value=&#123;&#123;<span class="attr">color</span>: <span class="string">&quot;red&quot;</span>, <span class="attr">fontSize</span>: <span class="string">&quot;20px&quot;</span>&#125;&#125;&gt;</span><br><span class="line">          &lt;ContextHook/&gt;</span><br><span class="line">        &lt;/ThemeContext.Provider&gt;</span><br><span class="line">      &lt;/UserContext.Provider&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在对应的函数式组件中使用Context Hook：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useContext &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; UserContext, ThemeContext &#125; <span class="keyword">from</span> <span class="string">&#x27;../App&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">ContextHook</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> user = useContext(UserContext);</span><br><span class="line">  <span class="keyword">const</span> theme = useContext(ThemeContext);</span><br><span class="line">  <span class="built_in">console</span>.log(user);</span><br><span class="line">  <span class="built_in">console</span>.log(theme);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      ContextHook</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意事项：当组件上层最近的 <code>` 更新时，该 Hook 会触发重新渲染，并使用最新传递给</code>MyContext<code>provider 的 context</code>value` 值。</p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列十九-react-router</title>
      <link href="/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81%E4%B9%9D-react-router/"/>
      <url>/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81%E4%B9%9D-react-router/</url>
      
        <content type="html"><![CDATA[<h2 id="认识react-router"><a href="#认识react-router" class="headerlink" title="认识react-router"></a>认识react-router</h2><h3 id="认识前端路由"><a href="#认识前端路由" class="headerlink" title="认识前端路由"></a>认识前端路由</h3><p>路由其实是网络工程中的一个术语：在架构一个网络时，非常重要的两个设备就是路由器和交换机。</p><p>当然，目前在我们生产中路由器也是越来越被大家所熟知，因为我们生活中都会用到路由器：</p><ul><li>事实上，路由器主要维护的是一个映射表；</li><li>映射表会决定数据的流向；</li></ul><p>路由的概念出现最早是在后端路由中实现的，原因是web的发展主要经历了这样一些阶段：</p><ul><li>后端路由阶段；</li><li>前后端分离阶段；</li><li>单页面富应用（SPA）；</li><li><a id="more"></a></li></ul><p><strong>阶段一：后端路由阶段</strong></p><p>早期的网站开发整个HTML页面是由服务器来渲染的.</p><ul><li>服务器直接生产渲染好对应的HTML页面, 返回给客户端进行展示.</li></ul><p>但是, 一个网站, 这么多页面服务器如何处理呢?</p><ul><li>一个页面有自己对应的网址, 也就是URL.</li><li>URL会发送到服务器, 服务器会通过正则对该URL进行匹配, 并且最后交给一个Controller进行处理.</li><li>Controller进行各种处理, 最终生成HTML或者数据, 返回给前端.</li><li>这就完成了一个IO操作.</li></ul><p>上面的这种操作, 就是后端路由.</p><ul><li>当我们页面中需要请求不同的<strong>路径</strong>内容时, 交给服务器来进行处理, 服务器渲染好整个页面, 并且将页面返回给客户端.</li><li>这种情况下渲染好的页面, 不需要单独加载任何的js和css, 可以直接交给浏览器展示, 这样也有利于SEO的优化.</li></ul><p>后端路由的缺点:</p><ul><li>一种情况是整个页面的模块由后端人员来编写和维护的.</li><li>另一种情况是前端开发人员如果要开发页面, 需要通过PHP和Java等语言来编写页面代码.</li><li>而且通常情况下HTML代码和数据以及对应的逻辑会混在一起, 编写和维护都是非常糟糕的事情.</li></ul><p><strong>阶段二：前后端分离阶段</strong></p><p>前端渲染的理解：</p><ul><li>每次请求涉及到的静态资源都会从静态资源服务器获取，这些资源包括HTML+CSS+JS，然后在前端对这些请求回来的资源进行渲染；</li><li>需要注意的是，客户端的每一次请求，都会从静态资源服务器请求文件；</li><li>同时可以看到，和之前的后端路由不同，这时后端只是负责提供API了；</li></ul><p>前后端分离阶段：</p><ul><li>随着Ajax的出现, 有了前后端分离的开发模式；</li><li>后端只提供API来返回数据，前端通过Ajax获取数据，并且可以通过JavaScript将数据渲染到页面中；</li><li>这样做最大的优点就是前后端责任的清晰，后端专注于数据上，前端专注于交互和可视化上；</li><li>并且当移动端(iOS/Android)出现后，后端不需要进行任何处理，依然使用之前的一套API即可；</li><li>目前很多的网站依然采用这种模式开发（jQuery开发模式）；</li></ul><p><strong>阶段三：单页面富应用（SPA）</strong></p><p>单页面富应用的理解：</p><ul><li>单页面富应用的英文是single-page application，简称SPA；</li><li>整个Web应用只有实际上只有一个页面，当URL发生改变时，并不会从服务器请求新的静态资源；</li><li>而是通过JavaScript监听URL的改变，并且根据URL的不同去渲染新的页面；</li></ul><p>如何可以应用URL和渲染的页面呢？前端路由</p><ul><li>前端路由维护着URL和渲染页面的映射关系；</li><li>路由可以根据不同的URL，最终让我们的框架（比如Vue、React、Angular）去渲染不同的组件；</li><li>最终我们在页面上看到的实际就是渲染的一个个组件页面；</li></ul><h3 id="前端路由原理"><a href="#前端路由原理" class="headerlink" title="前端路由原理"></a>前端路由原理</h3><p>前端路由是如何做到URL和内容进行映射呢？监听URL的改变。</p><p><strong>URL的hash</strong></p><ul><li>URL的hash也就是锚点(#), 本质上是改变window.location的href属性；</li><li>我们可以通过直接赋值location.hash来改变href, 但是页面不发生刷新；</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">  &lt;a href&#x3D;&quot;#&#x2F;home&quot;&gt;home&lt;&#x2F;a&gt;</span><br><span class="line">  &lt;a href&#x3D;&quot;#&#x2F;about&quot;&gt;about&lt;&#x2F;a&gt;</span><br><span class="line">  &lt;div class&#x3D;&quot;router-view&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">  &#x2F;&#x2F; 1.获取router-view</span><br><span class="line">  const routerViewEl &#x3D; document.querySelector(&quot;.router-view&quot;);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 2.监听hashchange</span><br><span class="line">  window.addEventListener(&quot;hashchange&quot;, () &#x3D;&gt; &#123;</span><br><span class="line">    switch(location.hash) &#123;</span><br><span class="line">      case &quot;#&#x2F;home&quot;:</span><br><span class="line">        routerViewEl.innerHTML &#x3D; &quot;home&quot;;</span><br><span class="line">        break;</span><br><span class="line">      case &quot;#&#x2F;about&quot;:</span><br><span class="line">        routerViewEl.innerHTML &#x3D; &quot;about&quot;;</span><br><span class="line">        break;</span><br><span class="line">      default:</span><br><span class="line">        routerViewEl.innerHTML &#x3D; &quot;default&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure><p>hash的优势就是兼容性更好，在老版IE中都可以运行，但是缺陷是有一个#，显得不像一个真实的路径。</p><p><strong>HTML5的History</strong></p><p>history接口是HTML5新增的, 它有l六种模式改变URL而不刷新页面：</p><ul><li>replaceState：替换原来的路径；</li><li>pushState：使用新的路径；</li><li>popState：路径的回退；</li><li>go：向前或向后改变路径；</li><li>forword：向前改变路径；</li><li>back：向后改变路径；</li></ul><p>我们这里来简单演示几个方法：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;app&quot;</span>&gt;</span><br><span class="line">  &lt;a href=<span class="string">&quot;/home&quot;</span>&gt;home&lt;/a&gt;</span><br><span class="line">  &lt;a href=<span class="string">&quot;/about&quot;</span>&gt;about&lt;/a&gt;</span><br><span class="line">  &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;router-view&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="comment">// 1.获取router-view</span></span><br><span class="line">  <span class="keyword">const</span> routerViewEl = <span class="built_in">document</span>.querySelector(<span class="string">&quot;.router-view&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2.监听所有的a元素</span></span><br><span class="line">  <span class="keyword">const</span> aEls = <span class="built_in">document</span>.getElementsByTagName(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> aEl <span class="keyword">of</span> aEls) &#123;</span><br><span class="line">    aEl.addEventListener(<span class="string">&quot;click&quot;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">      e.preventDefault();</span><br><span class="line">      <span class="keyword">const</span> href = aEl.getAttribute(<span class="string">&quot;href&quot;</span>);</span><br><span class="line">      <span class="built_in">console</span>.log(href);</span><br><span class="line">      history.pushState(&#123;&#125;, <span class="string">&quot;&quot;</span>, href);</span><br><span class="line">      historyChange();</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3.监听popstate和go操作</span></span><br><span class="line">  <span class="built_in">window</span>.addEventListener(<span class="string">&quot;popstate&quot;</span>, historyChange);</span><br><span class="line">  <span class="built_in">window</span>.addEventListener(<span class="string">&quot;go&quot;</span>, historyChange);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4.执行设置页面操作</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">historyChange</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">switch</span>(<span class="params">location.pathname</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;/home&quot;</span>:</span><br><span class="line">        routerViewEl.innerHTML = <span class="string">&quot;home&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;/about&quot;</span>:</span><br><span class="line">        routerViewEl.innerHTML = <span class="string">&quot;about&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        routerViewEl.innerHTML = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h3 id="react-router"><a href="#react-router" class="headerlink" title="react-router"></a>react-router</h3><p>目前前端流行的三大框架, 都有自己的路由实现:</p><ul><li>Angular的ngRouter</li><li>React的ReactRouter</li><li>Vue的vue-router</li></ul><p>React Router的版本4开始，路由不再集中在一个包中进行管理了：</p><ul><li>react-router是router的核心部分代码；</li><li>react-router-dom是用于浏览器的；</li><li>react-router-native是用于原生应用的；</li></ul><p>目前我们使用最新的React Router版本是v5的版本：</p><ul><li>实际上v4的版本和v5的版本差异并不大；</li></ul><p>安装react-router：</p><ul><li>安装react-router-dom会自动帮助我们安装react-router的依赖；</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add react-router-dom</span><br></pre></td></tr></table></figure><h2 id="react-router基本使用"><a href="#react-router基本使用" class="headerlink" title="react-router基本使用"></a>react-router基本使用</h2><h3 id="Router基本使用"><a href="#Router基本使用" class="headerlink" title="Router基本使用"></a>Router基本使用</h3><p>react-router最主要的API是给我们提供的一些组件：</p><ul><li><p>BrowserRouter或HashRouter</p></li><li><ul><li>Router中包含了对路径改变的监听，并且会将相应的路径传递给子组件；</li><li>BrowserRouter使用history模式；</li><li>HashRouter使用hash模式；</li></ul></li><li><p>Link和NavLink：</p></li><li><ul><li>通常路径的跳转是使用Link组件，最终会被渲染成a元素；</li><li>NavLink是在Link基础之上增加了一些样式属性（后续学习）；</li><li>to属性：Link中最重要的属性，用于设置跳转到的路径；</li></ul></li><li><p>Route：</p></li><li><ul><li>Route用于路径的匹配；</li><li>path属性：用于设置匹配到的路径；</li><li>component属性：设置匹配到路径后，渲染的组件；</li><li>exact：精准匹配，只有精准匹配到完全一致的路径，才会渲染对应的组件；</li></ul></li></ul><p>在App中进行如下演练：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; BrowserRouter, Route, Link &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Home <span class="keyword">from</span> <span class="string">&#x27;./pages/home&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> About <span class="keyword">from</span> <span class="string">&#x27;./pages/about&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> Profile <span class="keyword">from</span> <span class="string">&#x27;./pages/profile&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;BrowserRouter&gt;</span><br><span class="line">        &lt;Link to=<span class="string">&quot;/&quot;</span>&gt;首页&lt;/Link&gt;</span><br><span class="line">        &lt;Link to=<span class="string">&quot;/about&quot;</span>&gt;关于&lt;/Link&gt;</span><br><span class="line">        &lt;Link to=<span class="string">&quot;/profile&quot;</span>&gt;我的&lt;/Link&gt;</span><br><span class="line"></span><br><span class="line">        &lt;Route exact path=<span class="string">&quot;/&quot;</span> component=&#123;Home&#125; /&gt;</span><br><span class="line">        &lt;Route path=<span class="string">&quot;/about&quot;</span> component=&#123;About&#125; /&gt;</span><br><span class="line">        &lt;Route path=<span class="string">&quot;/profile&quot;</span> component=&#123;Profile&#125; /&gt;</span><br><span class="line">      &lt;/BrowserRouter&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/19001" alt="图片">显示效果</p><h3 id="NavLink的使用"><a href="#NavLink的使用" class="headerlink" title="NavLink的使用"></a>NavLink的使用</h3><p><strong>路径选中时，对应的a元素变为红色</strong></p><p>这个时候，我们要使用NavLink组件来替代Link组件：</p><ul><li>activeStyle：活跃时（匹配时）的样式；</li><li>activeClassName：活跃时添加的class；</li><li>exact：是否精准匹配；</li></ul><p>先演示activeStyle：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;NavLink to=<span class="string">&quot;/&quot;</span> activeStyle=&#123;&#123;<span class="attr">color</span>: <span class="string">&quot;red&quot;</span>&#125;&#125;&gt;首页&lt;/NavLink&gt;</span><br><span class="line">&lt;NavLink to=<span class="string">&quot;/about&quot;</span> activeStyle=&#123;&#123;<span class="attr">color</span>: <span class="string">&quot;red&quot;</span>&#125;&#125;&gt;关于&lt;/NavLink&gt;</span><br><span class="line">&lt;NavLink to=<span class="string">&quot;/profile&quot;</span> activeStyle=&#123;&#123;<span class="attr">color</span>: <span class="string">&quot;red&quot;</span>&#125;&#125;&gt;我的&lt;/NavLink&gt;</span><br></pre></td></tr></table></figure><p>但是，我们会发现在选中about或profile时，第一个也会变成红色：</p><ul><li>原因是/路径也匹配到了/about或/profile；</li><li>这个时候，我们可以在第一个NavLink中添加上exact属性；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;NavLink exact to=<span class="string">&quot;/&quot;</span> activeStyle=&#123;&#123;<span class="attr">color</span>: <span class="string">&quot;red&quot;</span>&#125;&#125;&gt;首页&lt;/NavLink&gt;</span><br></pre></td></tr></table></figure><p>默认的activeClassName：</p><ul><li>事实上在默认匹配成功时，NavLink就会添加上一个动态的active class；</li><li>所以我们也可以直接编写样式</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a.active &#123;</span><br><span class="line">  color: red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然，如果你担心这个class在其他地方被使用了，出现样式的层叠，也可以自定义class</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;NavLink exact to=<span class="string">&quot;/&quot;</span> activeClassName=<span class="string">&quot;link-active&quot;</span>&gt;首页&lt;/NavLink&gt;</span><br><span class="line">&lt;NavLink to=<span class="string">&quot;/about&quot;</span> activeClassName=<span class="string">&quot;link-active&quot;</span>&gt;关于&lt;/NavLink&gt;</span><br><span class="line">&lt;NavLink to=<span class="string">&quot;/profile&quot;</span> activeClassName=<span class="string">&quot;link-active&quot;</span>&gt;我的&lt;/NavLink&gt;</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/19002" alt="图片">设置activeClassName效果</p><h3 id="Switch的作用"><a href="#Switch的作用" class="headerlink" title="Switch的作用"></a>Switch的作用</h3><p>我们来看下面的路由规则：</p><ul><li>当我们匹配到某一个路径时，我们会发现有一些问题；</li><li>比如/about路径匹配到的同时，<code>/:userid</code>也被匹配到了，并且最后的一个NoMatch组件总是被匹配到；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;Route exact path=<span class="string">&quot;/&quot;</span> component=&#123;Home&#125; /&gt;</span><br><span class="line">&lt;Route path=<span class="string">&quot;/about&quot;</span> component=&#123;About&#125; /&gt;</span><br><span class="line">&lt;Route path=<span class="string">&quot;/profile&quot;</span> component=&#123;Profile&#125; /&gt;</span><br><span class="line">&lt;Route path=<span class="string">&quot;/:userid&quot;</span> component=&#123;User&#125;/&gt;</span><br><span class="line">&lt;Route component=&#123;NoMatch&#125;/&gt;</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/19003" alt="图片">匹配效果如下</p><p>原因是什么呢？默认情况下，react-router中只要是路径被匹配到的Route对应的组件都会被渲染；</p><p>但是实际开发中，我们往往希望有一种排他的思想：</p><ul><li>只要匹配到了第一个，那么后面的就不应该继续匹配了；</li><li>这个时候我们可以使用Switch来将所有的Route进行包裹即可；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;Switch&gt;</span><br><span class="line">  &lt;Route exact path=<span class="string">&quot;/&quot;</span> component=&#123;Home&#125; /&gt;</span><br><span class="line">  &lt;Route path=<span class="string">&quot;/about&quot;</span> component=&#123;About&#125; /&gt;</span><br><span class="line">  &lt;Route path=<span class="string">&quot;/profile&quot;</span> component=&#123;Profile&#125; /&gt;</span><br><span class="line">  &lt;Route path=<span class="string">&quot;/:userid&quot;</span> component=&#123;User&#125; /&gt;</span><br><span class="line">  &lt;Route component=&#123;NoMatch&#125; /&gt;</span><br><span class="line">&lt;/Switch&gt;</span><br></pre></td></tr></table></figure><h3 id="Redirect的使用"><a href="#Redirect的使用" class="headerlink" title="Redirect的使用"></a>Redirect的使用</h3><p>Redirect用于路由的重定向，当这个组件出现时，就会执行跳转到对应的to路径中：</p><p>我们这里使用这个的一个案例：</p><ul><li><p>用户跳转到User界面；</p></li><li><p>但是在User界面有一个isLogin用于记录用户是否登录：</p></li><li><ul><li>true：那么显示用户的名称；</li><li>false：直接重定向到登录界面；</li></ul></li></ul><p>App.js中提前定义好Login页面对应的Route：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;Switch&gt;</span><br><span class="line">  ...其他Route</span><br><span class="line">  &lt;Route path=<span class="string">&quot;/login&quot;</span> component=&#123;Login&#125; /&gt;</span><br><span class="line">  &lt;Route component=&#123;NoMatch&#125; /&gt;</span><br><span class="line">&lt;/Switch&gt;</span><br></pre></td></tr></table></figure><p>在User.js中写上对应的逻辑代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; Redirect &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      isLogin: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.state.isLogin ? (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;User&lt;/h2&gt;</span><br><span class="line">        &lt;h2&gt;用户名: coderwhy&lt;/h2&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    ): <span class="xml"><span class="tag">&lt;<span class="name">Redirect</span> <span class="attr">to</span>=<span class="string">&quot;/login&quot;</span>/&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="react-router高级使用"><a href="#react-router高级使用" class="headerlink" title="react-router高级使用"></a>react-router高级使用</h2><h3 id="路由嵌套"><a href="#路由嵌套" class="headerlink" title="路由嵌套"></a>路由嵌套</h3><p>在开发中，路由之间是存在嵌套关系的。</p><p>这里我们假设about页面中有两个页面内容：</p><ul><li>商品列表和消息列表；</li><li>点击不同的链接可以跳转到不同的地方，显示不同的内容；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Route, Switch, Link &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AboutProduct</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &lt;li&gt;商品列表<span class="number">1</span>&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;商品列表<span class="number">2</span>&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;商品列表<span class="number">3</span>&lt;/li&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AboutMessage</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &lt;li&gt;消息列表<span class="number">1</span>&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;消息列表<span class="number">2</span>&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;消息列表<span class="number">3</span>&lt;/li&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">About</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Link to=<span class="string">&quot;/about&quot;</span>&gt;商品&lt;/Link&gt;</span><br><span class="line">        &lt;Link to=<span class="string">&quot;/about/message&quot;</span>&gt;消息&lt;/Link&gt;</span><br><span class="line"></span><br><span class="line">        &lt;Switch&gt;</span><br><span class="line">          &lt;Route exact path=<span class="string">&quot;/about&quot;</span> component=&#123;AboutProduct&#125; /&gt;</span><br><span class="line">          &lt;Route path=<span class="string">&quot;/about/message&quot;</span> component=&#123;AboutMessage&#125; /&gt;</span><br><span class="line">        &lt;/Switch&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="手动跳转"><a href="#手动跳转" class="headerlink" title="手动跳转"></a>手动跳转</h3><p>目前我们实现的跳转主要是通过Link或者NavLink进行跳转的，实际上我们也可以通过<code>JavaScript代码</code>进行跳转。</p><p>但是通过<code>JavaScript代码</code>进行跳转有一个前提：必须获取到history对象。</p><p>如何可以获取到history的对象呢？两种方式</p><ul><li>方式一：如果该组件是通过路由直接跳转过来的，那么可以直接获取history、location、match对象；</li><li>方式二：如果该组件是一个普通渲染的组件，那么不可以直接获取history、location、match对象；</li></ul><p>那么如果普通的组件也希望获取对应的对象属性应该怎么做呢？</p><ul><li>前面我们学习过高阶组件，可以在组件中添加想要的属性；</li><li>react-router也是通过高阶组件为我们的组件添加相关的属性的；</li></ul><p>如果我们希望在App组件中获取到history对象，必须满足以下两个条件：</p><ul><li>App组件必须包裹在Router组件之内；</li><li>App组件使用withRouter高阶组件包裹；</li></ul><p>index.js代码修改如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;BrowserRouter&gt;</span><br><span class="line">    &lt;App /&gt;</span><br><span class="line">  &lt;/BrowserRouter&gt;,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>App.js代码修改如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Route, Switch, NavLink, withRouter &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line">...省略其他的导入代码</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.props.history);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        ...其他代码</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.pushToProfile()&#125;&gt;我的&lt;/button&gt;</span><br><span class="line"></span><br><span class="line">        &lt;Switch&gt;</span><br><span class="line">          &lt;Route exact path=<span class="string">&quot;/&quot;</span> component=&#123;Home&#125; /&gt;</span><br><span class="line">          &lt;Route path=<span class="string">&quot;/about&quot;</span> component=&#123;About&#125; /&gt;</span><br><span class="line">          &lt;Route path=<span class="string">&quot;/profile&quot;</span> component=&#123;Profile&#125; /&gt;</span><br><span class="line">          &lt;Route path=<span class="string">&quot;/:userid&quot;</span> component=&#123;User&#125; /&gt;</span><br><span class="line">          &lt;Route component=&#123;NoMatch&#125; /&gt;</span><br><span class="line">        &lt;/Switch&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">pushToProfile</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.props.history.push(<span class="string">&quot;/profile&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withRouter(App);</span><br></pre></td></tr></table></figure><p><strong>源码选读：这里的history来自哪里呢？是否和之前使用的window.history一样呢？</strong></p><p>我们发现withRouter的高阶函数来自react-router-dom：</p><ul><li>实际上来自react-router的包；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/19004" alt="图片"></p><p>withRouter函数：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/19005" alt="图片">withRouter函数</p><p>history对象来自哪里呢？</p><ul><li>实际来自上面代码的context；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/19006" alt="图片">context</p><p>这个context的值来自哪里呢？</p><ul><li>来自于context.Consumer的value中；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/19007" alt="图片">Router中的value</p><p>this.props.history来自哪里呢？</p><ul><li>来自BrowserRouter或者HashRouter在创建时，传入的值；</li><li>又传递给了Router，Router的子组件可以通过该context获取到这个值；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/19008" alt="图片">BrowserRouter的源码</p><p>createBrowserHistory来自哪里呢？</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/19009" alt="图片">history模块</p><p>执行push操作的本质：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/19010" alt="图片">push操作</p><h3 id="传递参数"><a href="#传递参数" class="headerlink" title="传递参数"></a>传递参数</h3><p>传递参数有三种方式：</p><ul><li>动态路由的方式；</li><li>search传递参数；</li><li>to传入对象；</li></ul><p><strong>动态路由的方式</strong></p><p>动态路由的概念指的是路由中的路径并不会固定：</p><ul><li>比如<code>/detail</code>的path对应一个组件Detail；</li><li>如果我们将path在Route匹配时写成<code>/detail/:id</code>，那么 <code>/detail/abc</code>、<code>/detail/123</code>都可以匹配到该Route，并且进行显示；</li><li>这个匹配规则，我们就称之为动态路由；</li></ul><p>通常情况下，使用动态路由可以为路由传递参数。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;</span><br><span class="line"> ...其他Link</span><br><span class="line">  &lt;NavLink to=<span class="string">&quot;/detail/abc123&quot;</span>&gt;详情&lt;/NavLink&gt;</span><br><span class="line"></span><br><span class="line">  &lt;Switch&gt;</span><br><span class="line">    ... 其他Route</span><br><span class="line">    &lt;Route path=<span class="string">&quot;/detail/:id&quot;</span> component=&#123;Detail&#125;/&gt;</span><br><span class="line">    &lt;Route component=&#123;NoMatch&#125; /&gt;</span><br><span class="line">  &lt;/Switch&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><p>detail.js的代码如下：</p><ul><li>我们可以直接通过match对象中获取id；</li><li>这里我们没有使用withRouter，原因是因为Detail本身就是通过路由进行的跳转；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Detail</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.props.match.params.id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;Detail: &#123;<span class="built_in">this</span>.props.match.params.id&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>search传递参数</strong></p><p>NavLink写法：</p><ul><li>我们在跳转的路径中添加了一些query参数；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;NavLink to=<span class="string">&quot;/detail2?name=why&amp;age=18&quot;</span>&gt;详情<span class="number">2</span>&lt;/NavLink&gt;</span><br><span class="line"></span><br><span class="line">&lt;Switch&gt;</span><br><span class="line">  &lt;Route path=<span class="string">&quot;/detail2&quot;</span> component=&#123;Detail2&#125;/&gt;</span><br><span class="line">&lt;/Switch&gt;</span><br></pre></td></tr></table></figure><p>Detail2中如何获取呢？</p><ul><li>Detail2中是需要在location中获取search的；</li><li>注意：这个search没有被解析，需要我们自己来解析；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Detail2</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.props.location.search); <span class="comment">// ?name=why&amp;age=18</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;Detail2:&lt;/h2&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>to传入对象</strong></p><p>to可以直接传入一个对象</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;NavLink to=&#123;&#123;</span><br><span class="line">    pathname: <span class="string">&quot;/detail2&quot;</span>, </span><br><span class="line">    query: &#123;<span class="attr">name</span>: <span class="string">&quot;kobe&quot;</span>, <span class="attr">age</span>: <span class="number">30</span>&#125;,</span><br><span class="line">    state: &#123;<span class="attr">height</span>: <span class="number">1.98</span>, <span class="attr">address</span>: <span class="string">&quot;洛杉矶&quot;</span>&#125;,</span><br><span class="line">    search: <span class="string">&quot;?apikey=123&quot;</span></span><br><span class="line">  &#125;&#125;&gt;</span><br><span class="line">  详情<span class="number">2</span></span><br><span class="line">&lt;/NavLink&gt;</span><br></pre></td></tr></table></figure><p>获取参数：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Detail2</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.props.location);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;Detail2:&lt;/h2&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/19011" alt="图片">location对象</p><h2 id="react-router-config"><a href="#react-router-config" class="headerlink" title="react-router-config"></a>react-router-config</h2><p>目前我们所有的路由定义都是直接使用Route组件，并且添加属性来完成的。</p><p>但是这样的方式会让路由变得非常混乱，我们希望将所有的路由配置放到一个地方进行集中管理：</p><ul><li>这个时候可以使用react-router-config来完成；</li></ul><p>安装react-router-config：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add react-router-config</span><br></pre></td></tr></table></figure><p>常见router/index.js文件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Home <span class="keyword">from</span> <span class="string">&quot;../pages/home&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> About, &#123; AboutMessage, AboutProduct &#125; <span class="keyword">from</span> <span class="string">&quot;../pages/about&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> Profile <span class="keyword">from</span> <span class="string">&quot;../pages/profile&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> Login <span class="keyword">from</span> <span class="string">&quot;../pages/login&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> User <span class="keyword">from</span> <span class="string">&quot;../pages/user&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> Detail <span class="keyword">from</span> <span class="string">&quot;../pages/detail&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> Detail2 <span class="keyword">from</span> <span class="string">&quot;../pages/detail2&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> NoMatch <span class="keyword">from</span> <span class="string">&quot;../pages/nomatch&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">    exact: <span class="literal">true</span>,</span><br><span class="line">    component: Home</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">&quot;/about&quot;</span>,</span><br><span class="line">    component: About,</span><br><span class="line">    routes: [</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">&quot;/about&quot;</span>,</span><br><span class="line">        exact: <span class="literal">true</span>,</span><br><span class="line">        component: AboutProduct</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">&quot;/about/message&quot;</span>,</span><br><span class="line">        component: AboutMessage</span><br><span class="line">      &#125;,</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">&quot;/profile&quot;</span>,</span><br><span class="line">    component: Profile</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">&quot;/login&quot;</span>,</span><br><span class="line">    component: Login</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">&quot;/user&quot;</span>,</span><br><span class="line">    component: User</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">&quot;/detail/:id&quot;</span>,</span><br><span class="line">    component: Detail</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">&quot;/detail2&quot;</span>,</span><br><span class="line">    component: Detail2</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    component: NoMatch</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> routes;</span><br></pre></td></tr></table></figure><p>将之前的Switch配置，换成react-router-config中提供的renderRoutes函数：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;renderRoutes(routes)&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="comment">/* &lt;Switch&gt;</span></span><br><span class="line"><span class="comment">     &lt;Route exact path=&quot;/&quot; component=&#123;Home&#125; /&gt;</span></span><br><span class="line"><span class="comment">      &lt;Route path=&quot;/about&quot; component=&#123;About&#125; /&gt;</span></span><br><span class="line"><span class="comment">      &lt;Route path=&quot;/profile&quot; component=&#123;Profile&#125; /&gt;</span></span><br><span class="line"><span class="comment">      &lt;Route path=&quot;/user&quot; component=&#123;User&#125; /&gt;</span></span><br><span class="line"><span class="comment">      &lt;Route path=&quot;/login&quot; component=&#123;Login&#125; /&gt;</span></span><br><span class="line"><span class="comment">      &lt;Route path=&quot;/detail/:id&quot; component=&#123;Detail&#125;/&gt;</span></span><br><span class="line"><span class="comment">      &lt;Route path=&quot;/detail2&quot; component=&#123;Detail2&#125;/&gt;</span></span><br><span class="line"><span class="comment">      &lt;Route component=&#123;NoMatch&#125; /&gt;</span></span><br><span class="line"><span class="comment"> &lt;/Switch&gt; */</span>&#125;</span><br></pre></td></tr></table></figure><p>如果是子组件中，需要路由跳转，那么需要在子组件中使用renderRoutes函数：</p><ul><li>在跳转到的路由组件中会多一个 <code>this.props.route</code> 属性；</li><li>该<code>route</code>属性代表当前跳转到的路由对象，可以通过该属性获取到 <code>routes</code>；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">About</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Link to=<span class="string">&quot;/about&quot;</span>&gt;商品&lt;/Link&gt;</span><br><span class="line">        &lt;Link to=<span class="string">&quot;/about/message&quot;</span>&gt;消息&lt;/Link&gt;</span><br><span class="line"></span><br><span class="line">        &#123;renderRoutes(<span class="built_in">this</span>.props.route.routes)&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实际上react-router-config中还提供了一个<code>matchRoutes</code>辅助函数：</p><ul><li><code>matchRoutes(routes, pathname)</code>传入一个路由对象数组，获取所有匹配的路径；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes = matchRoutes(<span class="built_in">this</span>.props.route.routes, <span class="string">&quot;/about&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(routes);</span><br></pre></td></tr></table></figure><p>查看renderRoutes的源码也是非常简单的：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/19012" alt="图片">renderRoutes源码</p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列十八-Redux(四)state如何管理</title>
      <link href="/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81%E5%85%AB-Redux-%E5%9B%9B-state%E5%A6%82%E4%BD%95%E7%AE%A1%E7%90%86/"/>
      <url>/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81%E5%85%AB-Redux-%E5%9B%9B-state%E5%A6%82%E4%BD%95%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="reducer拆分"><a href="#reducer拆分" class="headerlink" title="reducer拆分"></a>reducer拆分</h2><h3 id="reducer代码拆分"><a href="#reducer代码拆分" class="headerlink" title="reducer代码拆分"></a>reducer代码拆分</h3><p>我们来看一下目前我们的reducer：</p><ul><li><p>当前这个reducer既有处理counter的代码，又有处理home页面的数据；</p></li><li><p>后续counter相关的状态或home相关的状态会进一步变得更加复杂；</p></li><li><p>我们也会继续添加其他的相关状态，比如购物车、分类、歌单等等；</p><a id="more"></a></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state = initialState, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> ADD_NUMBER:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">counter</span>: state.counter + action.num &#125;;</span><br><span class="line">    <span class="keyword">case</span> SUB_NUMBER:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">counter</span>: state.counter - action.num &#125;;</span><br><span class="line">    <span class="keyword">case</span> CHANGE_BANNER:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">banners</span>: action.banners &#125;;</span><br><span class="line">    <span class="keyword">case</span> CHANGE_RECOMMEND:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">recommends</span>: action.recommends &#125;;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果将所有的状态都放到一个reducer中进行管理，随着项目的日趋庞大，必然会造成代码臃肿、难以维护。</p><p><strong>因此，我们可以对reducer进行拆分：</strong></p><p>我们先抽取一个对counter处理的reducer：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// counter相关的状态</span></span><br><span class="line"><span class="keyword">const</span> initialCounter = &#123;</span><br><span class="line">  counter: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">counterReducer</span>(<span class="params">state = initialCounter, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> ADD_NUMBER:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">counter</span>: state.counter + action.num &#125;;</span><br><span class="line">    <span class="keyword">case</span> SUB_NUMBER:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">counter</span>: state.counter - action.num &#125;;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再抽取一个对home处理的reducer：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// home相关的状态</span></span><br><span class="line"><span class="keyword">const</span> initialHome = &#123;</span><br><span class="line">  banners: [],</span><br><span class="line">  recommends: []</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">homeReducer</span>(<span class="params">state = initialHome, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> CHANGE_BANNER:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">banners</span>: action.banners &#125;;</span><br><span class="line">    <span class="keyword">case</span> CHANGE_RECOMMEND:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">recommends</span>: action.recommends &#125;;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果将它们合并起来呢？</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state = initialState, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    counterInfo: counterReducer(state.counterInfo, action),</span><br><span class="line">    homeInfo: homeReducer(state.homeInfo, action),</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="reducer文件拆分"><a href="#reducer文件拆分" class="headerlink" title="reducer文件拆分"></a>reducer文件拆分</h3><p>目前我们已经将不同的状态处理拆分到不同的reducer中，我们来思考：</p><ul><li>虽然已经放到不同的函数了，但是这些函数的处理依然是在同一个文件中，代码非常的混乱；</li><li>另外关于reducer中用到的constant、action等我们也依然是在同一个文件中；</li></ul><p>所以，接下来，我们可以对文件结构再次进行拆分：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">./store</span><br><span class="line">├── counter</span><br><span class="line">│   ├── actioncreators.js</span><br><span class="line">│   ├── constants.js</span><br><span class="line">│   ├── index.js</span><br><span class="line">│   └── reducer.js</span><br><span class="line">├── home</span><br><span class="line">│   ├── actioncreators.js</span><br><span class="line">│   ├── constants.js</span><br><span class="line">│   ├── index.js</span><br><span class="line">│   └── reducer.js</span><br><span class="line">├── index.js</span><br><span class="line">├── reducer.js</span><br><span class="line">└── saga.js</span><br></pre></td></tr></table></figure><p>这里不再给出代码，每个文件中存放的内容即可：</p><ul><li>home/actioncreators.js：存放home相关的action；</li><li>home/constants.js：存放home相关的常量；</li><li>home/reducer.js：存放分离的reducer代码；</li><li>index.js：统一对外暴露的内容；</li></ul><h3 id="combineReducers"><a href="#combineReducers" class="headerlink" title="combineReducers"></a>combineReducers</h3><p>目前我们合并的方式是通过每次调用reducer函数自己来返回一个新的对象：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; reducer <span class="keyword">as</span> counterReducer &#125; <span class="keyword">from</span> <span class="string">&#x27;./counter&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; reducer <span class="keyword">as</span> homeReducer &#125; <span class="keyword">from</span> <span class="string">&#x27;./home&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state = initialState, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    counterInfo: counterReducer(state.counterInfo, action),</span><br><span class="line">    homeInfo: homeReducer(state.homeInfo, action),</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>事实上，redux给我们提供了一个combineReducers函数可以方便的让我们对多个reducer进行合并：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; reducer <span class="keyword">as</span> counterReducer &#125; <span class="keyword">from</span> <span class="string">&#x27;./counter&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; reducer <span class="keyword">as</span> homeReducer &#125; <span class="keyword">from</span> <span class="string">&#x27;./home&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reducer = combineReducers(&#123;</span><br><span class="line">  counterInfo: counterReducer,</span><br><span class="line">  homeInfo: homeReducer</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> reducer;</span><br></pre></td></tr></table></figure><p>那么combineReducers是如何实现的呢？</p><ul><li>事实上，它也是讲我们传入的reducers合并到一个对象中，最终返回一个combination的函数（相当于我们之前的reducer函数了）；</li><li>在执行combination函数的过程中，它会通过判断前后返回的数据是否相同来决定返回之前的state还是新的state；</li><li>新的state会触发订阅者发生对应的刷新，而旧的state可以有效的组织订阅者发生刷新；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">combineReducers</span>(<span class="params">reducers</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> reducerKeys = <span class="built_in">Object</span>.keys(reducers)</span><br><span class="line">  <span class="keyword">const</span> finalReducers = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; reducerKeys.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = reducerKeys[i]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">        warning(<span class="string">`No reducer provided for key &quot;<span class="subst">$&#123;key&#125;</span>&quot;`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      finalReducers[key] = reducers[key]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> finalReducerKeys = <span class="built_in">Object</span>.keys(finalReducers)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This is used to make sure we don&#x27;t warn about the same</span></span><br><span class="line">  <span class="comment">// keys multiple times.</span></span><br><span class="line">  <span class="keyword">let</span> unexpectedKeyCache</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    unexpectedKeyCache = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> shapeAssertionError</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    assertReducerShape(finalReducers)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    shapeAssertionError = e</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">combination</span>(<span class="params">state = &#123;&#125;, action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (shapeAssertionError) &#123;</span><br><span class="line">      <span class="keyword">throw</span> shapeAssertionError</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> warningMessage = getUnexpectedStateShapeWarningMessage(</span><br><span class="line">        state,</span><br><span class="line">        finalReducers,</span><br><span class="line">        action,</span><br><span class="line">        unexpectedKeyCache</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">if</span> (warningMessage) &#123;</span><br><span class="line">        warning(warningMessage)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> hasChanged = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">const</span> nextState = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; finalReducerKeys.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> key = finalReducerKeys[i]</span><br><span class="line">      <span class="keyword">const</span> reducer = finalReducers[key]</span><br><span class="line">      <span class="keyword">const</span> previousStateForKey = state[key]</span><br><span class="line">      <span class="keyword">const</span> nextStateForKey = reducer(previousStateForKey, action)</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> nextStateForKey === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> errorMessage = getUndefinedStateErrorMessage(key, action)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(errorMessage)</span><br><span class="line">      &#125;</span><br><span class="line">      nextState[key] = nextStateForKey</span><br><span class="line">      hasChanged = hasChanged || nextStateForKey !== previousStateForKey</span><br><span class="line">    &#125;</span><br><span class="line">    hasChanged =</span><br><span class="line">      hasChanged || finalReducerKeys.length !== <span class="built_in">Object</span>.keys(state).length</span><br><span class="line">    <span class="keyword">return</span> hasChanged ? nextState : state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ImmutableJS"><a href="#ImmutableJS" class="headerlink" title="ImmutableJS"></a>ImmutableJS</h2><h3 id="数据可变性的问题"><a href="#数据可变性的问题" class="headerlink" title="数据可变性的问题"></a>数据可变性的问题</h3><p>在React开发中，我们总是会强调数据的不可变性：</p><ul><li>无论是类组件中的state，还是redux中管理的state；</li><li>事实上在整个JavaScript编码过程中，数据的不可变性都是非常重要的；</li></ul><p>数据的可变性引发的问题：</p><ul><li>我们明明没有修改obj，只是修改了obj2，但是最终obj也被我们修改掉了；</li><li>原因非常简单，对象是引用类型，它们指向同一块内存空间，两个引用都可以任意修改；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  name: <span class="string">&quot;why&quot;</span>,</span><br><span class="line">  age: <span class="number">18</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(obj); <span class="comment">// &#123;name: &quot;why&quot;, age: 18&#125;</span></span><br><span class="line"><span class="keyword">const</span> obj2 = obj;</span><br><span class="line">obj2.name = <span class="string">&quot;kobe&quot;</span>;</span><br><span class="line"><span class="built_in">console</span>.log(obj); <span class="comment">// &#123;name: &quot;kobe&quot;, age: 18&#125;</span></span><br></pre></td></tr></table></figure><p>有没有办法解决上面的问题呢？</p><ul><li>进行对象的拷贝即可：Object.assign或扩展运算符</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(obj); <span class="comment">// &#123;name: &quot;why&quot;, age: 18&#125;</span></span><br><span class="line"><span class="keyword">const</span> obj2 = &#123;...obj&#125;;</span><br><span class="line">obj2.name = <span class="string">&quot;kobe&quot;</span>;</span><br><span class="line"><span class="built_in">console</span>.log(obj); <span class="comment">// &#123;name: &quot;kobe&quot;, age: 18&#125;</span></span><br></pre></td></tr></table></figure><p>这种对象的浅拷贝有没有问题呢？</p><ul><li>从代码的角度来说，没有问题，也解决了我们实际开发中一些潜在风险；</li><li>从性能的角度来说，有问题，如果对象过于庞大，这种拷贝的方式会带来性能问题以及内存浪费；</li></ul><p>有人会说，开发中不都是这样做的吗？</p><ul><li>我比较喜欢一句话：从来如此，便是对的吗？</li></ul><h3 id="认识ImmutableJS"><a href="#认识ImmutableJS" class="headerlink" title="认识ImmutableJS"></a>认识ImmutableJS</h3><p>为了解决上面的问题，出现了Immutable对象的概念：</p><ul><li>Immutable对象的特点是只要修改了对象，就会返回一个新的对象，旧的对象不会发生改变；</li></ul><p>但是这样的方式就不会浪费内存了吗？</p><ul><li>为了节约内存，又出现了一个新的算法：Persistent Data Structure（持久化数据结构或一致性数据结构）；</li></ul><p>当然，我们一听到持久化第一反应应该是数据被保存到本地或者数据库，但是这里并不是这个含义：</p><ul><li>用一种数据结构来保存数据；</li><li>当数据被修改时，会返回一个对象，但是新的对象会尽可能的利用之前的数据结构而不会对内存造成浪费；</li></ul><p>如何做到这一点呢？结构共享：</p><ul><li>如果在公众号等地方动图不能正常显示，可以查看下面的静态图；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/18001" alt="图片">Immutable 原理动画</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/18002" alt="图片">Immutable data</p><h3 id="ImutableJS常见API"><a href="#ImutableJS常见API" class="headerlink" title="ImutableJS常见API"></a>ImutableJS常见API</h3><p>我们来学习一下ImmutableJS常用的API：</p><ul><li>注意：我这里只是演示了一些API，更多的方式可以参考官网；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> imjs = Immutable;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.定义JavaScript的Array和转换成immutable的List</span></span><br><span class="line"><span class="keyword">const</span> friends = [</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&quot;why&quot;</span>, <span class="attr">age</span>: <span class="number">18</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&quot;kobe&quot;</span>, <span class="attr">age</span>: <span class="number">30</span> &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不会进行深层转换</span></span><br><span class="line"><span class="keyword">const</span> imArray1 = imjs.List(friends);</span><br><span class="line"><span class="comment">// 会进行深层转换</span></span><br><span class="line"><span class="keyword">const</span> imArray2 = imjs.fromJS(friends);</span><br><span class="line"><span class="comment">// console.log(imArray1);</span></span><br><span class="line"><span class="comment">// console.log(imArray2);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.定义JavaScript的Object和转换成immutable的Map</span></span><br><span class="line"><span class="keyword">const</span> info = &#123;</span><br><span class="line">  name: <span class="string">&quot;coderwhy&quot;</span>,</span><br><span class="line">  age: <span class="number">18</span>,</span><br><span class="line">  friend: &#123;</span><br><span class="line">    name: <span class="string">&quot;kobe&quot;</span>,</span><br><span class="line">    age: <span class="number">30</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> imObj1 = imjs.Map(info);</span><br><span class="line"><span class="keyword">const</span> imObj2 = imjs.fromJS(info);</span><br><span class="line"><span class="comment">// console.log(imObj1);</span></span><br><span class="line"><span class="comment">// console.log(imObj2);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.对immutable操作</span></span><br><span class="line"><span class="comment">// 3.1.添加数据</span></span><br><span class="line"><span class="comment">// 产生一个新的immutable对象</span></span><br><span class="line"><span class="built_in">console</span>.log(imArray1.push(<span class="string">&quot;aaaa&quot;</span>));</span><br><span class="line"><span class="built_in">console</span>.log(imArray1.set(<span class="number">2</span>, <span class="string">&quot;aaaa&quot;</span>));</span><br><span class="line"><span class="comment">// 原来的是不变的</span></span><br><span class="line"><span class="built_in">console</span>.log(imArray1);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.2.修改数据</span></span><br><span class="line"><span class="built_in">console</span>.log(imArray1.set(<span class="number">1</span>, <span class="string">&quot;aaaa&quot;</span>));</span><br><span class="line"><span class="built_in">console</span>.log(imArray2.set(<span class="number">2</span>, imjs.fromJS(<span class="string">&quot;bbbb&quot;</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.3.删除数据</span></span><br><span class="line"><span class="built_in">console</span>.log(imArray1.delete(<span class="number">0</span>).get(<span class="number">0</span>)); <span class="comment">// &#123;name: &quot;kobe&quot;, age: 30&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.4.查询数据</span></span><br><span class="line"><span class="built_in">console</span>.log(imArray1.get(<span class="number">1</span>));</span><br><span class="line"><span class="built_in">console</span>.log(imArray2.get(<span class="number">1</span>));</span><br><span class="line"><span class="built_in">console</span>.log(imArray1.get(<span class="number">1</span>).name);</span><br><span class="line"><span class="built_in">console</span>.log(imArray2.getIn([<span class="number">1</span>, <span class="string">&quot;name&quot;</span>]));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.转换成JavaScript对象</span></span><br><span class="line"><span class="keyword">const</span> array = imArray1.toJS();</span><br><span class="line"><span class="keyword">const</span> obj = imObj1.toJS();</span><br><span class="line"><span class="built_in">console</span>.log(array);</span><br><span class="line"><span class="built_in">console</span>.log(obj);</span><br></pre></td></tr></table></figure><h3 id="ImmutableJS重构redux"><a href="#ImmutableJS重构redux" class="headerlink" title="ImmutableJS重构redux"></a>ImmutableJS重构redux</h3><p>目前Redux已经学习了过多的内容了，很多同学已经认识到redux的难度，所以如何将ImmutableJS和redux结合使用我们这里先不讲解。</p><p>具体ImmutableJS和Redux的结合使用，放到后续项目练习时，再详细说明。</p><h2 id="Redux-FAQ"><a href="#Redux-FAQ" class="headerlink" title="Redux FAQ"></a>Redux FAQ</h2><h3 id="是否将所有的状态应用到redux"><a href="#是否将所有的状态应用到redux" class="headerlink" title="是否将所有的状态应用到redux"></a>是否将所有的状态应用到redux</h3><p>我们学习了Redux用来管理我们的应用状态，并且非常好用（当然，你学会前提下，没有学会，好好回顾一下）。</p><p>目前我们已经主要学习了三种状态管理方式：</p><ul><li>方式一：组件中自己的state管理；</li><li>方式二：Context数据的共享状态；</li><li>方式三：Redux管理应用状态；</li></ul><p>在开发中如何选择呢？</p><ul><li>首先，这个没有一个标准的答案；</li><li>某些用户，选择将所有的状态放到redux中进行管理，因为这样方便追踪和共享；</li><li>有些用户，选择将某些组件自己的状态放到组件内部进行管理；</li><li>有些用户，将类似于主题、用户信息等数据放到Context中进行共享和管理；</li><li>做一个开发者，到底选择怎样的状态管理方式，是你的工作之一，可以一个最好的平衡方式（Find a balance that works for you, and go with it.）；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/18003" alt="图片">redux作者建议</p><p>目前项目中我采用的state管理方案：</p><ul><li>UI相关的组件内部可以维护的状态，在组件内部自己来维护；</li><li>只要是需要共享的状态，都交给redux来管理和维护；</li><li>从服务器请求的数据（包括请求的操作），交给redux来维护；</li></ul><p>当然，根据不同的情况会进行适当的调整，在后续学习网易云音乐项目时，我也会再次讲解以实战的角度来设计数据的管理方案。</p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列十七-Redux(三)中间件</title>
      <link href="/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81%E4%B8%83-Redux-%E4%B8%89-%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
      <url>/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81%E4%B8%83-Redux-%E4%B8%89-%E4%B8%AD%E9%97%B4%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<h2 id="中间件的使用"><a href="#中间件的使用" class="headerlink" title="中间件的使用"></a>中间件的使用</h2><h3 id="组件中异步请求"><a href="#组件中异步请求" class="headerlink" title="组件中异步请求"></a>组件中异步请求</h3><p>在之前简单的案例中，redux中保存的counter是一个本地定义的数据，我们可以直接通过同步的操作来dispatch action，state就会被立即更新。</p><p>但是真实开发中，redux中保存的很多数据可能来自服务器，我们需要进行异步的请求，再将数据保存到redux中。</p><p>在之前学习网络请求的时候我们讲过，网络请求可以在class组件的<code>componentDidMount</code>中发送，所以我们可以有这样的结构：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/17001" alt="图片">组件中发送网络请求</p><a id="more"></a><p>我现在完成如下案例操作：</p><ul><li>在Home组件中请求banners和recommends的数据；</li><li>在Profile组件中展示banners和recommends的数据；</li></ul><p><strong>redux代码进行如下修改：</strong></p><p>在reducer.js中添加state初始化数据和reducer函数中处理代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  counter: <span class="number">0</span>,</span><br><span class="line">  banners: [],</span><br><span class="line">  recommends: []</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state = initialState, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> ADD_NUMBER:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">counter</span>: state.counter + action.num &#125;;</span><br><span class="line">    <span class="keyword">case</span> SUB_NUMBER:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">counter</span>: state.counter - action.num &#125;;</span><br><span class="line">    <span class="keyword">case</span> CHANGE_BANNER:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">banners</span>: action.banners &#125;;</span><br><span class="line">    <span class="keyword">case</span> CHANGE_RECOMMEND:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">recommends</span>: action.recommends &#125;;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>constants中增加常量：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> CHANGE_BANNER = <span class="string">&quot;CHANGE_BANNER&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> CHANGE_RECOMMEND = <span class="string">&quot;CHANGE_RECOMMEND&quot;</span>;</span><br></pre></td></tr></table></figure><p>actionCreators.js中添加actions：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> changeBannersAction = <span class="function">(<span class="params">banners</span>) =&gt;</span> (&#123;</span><br><span class="line">  type: CHANGE_BANNER,</span><br><span class="line">  banners</span><br><span class="line">&#125;) </span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> changeRecommendsAction = <span class="function">(<span class="params">recommends</span>) =&gt;</span> (&#123;</span><br><span class="line">  type: CHANGE_RECOMMEND,</span><br><span class="line">  recommends</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>组件中代码代码修改：</strong></p><p>Home组件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">&quot;react-redux&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  addAction,</span><br><span class="line">  changeBannersAction,</span><br><span class="line">  changeRecommendsAction</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;../store/actionCreators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Home</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    axios.get(<span class="string">&quot;http://123.207.32.32:8000/home/multidata&quot;</span>).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> data = res.data.data;</span><br><span class="line">      <span class="built_in">this</span>.props.changeBanners(data.banner.list);</span><br><span class="line">      <span class="built_in">this</span>.props.changeRecommends(data.recommend.list);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...其他业务代码</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function"><span class="params">state</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    counter: state.counter</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function"><span class="params">dispatch</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    addNumber: <span class="function"><span class="keyword">function</span>(<span class="params">number</span>) </span>&#123;</span><br><span class="line">      dispatch(addAction(number));</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">changeBanners</span>(<span class="params">banners</span>)</span> &#123;</span><br><span class="line">      dispatch(changeBannersAction(banners));</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">changeRecommends</span>(<span class="params">recommends</span>)</span> &#123;</span><br><span class="line">      dispatch(changeRecommendsAction(recommends));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(Home);</span><br></pre></td></tr></table></figure><p>Profile组件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">&quot;react-redux&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  subAction</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;../store/actionCreators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        Profile</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;h2&gt;当前计数: &#123;<span class="built_in">this</span>.props.counter&#125;&lt;/h2&gt;</span><br><span class="line">          &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.decrement()&#125;&gt;-<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">          &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.subCounter()&#125;&gt;-<span class="number">5</span>&lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;h1&gt;Banners&lt;/h1&gt;</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">this</span>.props.banners.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;item.acm&#125;</span>&gt;</span>&#123;item.title&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line">        &lt;h1&gt;Recommends&lt;/h1&gt;</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">this</span>.props.recommends.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;item.acm&#125;</span>&gt;</span>&#123;item.title&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...其他逻辑代码</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function"><span class="params">state</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    counter: state.counter,</span><br><span class="line">    banners: state.banners,</span><br><span class="line">    recommends: state.recommends</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function"><span class="params">dispatch</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    subNumber: <span class="function"><span class="keyword">function</span> (<span class="params">number</span>) </span>&#123;</span><br><span class="line">      dispatch(subAction(number));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(Profile);</span><br></pre></td></tr></table></figure><h3 id="redux中异步请求"><a href="#redux中异步请求" class="headerlink" title="redux中异步请求"></a>redux中异步请求</h3><p>上面的代码有一个缺陷：</p><ul><li>我们必须将网络请求的异步代码放到组件的生命周期中来完成；</li><li>事实上，网络请求到的数据也属于我们状态管理的一部分，更好的一种方式应该是将其也交给redux来管理；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/17002" alt="图片">redux中发送网络请求</p><p>但是在redux中如何可以进行异步的操作呢？</p><ul><li>答案就是使用<strong>中间件（Middleware）</strong>；</li><li>学习过Express或Koa框架的童鞋对中间件的概念一定不陌生；</li><li>在这类框架中，Middleware可以帮助我们在请求和响应之间嵌入一些操作的代码，比如cookie解析、日志记录、文件压缩等操作；</li></ul><p>redux也引入了中间件（Middleware）的概念：</p><ul><li>这个中间件的目的是在<code>dispatch的action</code>和<code>最终达到的reducer</code>之间，扩展一些自己的代码；</li><li>比如日志记录、调用异步接口、添加代码调试功能等等；</li></ul><p>我们现在要做的事情就是发送异步的网络请求，所以我们可以添加对应的中间件：</p><ul><li>这里官网推荐的、包括演示的网络请求的中间件是使用 <code>redux-thunk</code>；</li></ul><p>redux-thunk是如何做到让我们可以发送异步的请求呢？</p><ul><li><p>我们知道，默认情况下的dispatch(action)，action需要是一个JavaScript的对象；</p></li><li><p><code>redux-thunk</code>可以让dispatch(action函数)，<code>action可以是一个函数</code>；</p></li><li><p>该函数会被调用，并且会传给这个函数一个dispatch函数和getState函数；</p></li><li><ul><li>dispatch函数用于我们之后再次派发action；</li><li>getState函数考虑到我们之后的一些操作需要依赖原来的状态，用于让我们可以获取之前的一些状态；</li></ul></li></ul><p><strong>如何使用redux-thunk呢？</strong></p><p>1.安装redux-thunk</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add redux-thunk</span><br></pre></td></tr></table></figure><p>2.在创建store时传入应用了middleware的enhance函数</p><ul><li>通过applyMiddleware来结合多个Middleware, 返回一个enhancer；</li><li>将enhancer作为第二个参数传入到createStore中；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过applyMiddleware来结合多个Middleware, 返回一个enhancer</span></span><br><span class="line"><span class="keyword">const</span> enhancer = applyMiddleware(thunkMiddleware);</span><br><span class="line"><span class="comment">// 将enhancer作为第二个参数传入到createStore中</span></span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer, enhancer);</span><br></pre></td></tr></table></figure><p>3.定义返回一个函数的action：</p><ul><li>注意：这里不是返回一个对象了，而是一个函数；</li><li>该函数在dispatch之后会被执行；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getHomeMultidataAction = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    axios.get(<span class="string">&quot;http://123.207.32.32:8000/home/multidata&quot;</span>).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> data = res.data.data;</span><br><span class="line">      dispatch(changeBannersAction(data.banner.list));</span><br><span class="line">      dispatch(changeRecommendsAction(data.recommend.list));</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4.修改home.js中的代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">&quot;react-redux&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  addAction,</span><br><span class="line">  getHomeMultidataAction</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;../store/actionCreators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Home</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.props.getHomeMultidata();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...其他逻辑代码</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...mapStatetoProps</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function"><span class="params">dispatch</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    addNumber: <span class="function"><span class="keyword">function</span>(<span class="params">number</span>) </span>&#123;</span><br><span class="line">      dispatch(addAction(number));</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">getHomeMultidata</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      dispatch(getHomeMultidataAction());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(Home);</span><br></pre></td></tr></table></figure><h3 id="redux-devtools"><a href="#redux-devtools" class="headerlink" title="redux-devtools"></a>redux-devtools</h3><p>我们之前讲过，redux可以方便的让我们对状态进行跟踪和调试，那么如何做到呢？</p><ul><li>redux官网为我们提供了redux-devtools的工具；</li><li>利用这个工具，我们可以知道每次状态是如何被修改的，修改前后的状态变化等等；</li></ul><p>安装该工具需要两步：</p><ul><li>第一步：在对应的浏览器中安装相关的插件（比如Chrome浏览器扩展商店中搜索Redux DevTools即可，其他方法可以参考GitHub）；</li><li>第二步：在redux中继承devtools</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware, compose &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> thunkMiddleware <span class="keyword">from</span> <span class="string">&#x27;redux-thunk&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">&#x27;./reducer.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> composeEnhancers = <span class="built_in">window</span>.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__ || compose;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过applyMiddleware来结合多个Middleware, 返回一个enhancer</span></span><br><span class="line"><span class="keyword">const</span> enhancer = composeEnhancers(applyMiddleware(thunkMiddleware));</span><br><span class="line"><span class="comment">// 将enhancer作为第二个参数传入到createStore中</span></span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer, enhancer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store;</span><br></pre></td></tr></table></figure><p>trace打开：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> composeEnhancers = <span class="built_in">window</span>.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__(&#123;<span class="attr">trace</span>: <span class="literal">true</span>&#125;) || compose;</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/17003" alt="图片">devtools工具</p><h3 id="redux-saga"><a href="#redux-saga" class="headerlink" title="redux-saga"></a>redux-saga</h3><h4 id="ES6的generator"><a href="#ES6的generator" class="headerlink" title="ES6的generator"></a>ES6的generator</h4><p>saga中间件使用了ES6的generator语法，所以我们有必须简单讲解一下：</p><ul><li>注意：我这里并没有列出generator的所有用法，事实上它的用法非常的灵活，大家可以自行去学习一下。</li></ul><p>在JavaScript中编写一个普通的函数，进行调用会立即拿到这个函数的返回结果：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foo() <span class="comment">// Hello World</span></span><br></pre></td></tr></table></figure><p>如果我们将这个函数编写成一个生成器函数：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">&quot;World&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> iterator = foo();</span><br><span class="line"><span class="built_in">console</span>.log(iterator, <span class="keyword">typeof</span> iterator); <span class="comment">// 一个object类型的iterator对象</span></span><br></pre></td></tr></table></figure><p>调用iterator的next函数，会销毁一次迭代器，并且返回一个yield的结果：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用一次next()是消耗一次迭代器</span></span><br><span class="line">iterator.next(); <span class="comment">// &#123;value: &quot;Hello&quot;, done: false&#125;</span></span><br><span class="line">iterator.next(); <span class="comment">// &#123;value: &quot;World&quot;, done: false&#125;</span></span><br><span class="line">iterator.next(); <span class="comment">// &#123;value: undefined, done: true&#125;</span></span><br></pre></td></tr></table></figure><p>研究一下foo生成器函数代码的执行顺序：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;111111&quot;</span>);</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;222222&quot;</span>);</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">&quot;World&quot;</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;333333&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用一次next()是消耗一次迭代器</span></span><br><span class="line">iterator.next(); <span class="comment">// &#123;value: &quot;Hello&quot;, done: false&#125;</span></span><br><span class="line"><span class="comment">// 打印111111</span></span><br><span class="line">iterator.next(); <span class="comment">// &#123;value: &quot;World&quot;, done: false&#125;</span></span><br><span class="line"><span class="comment">// 打印222222</span></span><br><span class="line">iterator.next(); <span class="comment">// &#123;value: undefined, done: true&#125;</span></span><br><span class="line"><span class="comment">// 打印333333</span></span><br></pre></td></tr></table></figure><p>generator和promise一起使用：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">bar</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">yield</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      resolve(<span class="string">&quot;Hello Generator&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bIterator = bar();</span><br><span class="line">bIterator.next().value.then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  bIterator.next(res);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="redux-saga的使用"><a href="#redux-saga的使用" class="headerlink" title="redux-saga的使用"></a>redux-saga的使用</h4><p>1.安装redux-saga</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add redux-saga</span><br></pre></td></tr></table></figure><p>2.集成redux-saga中间件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware, compose &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> thunkMiddleware <span class="keyword">from</span> <span class="string">&#x27;redux-thunk&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> createSagaMiddleware <span class="keyword">from</span> <span class="string">&#x27;redux-saga&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">&#x27;./reducer.js&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> mySaga <span class="keyword">from</span> <span class="string">&#x27;./saga&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过createSagaMiddleware函数来创建saga中间件</span></span><br><span class="line"><span class="keyword">const</span> sagaMiddleware = createSagaMiddleware();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> composeEnhancers = <span class="built_in">window</span>.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__(&#123;<span class="attr">trace</span>: <span class="literal">true</span>&#125;) || compose;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过applyMiddleware来结合多个Middleware, 返回一个enhancer</span></span><br><span class="line"><span class="keyword">const</span> enhancer = composeEnhancers(applyMiddleware(thunkMiddleware, sagaMiddleware));</span><br><span class="line"><span class="comment">// 将enhancer作为第二个参数传入到createStore中</span></span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer, enhancer);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 必须启动saga中间件，并且传入其要监听的generator</span></span><br><span class="line">sagaMiddleware.run(mySaga);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store;</span><br></pre></td></tr></table></figure><p>3.saga.js文件的编写：</p><ul><li>takeEvery：可以传入多个监听的actionType，每一个都可以被执行（对应有一个takeLastest，会取消前面的）</li><li>put：在saga中派发action不再是通过dispatch，而是通过put；</li><li>all：可以在yield的时候put多个action；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; takeEvery, put, all &#125; <span class="keyword">from</span> <span class="string">&#x27;redux-saga/effects&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  FETCH_HOME_MULTIDATA</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./constants&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  changeBannersAction,</span><br><span class="line">  changeRecommendsAction,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./actionCreators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">fetchHomeMultidata</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">yield</span> axios.get(<span class="string">&quot;http://123.207.32.32:8000/home/multidata&quot;</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(res);</span><br><span class="line">  <span class="keyword">const</span> data = res.data.data;</span><br><span class="line">  <span class="keyword">yield</span> all([</span><br><span class="line">    put(changeBannersAction(data.banner.list)),</span><br><span class="line">    put(changeRecommendsAction(data.recommend.list))</span><br><span class="line">  ])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">mySaga</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> takeEvery(FETCH_HOME_MULTIDATA, fetchHomeMultidata)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> mySaga;</span><br></pre></td></tr></table></figure><h2 id="中间件的原理"><a href="#中间件的原理" class="headerlink" title="中间件的原理"></a>中间件的原理</h2><h3 id="打印日志需求"><a href="#打印日志需求" class="headerlink" title="打印日志需求"></a>打印日志需求</h3><p>前面我们已经提过，中间件的目的是在redux中插入一些自己的操作：</p><ul><li>比如我们现在有一个需求，在dispatch之前，打印一下本次的action对象，dispatch完成之后可以打印一下最新的store state；</li><li>也就是我们需要将对应的代码插入到redux的某部分，让之后所有的dispatch都可以包含这样的操作；</li></ul><p>如果没有中间件，我们是否可以实现类似的代码呢？</p><p>当然可以，类似下面的方式即可：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;dispatching:&quot;</span>, addAction(<span class="number">5</span>));</span><br><span class="line">store.dispatch(addAction(<span class="number">5</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;new state:&quot;</span>, store.getState());</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;dispatching:&quot;</span>, addAction(<span class="number">10</span>));</span><br><span class="line">store.dispatch(subAction(<span class="number">10</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;new state:&quot;</span>, store.getState());</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/17004" alt="图片"></p><p>但是这种方式缺陷非常明显：</p><ul><li>首先，每一次的dispatch操作，我们都需要在前面加上这样的逻辑代码；</li><li>其次，存在大量重复的代码，会非常麻烦和臃肿；</li></ul><p>是否有一种更优雅的方式来处理这样的相同逻辑呢？</p><ul><li>我们可以将代码封装到一个独立的函数中</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatchAndLog</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;dispatching:&quot;</span>, action);</span><br><span class="line">  store.dispatch(addAction(<span class="number">5</span>));</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;新的state:&quot;</span>, store.getState());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dispatchAndLog(addAction(<span class="number">10</span>));</span><br></pre></td></tr></table></figure><p>但是这样的代码有一个非常大的缺陷：</p><ul><li>调用者（使用者）在使用我的dispatch时，必须使用我另外封装的一个函数dispatchAndLog；</li><li>显然，对于调用者来说，很难记住这样的API，更加习惯的方式是直接调用dispatch；</li></ul><p>我们来进一步对代码进行优化；</p><h3 id="修改dispatch"><a href="#修改dispatch" class="headerlink" title="修改dispatch"></a>修改dispatch</h3><p>事实上，我们可以利用一个hack一点的技术：Monkey Patching，利用它可以修改原有的程序逻辑；</p><p>我们对代码进行如下的修改：</p><ul><li>这样就意味着我们已经直接修改了dispatch的调用过程；</li><li>在调用dispatch的过程中，真正调用的函数其实是dispatchAndLog；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> next = store.dispatch;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatchAndLog</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;dispatching:&quot;</span>, addAction(<span class="number">10</span>));</span><br><span class="line">  next(addAction(<span class="number">5</span>));</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;新的state:&quot;</span>, store.getState());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">store.dispatch = dispatchAndLog;</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/17005" alt="图片"></p><p>当然，我们可以将它封装到一个模块中，只要调用这个模块中的函数，就可以对store进行这样的处理：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchLogging</span>(<span class="params">store</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> next = store.dispatch;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">dispatchAndLog</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;dispatching:&quot;</span>, action);</span><br><span class="line">    next(addAction(<span class="number">5</span>));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;新的state:&quot;</span>, store.getState());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  store.dispatch = dispatchAndLog;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="thunk需求"><a href="#thunk需求" class="headerlink" title="thunk需求"></a>thunk需求</h3><p>redux-thunk的作用：</p><ul><li>我们知道redux中利用一个中间件redux-thunk可以让我们的dispatch不再只是处理对象，并且可以处理函数；</li><li>那么redux-thunk中的基本实现过程是怎么样的呢？事实上非常的简单。</li></ul><p>我们来看下面的代码：</p><ul><li>我们又对dispatch进行转换，这个dispatch会判断传入的</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchThunk</span>(<span class="params">store</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> next = store.dispatch;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">dispatchAndThunk</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> action === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">      action(store.dispatch, store.getState);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      next(action);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  store.dispatch = dispatchAndThunk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将两个patch应用起来，进行测试：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">patchLogging(store);</span><br><span class="line">patchThunk(store);</span><br><span class="line"></span><br><span class="line">store.dispatch(addAction(<span class="number">10</span>));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params">dispatch</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    dispatch(subAction(<span class="number">10</span>));</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传入函数</span></span><br><span class="line">store.dispatch(getData);</span><br></pre></td></tr></table></figure><h3 id="合并中间件"><a href="#合并中间件" class="headerlink" title="合并中间件"></a>合并中间件</h3><p>单个调用某个函数来合并中间件并不是特别的方便，我们可以封装一个函数来实现所有的中间件合并：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyMiddleware</span>(<span class="params">store, middlewares</span>) </span>&#123;</span><br><span class="line">  middlewares = middlewares.slice();</span><br><span class="line"></span><br><span class="line">  middlewares.forEach(<span class="function"><span class="params">middleware</span> =&gt;</span> &#123;</span><br><span class="line">    store.dispatch = middleware(store);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">applyMiddleware(store, [patchLogging, patchThunk]);</span><br></pre></td></tr></table></figure><p>我们来理解一下上面操作之后，代码的流程：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/17006" alt="图片">合并中间件的流程</p><p>当然，真实的中间件实现起来会更加的灵活，这里我们仅仅做一个抛砖引玉，有兴趣可以参考redux合并中间件的源码流程。</p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列十六-Redux(二)react-redux</title>
      <link href="/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81%E5%85%AD-Redux-%E4%BA%8C-react-redux/"/>
      <url>/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81%E5%85%AD-Redux-%E4%BA%8C-react-redux/</url>
      
        <content type="html"><![CDATA[<blockquote><p>上一个章节主要是学习redux本身的基本使用过程，这个章节我们来学习一下如何将redux结合到React中来使用。</p><p>我会先按照简单的方式，自己来将redux结合到react中，并且结合高阶函数、Context一步步来实现connect和Provider的功能。</p><p>紧接着会讲解react-redux库的使用，帮助我们实现react-redux的连接。</p></blockquote><a id="more"></a><h2 id="react结合redux"><a href="#react结合redux" class="headerlink" title="react结合redux"></a>react结合redux</h2><h3 id="redux融入react代码"><a href="#redux融入react代码" class="headerlink" title="redux融入react代码"></a>redux融入react代码</h3><p>目前redux在react中使用是最大的，所以我们需要将之前编写的redux代码，融入到react当中去。</p><p>这里我创建了两个组件：</p><ul><li>Home组件：其中会展示当前的counter值，并且有一个+1和+5的按钮；</li><li>Profile组件：其中会展示当前的counter值，并且有一个-1和-5的按钮；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/16001" alt="图片">界面展示效果</p><p>home.js代码实现：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;../store&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  addAction</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;../store/actionCreators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Home</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      counter: store.getState().counter</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    store.subscribe(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">        counter: store.getState().counter</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;Home&lt;/h1&gt;</span><br><span class="line">        &lt;h2&gt;当前计数: &#123;<span class="built_in">this</span>.state.counter&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.increment()&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.addCounter()&#125;&gt;+<span class="number">5</span>&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">increment</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    store.dispatch(addAction(<span class="number">1</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">addCounter</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    store.dispatch(addAction(<span class="number">5</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Profile.js代码实现：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;../store&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  subAction</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;../store/actionCreators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Profile</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      counter: store.getState().counter</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    store.subscribe(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">        counter: store.getState().counter</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;hr/&gt;</span><br><span class="line">        &lt;h1&gt;Profile&lt;/h1&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;h2&gt;当前计数: &#123;<span class="built_in">this</span>.state.counter&#125;&lt;/h2&gt;</span><br><span class="line">          &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.decrement()&#125;&gt;-<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">          &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.subCounter()&#125;&gt;-<span class="number">5</span>&lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">decrement</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    store.dispatch(subAction(<span class="number">1</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">subCounter</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    store.dispatch(subAction(<span class="number">5</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的代码其实非常简单，核心代码主要是两个：</p><ul><li>在 <code>componentDidMount</code> 中定义数据的变化，当数据发生变化时重新设置 <code>counter</code>;</li><li>在发生点击事件时，调用store的<code>dispatch</code>来派发对应的<code>action</code>；</li></ul><h3 id="自定义connect函数"><a href="#自定义connect函数" class="headerlink" title="自定义connect函数"></a>自定义connect函数</h3><p>上面的代码是否可以实现<code>react组件</code>和<code>redux</code>结合起来呢？</p><ul><li>当然是可以的，但是我们会发现每个使用的地方其实会有一些重复的代码：</li><li>比如监听store数据改变的代码，都需要在 <code>componentDidMount</code>中完成；</li><li>比如派发事件，我们都需要去先拿到 <code>store</code>， 在调用其 <code>dispatch</code> 等；</li></ul><p>能否将这些公共的内容提取出来呢？</p><p>我们来定义一个connect函数：</p><ul><li><p>这个connect函数本身接受两个参数：</p></li><li><ul><li>参数一：里面存放 <code>component</code> 希望使用到的 <code>State</code> 属性；</li><li>参数二：里面存放 <code>component</code> 希望使用到的 <code>dispatch</code>动作；</li></ul></li><li><p>这个connect函数有一个返回值，是一个高阶组件：</p></li><li><ul><li>在<code>constructor</code>中的state中保存一下我们需要获取的状态；</li><li>在<code>componentDidMount</code>中订阅store中数据的变化，并且执行 <code>setState</code>操作；</li><li>在<code>componentWillUnmount</code>中需要取消订阅；</li><li>在<code>render</code>函数中返回传入的<code>WrappedComponent</code>，并且将所有的状态映射到其<code>props</code>中；</li><li>这个高阶组件接受一个组件作为参数，返回一个class组件；</li><li>在这个class组件中，我们进行如下操作：</li></ul></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;../store&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params">mapStateToProps, mapDispatchToProps</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">handleMapCpn</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">      <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.state = &#123;</span><br><span class="line">          storeState: mapStateToProps(store.getState())</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.unsubscribe = store.subscribe(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">            storeState: mapStateToProps(store.getState())</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="title">componentWillUnmount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.unsubscribe();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WrappedComponent</span> &#123;<span class="attr">...this.props</span>&#125; </span></span></span><br><span class="line"><span class="xml">                                 &#123;...mapStateToProps(store.getState())&#125;</span></span><br><span class="line"><span class="xml">                                 &#123;...mapDispatchToProps(store.dispatch)&#125;/&gt;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在home和props文件中，我们按照自己需要的state、dispatch来进行映射：</p><p>比如home.js中进行如下修改：</p><ul><li><p>mapStateToProps：用于将state映射到一个对象中，对象中包含我们需要的属性；</p></li><li><p>mapDispatchToProps：用于将dispatch映射到对象中，对象中包含在组件中可能操作的函数；</p></li><li><ul><li>当调用该函数时，本质上其实是调用dispatch(对应的Action)；</li></ul></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function"><span class="params">state</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    counter: state.counter</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function"><span class="params">dispatch</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    addNumber: <span class="function"><span class="keyword">function</span>(<span class="params">number</span>) </span>&#123;</span><br><span class="line">      dispatch(addAction(number));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(Home);</span><br></pre></td></tr></table></figure><p>在Profile中也是类似的操作。</p><p>有了connect函数，我们之后只需要关心从state和dispatch中映射自己需要的状态和行为即可；</p><h3 id="store的context处理"><a href="#store的context处理" class="headerlink" title="store的context处理"></a>store的context处理</h3><p>但是上面的connect函数有一个很大的缺陷：依赖导入的store</p><ul><li>如果我们将其封装成一个独立的库，需要依赖用于创建的store，我们应该如何去获取呢？</li><li>难道让用户来修改我们的源码吗？不太现实；</li></ul><p>正确的做法是我们提供一个Provider，Provider来自于我们创建的Context，让用户将store传入到value中即可；</p><p>创建一个context.js文件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createContext &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> StoreContext = createContext();</span><br></pre></td></tr></table></figure><p>修改connect函数中class组件部分的代码：</p><ul><li>注意下面我们将class组件的名称明确的定义出来，并且给它的<code>contextType</code>进行了赋值；</li><li>在组件内部用到store的地方，统一使用this.context代替（注意：constructor中直接使用第二个参数即可）</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; StoreContext &#125; <span class="keyword">from</span> <span class="string">&#x27;./context&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params">mapStateToProps, mapDispatchToProps</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">handleMapCpn</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ConnectCpn</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">      <span class="function"><span class="title">constructor</span>(<span class="params">props, context</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.state = &#123;</span><br><span class="line">          storeState: mapStateToProps(context.getState())</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.unsubscribe = <span class="built_in">this</span>.context.subscribe(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">            storeState: mapStateToProps(<span class="built_in">this</span>.context.getState())</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="title">componentWillUnmount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.unsubscribe();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WrappedComponent</span> &#123;<span class="attr">...this.props</span>&#125;</span></span></span><br><span class="line"><span class="xml">          &#123;...mapStateToProps(this.context.getState())&#125;</span></span><br><span class="line"><span class="xml">          &#123;...mapDispatchToProps(this.context.dispatch)&#125; /&gt;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ConnectCpn.contextType = StoreContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ConnectCpn;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在入口的index.js中，使用Provider并且提供store即可：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; StoreContext &#125; <span class="keyword">from</span> <span class="string">&#x27;./utils/context&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;./store&#x27;</span>;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;StoreContext.Provider value=&#123;store&#125;&gt;</span><br><span class="line">    &lt;App /&gt;</span><br><span class="line">  &lt;/StoreContext.Provider&gt;,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>测试代码，依然可以正常运行。</p><h2 id="react-redux使用"><a href="#react-redux使用" class="headerlink" title="react-redux使用"></a>react-redux使用</h2><h3 id="react-redux的使用"><a href="#react-redux的使用" class="headerlink" title="react-redux的使用"></a>react-redux的使用</h3><p>开始之前需要强调一下，redux和react没有直接的关系，你完全可以在React, Angular, Ember, jQuery, or vanilla JavaScript中使用Redux。</p><p>尽管这样说，redux依然是和React或者Deku的库结合的更好，因为他们是通过state函数来描述界面的状态，Redux可以发射状态的更新，让他们作出相应。</p><p>虽然我们之前已经实现了connect、Provider这些帮助我们完成连接redux、react的辅助工具，但是实际上redux官方帮助我们提供了 react-redux 的库，可以直接在项目中使用，并且实现的逻辑会更加的严谨和高效。</p><p>安装react-redux：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add react-redux</span><br></pre></td></tr></table></figure><p>使用connect函数：</p><ul><li>将之前使用的connect函数，换成react-redux的connect函数；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">&quot;react-redux&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// import connect from &#x27;../utils/connect2&#x27;;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(Home);</span><br></pre></td></tr></table></figure><p>使用Provider：</p><ul><li>将之前自己创建的Context的Provider，换成react-redux的Provider组件：</li><li>注意：这里传入的是store属性，而不是value属性（待会儿可以在源码中查看）；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Provider &#125; <span class="keyword">from</span> <span class="string">&#x27;react-redux&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;./store&#x27;</span>;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">    &lt;App /&gt;</span><br><span class="line">  &lt;/Provider&gt;,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="react-redux的源码"><a href="#react-redux的源码" class="headerlink" title="react-redux的源码"></a>react-redux的源码</h3><p>这里我简单带着大家看一下react-redux的源码：</p><ul><li>但是第一因为这个教程不是讲源码为主的教程（穿插讲解部分源码），所以源码只会阅读核心的部分；</li><li>另外我经常会说，整个社区在hooks出现后大量的库转向了hooks，所以在源码中会出现大量的hooks代码；</li><li>因为目前还没有讲解hooks相关的API，所以某些hooks的作用在这里也不方便解释（可以学习完hooks之后再详细阅读）；</li></ul><p>首先，我们简单看一下Provider的源码：</p><ul><li><p>使用了一个useMemo来返回一个contextValue的对象；</p></li><li><ul><li>这里使用useMemo的原因是为了进行性能的优化；</li><li>在依赖的store不改变的情况下，不会进行重新计算，返回一个新的对象；</li></ul></li><li><p>在下面的Context的Provider中就会将其赋值给value属性；</p></li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/16002" alt="图片"></p><p>ReactReduxContext来自另外一个文件：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/16003" alt="图片">Context对象的创建</p><p><strong>connect函数的依赖比较复杂：</strong></p><p>调用createConnect来返回一个connect函数：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/16004" alt="图片"></p><p>createConnect函数的调用：</p><ul><li><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/16005" alt="图片">createConnect函数</p></li></ul><p>connect函数最终调用的是connectHOC：</p><ul><li>connectHOC其实是connectAdvanced的函数；</li><li>connectAdvanced函数最终返回的是wrapWithConnect函数；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/16006" alt="图片"></p><p>wrapWithConnect函数：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/16007" alt="图片">wrapWithConnect函数</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/16008" alt="图片">wrapWithConnect最终的返回值</p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列十五-Redux初见</title>
      <link href="/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81%E4%BA%94-Redux%E5%88%9D%E8%A7%81/"/>
      <url>/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81%E4%BA%94-Redux%E5%88%9D%E8%A7%81/</url>
      
        <content type="html"><![CDATA[<blockquote><p>在React的开发过程中，Redux对于我们是非常重要的。</p><p>但是对于很多人来说，初次接触redux会感觉redux的学习坡度非常陡峭，难度比较大。</p><p>在接下来，我会通过一个系列的方式循循渐进、层层深入的方式来讲解Redux：从redux的独立使用过程、到redux的结构划分、到redux结合react的过程、到redux中异步操作、到复杂数据的结构处理、到结合immutable的使用。</p><p>整个过程，都是在现有知识的基础之上层层递增、一步步掌握redux的使用！</p></blockquote><a id="more"></a><h2 id="认识Redux"><a href="#认识Redux" class="headerlink" title="认识Redux"></a>认识Redux</h2><h3 id="JavaScript纯函数"><a href="#JavaScript纯函数" class="headerlink" title="JavaScript纯函数"></a>JavaScript纯函数</h3><p>函数式编程中有一个概念叫纯函数，JavaScript符合函数式编程的范式，所以也有纯函数的概念；</p><p>在React中，纯函数的概念非常重要，在接下来我们学习的Redux中也非常重要，所以我们有必须来回顾（如果你之前没有学过，那么你就是学习）一下纯函数。</p><p><strong>纯函数的维基百科定义：</strong></p><p>在程序设计中，若一个函数符合以下条件，那么这个函数被称为纯函数：</p><ul><li>此函数在相同的输入值时，需产生相同的输出。函数的输出和输入值以外的其他隐藏信息或状态无关，也和由I/O设备产生的外部输出无关。</li><li>该函数不能有语义上可观察的函数副作用，诸如“触发事件”，使输出设备输出，或更改输出值以外物件的内容等。</li></ul><p>当然上面的定义会过于的晦涩，所以我简单总结一下：</p><ul><li>确定的输入，一定会产生确定的输出；</li><li>函数在执行过程中，不能产生副作用；</li></ul><p>那么我们来看几个函数是否是纯函数：</p><p>案例一：</p><ul><li>很明显，下面的函数是一个纯函数；</li><li>它的输出是依赖我们的输入内容，并且中间没有产生任何副作用；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">num1, num2</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> num1 + num2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>案例二：</p><ul><li>add函数不是一个纯函数；</li><li>函数依赖一个外部的变量，变量发生改变时，会影响：确定的输入，产生确定的输出；</li><li>能否改进成纯函数呢？const foo = 5; 即可</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> foo = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">num</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> foo + num;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(add(<span class="number">5</span>));</span><br><span class="line">foo = <span class="number">10</span>;</span><br><span class="line"><span class="built_in">console</span>.log(add(<span class="number">5</span>));</span><br></pre></td></tr></table></figure><p>案例三：</p><ul><li>printInfo不是一个纯函数；</li><li>虽然无论输入什么，最终输出都是undefined，但是它产生了副作用，修改了传入的对象；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printInfo</span>(<span class="params">info</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(info.name, info.age);</span><br><span class="line">  info.name = <span class="string">&quot;哈哈哈&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然纯函数还有很多的变种，但是我们只需要理解它的核心就可以了。</p><p>为什么纯函数在函数式编程中非常重要呢？</p><ul><li>因为你可以<code>安心的写</code>和<code>安心的用</code>；</li><li>你在写的时候保证了函数的纯度，只是但是实现自己的业务逻辑即可，不需要关心传入的内容或者依赖其他的外部变量；</li><li>你在用的时候，你确定你的输入内容不会被任意篡改，并且自己确定的输入，一定会有确定的输出；</li></ul><p>React中就要求我们无论是函数还是class声明一个组件，这个组件都必须像纯函数一样，保护它们的props不被修改：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/15001" alt="图片">React的严格规则</p><p>在之后学习redux中，reducer也被要求是一个纯函数。</p><h3 id="认识Redux-1"><a href="#认识Redux-1" class="headerlink" title="认识Redux"></a>认识Redux</h3><h4 id="为什么需要redux？"><a href="#为什么需要redux？" class="headerlink" title="为什么需要redux？"></a>为什么需要redux？</h4><p>JavaScript开发的应用程序，已经变得越来越复杂了：</p><ul><li>JavaScript需要管理的状态越来越多，越来越复杂；</li><li>这些状态包括服务器返回的数据、缓存数据、用户操作产生的数据等等，也包括一些UI的状态，比如某些元素是否被选中，是否显示加载动效，当前分页；</li></ul><p>管理不断变化的state是非常困难的：</p><ul><li>状态之间相互会存在依赖，一个状态的变化会引起另一个状态的变化，View页面也有可能会引起状态的变化；</li><li>当应用程序复杂时，state在什么时候，因为什么原因而发生了变化，发生了怎么样的变化，会变得非常难以控制和追踪；</li></ul><p>React是在视图层帮助我们解决了DOM的渲染过程，但是State依然是留给我们自己来管理：</p><ul><li>无论是组件定义自己的state，还是组件之间的通信通过props进行传递；也包括通过Context进行数据之间的共享；</li><li>React主要负责帮助我们管理视图，state如何维护最终还是我们自己来决定；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/15002" alt="图片"></p><p>Redux就是一个帮助我们管理State的容器：Redux是JavaScript的状态容器，提供了可预测的状态管理；</p><p>Redux除了和React一起使用之外，它也可以和其他界面库一起来使用（比如Vue），并且它非常小（包括依赖在内，只有2kb）</p><h4 id="redux的核心理念"><a href="#redux的核心理念" class="headerlink" title="redux的核心理念"></a>redux的核心理念</h4><p>Redux的核心理念非常简单。</p><p>比如我们有一个朋友列表需要管理：</p><ul><li>如果我们没有定义统一的规范来操作这段数据，那么整个数据的变化就是无法跟踪的；</li><li>比如页面的某处通过<code>products.push</code>的方式增加了一条数据；</li><li>比如另一个页面通过<code>products[0].age = 25</code>修改了一条数据；</li><li>整个应用程序错综复杂，当出现bug时，很难跟踪到底哪里发生的变化；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  friends: [</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&quot;why&quot;</span>, <span class="attr">age</span>: <span class="number">18</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&quot;kobe&quot;</span>, <span class="attr">age</span>: <span class="number">40</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&quot;lilei&quot;</span>, <span class="attr">age</span>: <span class="number">30</span> &#125;,</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Redux要求我们通过action来更新数据：</p><ul><li>所有数据的变化，必须通过派发（dispatch）action来更新；</li><li>action是一个普通的JavaScript对象，用来描述这次更新的type和content；</li></ul><p>比如下面就是几个更新friends的action：</p><ul><li>强制使用action的好处是可以清晰的知道数据到底发生了什么样的变化，所有的数据变化都是可跟追、可预测的；</li><li>当然，目前我们的action是固定的对象，真实应用中，我们会通过函数来定义，返回一个action；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> action1 = &#123; <span class="attr">type</span>: <span class="string">&quot;ADD_FRIEND&quot;</span>, <span class="attr">info</span>: &#123; <span class="attr">name</span>: <span class="string">&quot;lucy&quot;</span>, <span class="attr">age</span>: <span class="number">20</span> &#125; &#125;</span><br><span class="line"><span class="keyword">const</span> action2 = &#123; <span class="attr">type</span>: <span class="string">&quot;INC_AGE&quot;</span>, <span class="attr">index</span>: <span class="number">0</span> &#125;</span><br><span class="line"><span class="keyword">const</span> action3 = &#123; <span class="attr">type</span>: <span class="string">&quot;CHANGE_NAME&quot;</span>, <span class="attr">playload</span>: &#123; <span class="attr">index</span>: <span class="number">0</span>, <span class="attr">newName</span>: <span class="string">&quot;coderwhy&quot;</span> &#125; &#125;</span><br></pre></td></tr></table></figure><p>但是如何将state和action联系在一起呢？答案就是reducer</p><ul><li>reducer是一个纯函数；</li><li>reducer做的事情就是将传入的state和action结合起来生成一个新的state；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state = initialState, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;ADD_FRIEND&quot;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">friends</span>: [...state.friends, action.info] &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;INC_AGE&quot;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state, <span class="attr">friends</span>: state.friends.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (index === action.index) &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123; ...item, <span class="attr">age</span>: item.age + <span class="number">1</span> &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> item;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;CHANGE_NAME&quot;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state, <span class="attr">friends</span>: state.friends.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (index === action.index) &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123; ...item, <span class="attr">name</span>: action.newName &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> item;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="redux的三大原则"><a href="#redux的三大原则" class="headerlink" title="redux的三大原则"></a>redux的三大原则</h4><p><strong>单一数据源</strong></p><p>整个应用程序的state被存储在一颗object tree中，并且这个object tree只存储在一个 store 中：</p><ul><li>Redux并没有强制让我们不能创建多个Store，但是那样做并不利于数据的维护；</li><li>单一的数据源可以让整个应用程序的state变得方便维护、追踪、修改；</li></ul><p><strong>State是只读的</strong></p><p>唯一修改State的方法一定是触发action，不要试图在其他地方通过任何的方式来修改State：</p><ul><li>这样就确保了View或网络请求都不能直接修改state，它们只能通过action来描述自己想要如何修改state；</li><li>这样可以保证所有的修改都被集中化处理，并且按照严格的顺序来执行，所以不需要担心race condition（竟态）的问题；</li></ul><p><strong>使用纯函数来执行修改</strong></p><p>通过reducer将 <code>旧state</code>和 <code>actions</code>联系在一起，并且返回一个新的State：</p><ul><li>随着应用程序的复杂度增加，我们可以将reducer拆分成多个小的reducers，分别操作不同state tree的一部分；</li><li>但是所有的reducer都应该是纯函数，不能产生任何的副作用；</li></ul><h2 id="redux的基本使用"><a href="#redux的基本使用" class="headerlink" title="redux的基本使用"></a>redux的基本使用</h2><h3 id="redux使用过程"><a href="#redux使用过程" class="headerlink" title="redux使用过程"></a>redux使用过程</h3><p>安装redux：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install redux --save</span><br><span class="line"># 或</span><br><span class="line">yarn add redux</span><br></pre></td></tr></table></figure><p>这里，我通过创建一个简单的js文件，我们先来简单学习一下redux：</p><p><strong>搭建项目结构</strong></p><p>1.创建一个新的项目文件夹：learn-redux</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 执行初始化操作</span><br><span class="line">yarn init</span><br><span class="line"></span><br><span class="line"># 安装redux</span><br><span class="line">yarn add redux</span><br></pre></td></tr></table></figure><p>2.创建src目录，并且创建index.js文件</p><ul><li>暂时没有任何内容</li></ul><p>3.修改package.json可以执行index.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;start&quot;</span>: <span class="string">&quot;node src/index.js&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/15003" alt="图片">修改packages.json</p><p><strong>开始在index.js中编写代码</strong></p><p>1.创建一个对象，作为我们要保存的状态：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> redux = <span class="built_in">require</span>(<span class="string">&#x27;redux&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  counter: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.创建Store来存储这个state</p><ul><li>创建store时必须创建reducer；</li><li>我们可以通过 <code>store.getState</code> 来获取当前的state</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建reducer</span></span><br><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = initialState, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据reducer创建store</span></span><br><span class="line"><span class="keyword">const</span> store = redux.createStore(reducer);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(store.getState());</span><br></pre></td></tr></table></figure><p>3.通过action来修改state</p><ul><li>通过dispatch来派发action；</li><li>通常action中都会有type属性，也可以携带其他的数据；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">store.dispatch(&#123;</span><br><span class="line">  type: <span class="string">&quot;INCREMENT&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">store.dispath(&#123;</span><br><span class="line">  type: <span class="string">&quot;DECREMENT&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">store.dispatch(&#123;</span><br><span class="line">  type: <span class="string">&quot;ADD_NUMBER&quot;</span>,</span><br><span class="line">  number: <span class="number">5</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>4.修改reducer中的处理代码</p><ul><li>这里一定要记住，reducer是一个纯函数，不需要直接修改state；</li><li>后面我会讲到直接修改state带来的问题；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = initialState, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;INCREMENT&quot;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;...state, <span class="attr">counter</span>: state.counter + <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;DECREMENT&quot;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;...state, <span class="attr">counter</span>: state.counter - <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;ADD_NUMBER&quot;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;...state, <span class="attr">counter</span>: state.counter + action.number&#125;</span><br><span class="line">    <span class="keyword">default</span>: </span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5.可以在派发action之前，监听store的变化：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">store.subscribe(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(store.getState());</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>完成的案例代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> redux = <span class="built_in">require</span>(<span class="string">&#x27;redux&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  counter: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建reducer</span></span><br><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = initialState, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;INCREMENT&quot;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;...state, <span class="attr">counter</span>: state.counter + <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;DECREMENT&quot;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;...state, <span class="attr">counter</span>: state.counter - <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;ADD_NUMBER&quot;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;...state, <span class="attr">counter</span>: state.counter + action.number&#125;</span><br><span class="line">    <span class="keyword">default</span>: </span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据reducer创建store</span></span><br><span class="line"><span class="keyword">const</span> store = redux.createStore(reducer);</span><br><span class="line"></span><br><span class="line">store.subscribe(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(store.getState());</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改store中的state</span></span><br><span class="line">store.dispatch(&#123;</span><br><span class="line">  type: <span class="string">&quot;INCREMENT&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// console.log(store.getState());</span></span><br><span class="line"></span><br><span class="line">store.dispatch(&#123;</span><br><span class="line">  type: <span class="string">&quot;DECREMENT&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// console.log(store.getState());</span></span><br><span class="line"></span><br><span class="line">store.dispatch(&#123;</span><br><span class="line">  type: <span class="string">&quot;ADD_NUMBER&quot;</span>,</span><br><span class="line">  number: <span class="number">5</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// console.log(store.getState());</span></span><br></pre></td></tr></table></figure><h3 id="redux结构划分"><a href="#redux结构划分" class="headerlink" title="redux结构划分"></a>redux结构划分</h3><p>如果我们将所有的逻辑代码写到一起，那么当redux变得复杂时代码就难以维护。</p><p>接下来，我会对代码进行拆分，将store、reducer、action、constants拆分成一个个文件。</p><p><strong>注意：node中对ES6模块化的支持</strong></p><p>目前我使用的node版本是v12.16.1，从node v13.2.0开始，node才对ES6模块化提供了支持：</p><ul><li><p>node v13.2.0之前，需要进行如下操作：</p></li><li><ul><li>在package.json中添加属性：<code>&quot;type&quot;: &quot;module&quot;</code>；</li><li>在执行命令中添加如下选项：<code>node --experimental-modules src/index.js</code>;</li></ul></li><li><p>node v13.2.0之后，只需要进行如下操作：</p></li><li><ul><li>在package.json中添加属性：<code>&quot;type&quot;: &quot;module&quot;</code>；</li></ul></li></ul><p>注意：导入文件时，需要跟上.js后缀名；</p><p><strong>对redux结构进行划分</strong></p><p>创建store/index.js文件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redux <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">&#x27;./reducer.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = redux.createStore(reducer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store;</span><br></pre></td></tr></table></figure><p>创建store/reducer.js文件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  ADD_NUMBER,</span><br><span class="line">  SUB_NUMBER</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./constants.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  counter: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state = initialState, action</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">switch</span>(<span class="params">action.type</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> ADD_NUMBER:</span><br><span class="line">      <span class="keyword">return</span> &#123;...state, <span class="attr">counter</span>: state.counter + action.num&#125;;</span><br><span class="line">    <span class="keyword">case</span> SUB_NUMBER:</span><br><span class="line">      <span class="keyword">return</span> &#123;...state, <span class="attr">counter</span>: state.counter - action.num&#125;;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> reducer;</span><br></pre></td></tr></table></figure><p>创建store/actionCreators.js文件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  ADD_NUMBER,</span><br><span class="line">  SUB_NUMBER</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./constants.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> addAction = <span class="function">(<span class="params">count</span>) =&gt;</span> (&#123;</span><br><span class="line">  type: ADD_NUMBER,</span><br><span class="line">  num: count</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> subAction = <span class="function">(<span class="params">count</span>) =&gt;</span> (&#123;</span><br><span class="line">  type: SUB_NUMBER,</span><br><span class="line">  num: count</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  addAction,</span><br><span class="line">  subAction</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建store/constants.js文件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ADD_NUMBER = <span class="string">&quot;ADD_NUMBER&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> SUB_NUMBER = <span class="string">&quot;SUB_NUMER&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  ADD_NUMBER,</span><br><span class="line">  SUB_NUMBER</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Redux流程图"><a href="#Redux流程图" class="headerlink" title="Redux流程图"></a>Redux流程图</h3><p>我们已经知道了redux的基本使用过程，那么我们就更加清晰来认识一下redux在实际开发中的流程：</p><ul><li>1.全局通常只有一个Store，存储我们的State；</li><li>2.Component中在某些情况会派发Action（这些Action是我们提前定义好的）；</li><li>3.Reducer会接收到这些Action，并且在Reducer中会返回一个新的State，作为Store的State；</li><li>4.State发生更新之后会触发通知，告知订阅者数据发生了改变；</li><li>5.订阅者拿到最新的数据（在props中），更新到jsx中，界面发生改变；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/15004" alt="图片"></p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列十四-React过渡动画</title>
      <link href="/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81%E5%9B%9B-React%E8%BF%87%E6%B8%A1%E5%8A%A8%E7%94%BB/"/>
      <url>/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81%E5%9B%9B-React%E8%BF%87%E6%B8%A1%E5%8A%A8%E7%94%BB/</url>
      
        <content type="html"><![CDATA[<blockquote><p>在开发中，我们想要给一个组件的显示和消失添加某种过渡动画，可以很好的增加用户体验。</p><p>当然，我们可以通过原生的CSS来实现这些过渡动画，但是React社区为我们提供了react-transition-group用来完成过渡动画。</p></blockquote><a id="more"></a><h2 id="react-transition-group介绍"><a href="#react-transition-group介绍" class="headerlink" title="react-transition-group介绍"></a>react-transition-group介绍</h2><p>React曾为开发者提供过动画插件 <code>react-addons-css-transition-group</code>，后由社区维护，形成了现在的 <code>react-transition-group</code>。</p><p>这个库可以帮助我们方便的实现组件的 <code>入场</code> 和 <code>离场</code> 动画，使用时需要进行额外的安装：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># npm</span><br><span class="line">npm install react-transition-group --save</span><br><span class="line"></span><br><span class="line"># yarn</span><br><span class="line">yarn add react-transition-group</span><br></pre></td></tr></table></figure><p>react-transition-group本身非常小，不会为我们应用程序增加过多的负担。</p><p>react-transition-group主要包含四个组件：</p><ul><li><p>Transition</p></li><li><ul><li>该组件是一个和平台无关的组件（不一定要结合CSS）；</li><li>在前端开发中，我们一般是结合CSS来完成样式，所以比较常用的是CSSTransition；</li></ul></li><li><p>CSSTransition</p></li><li><ul><li>在前端开发中，通常使用CSSTransition来完成过渡动画效果</li></ul></li><li><p>SwitchTransition</p></li><li><ul><li>两个组件显示和隐藏切换时，使用该组件</li></ul></li><li><p>TransitionGroup</p></li><li><ul><li>将多个动画组件包裹在其中，一般用于列表中元素的动画；</li></ul></li></ul><h2 id="react-transition-group使用"><a href="#react-transition-group使用" class="headerlink" title="react-transition-group使用"></a>react-transition-group使用</h2><h3 id="CSSTransition"><a href="#CSSTransition" class="headerlink" title="CSSTransition"></a>CSSTransition</h3><p>CSSTransition是基于Transition组件构建的：</p><ul><li><p>CSSTransition执行过程中，有三个状态：appear、enter、exit；</p></li><li><p>它们有三种状态，需要定义对应的CSS样式：</p></li><li><ul><li>第一类，开始状态：对于的类是-appear、-enter、exit；</li><li>第二类：执行动画：对应的类是-appear-active、-enter-active、-exit-active；</li><li>第三类：执行结束：对应的类是-appear-done、-enter-done、-exit-done；</li></ul></li></ul><p>CSSTransition常见对应的属性：</p><ul><li><p>in：触发进入或者退出状态</p></li><li><ul><li>如果添加了<code>unmountOnExit=&#123;true&#125;</code>，那么该组件会在执行退出动画结束后被移除掉；</li><li>当in为true时，触发进入状态，会添加-enter、-enter-acitve的class开始执行动画，当动画执行结束后，会移除两个class，并且添加-enter-done的class；</li><li>当in为false时，触发退出状态，会添加-exit、-exit-active的class开始执行动画，当动画执行结束后，会移除两个class，并且添加-enter-done的class；</li></ul></li><li><p>classNames：动画class的名称</p></li><li><ul><li>决定了在编写css时，对应的class名称：比如card-enter、card-enter-active、card-enter-done；</li></ul></li><li><p>timeout：</p></li><li><ul><li>过渡动画的时间</li></ul></li><li><p>appear：</p></li><li><ul><li>是否在初次进入添加动画（需要和in同时为true）</li></ul></li><li><p>其他属性可以参考官网来学习：</p></li><li><ul><li><a href="https://reactcommunity.org/react-transition-group/transition">https://reactcommunity.org/react-transition-group/transition</a></li></ul></li></ul><p>CSSTransition对应的钩子函数：主要为了检测动画的执行过程，来完成一些JavaScript的操作</p><ul><li>onEnter：在进入动画之前被触发；</li><li>onEntering：在应用进入动画时被触发；</li><li>onEntered：在应用进入动画结束后被触发；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./App.css&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; CSSTransition &#125; <span class="keyword">from</span> <span class="string">&#x27;react-transition-group&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Card, Avatar, Button &#125; <span class="keyword">from</span> <span class="string">&#x27;antd&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; EditOutlined, EllipsisOutlined, SettingOutlined &#125; <span class="keyword">from</span> <span class="string">&#x27;@ant-design/icons&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; Meta &#125; = Card;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      isShowCard: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Button type=<span class="string">&quot;primary&quot;</span> onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.setState(&#123;<span class="attr">isShowCard</span>: !<span class="built_in">this</span>.state.isShowCard&#125;)&#125;&gt;显示/隐藏&lt;/Button&gt;</span><br><span class="line">        &lt;CSSTransition <span class="keyword">in</span>=&#123;<span class="built_in">this</span>.state.isShowCard&#125;</span><br><span class="line">                       classNames=<span class="string">&quot;card&quot;</span></span><br><span class="line">                       timeout=&#123;<span class="number">1000</span>&#125;</span><br><span class="line">                       unmountOnExit=&#123;<span class="literal">true</span>&#125;</span><br><span class="line">                       onEnter=&#123;<span class="function"><span class="params">el</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&quot;进入动画前&quot;</span>)&#125;</span><br><span class="line">                       onEntering=&#123;<span class="function"><span class="params">el</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&quot;进入动画&quot;</span>)&#125;</span><br><span class="line">                       onEntered=&#123;<span class="function"><span class="params">el</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&quot;进入动画后&quot;</span>)&#125;</span><br><span class="line">                       onExit=&#123;<span class="function"><span class="params">el</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&quot;退出动画前&quot;</span>)&#125;</span><br><span class="line">                       onExiting=&#123;<span class="function"><span class="params">el</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&quot;退出动画&quot;</span>)&#125;</span><br><span class="line">                       onExited=&#123;<span class="function"><span class="params">el</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&quot;退出动画后&quot;</span>)&#125;</span><br><span class="line">                      &gt;</span><br><span class="line">          &lt;Card</span><br><span class="line">            style=&#123;&#123; <span class="attr">width</span>: <span class="number">300</span> &#125;&#125;</span><br><span class="line">            cover=&#123;</span><br><span class="line">              &lt;img</span><br><span class="line">                alt=<span class="string">&quot;example&quot;</span></span><br><span class="line">                src=<span class="string">&quot;https://gw.alipayobjects.com/zos/rmsportal/JiqGstEfoWAOHiTxclqi.png&quot;</span></span><br><span class="line">              /&gt;</span><br><span class="line">            &#125;</span><br><span class="line">            actions=&#123;[</span><br><span class="line">              &lt;SettingOutlined key=<span class="string">&quot;setting&quot;</span> /&gt;,</span><br><span class="line">              &lt;EditOutlined key=<span class="string">&quot;edit&quot;</span> /&gt;,</span><br><span class="line">              &lt;EllipsisOutlined key=<span class="string">&quot;ellipsis&quot;</span> /&gt;,</span><br><span class="line">            ]&#125;</span><br><span class="line">          &gt;</span><br><span class="line">            &lt;Meta</span><br><span class="line">              avatar=&#123;<span class="xml"><span class="tag">&lt;<span class="name">Avatar</span> <span class="attr">src</span>=<span class="string">&quot;https://zos.alipayobjects.com/rmsportal/ODTLcjxAfvqbxHnVXCYX.png&quot;</span> /&gt;</span></span>&#125;</span><br><span class="line">              title=<span class="string">&quot;Card title&quot;</span></span><br><span class="line">              description=<span class="string">&quot;This is the description&quot;</span></span><br><span class="line">            /&gt;</span><br><span class="line">          &lt;/Card&gt;</span><br><span class="line">        &lt;/CSSTransition&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的css样式如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.card-enter, .card-appear &#123;</span><br><span class="line">  opacity: <span class="number">0</span>;</span><br><span class="line">  transform: scale(<span class="number">.8</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.card-enter-active, .card-appear-active &#123;</span><br><span class="line">  opacity: <span class="number">1</span>;</span><br><span class="line">  transform: scale(<span class="number">1</span>);</span><br><span class="line">  transition: opacity <span class="number">300</span>ms, transform <span class="number">300</span>ms;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.card-exit &#123;</span><br><span class="line">  opacity: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.card-exit-active &#123;</span><br><span class="line">  opacity: <span class="number">0</span>;</span><br><span class="line">  transform: scale(<span class="number">.8</span>);</span><br><span class="line">  transition: opacity <span class="number">300</span>ms, transform <span class="number">300</span>ms;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="SwitchTransition"><a href="#SwitchTransition" class="headerlink" title="SwitchTransition"></a>SwitchTransition</h3><p>SwitchTransition可以完成两个组件之间切换的炫酷动画：</p><ul><li>比如我们有一个按钮需要在on和off之间切换，我们希望看到on先从左侧退出，off再从右侧进入；</li><li>这个动画在vue中被称之为 vue transition modes；</li><li>react-transition-group中使用SwitchTransition来实现该动画；</li></ul><p>SwitchTransition中主要有一个属性：mode，有两个值</p><ul><li>in-out：表示新组件先进入，旧组件再移除；</li><li>out-in：表示就组件先移除，新组建再进入；</li></ul><p>如何使用SwitchTransition呢？</p><ul><li>SwitchTransition组件里面要有CSSTransition或者Transition组件，不能直接包裹你想要切换的组件；</li><li>SwitchTransition里面的CSSTransition或Transition组件不再像以前那样接受in属性来判断元素是何种状态，取而代之的是key属性；</li></ul><p>我们来演练一个按钮的入场和出场效果：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; SwitchTransition, CSSTransition &#125; <span class="keyword">from</span> <span class="string">&quot;react-transition-group&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">SwitchAnimation</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      isOn: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;isOn&#125; = <span class="built_in">this</span>.state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;SwitchTransition mode=<span class="string">&quot;out-in&quot;</span>&gt;</span><br><span class="line">        &lt;CSSTransition classNames=<span class="string">&quot;btn&quot;</span></span><br><span class="line">                       timeout=&#123;<span class="number">500</span>&#125;</span><br><span class="line">                       key=&#123;isOn ? <span class="string">&quot;on&quot;</span> : <span class="string">&quot;off&quot;</span>&#125;&gt;</span><br><span class="line">          &#123;</span><br><span class="line">          &lt;button onClick=&#123;<span class="built_in">this</span>.btnClick.bind(<span class="built_in">this</span>)&#125;&gt;</span><br><span class="line">            &#123;isOn ? <span class="string">&quot;on&quot;</span>: <span class="string">&quot;off&quot;</span>&#125;</span><br><span class="line">          &lt;/button&gt;</span><br><span class="line">        &#125;</span><br><span class="line">        &lt;/CSSTransition&gt;</span><br><span class="line">      &lt;/SwitchTransition&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">btnClick</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;<span class="attr">isOn</span>: !<span class="built_in">this</span>.state.isOn&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的css代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.btn-enter &#123;</span><br><span class="line">  transform: translate(<span class="number">100</span>%, <span class="number">0</span>);</span><br><span class="line">  opacity: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.btn-enter-active &#123;</span><br><span class="line">  transform: translate(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  opacity: <span class="number">1</span>;</span><br><span class="line">  transition: all <span class="number">500</span>ms;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.btn-exit &#123;</span><br><span class="line">  transform: translate(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  opacity: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.btn-exit-active &#123;</span><br><span class="line">  transform: translate(-<span class="number">100</span>%, <span class="number">0</span>);</span><br><span class="line">  opacity: <span class="number">0</span>;</span><br><span class="line">  transition: all <span class="number">500</span>ms;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TransitionGroup"><a href="#TransitionGroup" class="headerlink" title="TransitionGroup"></a>TransitionGroup</h3><p>当我们有一组动画时，需要将这些CSSTransition放入到一个TransitionGroup中来完成动画：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; CSSTransition, TransitionGroup &#125; <span class="keyword">from</span> <span class="string">&#x27;react-transition-group&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupAnimation</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      friends: []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;TransitionGroup&gt;</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">this</span>.state.friends.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">return</span> (</span><br><span class="line">                &lt;CSSTransition classNames=<span class="string">&quot;friend&quot;</span> timeout=&#123;<span class="number">300</span>&#125; key=&#123;index&#125;&gt;</span><br><span class="line">                  &lt;div&gt;&#123;item&#125;&lt;/div&gt;</span><br><span class="line">                &lt;/CSSTransition&gt;</span><br><span class="line">              )</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &lt;/TransitionGroup&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.addFriend()&#125;&gt;+friend&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">addFriend</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      friends: [...this.state.friends, <span class="string">&quot;coderwhy&quot;</span>]</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列十三-axios库的使用</title>
      <link href="/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81%E4%B8%89-axios%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
      <url>/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81%E4%B8%89-axios%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="axios库的基本使用"><a href="#axios库的基本使用" class="headerlink" title="axios库的基本使用"></a>axios库的基本使用</h2><h3 id="网络请求的选择"><a href="#网络请求的选择" class="headerlink" title="网络请求的选择"></a>网络请求的选择</h3><p>目前前端中发送网络请求的方式有很多种：</p><p>选择一:传统的Ajax是基于XMLHttpReques(XHR)</p><ul><li><p>为什么不用它呢?</p></li><li><ul><li>非常好解释, 配置和调用方式等非常混乱.</li><li>编码起来看起来就非常蛋疼.</li><li>所以真实开发中很少直接使用, 而是使用jQuery-Ajax</li></ul></li></ul><p>选择二: 在前面的学习中, 我们经常会使用jQuery-Ajax</p><ul><li><p>相对于传统的Ajax非常好用.</p></li><li><p>为什么不选择它呢？</p></li><li><ul><li>jQuery整个项目太大，单纯使用ajax却要引入整个JQuery非常的不合理（采取个性化打包的方案又不能享受CDN服务）；</li><li>基于原生的XHR开发，XHR本身的架构不清晰，已经有了fetch的替代方案；</li><li>尽管JQuery对我们前端的开发工作曾有着深远的影响，但是的确正在退出历史舞台；</li></ul></li></ul><p>选择三: Fetch API</p><a id="more"></a><ul><li><p>选择或者不选择它?</p></li><li><ul><li>Fetch是AJAX的替换方案，基于Promise设计，很好的进行了关注分离，有很大一批人喜欢使用fetch进行项目开发；</li><li>但是Fetch的缺点也很明显，首先需要明确的是Fetch是一个 low-level（底层）的API，没有帮助你封装好各种各样的功能和实现；</li><li>比如发送网络请求需要自己来配置Header的Content-Type，不会默认携带cookie等；</li><li>比如错误处理相对麻烦（只有网络错误才会reject，HTTP状态码404或者500不会被标记为reject）；</li><li>比如不支持取消一个请求，不能查看一个请求的进度等等；</li><li>MDN Fetch学习地址：<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API/Using_Fetch">https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API/Using_Fetch</a></li></ul></li></ul><p>选择四：axios</p><ul><li><p>axios: ajax i/o system.</p></li><li><p>axios是目前前端使用非常广泛的网络请求库，包括Vue作者也是推荐在vue中使用axios；</p></li><li><p>主要特点包括：</p></li><li><ul><li>在浏览器中发送 XMLHttpRequests 请求；</li><li>在 node.js 中发送 http请求；</li><li>支持 Promise API；</li><li>拦截请求和响应；</li><li>转换请求和响应数据；</li><li>等等；</li></ul></li></ul><h3 id="axios的基本使用"><a href="#axios的基本使用" class="headerlink" title="axios的基本使用"></a>axios的基本使用</h3><p>支持多种请求方式:</p><ul><li>paxios(config)</li><li>axios.request(config)</li><li>axios.get(url[, config])</li><li>axios.delete(url[, config])</li><li>axios.head(url[, config])</li><li>axios.post(url[, data[, config]])</li><li>axios.put(url[, data[, config]])</li><li>axios.patch(url[, data[, config]])</li></ul><p><strong>注意：下面的测试我都会使用httpbin.org这个网站来测试，是我个人非常喜欢的一个网站；</strong></p><p>我们来发送一个get请求：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.发送一个get请求</span></span><br><span class="line">axios(&#123;</span><br><span class="line">  method: <span class="string">&quot;get&quot;</span>,</span><br><span class="line">  url: <span class="string">&quot;https:httpbin.org/get&quot;</span>,</span><br><span class="line">  params: &#123;</span><br><span class="line">    name: <span class="string">&quot;coderwhy&quot;</span>,</span><br><span class="line">    age: <span class="number">18</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;请求结果:&quot;</span>, res);</span><br><span class="line">&#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;错误信息:&quot;</span>, err);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>你也可以直接发送get，那么就不需要传入method（当然不传入默认也是get请求）</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">axios.get(<span class="string">&quot;https://httpbin.org/get&quot;</span>, &#123;</span><br><span class="line">  params: &#123;</span><br><span class="line">    name: <span class="string">&quot;kobe&quot;</span>,</span><br><span class="line">    age: <span class="number">40</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;请求结果:&quot;</span>, res);</span><br><span class="line">&#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;错误信息:&quot;</span>, err);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>当然，你也可以使用await、async在componentDidMount中发送网络请求：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> axios.get(<span class="string">&quot;https://httpbin.org/get&quot;</span>, &#123;</span><br><span class="line">    params: &#123;</span><br><span class="line">      name: <span class="string">&quot;kobe&quot;</span>,</span><br><span class="line">      age: <span class="number">40</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么，有错误的时候，await中如何处理呢？使用try-catch来处理错误信息</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> axios.get(<span class="string">&quot;https://httpbin.org/get&quot;</span>, &#123;</span><br><span class="line">      params: &#123;</span><br><span class="line">        name: <span class="string">&quot;kobe&quot;</span>,</span><br><span class="line">        age: <span class="number">40</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">  &#125; <span class="function"><span class="title">catch</span>(<span class="params">err</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发送多个并发的请求：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> request1 = axios.get(<span class="string">&quot;https://httpbin.org/get&quot;</span>, &#123;</span><br><span class="line">  params: &#123;<span class="attr">name</span>: <span class="string">&quot;why&quot;</span>, <span class="attr">age</span>: <span class="number">18</span>&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> request2 = axios.post(<span class="string">&quot;https://httpbin.org/post&quot;</span>, &#123;</span><br><span class="line">  name: <span class="string">&quot;kobe&quot;</span>,</span><br><span class="line">  age: <span class="number">40</span></span><br><span class="line">&#125;)</span><br><span class="line">axios.all([request1, request2]).then(<span class="function">(<span class="params">[res1, res2]</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(res1, res2);</span><br><span class="line">&#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>选读：axios(config)和axios.get()或axios.post有上什么区别呢？</strong></p><p>查看源码就会发现，<code>axios.get()或axios.post</code>本质上最终都是在调用axios的request</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/13001" alt="图片">在Axios的原型上添加各种请求方法</p><p>本质上都是request请求：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/13002" alt="图片">本质都是request请求</p><h3 id="axios的配置信息"><a href="#axios的配置信息" class="headerlink" title="axios的配置信息"></a>axios的配置信息</h3><h4 id="请求配置选项"><a href="#请求配置选项" class="headerlink" title="请求配置选项"></a>请求配置选项</h4><p>下面是创建请求时可以用的配置选项：</p><ul><li>只有URL是必传的；</li><li>如果没有指定method，请求将默认使用<code>get</code>请求；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="comment">// `url` 是用于请求的服务器 URL</span></span><br><span class="line">  url: <span class="string">&#x27;/user&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `method` 是创建请求时使用的方法</span></span><br><span class="line">  method: <span class="string">&#x27;get&#x27;</span>, <span class="comment">// default</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// `baseURL` 将自动加在 `url` 前面，除非 `url` 是一个绝对 URL。</span></span><br><span class="line">  <span class="comment">// 它可以通过设置一个 `baseURL` 便于为 axios 实例的方法传递相对 URL</span></span><br><span class="line">  baseURL: <span class="string">&#x27;https://some-domain.com/api/&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `transformRequest` 允许在向服务器发送前，修改请求数据</span></span><br><span class="line">  <span class="comment">// 只能用在 &#x27;PUT&#x27;, &#x27;POST&#x27; 和 &#x27;PATCH&#x27; 这几个请求方法</span></span><br><span class="line">  <span class="comment">// 后面数组中的函数必须返回一个字符串，或 ArrayBuffer，或 Stream</span></span><br><span class="line">  transformRequest: [<span class="function"><span class="keyword">function</span> (<span class="params">data, headers</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 对 data 进行任意转换处理</span></span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">  &#125;],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `transformResponse` 在传递给 then/catch 前，允许修改响应数据</span></span><br><span class="line">  transformResponse: [<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 对 data 进行任意转换处理</span></span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">  &#125;],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `headers` 是即将被发送的自定义请求头</span></span><br><span class="line">  headers: &#123;<span class="string">&#x27;X-Requested-With&#x27;</span>: <span class="string">&#x27;XMLHttpRequest&#x27;</span>&#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `params` 是即将与请求一起发送的 URL 参数</span></span><br><span class="line">  <span class="comment">// 必须是一个无格式对象(plain object)或 URLSearchParams 对象</span></span><br><span class="line">  params: &#123;</span><br><span class="line">    ID: <span class="number">12345</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">   <span class="comment">// `paramsSerializer` 是一个负责 `params` 序列化的函数</span></span><br><span class="line">  <span class="comment">// (e.g. https://www.npmjs.com/package/qs, http://api.jquery.com/jquery.param/)</span></span><br><span class="line">  paramsSerializer: <span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Qs.stringify(params, &#123;<span class="attr">arrayFormat</span>: <span class="string">&#x27;brackets&#x27;</span>&#125;)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `data` 是作为请求主体被发送的数据</span></span><br><span class="line">  <span class="comment">// 只适用于这些请求方法 &#x27;PUT&#x27;, &#x27;POST&#x27;, 和 &#x27;PATCH&#x27;</span></span><br><span class="line">  <span class="comment">// 在没有设置 `transformRequest` 时，必须是以下类型之一：</span></span><br><span class="line">  <span class="comment">// - string, plain object, ArrayBuffer, ArrayBufferView, URLSearchParams</span></span><br><span class="line">  <span class="comment">// - 浏览器专属：FormData, File, Blob</span></span><br><span class="line">  <span class="comment">// - Node 专属：Stream</span></span><br><span class="line">  data: &#123;</span><br><span class="line">    firstName: <span class="string">&#x27;Fred&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `timeout` 指定请求超时的毫秒数(0 表示无超时时间)</span></span><br><span class="line">  <span class="comment">// 如果请求话费了超过 `timeout` 的时间，请求将被中断</span></span><br><span class="line">  timeout: <span class="number">1000</span>,</span><br><span class="line"></span><br><span class="line">   <span class="comment">// `withCredentials` 表示跨域请求时是否需要使用凭证</span></span><br><span class="line">  withCredentials: <span class="literal">false</span>, <span class="comment">// default</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// `adapter` 允许自定义处理请求，以使测试更轻松</span></span><br><span class="line">  <span class="comment">// 返回一个 promise 并应用一个有效的响应 (查阅 [response docs](#response-api)).</span></span><br><span class="line">  adapter: <span class="function"><span class="keyword">function</span> (<span class="params">config</span>) </span>&#123;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line"> <span class="comment">// `auth` 表示应该使用 HTTP 基础验证，并提供凭据</span></span><br><span class="line">  <span class="comment">// 这将设置一个 `Authorization` 头，覆写掉现有的任意使用 `headers` 设置的自定义 `Authorization`头</span></span><br><span class="line">  auth: &#123;</span><br><span class="line">    username: <span class="string">&#x27;janedoe&#x27;</span>,</span><br><span class="line">    password: <span class="string">&#x27;s00pers3cret&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">   <span class="comment">// `responseType` 表示服务器响应的数据类型，可以是 &#x27;arraybuffer&#x27;, &#x27;blob&#x27;, &#x27;document&#x27;, &#x27;json&#x27;, &#x27;text&#x27;, &#x27;stream&#x27;</span></span><br><span class="line">  responseType: <span class="string">&#x27;json&#x27;</span>, <span class="comment">// default</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// `responseEncoding` indicates encoding to use for decoding responses</span></span><br><span class="line">  <span class="comment">// Note: Ignored for `responseType` of &#x27;stream&#x27; or client-side requests</span></span><br><span class="line">  responseEncoding: <span class="string">&#x27;utf8&#x27;</span>, <span class="comment">// default</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// `xsrfCookieName` 是用作 xsrf token 的值的cookie的名称</span></span><br><span class="line">  xsrfCookieName: <span class="string">&#x27;XSRF-TOKEN&#x27;</span>, <span class="comment">// default</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// `xsrfHeaderName` is the name of the http header that carries the xsrf token value</span></span><br><span class="line">  xsrfHeaderName: <span class="string">&#x27;X-XSRF-TOKEN&#x27;</span>, <span class="comment">// default</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// `onUploadProgress` 允许为上传处理进度事件</span></span><br><span class="line">  onUploadProgress: <span class="function"><span class="keyword">function</span> (<span class="params">progressEvent</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Do whatever you want with the native progress event</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `onDownloadProgress` 允许为下载处理进度事件</span></span><br><span class="line">  onDownloadProgress: <span class="function"><span class="keyword">function</span> (<span class="params">progressEvent</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 对原生进度事件的处理</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">   <span class="comment">// `maxContentLength` 定义允许的响应内容的最大尺寸</span></span><br><span class="line">  maxContentLength: <span class="number">2000</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `validateStatus` 定义对于给定的HTTP 响应状态码是 resolve 或 reject  promise 。如果 `validateStatus` 返回 `true` (或者设置为 `null` 或 `undefined`)，promise 将被 resolve; 否则，promise 将被 rejecte</span></span><br><span class="line">  validateStatus: <span class="function"><span class="keyword">function</span> (<span class="params">status</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> status &gt;= <span class="number">200</span> &amp;&amp; status &lt; <span class="number">300</span>; <span class="comment">// default</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `maxRedirects` 定义在 node.js 中 follow 的最大重定向数目</span></span><br><span class="line">  <span class="comment">// 如果设置为0，将不会 follow 任何重定向</span></span><br><span class="line">  maxRedirects: <span class="number">5</span>, <span class="comment">// default</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// `socketPath` defines a UNIX Socket to be used in node.js.</span></span><br><span class="line">  <span class="comment">// e.g. &#x27;/var/run/docker.sock&#x27; to send requests to the docker daemon.</span></span><br><span class="line">  <span class="comment">// Only either `socketPath` or `proxy` can be specified.</span></span><br><span class="line">  <span class="comment">// If both are specified, `socketPath` is used.</span></span><br><span class="line">  socketPath: <span class="literal">null</span>, <span class="comment">// default</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// `httpAgent` 和 `httpsAgent` 分别在 node.js 中用于定义在执行 http 和 https 时使用的自定义代理。允许像这样配置选项：</span></span><br><span class="line">  <span class="comment">// `keepAlive` 默认没有启用</span></span><br><span class="line">  httpAgent: <span class="keyword">new</span> http.Agent(&#123; <span class="attr">keepAlive</span>: <span class="literal">true</span> &#125;),</span><br><span class="line">  httpsAgent: <span class="keyword">new</span> https.Agent(&#123; <span class="attr">keepAlive</span>: <span class="literal">true</span> &#125;),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// &#x27;proxy&#x27; 定义代理服务器的主机名称和端口</span></span><br><span class="line">  <span class="comment">// `auth` 表示 HTTP 基础验证应当用于连接代理，并提供凭据</span></span><br><span class="line">  <span class="comment">// 这将会设置一个 `Proxy-Authorization` 头，覆写掉已有的通过使用 `header` 设置的自定义 `Proxy-Authorization` 头。</span></span><br><span class="line">  proxy: &#123;</span><br><span class="line">    host: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">    port: <span class="number">9000</span>,</span><br><span class="line">    auth: &#123;</span><br><span class="line">      username: <span class="string">&#x27;mikeymike&#x27;</span>,</span><br><span class="line">      password: <span class="string">&#x27;rapunz3l&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `cancelToken` 指定用于取消请求的 cancel token</span></span><br><span class="line">  <span class="comment">// （查看后面的 Cancellation 这节了解更多）</span></span><br><span class="line">  cancelToken: <span class="keyword">new</span> CancelToken(<span class="function"><span class="keyword">function</span> (<span class="params">cancel</span>) </span>&#123;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="响应结构信息"><a href="#响应结构信息" class="headerlink" title="响应结构信息"></a>响应结构信息</h4><p>某个请求的响应包含以下信息：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// `data` 由服务器提供的响应</span></span><br><span class="line">  data: &#123;&#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `status` 来自服务器响应的 HTTP 状态码</span></span><br><span class="line">  status: <span class="number">200</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `statusText` 来自服务器响应的 HTTP 状态信息</span></span><br><span class="line">  statusText: <span class="string">&#x27;OK&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `headers` 服务器响应的头</span></span><br><span class="line">  headers: &#123;&#125;,</span><br><span class="line"></span><br><span class="line">   <span class="comment">// `config` 是为请求提供的配置信息</span></span><br><span class="line">  config: &#123;&#125;,</span><br><span class="line"> <span class="comment">// &#x27;request&#x27;</span></span><br><span class="line">  <span class="comment">// `request` is the request that generated this response</span></span><br><span class="line">  <span class="comment">// It is the last ClientRequest instance in node.js (in redirects)</span></span><br><span class="line">  <span class="comment">// and an XMLHttpRequest instance the browser</span></span><br><span class="line">  request: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="默认配置信息"><a href="#默认配置信息" class="headerlink" title="默认配置信息"></a>默认配置信息</h4><p>你可以指定将被用在各个请求的配置默认值：</p><p><strong>全局的axios默认配置：</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">axios.defaults.baseURL = <span class="string">&#x27;https://api.example.com&#x27;</span>;</span><br><span class="line">axios.defaults.headers.common[<span class="string">&#x27;Authorization&#x27;</span>] = AUTH_TOKEN;</span><br><span class="line">axios.defaults.headers.post[<span class="string">&#x27;Content-Type&#x27;</span>] = <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>;</span><br></pre></td></tr></table></figure><p><strong>自定义实例默认配置：</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> instance = axios.create(&#123;</span><br><span class="line">  baseURL: <span class="string">&#x27;https://api.example.com&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Alter defaults after instance has been created</span></span><br><span class="line">instance.defaults.headers.common[<span class="string">&#x27;Authorization&#x27;</span>] = AUTH_TOKEN;</span><br></pre></td></tr></table></figure><p>配置信息的查找顺序如下：</p><ul><li>优先是请求的config参数配置；</li><li>其次是实例的default中的配置；</li><li>最后是创建实例时的配置；</li></ul><h3 id="axios的拦截器"><a href="#axios的拦截器" class="headerlink" title="axios的拦截器"></a>axios的拦截器</h3><p>axios库有一个非常好用的特性是可以添加拦截器：</p><ul><li><p>请求拦截器：在发送请求时，请求被拦截；</p></li><li><ul><li>发送网络请求时，在页面中添加一个loading组件作为动画；</li><li>某些网络请求要求用户必须登录，可以在请求中判断是否携带了token，没有携带token直接跳转到login页面；</li><li>对某些请求参数进行序列化；</li></ul></li><li><p>响应拦截器：在响应结果中，结果被拦截；</p></li><li><ul><li>响应拦截中可以对结果进行二次处理（比如服务器真正返回的数据其实是在response的data中）；</li><li>对于错误信息进行判断，根据不同的状态进行不同的处理；</li></ul></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">axios.interceptors.request.use(<span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 1.发送网络请求时，在页面中添加一个loading组件作为动画；</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2.某些网络请求要求用户必须登录，可以在请求中判断是否携带了token，没有携带token直接跳转到login页面；</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3.对某些请求参数进行序列化；</span></span><br><span class="line">  <span class="keyword">return</span> config;</span><br><span class="line">&#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> err;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">axios.interceptors.response.use(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> response.data;</span><br><span class="line">&#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (err &amp;&amp; err.response) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (err.response.status) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">400</span>:</span><br><span class="line">        err.message = <span class="string">&quot;请求错误&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">401</span>:</span><br><span class="line">        err.message = <span class="string">&quot;未授权访问&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> err;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="axios库的二次封装"><a href="#axios库的二次封装" class="headerlink" title="axios库的二次封装"></a>axios库的二次封装</h2><h3 id="为什么要封装"><a href="#为什么要封装" class="headerlink" title="为什么要封装"></a>为什么要封装</h3><p>为什么我们要对axios进行二次封装呢？</p><ul><li>默认情况下我们是可以直接使用axios来进行开发的；</li><li>但是我们考虑一个问题，假如有100多处中都直接依赖axios，突然间有一天axios出现了重大bug，并且该库已经不再维护，这个时候你如何处理呢？</li><li>大多数情况下我们会寻找一个新的网络请求库或者自己进行二次封装；</li><li>但是有100多处都依赖了axios，方便我们进行修改吗？我们所有依赖axios库的地方都需要进行修改；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/13003" alt="图片">直接依赖axios</p><p>如果是自己进行了二次封装，并且暴露一套自己的API：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/13004" alt="图片">自己进行二次封装</p><h3 id="axios二次封装"><a href="#axios二次封装" class="headerlink" title="axios二次封装"></a>axios二次封装</h3><p>创建一个service文件夹（其他名字都可以），用于存放所有的网络请求相关的内容。</p><p>创建文件config.js，用于存放一些配置信息：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export const TIMEOUT &#x3D; 5000;</span><br><span class="line"></span><br><span class="line">const devBaseURL &#x3D; &quot;https:&#x2F;&#x2F;httpbin.org&quot;;</span><br><span class="line">const proBaseURL &#x3D; &quot;https:&#x2F;&#x2F;production.org&quot;;</span><br><span class="line">console.log(process.env.NODE_ENV);</span><br><span class="line">export const baseURL &#x3D; process.env.NODE_ENV &#x3D;&#x3D;&#x3D; &#39;development&#39; ? devBaseURL: proBaseURL;</span><br></pre></td></tr></table></figure><p>创建request.js，用于封装请求对象：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  TIMEOUT,</span><br><span class="line">  baseURL</span><br><span class="line"> &#125; <span class="keyword">from</span> <span class="string">&quot;./config&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> instance = axios.create(&#123;</span><br><span class="line">  timeout: TIMEOUT,</span><br><span class="line">  baseURL: baseURL</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">axios.interceptors.request.use(<span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 1.发送网络请求时，在页面中添加一个loading组件作为动画；</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2.某些网络请求要求用户必须登录，可以在请求中判断是否携带了token，没有携带token直接跳转到login页面；</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3.对某些请求参数进行序列化；</span></span><br><span class="line">  <span class="keyword">return</span> config;</span><br><span class="line">&#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> err;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">instance.interceptors.response.use(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> response.data;</span><br><span class="line">&#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (err &amp;&amp; err.response) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (err.response.status) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">400</span>:</span><br><span class="line">        err.message = <span class="string">&quot;请求错误&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">401</span>:</span><br><span class="line">        err.message = <span class="string">&quot;未授权访问&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> err;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> instance;</span><br></pre></td></tr></table></figure><p>使用测试：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">request(&#123;</span><br><span class="line">  url: <span class="string">&quot;/get&quot;</span>,</span><br><span class="line">  params: &#123;</span><br><span class="line">    name: <span class="string">&quot;why&quot;</span>,</span><br><span class="line">    age: <span class="number">18</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;).then(<span class="built_in">console</span>.log).catch(<span class="built_in">console</span>.error);</span><br><span class="line"></span><br><span class="line">request(&#123;</span><br><span class="line">  url: <span class="string">&quot;/post&quot;</span>,</span><br><span class="line">  method: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">  data: &#123;</span><br><span class="line">    name: <span class="string">&quot;kobe&quot;</span>,</span><br><span class="line">    age: <span class="number">40</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;).then(<span class="built_in">console</span>.log).catch(<span class="built_in">console</span>.error);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列十二-AntDesign UI库</title>
      <link href="/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81%E4%BA%8C-AntDesign-UI%E5%BA%93/"/>
      <url>/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81%E4%BA%8C-AntDesign-UI%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<blockquote><p>对于学习过程，不是特别建议从一开始就使用别人的第三方库UI库，更重要的是要学会组件化相关的知识（就想前面我们已经讲了非常相关知识），之后自己来封装、设计一套自己的可复用组件。</p><p>但是在公司开发为了开发效率，我们往往也会选择一些非常优秀的第三方UI库，而AntDesign就是这样的一套优秀的UI组件库。</p></blockquote><a id="more"></a><h2 id="认识AntDesign"><a href="#认识AntDesign" class="headerlink" title="认识AntDesign"></a>认识AntDesign</h2><h3 id="AntDesign的介绍"><a href="#AntDesign的介绍" class="headerlink" title="AntDesign的介绍"></a>AntDesign的介绍</h3><p><code>AntDesign</code> ，简称 <code>antd</code> 是基于 Ant Design 设计体系的 React UI 组件库，主要用于研发企业级中后台产品。</p><p>AntDesign的特点：</p><ul><li>🌈 提炼自企业级中后台产品的交互语言和视觉风格。</li><li>📦 开箱即用的高质量 React 组件。</li><li>🛡 使用 TypeScript 开发，提供完整的类型定义文件。</li><li>⚙️ 全链路开发和设计工具体系。</li><li>🌍 数十个国际化语言支持。</li><li>🎨 深入每个细节的主题定制能力。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">全链路开发和设计指的是什么？</span><br></pre></td></tr></table></figure><ul><li>全链路这个词我记得是16年左右阿里提出的；</li><li>从<code>业务战略—用户场景—设计目标—交互体验—用户流程—预期效率</code>全方面进行分析和考虑；</li><li>这个主要是产品经理会考虑的一个点；</li></ul><p>AntDesign的兼容性：</p><ul><li>现代浏览器和 IE11（需要 polyfills）。</li><li>支持服务端渲染。</li><li>Electron</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/12001" alt="图片">浏览器兼容</p><p><code>antd@2.0</code> 之后不再支持 IE8，<code>antd@4.0</code> 之后不再支持 IE9/10。</p><p>目前稳定的版本：v4.4.0</p><h3 id="AntDesign的安装"><a href="#AntDesign的安装" class="headerlink" title="AntDesign的安装"></a>AntDesign的安装</h3><p><strong>使用 npm 或 yarn 安装</strong></p><p>npm安装：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install antd --save</span><br></pre></td></tr></table></figure><p>yarn安装：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add antd</span><br></pre></td></tr></table></figure><p>我们需要在index.js中引入全局的Antd样式：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;antd/dist/antd.css&quot;</span>;</span><br></pre></td></tr></table></figure><p>在App.js中就可以使用一些组件了：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/12002" alt="图片">antd的使用</p><p><strong>考虑一个问题：Antd是否会将一些没有用的代码（组件或者逻辑代码）引入，造成包很大呢？</strong></p><p><code>antd</code> 官网有提到：<code>antd</code> 的 JS 代码默认支持基于 ES modules 的 tree shaking，对于 js 部分，直接引入 <code>import &#123; Button &#125; from &#39;antd&#39;</code> 就会有按需加载的效果。</p><h3 id="高级配置"><a href="#高级配置" class="headerlink" title="高级配置"></a>高级配置</h3><h4 id="认识craco"><a href="#认识craco" class="headerlink" title="认识craco"></a>认识craco</h4><p>上面的使用过程是无法对主题进行配置的，好像对主题等相关的高级特性进行配置，需要修改create-react-app 的默认配置。</p><p>如何修改create-react-app 的默认配置呢？</p><ul><li>前面我们讲过，可以通过<code>yarn run eject</code>来暴露出来对应的配置信息进行修改；</li><li>但是对于webpack并不熟悉的人来说，直接修改 CRA 的配置是否会给你的项目带来负担，甚至会增加项目的隐患和不稳定性呢？</li><li>所以，在项目开发中是不建议大家直接去修改 CRA 的配置信息的；</li></ul><p>那么如何来进行修改默认配置呢？社区目前有两个比较常见的方案：</p><ul><li>react-app-rewired + customize-cra；（这个是antd早期推荐的方案）</li><li>craco；（目前antd推荐的方案）</li></ul><p>第一步：安装craco：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add @craco/craco</span><br></pre></td></tr></table></figure><p>第二步：修改package.json文件</p><ul><li>原本启动时，我们是通过react-scripts来管理的；</li><li>现在启动时，我们通过craco来管理；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">-   <span class="string">&quot;start&quot;</span>: <span class="string">&quot;react-scripts start&quot;</span>,</span><br><span class="line">-   <span class="string">&quot;build&quot;</span>: <span class="string">&quot;react-scripts build&quot;</span>,</span><br><span class="line">-   <span class="string">&quot;test&quot;</span>: <span class="string">&quot;react-scripts test&quot;</span>,</span><br><span class="line">+   <span class="string">&quot;start&quot;</span>: <span class="string">&quot;craco start&quot;</span>,</span><br><span class="line">+   <span class="string">&quot;build&quot;</span>: <span class="string">&quot;craco build&quot;</span>,</span><br><span class="line">+   <span class="string">&quot;test&quot;</span>: <span class="string">&quot;craco test&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第三步：在根目录下创建craco.config.js文件用于修改默认配置</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 配置文件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="配置主题"><a href="#配置主题" class="headerlink" title="配置主题"></a>配置主题</h4><p>按照 配置主题 的要求，自定义主题需要用到类似 less-loader 提供的 less 变量覆盖功能：</p><ul><li>我们可以引入 craco-less 来帮助加载 less 样式和修改变量；</li></ul><p>安装 <code>craco-less</code>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add craco-less</span><br></pre></td></tr></table></figure><p>修改craco.config.js中的plugins：</p><ul><li>使用<code>modifyVars</code>可以在运行时修改LESS变量；</li><li></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">const CracoLessPlugin &#x3D; require(&#39;craco-less&#39;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    &#123;</span><br><span class="line">      plugin: CracoLessPlugin,</span><br><span class="line">      options: &#123;</span><br><span class="line">        lessLoaderOptions: &#123;</span><br><span class="line">          lessOptions: &#123;</span><br><span class="line">            modifyVars: &#123; &#39;@primary-color&#39;: &#39;#1DA57A&#39; &#125;,</span><br><span class="line">            javascriptEnabled: true,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>引入antd的样式时，引入antd.less文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; import &quot;antd&#x2F;dist&#x2F;antd.css&quot;;</span><br><span class="line">import &#39;antd&#x2F;dist&#x2F;antd.less&#39;;</span><br></pre></td></tr></table></figure><p>修改后重启 <code>yarn start</code>，如果看到一个绿色的按钮就说明配置成功了。</p><h4 id="配置别名"><a href="#配置别名" class="headerlink" title="配置别名"></a>配置别名</h4><p>在项目开发中，某些组件或者文件的层级会较深，</p><ul><li>如果我们通过上层目录去引入就会出现这样的情况：<code>../../../../components/button</code>；</li><li>如果我们可以配置别名，就可以直接从根目录下面开始查找文件：<code>@/components/button</code>，甚至是：<code>components/button</code>；</li></ul><p>配置别名也需要修改webpack的配置，当然我们也可以借助于 craco 来完成：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">const path &#x3D; require(&quot;path&quot;);</span><br><span class="line">const resolve &#x3D; dir &#x3D;&gt; path.resolve(__dirname, dir);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  ...</span><br><span class="line">  ,</span><br><span class="line">  webpack: &#123;</span><br><span class="line">    alias: &#123;</span><br><span class="line">      &#39;@&#39;: resolve(&quot;src&quot;),</span><br><span class="line">      &#39;components&#39;: resolve(&quot;src&#x2F;components&quot;),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在导入时就可以按照下面的方式来使用了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import HYCommentInput from &#39;@&#x2F;components&#x2F;comment-input&#39;;</span><br><span class="line">import HYCommentItem from &#39;components&#x2F;comment-item&#39;;</span><br></pre></td></tr></table></figure><h2 id="AntDesign案例"><a href="#AntDesign案例" class="headerlink" title="AntDesign案例"></a>AntDesign案例</h2><p>我们通过AntDesign来编写一个案例：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/12003" alt="图片">image-</p><h3 id="案例-评论框"><a href="#案例-评论框" class="headerlink" title="案例-评论框"></a>案例-评论框</h3><p>我们选来完成评论框，评论框有两部分组成：</p><ul><li>TextArea的输入框：Input.TextArea；</li><li>提交评论的按钮：Button；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> moment <span class="keyword">from</span> <span class="string">&#x27;moment&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Form, Button, Input</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;antd&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">HYCommentInput</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      value: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Input.TextArea rows=&#123;<span class="number">4</span>&#125; onChange=&#123;<span class="built_in">this</span>.onChange.bind(<span class="built_in">this</span>)&#125; value=&#123;<span class="built_in">this</span>.state.value&#125; /&gt;</span><br><span class="line">        &lt;Button onClick=&#123;<span class="built_in">this</span>.onSubmit.bind(<span class="built_in">this</span>)&#125; type=<span class="string">&quot;primary&quot;</span>&gt;</span><br><span class="line">          添加评论</span><br><span class="line">        &lt;/Button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">onChange</span>(<span class="params">e</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      value: e.target.value</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">onSubmit</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.state.value, moment().fromNow());</span><br><span class="line">    <span class="keyword">const</span> commentInfo = &#123;</span><br><span class="line">      id: <span class="built_in">Date</span>.now(),</span><br><span class="line">      name: <span class="string">&quot;coderwhy&quot;</span>,</span><br><span class="line">      avatar: <span class="string">&quot;https://upload.jianshu.io/users/upload_avatars/1102036/c3628b478f06.jpeg?imageMogr2/auto-orient/strip|imageView2/1/w/240/h/240&quot;</span>,</span><br><span class="line">      content: <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;this.state.value&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>,</span><br><span class="line">      datetime: moment()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.props.submitComment(commentInfo);</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      value: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="案例-评论列表"><a href="#案例-评论列表" class="headerlink" title="案例-评论列表"></a>案例-评论列表</h3><p>评论列表主要是使用Comment组件，Comment组件有一些属性：</p><ul><li><p>author：展示作者的名称；</p></li><li><p>avatar：展示作者的头像；</p></li><li><ul><li>可以使用Avatar的组件进行展示；</li></ul></li><li><p>content：展示评论的内容；</p></li><li><p>datetime：展示评论的时间：</p></li><li><ul><li>这里我们可以使用Tooltip组件，当鼠标放在上面时，会显示对应的title内容；</li></ul></li><li><p>actions：评论下方的操作按钮；</p></li><li><ul><li>这里我们可以使用DeleteOutlined，但是它来自 <code>@ant-design/icons</code>，需要我们进行安装；</li></ul></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Comment,</span><br><span class="line">  Avatar,</span><br><span class="line">  Tooltip</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;antd&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; DeleteOutlined &#125; <span class="keyword">from</span> <span class="string">&quot;@ant-design/icons&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">HYCommentItem</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; comment &#125; = <span class="built_in">this</span>.props;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Comment</span><br><span class="line">        author=&#123;<span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/#&quot;</span>&gt;</span>&#123;comment.name&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span>&#125;</span><br><span class="line">        avatar=&#123;</span><br><span class="line">          &lt;Avatar</span><br><span class="line">            src=&#123;comment.avatar&#125;</span><br><span class="line">            alt=&#123;comment.name&#125;</span><br><span class="line">          /&gt;</span><br><span class="line">        &#125;</span><br><span class="line">        content=&#123;comment.content&#125;</span><br><span class="line">        datetime=&#123;</span><br><span class="line">          &lt;Tooltip title=&#123;comment.datetime.format(<span class="string">&#x27;YYYY-MM-DD HH:mm:ss&#x27;</span>)&#125;&gt;</span><br><span class="line">            &lt;span&gt;&#123;comment.datetime.fromNow()&#125;&lt;/span&gt;</span><br><span class="line">          &lt;/Tooltip&gt;</span><br><span class="line">        &#125;</span><br><span class="line">        actions=&#123; <span class="built_in">this</span>.getActions() &#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">getActions</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      &lt;span onClick=&#123;<span class="built_in">this</span>.props.removeItem&#125;&gt;<span class="xml"><span class="tag">&lt;<span class="name">DeleteOutlined</span>/&gt;</span></span> 删除&lt;/span&gt;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="案例-App组件"><a href="#案例-App组件" class="headerlink" title="案例-App组件"></a>案例-App组件</h3><p>我们在App组件中，使用封装的两个组件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> HYCommentInput <span class="keyword">from</span> <span class="string">&#x27;./components/comment-input&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> HYCommentItem <span class="keyword">from</span> <span class="string">&#x27;./components/comment-item&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      commentList: []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div style=&#123;&#123;<span class="attr">width</span>: <span class="string">&quot;500px&quot;</span>, <span class="attr">padding</span>: <span class="string">&quot;20px&quot;</span>&#125;&#125;&gt;</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">this</span>.state.commentList.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">HYCommentItem</span> <span class="attr">key</span>=<span class="string">&#123;item.id&#125;</span> </span></span></span><br><span class="line"><span class="xml">                                  comment=&#123;item&#125; </span></span><br><span class="line"><span class="xml">                                  index=&#123;index&#125; </span></span><br><span class="line"><span class="xml">                                  removeItem=&#123;e =&gt; this.removeItem(index)&#125;/&gt;</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        &lt;HYCommentInput submitComment=&#123;<span class="built_in">this</span>.submitComment.bind(<span class="built_in">this</span>)&#125;/&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">submitComment</span>(<span class="params">comment</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      commentList: [...this.state.commentList, comment]</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">removeItem</span>(<span class="params">index</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> newCommentList = [...this.state.commentList];</span><br><span class="line">    newCommentList.splice(index, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      commentList: newCommentList</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列十一-React中的CSS</title>
      <link href="/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81%E4%B8%80-React%E4%B8%AD%E7%9A%84CSS/"/>
      <url>/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81%E4%B8%80-React%E4%B8%AD%E7%9A%84CSS/</url>
      
        <content type="html"><![CDATA[<blockquote><p>前面说过，整个前端已经是组件化的天下，而CSS的设计就不是为组件化而生的，所以在目前组件化的框架中都在需要一种合适的CSS解决方案。</p></blockquote><a id="more"></a><h2 id="React中的css方案"><a href="#React中的css方案" class="headerlink" title="React中的css方案"></a>React中的css方案</h2><h3 id="react中的css"><a href="#react中的css" class="headerlink" title="react中的css"></a>react中的css</h3><p>事实上，css一直是React的痛点，也是被很多开发者吐槽、诟病的一个点。</p><p>在组件化中选择合适的CSS解决方案应该符合以下条件：</p><ul><li>可以编写局部css：css具备自己的具备作用域，不会随意污染其他组件内的原生；</li><li>可以编写动态的css：可以获取当前组件的一些状态，根据状态的变化生成不同的css样式；</li><li>支持所有的css特性：伪类、动画、媒体查询等；</li><li>编写起来简洁方便、最好符合一贯的css风格特点；</li><li>等等…</li></ul><p>在这一点上，Vue做的要远远好于React：</p><ul><li>Vue通过在.vue文件中编写 <code>&lt;style&gt;</code> 标签来编写自己的样式；</li><li>通过是否添加 <code>scoped</code> 属性来决定编写的样式是全局有效还是局部有效；</li><li>通过 <code>lang</code> 属性来设置你喜欢的 <code>less</code>、<code>sass</code>等预处理器；</li><li>通过内联样式风格的方式来根据最新状态设置和改变css；</li><li>等等…</li></ul><p>Vue在CSS上虽然不能称之为完美，但是已经足够简洁、自然、方便了，至少统一的样式风格不会出现多个开发人员、多个项目采用不一样的样式风格。</p><p>相比而言，React官方并没有给出在React中统一的样式风格：</p><ul><li>由此，从普通的css，到css modules，再到css in js，有几十种不同的解决方案，上百个不同的库；</li><li>大家一致在寻找最好的或者说最适合自己的CSS方案，但是到目前为止也没有统一的方案；</li></ul><p>在这篇文章中，我会介绍挑选四种解决方案来介绍：</p><ul><li>方案一：内联样式的写法；</li><li>方案二：普通的css写法；</li><li>方案三：css modules；</li><li>方案四：css in js（styled-components）；</li></ul><h3 id="普通的解决方案"><a href="#普通的解决方案" class="headerlink" title="普通的解决方案"></a>普通的解决方案</h3><h4 id="内联样式"><a href="#内联样式" class="headerlink" title="内联样式"></a>内联样式</h4><p>内联样式是官方推荐的一种css样式的写法：</p><ul><li><code>style</code> 接受一个采用小驼峰命名属性的 JavaScript 对象，，而不是 CSS 字符串；</li><li>并且可以引用state中的状态来设置相关的样式；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      titleColor: <span class="string">&quot;red&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2 style=&#123;&#123;<span class="attr">color</span>: <span class="built_in">this</span>.state.titleColor, <span class="attr">fontSize</span>: <span class="string">&quot;20px&quot;</span>&#125;&#125;&gt;我是App标题&lt;/h2&gt;</span><br><span class="line">        &lt;p style=&#123;&#123;<span class="attr">color</span>: <span class="string">&quot;green&quot;</span>, <span class="attr">textDecoration</span>: <span class="string">&quot;underline&quot;</span>&#125;&#125;&gt;我是一段文字描述&lt;/p&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>内联样式的优点:</p><ul><li>1.内联样式, 样式之间不会有冲突</li><li>2.可以动态获取当前state中的状态</li></ul><p>内联样式的缺点：</p><ul><li>1.写法上都需要使用驼峰标识</li><li>2.某些样式没有提示</li><li>3.大量的样式, 代码混乱</li><li>4.某些样式无法编写(比如伪类/伪元素)</li></ul><p>所以官方依然是希望内联合适和普通的css来结合编写；</p><h4 id="普通的css"><a href="#普通的css" class="headerlink" title="普通的css"></a>普通的css</h4><p>普通的css我们通常会编写到一个单独的文件。</p><p>App.js中编写React逻辑代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Home <span class="keyword">from</span> <span class="string">&#x27;./Home&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./App.css&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div className=<span class="string">&quot;app&quot;</span>&gt;</span><br><span class="line">        &lt;h2 className=<span class="string">&quot;title&quot;</span>&gt;我是App的标题&lt;/h2&gt;</span><br><span class="line">        &lt;p className=<span class="string">&quot;desc&quot;</span>&gt;我是App中的一段文字描述&lt;/p&gt;</span><br><span class="line">        &lt;Home/&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>App.css中编写React样式代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.title &#123;</span><br><span class="line">  color: red;</span><br><span class="line">  font-size: <span class="number">20</span>px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.desc &#123;</span><br><span class="line">  color: green;</span><br><span class="line">  text-decoration: underline;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样的编写方式和普通的网页开发中编写方式是一致的：</p><ul><li>如果我们按照普通的网页标准去编写，那么也不会有太大的问题；</li><li>但是组件化开发中我们总是希望组件是一个独立的模块，即便是样式也只是在自己内部生效，不会相互影响；</li><li>但是普通的css都属于全局的css，样式之间会相互影响；</li></ul><p>比如编写Home.js的逻辑代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./Home.css&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Home</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div className=<span class="string">&quot;home&quot;</span>&gt;</span><br><span class="line">        &lt;h2 className=<span class="string">&quot;title&quot;</span>&gt;我是Home标题&lt;/h2&gt;</span><br><span class="line">        &lt;span className=<span class="string">&quot;desc&quot;</span>&gt;我是Home中的span段落&lt;/span&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>又编写了Home.css的样式代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.title &#123;</span><br><span class="line">  color: orange;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.desc &#123;</span><br><span class="line">  color: purple;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终样式之间会相互层叠，只有一个样式会生效；</p><h4 id="css-modules"><a href="#css-modules" class="headerlink" title="css modules"></a>css modules</h4><p>css modules并不是React特有的解决方案，而是所有使用了类似于webpack配置的环境下都可以使用的。</p><p>但是，如果在其他项目中使用，那么我们需要自己来进行配置，比如配置webpack.config.js中的<code>modules: true</code>等。</p><p>但是React的脚手架已经内置了css modules的配置：</p><ul><li>.css/.less/.scss 等样式文件都修改成 .module.css/.module.less/.module.scss 等；</li><li>之后就可以引用并且进行使用了；</li></ul><p>使用的方式如下：</p><p><img src="F:\ImageBed\images_blog\2020-12-14-React系列\11001" alt="图片">css modules用法</p><p>这种css使用方式最终生成的class名称会全局唯一：</p><p><img src="F:\ImageBed\images_blog\2020-12-14-React系列\11002" alt="图片">生成的代码结构</p><p>css modules确实解决了局部作用域的问题，也是很多人喜欢在React中使用的一种方案。</p><p>但是这种方案也有自己的缺陷：</p><ul><li>引用的类名，不能使用连接符(.home-title)，在JavaScript中是不识别的；</li><li>所有的className都必须使用<code>&#123;style.className&#125;</code> 的形式来编写；</li><li>不方便动态来修改某些样式，依然需要使用内联样式的方式；</li></ul><p>如果你觉得上面的缺陷还算OK，那么你在开发中完全可以选择使用css modules来编写，并且也是在React中很受欢迎的一种方式。</p><h2 id="CSS-in-JS"><a href="#CSS-in-JS" class="headerlink" title="CSS in JS"></a>CSS in JS</h2><h3 id="认识CSS-in-JS"><a href="#认识CSS-in-JS" class="headerlink" title="认识CSS in JS"></a>认识CSS in JS</h3><p>实际上，官方文档也有提到过CSS in JS这种方案：</p><ul><li>“CSS-in-JS” 是指一种模式，其中 CSS 由 JavaScript 生成而不是在外部文件中定义；</li><li><em>注意此功能并不是 React 的一部分，而是由第三方库提供。</em> React 对样式如何定义并没有明确态度；</li></ul><p>在传统的前端开发中，我们通常会将结构（HTML）、样式（CSS）、逻辑（JavaScript）进行分离。</p><ul><li>但是在前面的学习中，我们就提到过，React的思想中认为逻辑本身和UI是无法分离的，所以才会有了JSX的语法。</li><li>样式呢？样式也是属于UI的一部分；</li><li>事实上CSS-in-JS的模式就是一种将样式（CSS）也写入到JavaScript中的方式，并且可以方便的使用JavaScript的状态；</li><li>所以React有被人称之为 <code>All in JS</code>；</li></ul><p>当然，这种开发的方式也受到了很多的批评：</p><ul><li>Stop using CSS in JavaScript for web development</li><li><a href="https://hackernoon.com/stop-using-css-in-javascript-for-web-development-fa32fb873dcc">https://hackernoon.com/stop-using-css-in-javascript-for-web-development-fa32fb873dcc</a></li></ul><p>批评声音虽然有，但是在我们看来很多优秀的CSS-in-JS的库依然非常强大、方便：</p><ul><li>CSS-in-JS通过JavaScript来为CSS赋予一些能力，包括类似于CSS预处理器一样的样式嵌套、函数定义、逻辑复用、动态修改状态等等；</li><li>依然CSS预处理器也具备某些能力，但是获取动态状态依然是一个不好处理的点；</li><li>所以，目前可以说CSS-in-JS是React编写CSS最为受欢迎的一种解决方案；</li></ul><p>目前比较流行的CSS-in-JS的库有哪些呢？</p><ul><li>styled-components</li><li>emotion</li><li>glamorous</li></ul><p>目前可以说styled-components依然是社区最流行的CSS-in-JS库，所以我们以styled-components的讲解为主；</p><p>安装styled-components：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add styled-components</span><br></pre></td></tr></table></figure><h3 id="styled-components"><a href="#styled-components" class="headerlink" title="styled-components"></a>styled-components</h3><h4 id="标签模板字符串"><a href="#标签模板字符串" class="headerlink" title="标签模板字符串"></a>标签模板字符串</h4><p>ES6中增加了<code>模板字符串</code>的语法，这个对于很多人来说都会使用。</p><p>但是模板字符串还有另外一种用法：标签模板字符串（Tagged Template Literals）。</p><p>我们一起来看一个普通的JavaScript的函数：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foo(<span class="string">&quot;Hello World&quot;</span>);</span><br></pre></td></tr></table></figure><p>正常情况下，我们都是通过 <code>函数名()</code> 方式来进行调用的，其实函数还有另外一种调用方式：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foo<span class="string">`Hello World`</span>; <span class="comment">// [[&quot;Hello World&quot;]]</span></span><br></pre></td></tr></table></figure><p>如果我们在调用的时候插入其他的变量：</p><ul><li>模板字符串被拆分了；</li><li>第一个元素是数组，是被模块字符串拆分的字符串组合；</li><li>后面的元素是一个个模块字符串传入的内容；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foo<span class="string">`Hello <span class="subst">$&#123;name&#125;</span>`</span>; <span class="comment">// [[&quot;Hello &quot;, &quot;&quot;], &quot;kobe&quot;];</span></span><br></pre></td></tr></table></figure><p>在styled component中，就是通过这种方式来解析模块字符串，最终生成我们想要的样式的</p><h4 id="styled基本使用"><a href="#styled基本使用" class="headerlink" title="styled基本使用"></a>styled基本使用</h4><p>styled-components的本质是通过函数的调用，最终创建出一个<code>组件</code>：</p><ul><li>这个组件会被自动添加上一个不重复的class；</li><li>styled-components会给该class添加相关的样式；</li></ul><p>比如我们正常开发出来的Home组件是这样的格式：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;</span><br><span class="line">  &lt;h2&gt;我是Home标题&lt;/h2&gt;</span><br><span class="line">  &lt;ul&gt;</span><br><span class="line">    &lt;li&gt;我是列表<span class="number">1</span>&lt;/li&gt;</span><br><span class="line">    &lt;li&gt;我是列表<span class="number">2</span>&lt;/li&gt;</span><br><span class="line">    &lt;li&gt;我是列表<span class="number">3</span>&lt;/li&gt;</span><br><span class="line">  &lt;/ul&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><p>我们希望给外层的div添加一个特殊的class，并且添加相关的样式：</p><p><img src="F:\ImageBed\images_blog\2020-12-14-React系列\11003" alt="图片">styled-components基本使用</p><p>另外，它支持类似于CSS预处理器一样的样式嵌套：</p><ul><li>支持直接子代选择器或后代选择器，并且直接编写样式；</li><li>可以通过&amp;符号获取当前元素；</li><li>直接伪类选择器、伪元素等；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> HomeWrapper = styled.div<span class="string">`</span></span><br><span class="line"><span class="string">  color: purple;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  h2 &#123;</span></span><br><span class="line"><span class="string">    font-size: 50px;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  ul &gt; li &#123;</span></span><br><span class="line"><span class="string">    color: orange;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &amp;.active &#123;</span></span><br><span class="line"><span class="string">      color: red;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &amp;:hover &#123;</span></span><br><span class="line"><span class="string">      background: #aaa;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &amp;::after &#123;</span></span><br><span class="line"><span class="string">      content: &quot;abc&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure><p><img src="F:\ImageBed\images_blog\2020-12-14-React系列\11004" alt="图片">最终效果如下</p><h4 id="props、attrs属性"><a href="#props、attrs属性" class="headerlink" title="props、attrs属性"></a>props、attrs属性</h4><p><strong>props可以穿透</strong></p><p>定义一个styled组件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> HYInput = styled.input<span class="string">`</span></span><br><span class="line"><span class="string">  border-color: red;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  &amp;:focus &#123;</span></span><br><span class="line"><span class="string">    outline-color: orange;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure><p>使用styled的组件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;HYInput type=<span class="string">&quot;password&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p><strong>props可以被传递给styled组件</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;HomeWrapper color=<span class="string">&quot;blue&quot;</span>&gt;</span><br><span class="line">&lt;/HomeWrapper&gt;</span><br></pre></td></tr></table></figure><p>使用时可以获取到传入的color：</p><ul><li>获取props需要通过${}传入一个插值函数，props会作为该函数的参数；</li><li>这种方式可以有效的解决动态样式的问题；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> HomeWrapper = styled.div<span class="string">`</span></span><br><span class="line"><span class="string">  color: <span class="subst">$&#123;props =&gt; props.color&#125;</span>;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>添加attrs属性</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> HYInput = styled.input.attrs(&#123;</span><br><span class="line">  placeholder: <span class="string">&quot;请填写密码&quot;</span>,</span><br><span class="line">  paddingLeft: <span class="function"><span class="params">props</span> =&gt;</span> props.left || <span class="string">&quot;5px&quot;</span></span><br><span class="line">&#125;)<span class="string">`</span></span><br><span class="line"><span class="string">  border-color: red;</span></span><br><span class="line"><span class="string">  padding-left: <span class="subst">$&#123;props =&gt; props.paddingLeft&#125;</span>;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  &amp;:focus &#123;</span></span><br><span class="line"><span class="string">    outline-color: orange;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure><h4 id="styled高级特性"><a href="#styled高级特性" class="headerlink" title="styled高级特性"></a>styled高级特性</h4><p><strong>支持样式的继承</strong></p><p>编写styled组件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> HYButton = styled.button<span class="string">`</span></span><br><span class="line"><span class="string">  padding: 8px 30px;</span></span><br><span class="line"><span class="string">  border-radius: 5px;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> HYWarnButton = styled(HYButton)<span class="string">`</span></span><br><span class="line"><span class="string">  background-color: red;</span></span><br><span class="line"><span class="string">  color: #fff;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> HYPrimaryButton = styled(HYButton)<span class="string">`</span></span><br><span class="line"><span class="string">  background-color: green;</span></span><br><span class="line"><span class="string">  color: #fff;</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure><p>按钮的使用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;HYButton&gt;我是普通按钮&lt;/HYButton&gt;</span><br><span class="line">&lt;HYWarnButton&gt;我是警告按钮&lt;/HYWarnButton&gt;</span><br><span class="line">&lt;HYPrimaryButton&gt;我是主要按钮&lt;/HYPrimaryButton&gt;</span><br></pre></td></tr></table></figure><p><strong>styled设置主题</strong></p><p>在全局定制自己的主题，通过Provider进行共享：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ThemeProvider &#125; <span class="keyword">from</span> <span class="string">&#x27;styled-components&#x27;</span>;</span><br><span class="line"></span><br><span class="line">&lt;ThemeProvider theme=&#123;&#123;<span class="attr">color</span>: <span class="string">&quot;red&quot;</span>, <span class="attr">fontSize</span>: <span class="string">&quot;30px&quot;</span>&#125;&#125;&gt;</span><br><span class="line">  &lt;Home /&gt;</span><br><span class="line">  &lt;Profile /&gt;</span><br><span class="line">&lt;/ThemeProvider&gt;</span><br></pre></td></tr></table></figure><p>在styled组件中可以获取到主题的内容：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ProfileWrapper = styled.div<span class="string">`</span></span><br><span class="line"><span class="string">  color: <span class="subst">$&#123;props =&gt; props.theme.color&#125;</span>;</span></span><br><span class="line"><span class="string">  font-size: <span class="subst">$&#123;props =&gt; props.theme.fontSize&#125;</span>;</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure><h3 id="classnames"><a href="#classnames" class="headerlink" title="classnames"></a>classnames</h3><p><strong>vue中添加class</strong></p><p>在vue中给一个元素添加动态的class是一件非常简单的事情：</p><p>你可以通过传入一个对象：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;div</span><br><span class="line">  <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;static&quot;</span></span><br><span class="line">  v-bind:<span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;&#123; active: isActive, &#x27;text-danger&#x27;: hasError &#125;&quot;</span></span><br><span class="line">&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure><p>你也可以传入一个数组：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div v-bind:<span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;[activeClass, errorClass]&quot;</span>&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure><p>甚至是对象和数组混合使用：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div v-bind:<span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;[&#123; active: isActive &#125;, errorClass]&quot;</span>&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure><p><strong>react中添加class</strong></p><p>React在JSX给了我们开发者足够多的灵活性，你可以像编写JavaScript代码一样，通过一些逻辑来决定是否添加某些class：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      isActive: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;isActive&#125; = <span class="built_in">this</span>.state; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2 className=&#123;<span class="string">&quot;title &quot;</span> + (isActive ? <span class="string">&quot;active&quot;</span>: <span class="string">&quot;&quot;</span>)&#125;&gt;我是标题&lt;/h2&gt;</span><br><span class="line">        &lt;h2 className=&#123;[<span class="string">&quot;title&quot;</span>, (isActive ? <span class="string">&quot;active&quot;</span>: <span class="string">&quot;&quot;</span>)].join(<span class="string">&quot; &quot;</span>)&#125;&gt;我是标题&lt;/h2&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个时候我们可以借助于一个第三方的库：classnames</p><ul><li>很明显，这是一个用于动态添加classnames的一个库。</li></ul><p>我们来使用一下最常见的使用案例：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">classNames(<span class="string">&#x27;foo&#x27;</span>, <span class="string">&#x27;bar&#x27;</span>); <span class="comment">// =&gt; &#x27;foo bar&#x27;</span></span><br><span class="line">classNames(<span class="string">&#x27;foo&#x27;</span>, &#123; <span class="attr">bar</span>: <span class="literal">true</span> &#125;); <span class="comment">// =&gt; &#x27;foo bar&#x27;</span></span><br><span class="line">classNames(&#123; <span class="string">&#x27;foo-bar&#x27;</span>: <span class="literal">true</span> &#125;); <span class="comment">// =&gt; &#x27;foo-bar&#x27;</span></span><br><span class="line">classNames(&#123; <span class="string">&#x27;foo-bar&#x27;</span>: <span class="literal">false</span> &#125;); <span class="comment">// =&gt; &#x27;&#x27;</span></span><br><span class="line">classNames(&#123; <span class="attr">foo</span>: <span class="literal">true</span> &#125;, &#123; <span class="attr">bar</span>: <span class="literal">true</span> &#125;); <span class="comment">// =&gt; &#x27;foo bar&#x27;</span></span><br><span class="line">classNames(&#123; <span class="attr">foo</span>: <span class="literal">true</span>, <span class="attr">bar</span>: <span class="literal">true</span> &#125;); <span class="comment">// =&gt; &#x27;foo bar&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// lots of arguments of various types</span></span><br><span class="line">classNames(<span class="string">&#x27;foo&#x27;</span>, &#123; <span class="attr">bar</span>: <span class="literal">true</span>, <span class="attr">duck</span>: <span class="literal">false</span> &#125;, <span class="string">&#x27;baz&#x27;</span>, &#123; <span class="attr">quux</span>: <span class="literal">true</span> &#125;); <span class="comment">// =&gt; &#x27;foo bar baz quux&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// other falsy values are just ignored</span></span><br><span class="line">classNames(<span class="literal">null</span>, <span class="literal">false</span>, <span class="string">&#x27;bar&#x27;</span>, <span class="literal">undefined</span>, <span class="number">0</span>, <span class="number">1</span>, &#123; <span class="attr">baz</span>: <span class="literal">null</span> &#125;, <span class="string">&#x27;&#x27;</span>); <span class="comment">// =&gt; &#x27;bar 1&#x27;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列十-高阶组件以及组件补充</title>
      <link href="/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81-%E9%AB%98%E9%98%B6%E7%BB%84%E4%BB%B6%E4%BB%A5%E5%8F%8A%E7%BB%84%E4%BB%B6%E8%A1%A5%E5%85%85/"/>
      <url>/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%8D%81-%E9%AB%98%E9%98%B6%E7%BB%84%E4%BB%B6%E4%BB%A5%E5%8F%8A%E7%BB%84%E4%BB%B6%E8%A1%A5%E5%85%85/</url>
      
        <content type="html"><![CDATA[<h2 id="高阶组件"><a href="#高阶组件" class="headerlink" title="高阶组件"></a>高阶组件</h2><h3 id="认识高阶组件"><a href="#认识高阶组件" class="headerlink" title="认识高阶组件"></a>认识高阶组件</h3><p>什么是高阶组件呢？相信很多同学都听说过，也用过 <code>高阶函数</code>，它们非常相似，所以我们可以先来回顾一下什么是 <code>高阶函数</code>。</p><p>高阶函数的维基百科定义：至少满足以下条件之一：</p><ul><li>接受一个或多个函数作为输入；</li><li>输出一个函数；</li></ul><a id="more"></a><p>JavaScript中比较常见的filter、map、reduce都是高阶函数。</p><p>那么说明是高阶组件呢？</p><ul><li>高阶组件的英文是 <strong>Higher-Order Components</strong>，简称为 <code>HOC</code>；</li><li>官方的定义：<strong>高阶组件是参数为组件，返回值为新组件的函数</strong>；</li></ul><p>我们可以进行如下的解析：</p><ul><li>首先， <code>高阶组件</code> 本身不是一个组件，而是一个函数；</li><li>其次，这个函数的参数是一个组件，返回值也是一个组件；</li></ul><p>高阶组件的调用过程类似于这样：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> EnhancedComponent = higherOrderComponent(WrappedComponent);</span><br></pre></td></tr></table></figure><p>高阶函数的编写过程类似于这样：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">higherOrderComponent</span>(<span class="params">WrapperComponent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="title">NewComponent</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WrapperComponent</span>/&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在ES6中，类表达式中类名是可以省略的，所以可以可以写成下面的写法：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">higherOrderComponent</span>(<span class="params">WrapperComponent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WrapperComponent</span>/&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>另外，组件的名称都可以通过displayName来修改：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/10001" alt="图片">修改名称</p><p>完整的代码，我们可以这样来编写：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">higherOrderComponent</span>(<span class="params">WrapperComponent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="title">NewComponent</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WrapperComponent</span>/&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        App</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> higherOrderComponent(App);</span><br></pre></td></tr></table></figure><p>高阶组件并不是React API的一部分，它是基于React的组合特性而形成的设计模式；</p><p>高阶组件在一些React第三方库中非常常见：</p><ul><li>比如redux中的connect；（后续会讲到）</li><li>比如react-router中的withRouter；（后续会讲到）</li></ul><p>在我们的开发中，高阶组件可以帮助我们做哪些事情呢？</p><h3 id="高阶组件的使用"><a href="#高阶组件的使用" class="headerlink" title="高阶组件的使用"></a>高阶组件的使用</h3><h4 id="props的增强"><a href="#props的增强" class="headerlink" title="props的增强"></a>props的增强</h4><p><strong>不修改原有代码的情况下，添加新的props</strong></p><p>加入我们有如下案例：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Header</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; name, age &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Header &#123;name + age&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Header name=<span class="string">&quot;aaa&quot;</span> age=&#123;<span class="number">18</span>&#125; /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们可以通过一个高阶组件，让使用者在不破坏原有结构的情况下对某个组件增强props：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enhanceProps</span>(<span class="params">WrapperCpn, otherProps</span>) </span>&#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="function"><span class="params">props</span> =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">WrapperCpn</span> &#123;<span class="attr">...props</span>&#125; &#123;<span class="attr">...otherProps</span>&#125; /&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> EnhanceHeader = enhanceProps(Header, &#123;<span class="attr">height</span>: <span class="number">1.88</span>&#125;)</span><br></pre></td></tr></table></figure><p><strong>利用高阶组件来共享Context</strong></p><p>利用高阶组件来共享Context属性</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent, createContext &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UserContext = createContext(&#123;</span><br><span class="line">  nickname: <span class="string">&quot;默认&quot;</span>,</span><br><span class="line">  level: -<span class="number">1</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Header</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;UserContext.Consumer&gt;</span><br><span class="line">      &#123;</span><br><span class="line">        value =&gt; &#123;</span><br><span class="line">          <span class="keyword">const</span> &#123; nickname, level &#125; = value;</span><br><span class="line">          <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Header &#123;&quot;昵称:&quot; + nickname + &quot;等级&quot; + level&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &lt;/UserContext.Consumer&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Footer</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;UserContext.Consumer&gt;</span><br><span class="line">      &#123;</span><br><span class="line">        value =&gt; &#123;</span><br><span class="line">          <span class="keyword">const</span> &#123; nickname, level &#125; = value;</span><br><span class="line">          <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Footer &#123;&quot;昵称:&quot; + nickname + &quot;等级&quot; + level&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &lt;/UserContext.Consumer&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> EnhanceHeader = enhanceProps(Header, &#123; <span class="attr">height</span>: <span class="number">1.88</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;UserContext.Provider value=&#123;&#123; <span class="attr">nickname</span>: <span class="string">&quot;why&quot;</span>, <span class="attr">level</span>: <span class="number">90</span> &#125;&#125;&gt;</span><br><span class="line">          &lt;Header /&gt;</span><br><span class="line">          &lt;Footer /&gt;</span><br><span class="line">        &lt;/UserContext.Provider&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>利用高阶组件<code>withUser</code>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent, createContext &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UserContext = createContext(&#123;</span><br><span class="line">  nickname: <span class="string">&quot;默认&quot;</span>,</span><br><span class="line">  level: -<span class="number">1</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">withUser</span>(<span class="params">WrapperCpn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;UserContext.Consumer&gt;</span><br><span class="line">        &#123;</span><br><span class="line">          value =&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WrapperCpn</span> &#123;<span class="attr">...props</span>&#125; &#123;<span class="attr">...value</span>&#125;/&gt;</span></span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &lt;/UserContext.Consumer&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Header</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; nickname, level &#125; = props;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Header &#123;&quot;昵称:&quot; + nickname + &quot;等级:&quot; + level&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Footer</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; nickname, level &#125; = props;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Footer &#123;&quot;昵称:&quot; + nickname + &quot;等级:&quot; + level&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UserHeader = withUser(Header);</span><br><span class="line"><span class="keyword">const</span> UserFooter = withUser(Footer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;UserContext.Provider value=&#123;&#123; <span class="attr">nickname</span>: <span class="string">&quot;why&quot;</span>, <span class="attr">level</span>: <span class="number">90</span> &#125;&#125;&gt;</span><br><span class="line">          &lt;UserHeader /&gt;</span><br><span class="line">          &lt;UserFooter /&gt;</span><br><span class="line">        &lt;/UserContext.Provider&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="渲染判断鉴权"><a href="#渲染判断鉴权" class="headerlink" title="渲染判断鉴权"></a>渲染判断鉴权</h4><p>在开发中，我们可能遇到这样的场景：</p><ul><li>某些页面是必须用户登录成功才能进行进入；</li><li>如果用户没有登录成功，那么直接跳转到登录页面；</li></ul><p>这个时候，我们就可以使用高阶组件来完成鉴权操作：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LoginPage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>LoginPage<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CartPage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>CartPage<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;CartPage/&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编写鉴权的高阶组件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loginAuth</span>(<span class="params">Page</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (props.isLogin) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Page</span>/&gt;</span></span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">LoginPage</span>/&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>完整的代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loginAuth</span>(<span class="params">Page</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (props.isLogin) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Page</span>/&gt;</span></span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">LoginPage</span>/&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LoginPage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>LoginPage<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CartPage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>CartPage<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> AuthCartPage = loginAuth(CartPage);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;AuthCartPage isLogin=&#123;<span class="literal">true</span>&#125;/&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="生命周期劫持"><a href="#生命周期劫持" class="headerlink" title="生命周期劫持"></a>生命周期劫持</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Home</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">UNSAFE_componentWillMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.begin = <span class="built_in">Date</span>.now();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.end = <span class="built_in">Date</span>.now();</span><br><span class="line">    <span class="keyword">const</span> interval = <span class="built_in">this</span>.end - <span class="built_in">this</span>.begin;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Home渲染使用时间:<span class="subst">$&#123;interval&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;Home&lt;/h2&gt;</span><br><span class="line">        &lt;p&gt;我是home的元素,哈哈哈&lt;/p&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Detail</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">UNSAFE_componentWillMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.begin = <span class="built_in">Date</span>.now();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.end = <span class="built_in">Date</span>.now();</span><br><span class="line">    <span class="keyword">const</span> interval = <span class="built_in">this</span>.end - <span class="built_in">this</span>.begin;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Detail渲染使用时间:<span class="subst">$&#123;interval&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;Detail&lt;/h2&gt;</span><br><span class="line">        &lt;p&gt;我是detail的元素,哈哈哈&lt;/p&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Home/&gt;</span><br><span class="line">        &lt;Detail/&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们可以定义如下高阶组件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logRenderTime</span>(<span class="params">WrapperCpn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">UNSAFE_componentWillMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.begin = <span class="built_in">Date</span>.now();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.end = <span class="built_in">Date</span>.now();</span><br><span class="line">      <span class="keyword">const</span> interval = <span class="built_in">this</span>.end - <span class="built_in">this</span>.begin;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Home渲染使用时间:<span class="subst">$&#123;interval&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WrapperCpn</span> &#123;<span class="attr">...this.props</span>&#125;/&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> LogHome = logRenderTime(Home);</span><br><span class="line"><span class="keyword">const</span> LogDetail = logRenderTime(Detail);</span><br></pre></td></tr></table></figure><p>完整代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logRenderTime</span>(<span class="params">WrapperCpn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">UNSAFE_componentWillMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.begin = <span class="built_in">Date</span>.now();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.end = <span class="built_in">Date</span>.now();</span><br><span class="line">      <span class="keyword">const</span> interval = <span class="built_in">this</span>.end - <span class="built_in">this</span>.begin;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;WrapperCpn.name&#125;</span>渲染使用时间:<span class="subst">$&#123;interval&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WrapperCpn</span> &#123;<span class="attr">...this.props</span>&#125;/&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Home</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;Home&lt;/h2&gt;</span><br><span class="line">        &lt;p&gt;我是home的元素,哈哈哈&lt;/p&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Detail</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;Detail&lt;/h2&gt;</span><br><span class="line">        &lt;p&gt;我是detail的元素,哈哈哈&lt;/p&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> LogHome = logRenderTime(Home);</span><br><span class="line"><span class="keyword">const</span> LogDetail = logRenderTime(Detail);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;LogHome /&gt;</span><br><span class="line">        &lt;LogDetail /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="高阶函数的意义"><a href="#高阶函数的意义" class="headerlink" title="高阶函数的意义"></a>高阶函数的意义</h3><p>我们会发现利用高阶组件可以针对某些React代码进行更加优雅的处理。</p><p>其实早期的React有提供组件之间的一种复用方式是mixin，目前已经不再建议使用：</p><ul><li><code>Mixin</code> 可能会相互依赖，相互耦合，不利于代码维护</li><li>不同的<code>Mixin</code>中的方法可能会相互冲突</li><li><code>Mixin</code>非常多时，组件是可以感知到的，甚至还要为其做相关处理，这样会给代码造成滚雪球式的复杂性</li></ul><p>当然，HOC也有自己的一些缺陷：</p><ul><li><code>HOC</code>需要在原组件上进行包裹或者嵌套，如果大量使用<code>HOC</code>，将会产生非常多的嵌套，这让调试变得非常困难；</li><li><code>HOC</code>可以劫持<code>props</code>，在不遵守约定的情况下也可能造成冲突；</li></ul><p>Hooks的出现，是开创性的，它解决了很多React之前的存在的问题，比如this指向问题、比如hoc的嵌套复杂度问题等等；</p><p>后续我们还会专门来学习hooks相关的知识，敬请期待；</p><h2 id="二-组件补充"><a href="#二-组件补充" class="headerlink" title="二. 组件补充"></a>二. 组件补充</h2><h3 id="ref转发"><a href="#ref转发" class="headerlink" title="ref转发"></a>ref转发</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent, createRef &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Home</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2 ref=&#123;props.ref&#125;&gt;Home&lt;/h2&gt;</span><br><span class="line">      &lt;button&gt;按钮&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.homeTitleRef = createRef();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Home ref=&#123;<span class="built_in">this</span>.homeTitleRef&#125;/&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.printInfo()&#125;&gt;打印ref&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">printInfo</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.homeTitleRef);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用forwardRef</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent, createRef, forwardRef &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Home = forwardRef(<span class="function"><span class="keyword">function</span>(<span class="params">props, ref</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2 ref=&#123;ref&#125;&gt;Home&lt;/h2&gt;</span><br><span class="line">      &lt;button&gt;按钮&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.homeTitleRef = createRef();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Home ref=&#123;<span class="built_in">this</span>.homeTitleRef&#125;/&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.printInfo()&#125;&gt;打印ref&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">printInfo</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.homeTitleRef.current);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Portals"><a href="#Portals" class="headerlink" title="Portals"></a>Portals</h3><p>某些情况下，我们希望渲染的内容独立于父组件，甚至是独立于当前挂载到的DOM元素中（默认都是挂载到id为root的DOM元素上的）。</p><p>Portal 提供了一种将子节点渲染到存在于父组件以外的 DOM 节点的优秀的方案：</p><ul><li>第一个参数（<code>child</code>）是任何可渲染的 React 子元素，例如一个元素，字符串或 fragment；</li><li>第二个参数（<code>container</code>）是一个 DOM 元素；</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ReactDOM.createPortal(child, container)</span><br></pre></td></tr></table></figure><p>通常来讲，当你从组件的 render 方法返回一个元素时，该元素将被挂载到 DOM 节点中离其最近的父节点：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="comment">// React 挂载了一个新的 div，并且把子元素渲染其中</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;      </span><br><span class="line">      &#123;<span class="built_in">this</span>.props.children&#125;</span><br><span class="line">    &lt;/div&gt;  </span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然而，有时候将子元素插入到 DOM 节点中的不同位置也是有好处的：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="comment">// React 并*没有*创建一个新的 div。它只是把子元素渲染到 `domNode` 中。</span></span><br><span class="line">  <span class="comment">// `domNode` 是一个可以在任何位置的有效 DOM 节点。</span></span><br><span class="line">  <span class="keyword">return</span> ReactDOM.createPortal(</span><br><span class="line">    <span class="built_in">this</span>.props.children,</span><br><span class="line">    domNode  </span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>比如说，我们准备开发一个Modal组件，它可以将它的子组件渲染到屏幕的中间位置：</strong></p><p>步骤一：修改index.html添加新的节点</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;root&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;!-- 新节点 --&gt;</span><br><span class="line">&lt;div id=<span class="string">&quot;modal&quot;</span>&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure><p>步骤二：编写这个节点的样式：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#modal &#123;</span><br><span class="line">  position: fixed;</span><br><span class="line">  left: <span class="number">50</span>%;</span><br><span class="line">  top: <span class="number">50</span>%;</span><br><span class="line">  transform: translate(-<span class="number">50</span>%, -<span class="number">50</span>%);</span><br><span class="line">  background-color: red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>步骤三：编写组件代码</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modal</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ReactDOM.createPortal(</span><br><span class="line">      <span class="built_in">this</span>.props.children,</span><br><span class="line">      <span class="built_in">document</span>.getElementById(<span class="string">&quot;modal&quot;</span>)</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Modal&gt;</span><br><span class="line">          &lt;h2&gt;我是标题&lt;/h2&gt;</span><br><span class="line">        &lt;/Modal&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Fragment"><a href="#Fragment" class="headerlink" title="Fragment"></a>Fragment</h3><p>在之前的开发中，我们总是在一个组件中返回内容时包裹一个div元素：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;当前计数: <span class="number">0</span>&lt;/h2&gt;</span><br><span class="line">        &lt;button&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">        &lt;button&gt;-<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/10002" alt="图片">界面渲染</p><p>我们会发现多了一个div元素：</p><ul><li>这个div元素对于某些场景是需要的（比如我们就希望放到一个div元素中，再针对性设置样式）</li><li>某些场景下这个div是没有必要的，比如当前这里我可能希望所有的内容直接渲染到root中即可；</li></ul><p>我们可以删除这个div吗？</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/10003" alt="图片">删除div报错</p><p>我们又希望可以不渲染这样一个div应该如何操作呢？</p><ul><li>使用Fragment</li><li>Fragment 允许你将子列表分组，而无需向 DOM 添加额外节点；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/10004" alt="图片">使用Fragment效果</p><p>React还提供了Fragment的段语法：</p><ul><li>它看起来像空标签 <code>&lt;&gt;</code>；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;&gt;</span><br><span class="line">        &lt;h2&gt;当前计数: <span class="number">0</span>&lt;/h2&gt;</span><br><span class="line">        &lt;button&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">        &lt;button&gt;-<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &lt;/&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是，如果我们需要在Fragment中添加key，那么就不能使用段语法：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="built_in">this</span>.state.friends.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Fragment key=&#123;item.name&#125;&gt;</span><br><span class="line">        &lt;div&gt;&#123;item.name&#125;&lt;/div&gt;</span><br><span class="line">        &lt;div&gt;&#123;item.age&#125;&lt;/div&gt;</span><br><span class="line">      &lt;/Fragment&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里是不支持如下写法的：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;key=&#123;item.name&#125;&gt;</span><br><span class="line">  &lt;div&gt;&#123;item.name&#125;&lt;/div&gt;</span><br><span class="line">  &lt;div&gt;&#123;item.age&#125;&lt;/div&gt;</span><br><span class="line">&lt;/&gt;</span><br></pre></td></tr></table></figure><h3 id="StrictMode"><a href="#StrictMode" class="headerlink" title="StrictMode"></a>StrictMode</h3><p><code>StrictMode</code> 是一个用来突出显示应用程序中潜在问题的工具。</p><ul><li>与 <code>Fragment</code> 一样，<code>StrictMode</code> 不会渲染任何可见的 UI；</li><li>它为其后代元素触发额外的检查和警告；</li><li>严格模式检查仅在开发模式下运行；<em>它们不会影响生产构建</em>；</li></ul><p>可以为应用程序的任何部分启用严格模式：</p><ul><li><em>不</em>会对 <code>Header</code> 和 <code>Footer</code> 组件运行严格模式检查；</li><li>但是，<code>ComponentOne</code> 和 <code>ComponentTwo</code> 以及它们的所有后代元素都将进行检查；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ExampleApplication</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Header /&gt;</span><br><span class="line">      &lt;React.StrictMode&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;ComponentOne /&gt;</span><br><span class="line">          &lt;ComponentTwo /&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/React.StrictMode&gt;</span><br><span class="line">      &lt;Footer /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>但是检测，到底检测什么呢？</strong></p><p>1.识别不安全的生命周期：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Home</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">UNSAFE_componentWillMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/10005" alt="图片">警告信息</p><p>2.使用过时的ref API</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Home</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">UNSAFE_componentWillMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">ref</span>=<span class="string">&quot;home&quot;</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/10006" alt="图片">警告信息</p><p>3.使用废弃的findDOMNode方法</p><p>在之前的React API中，可以通过findDOMNode来获取DOM，不过已经不推荐使用了，可以自行学习演练一下</p><p>4.检查意外的副作用</p><ul><li>这个组件的constructor会被调用两次；</li><li>这是严格模式下故意进行的操作，让你来查看在这里写的一些逻辑代码被调用多次时，是否会产生一些副作用；</li><li>在生产环境中，是不会被调用两次的；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Home</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;home constructor&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">UNSAFE_componentWillMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">ref</span>=<span class="string">&quot;home&quot;</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5.检测过时的context API</p><p>早期的Context是通过static属性声明Context对象属性，通过getChildContext返回Context对象等方式来使用Context的；</p><p>目前这种方式已经不推荐使用，大家可以自行学习了解一下它的用法；</p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列九-受控非受控组件</title>
      <link href="/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E4%B9%9D-%E5%8F%97%E6%8E%A7%E9%9D%9E%E5%8F%97%E6%8E%A7%E7%BB%84%E4%BB%B6/"/>
      <url>/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E4%B9%9D-%E5%8F%97%E6%8E%A7%E9%9D%9E%E5%8F%97%E6%8E%A7%E7%BB%84%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<h2 id="refs的使用"><a href="#refs的使用" class="headerlink" title="refs的使用"></a>refs的使用</h2><p>在React的开发模式中，通常情况下不需要、也不建议直接操作DOM原生，但是某些特殊的情况，确实需要获取到DOM进行某些操作：</p><ul><li>管理焦点，文本选择或媒体播放。</li><li>触发强制动画。</li><li>集成第三方 DOM 库。</li></ul><a id="more"></a><h3 id="创建ref的方式"><a href="#创建ref的方式" class="headerlink" title="创建ref的方式"></a>创建ref的方式</h3><p>如何创建refs来获取对应的DOM呢？目前有三种方式：</p><ul><li><p>方式一：传入字符串</p></li><li><ul><li>使用时通过 <code>this.refs.传入的字符串</code>格式获取对应的元素；</li></ul></li><li><p>方式二：传入一个对象</p></li><li><ul><li>对象是通过 <code>React.createRef()</code> 方式创建出来的；</li><li>使用时获取到创建的对象其中有一个<code>current</code>属性就是对应的元素；</li></ul></li><li><p>方式三：传入一个函数</p></li><li><ul><li>该函数会在DOM被挂载时进行回调，这个函数会传入一个 元素对象，我们可以自己保存；</li><li>使用时，直接拿到之前保存的元素对象即可；</li></ul></li></ul><p>代码演练：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent, createRef &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.titleRef = createRef();</span><br><span class="line">    <span class="built_in">this</span>.titleEl = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2 ref=<span class="string">&quot;title&quot;</span>&gt;<span class="built_in">String</span> Ref&lt;/h2&gt;</span><br><span class="line">        &lt;h2 ref=&#123;<span class="built_in">this</span>.titleRef&#125;&gt;Hello Create Ref&lt;/h2&gt;</span><br><span class="line">        &lt;h2 ref=&#123;<span class="function"><span class="params">element</span> =&gt;</span> <span class="built_in">this</span>.titleEl = element&#125;&gt;Callback Ref&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.changeText()&#125;&gt;改变文本&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">changeText</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.refs.title.innerHTML = <span class="string">&quot;你好啊,李银河&quot;</span>;</span><br><span class="line">    <span class="built_in">this</span>.titleRef.current.innerHTML = <span class="string">&quot;你好啊,李银河&quot;</span>;</span><br><span class="line">    <span class="built_in">this</span>.titleEl.innerHTML = <span class="string">&quot;你好啊,李银河&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ref节点的类型"><a href="#ref节点的类型" class="headerlink" title="ref节点的类型"></a>ref节点的类型</h3><p>ref 的值根据节点的类型而有所不同：</p><ul><li>当 <code>ref</code> 属性用于 HTML 元素时，构造函数中使用 <code>React.createRef()</code> 创建的 <code>ref</code> 接收底层 DOM 元素作为其 <code>current</code> 属性；</li><li>当 <code>ref</code> 属性用于自定义 class 组件时，<code>ref</code> 对象接收组件的挂载实例作为其 <code>current</code> 属性；</li><li><strong>你不能在函数组件上使用 <code>ref</code> 属性</strong>，因为他们没有实例；</li></ul><p>这里我们演示一下ref引用一个class组件对象：</p><p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/O8xWXzAqXuvFsopQCEXnsr5PfAgan49KjZicPiaQY7FPSbeEnuvSIB1rsagSraseD0Nk09allmwckn0pnSibsEQjA/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片">class组件案例</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent, createRef &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      counter: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;当前计数: &#123;<span class="built_in">this</span>.state.counter&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.increment()&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">increment</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      counter: <span class="built_in">this</span>.state.counter + <span class="number">1</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.counterRef = createRef();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Counter ref=&#123;<span class="built_in">this</span>.counterRef&#125;/&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.increment()&#125;&gt;app +<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">increment</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.counterRef.current.increment();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数式组件是没有实例的，所以无法通过ref获取他们的实例：</p><ul><li>但是某些时候，我们可能想要获取函数式组件中的某个DOM元素；</li><li>这个时候我们可以通过 <code>React.forwardRef</code> ，后面我们也会学习 hooks 中如何使用ref；</li></ul><h2 id="受控组件"><a href="#受控组件" class="headerlink" title="受控组件"></a>受控组件</h2><h3 id="认识受控组件"><a href="#认识受控组件" class="headerlink" title="认识受控组件"></a>认识受控组件</h3><h4 id="默认提交表单方式"><a href="#默认提交表单方式" class="headerlink" title="默认提交表单方式"></a>默认提交表单方式</h4><p>在React中，HTML表单的处理方式和普通的DOM元素不太一样：表单元素通常会保存在一些内部的state。</p><p>比如下面的HTML表单元素：</p><ul><li>这个处理方式是DOM默认处理HTML表单的行为，在用户点击提交时会提交到某个服务器中，并且刷新页面；</li><li>在React中，并没有禁止这个行为，它依然是有效的；</li><li>但是通常情况下会使用JavaScript函数来方便的处理表单提交，同时还可以访问用户填写的表单数据；</li><li>实现这种效果的标准方式是使用“受控组件”；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;form&gt;</span><br><span class="line">  &lt;label&gt;</span><br><span class="line">    名字:</span><br><span class="line">    &lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;name&quot;</span> /&gt;</span><br><span class="line">  &lt;/label&gt;</span><br><span class="line">  &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;提交&quot;</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure><h4 id="受控组件提交表单"><a href="#受控组件提交表单" class="headerlink" title="受控组件提交表单"></a>受控组件提交表单</h4><p>在 HTML 中，表单元素（如<code>、</code> 和 ``）之类的表单元素通常自己维护 state，并根据用户输入进行更新。</p><p>而在 React 中，可变状态（mutable state）通常保存在组件的 state 属性中，并且只能通过使用 <code>setState()</code>来更新。</p><ul><li>我们将两者结合起来，使React的state成为“唯一数据源”；</li><li>渲染表单的 React 组件还控制着用户输入过程中表单发生的操作；</li><li>被 React 以这种方式控制取值的表单输入元素就叫做“受控组件”；</li></ul><p>例如，如果我们想让前一个示例在提交时打印出名称，我们可以将表单写为受控组件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      username: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;username&#125; = <span class="built_in">this</span>.state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;form onSubmit=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.handleSubmit(e)&#125;&gt;</span><br><span class="line">          &lt;label htmlFor=<span class="string">&quot;username&quot;</span>&gt;</span><br><span class="line">            用户名: </span><br><span class="line">            &lt;input type=<span class="string">&quot;text&quot;</span> </span><br><span class="line">                   id=<span class="string">&quot;username&quot;</span> </span><br><span class="line">                   onChange=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.handleUsernameChange(e)&#125; </span><br><span class="line">                   value=&#123;username&#125;/&gt;</span><br><span class="line">          &lt;/label&gt;</span><br><span class="line">          &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;提交&quot;</span>/&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">handleUsernameChange</span>(<span class="params">event</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      username: event.target.value</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">handleSubmit</span>(<span class="params">event</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.state.username);</span><br><span class="line">    event.preventDefault();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于在表单元素上设置了 <code>value</code> 属性，因此显示的值将始终为 <code>this.state.value</code>，这使得 React 的 state 成为唯一数据源。</p><p>由于 <code>handleUsernameChange</code> 在每次按键时都会执行并更新 React 的 state，因此显示的值将随着用户输入而更新。</p><h3 id="常见表单的处理"><a href="#常见表单的处理" class="headerlink" title="常见表单的处理"></a>常见表单的处理</h3><p>刚才我们演示的是一个input表单的处理，这里我们再演示一下其他的情况。</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/09001" alt="图片">表单的处理方式</p><h4 id="textarea标签"><a href="#textarea标签" class="headerlink" title="textarea标签"></a>textarea标签</h4><p>texteare标签和input比较相似：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      article: <span class="string">&quot;请编写你喜欢的文章&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;form onSubmit=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.handleSubmit(e)&#125;&gt;</span><br><span class="line">          &lt;label htmlFor=<span class="string">&quot;article&quot;</span>&gt;</span><br><span class="line">            &lt;textarea id=<span class="string">&quot;article&quot;</span> cols=<span class="string">&quot;30&quot;</span> rows=<span class="string">&quot;10&quot;</span></span><br><span class="line">                      value=&#123;<span class="built_in">this</span>.state.article&#125;</span><br><span class="line">                      onChange=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.handleArticelChange(e)&#125;/&gt;</span><br><span class="line">          &lt;/label&gt;</span><br><span class="line">          &lt;div&gt;</span><br><span class="line">            &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;发布文章&quot;</span>/&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">handleArticelChange</span>(<span class="params">event</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      article: event.target.value</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">handleSubmit</span>(<span class="params">event</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.state.article);</span><br><span class="line">    event.preventDefault();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="select标签"><a href="#select标签" class="headerlink" title="select标签"></a>select标签</h4><p>select标签的使用也非常简单，只是它不需要通过selected属性来控制哪一个被选中，它可以匹配state的value来选中。</p><p>我们来进行一个简单的演示：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      fruits: <span class="string">&quot;orange&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;form onSubmit=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.handleSubmit(e)&#125;&gt;</span><br><span class="line">          &lt;label htmlFor=<span class="string">&quot;fruits&quot;</span>&gt;</span><br><span class="line">            &lt;select id=<span class="string">&quot;fruits&quot;</span> </span><br><span class="line">                    value=&#123;<span class="built_in">this</span>.state.fruits&#125;</span><br><span class="line">                    onChange=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.handleFruitsChange(e)&#125;&gt;</span><br><span class="line">              &lt;option value=<span class="string">&quot;apple&quot;</span>&gt;苹果&lt;/option&gt;</span><br><span class="line">              &lt;option value=<span class="string">&quot;orange&quot;</span>&gt;橘子&lt;/option&gt;</span><br><span class="line">              &lt;option value=<span class="string">&quot;banana&quot;</span>&gt;香蕉&lt;/option&gt;</span><br><span class="line">            &lt;/select&gt;</span><br><span class="line">          &lt;/label&gt;</span><br><span class="line">          &lt;div&gt;</span><br><span class="line">            &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;提交&quot;</span>/&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">handleFruitsChange</span>(<span class="params">event</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      fruits: event.target.value</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">handleSubmit</span>(<span class="params">event</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.state.article);</span><br><span class="line">    event.preventDefault();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="处理多个输入"><a href="#处理多个输入" class="headerlink" title="处理多个输入"></a>处理多个输入</h4><p>多处理方式可以像单处理方式那样进行操作，但是需要多个监听方法：</p><ul><li>这里我们可以使用ES6的一个语法：计算属性名（Computed property names）</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> i = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> a = &#123;</span><br><span class="line">  [<span class="string">&#x27;foo&#x27;</span> + ++i]: i,</span><br><span class="line">  [<span class="string">&#x27;foo&#x27;</span> + ++i]: i,</span><br><span class="line">  [<span class="string">&#x27;foo&#x27;</span> + ++i]: i</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(a.foo1) <span class="comment">// 1</span></span><br><span class="line"><span class="built_in">console</span>.log(a.foo2) <span class="comment">// 2</span></span><br><span class="line"><span class="built_in">console</span>.log(a.foo3) <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> param = <span class="string">&#x27;size&#x27;</span></span><br><span class="line"><span class="keyword">let</span> config = &#123;</span><br><span class="line">  [param]: <span class="number">12</span>,</span><br><span class="line">  [<span class="string">&#x27;mobile&#x27;</span> + param.charAt(<span class="number">0</span>).toUpperCase() + param.slice(<span class="number">1</span>)]: <span class="number">4</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(config) <span class="comment">// &#123;size: 12, mobileSize: 4&#125;</span></span><br></pre></td></tr></table></figure><p>我们进行对应的代码演练</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      username: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      password: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;username, password&#125; = <span class="built_in">this</span>.state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;form onSubmit=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.handleSubmit(e)&#125;&gt;</span><br><span class="line">          &lt;label htmlFor=<span class="string">&quot;username&quot;</span>&gt;</span><br><span class="line">            用户: </span><br><span class="line">            &lt;input type=<span class="string">&quot;text&quot;</span> </span><br><span class="line">                   id=<span class="string">&quot;username&quot;</span> </span><br><span class="line">                   name=<span class="string">&quot;username&quot;</span></span><br><span class="line">                   onChange=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.handleChange(e)&#125; </span><br><span class="line">                   value=&#123;username&#125;/&gt;</span><br><span class="line">          &lt;/label&gt;</span><br><span class="line">          &lt;label htmlFor=<span class="string">&quot;password&quot;</span>&gt;</span><br><span class="line">            密码: </span><br><span class="line">            &lt;input type=<span class="string">&quot;text&quot;</span> </span><br><span class="line">                   id=<span class="string">&quot;password&quot;</span> </span><br><span class="line">                   name=<span class="string">&quot;password&quot;</span></span><br><span class="line">                   onChange=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.handleChange(e)&#125; </span><br><span class="line">                   value=&#123;password&#125;/&gt;</span><br><span class="line">          &lt;/label&gt;</span><br><span class="line">          &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;提交&quot;</span>/&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">handleChange</span>(<span class="params">event</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      [event.target.name]: event.target.value</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">handleSubmit</span>(<span class="params">event</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.state.username, <span class="built_in">this</span>.state.password);</span><br><span class="line">    event.preventDefault();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="非受控组件"><a href="#非受控组件" class="headerlink" title="非受控组件"></a>非受控组件</h2><p>React推荐大多数情况下使用 <code>受控组件</code> 来处理表单数据：</p><ul><li>一个受控组件中，表单数据是由 React 组件来管理的；</li><li>另一种替代方案是使用非受控组件，这时表单数据将交由 DOM 节点来处理；</li></ul><p>如果要使用非受控组件中的数据，那么我们需要使用 <code>ref</code> 来从DOM节点中获取表单数据。</p><p>我们来进行一个简单的演练：</p><ul><li>使用ref来获取input元素；</li><li>在非受控组件中通常使用defaultValue来设置默认值；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent, createRef &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.usernameRef = createRef();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;form onSubmit=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.handleSubmit(e)&#125;&gt;</span><br><span class="line">          &lt;label htmlFor=<span class="string">&quot;&quot;</span>&gt;</span><br><span class="line">            用户:<span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">defaultValue</span>=<span class="string">&quot;username&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">ref</span>=<span class="string">&#123;this.usernameRef&#125;/</span>&gt;</span></span></span><br><span class="line">          &lt;/label&gt;</span><br><span class="line">          &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;提交&quot;</span>/&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">handleSubmit</span>(<span class="params">event</span>)</span> &#123;</span><br><span class="line">    event.preventDefault();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.usernameRef.current.value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同样，<code>和</code> 支持 <code>defaultChecked</code>，<code>和</code> 支持 <code>defaultValue</code>。</p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列八-深入理解setState</title>
      <link href="/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%85%AB-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3setState/"/>
      <url>/blog/2020/12/15/React%E7%B3%BB%E5%88%97%E5%85%AB-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3setState/</url>
      
        <content type="html"><![CDATA[<blockquote><p>setState是React中使用频率最高的一个API（当然hooks出现之前），它的用法灵活多样，并且也是React面试题经常会考的一个知识点。</p><p>在这篇文章中，我对React的setState进行了很多解析，希望可以帮助大家真正理解setState。（其中涉及到一个源码，我有贴出，但是没有详细展开，有机会我们再对源码进行解析，大家不是很懂也不影响你的学习，只需要知道React内部是这样做的即可，面试时也可以回答出来）</p></blockquote><a id="more"></a><h2 id="setState的使用"><a href="#setState的使用" class="headerlink" title="setState的使用"></a>setState的使用</h2><h3 id="为什么使用setState"><a href="#为什么使用setState" class="headerlink" title="为什么使用setState"></a>为什么使用setState</h3><p>回到最早的案例，当点击一个 <code>改变文本</code> 的按钮时，修改界面显示的内容：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/08001" alt="图片"></p><p>案例的基础代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      message: <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;&#123;<span class="built_in">this</span>.state.message&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.changeText()&#125;&gt;改变文本&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">changeText</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>关键是changeText中应该如何实现：</strong></p><p>我们是否可以通过直接修改state中的message来修改界面呢？</p><ul><li>点击不会有任何反应，为什么呢？</li><li>因为我们修改了state之后，希望React根据最新的State来重新渲染界面，但是这种方式的修改React并不知道数据发生了变化；</li><li>React并没有实现类似于Vue2中的Object.defineProperty或者Vue3中的Proxy的方式来监听数据的变化；</li><li>我们必须通过setState来告知React数据已经发生了变化；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">changeText</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.state.message = <span class="string">&quot;你好啊,李银河&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们必须通过setState来更新数据：</p><ul><li>疑惑：在组件中并没有实现setState的方法，为什么可以调用呢？</li><li>原因很简单，setState方法是从Component中继承过来的。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Component.prototype.setState = <span class="function"><span class="keyword">function</span>(<span class="params">partialState, callback</span>) </span>&#123;</span><br><span class="line">  invariant(</span><br><span class="line">    <span class="keyword">typeof</span> partialState === <span class="string">&#x27;object&#x27;</span> ||</span><br><span class="line">      <span class="keyword">typeof</span> partialState === <span class="string">&#x27;function&#x27;</span> ||</span><br><span class="line">      partialState == <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&#x27;setState(...): takes an object of state variables to update or a &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;function which returns an object of state variables.&#x27;</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="built_in">this</span>.updater.enqueueSetState(<span class="built_in">this</span>, partialState, callback, <span class="string">&#x27;setState&#x27;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/08002" alt="图片"></p><p>所以，我们可以通过调用setState来修改数据：</p><ul><li>当我们调用setState时，会重新执行render函数，根据最新的State来创建ReactElement对象；</li><li>再根据最新的ReactElement对象，对DOM进行修改；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">changeText</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">    message: <span class="string">&quot;你好啊,李银河&quot;</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="setState异步更新"><a href="#setState异步更新" class="headerlink" title="setState异步更新"></a>setState异步更新</h3><p>我们来看下面的代码：</p><ul><li>最终打印结果是Hello World；</li><li>可见setState是异步的操作，我们并不能在执行完setState之后立马拿到最新的state的结果</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">changeText</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">    message: <span class="string">&quot;你好啊,李银河&quot;</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="built_in">this</span>.state.message); <span class="comment">// Hello World</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为什么setState设计为异步呢？</p><ul><li>setState设计为异步其实之前在GitHub上也有很多的讨论；</li><li>React核心成员（Redux的作者）Dan Abramov也有对应的回复，有兴趣的同学可以参考一下；</li><li><a href="https://github.com/facebook/react/issues/11527#issuecomment-360199710；">https://github.com/facebook/react/issues/11527#issuecomment-360199710；</a></li></ul><p>我对其回答做一个简单的总结：</p><ul><li><p><code>setState</code>设计为异步，可以显著的提升性能；</p></li><li><ul><li>如果每次调用 setState都进行一次更新，那么意味着render函数会被频繁调用，界面重新渲染，这样效率是很低的；</li><li>最好的办法应该是获取到多个更新，之后进行批量更新；</li></ul></li><li><p>如果同步更新了state，但是还没有执行render函数，那么state和props不能保持同步；</p></li><li><ul><li>state和props不能保持一致性，会在开发中产生很多的问题；</li></ul></li></ul><p>那么如何可以获取到更新后的值呢？</p><ul><li>setState接受两个参数：第二个参数是一个回调函数，这个回调函数会在更新后会执行；</li><li>格式如下：<code>setState(partialState, callback)</code></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">changeText</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">    message: <span class="string">&quot;你好啊,李银河&quot;</span></span><br><span class="line">  &#125;, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.state.message); <span class="comment">// 你好啊,李银河</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然，我们也可以在生命周期函数：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">componentDidUpdate</span>(<span class="params">prevProps, provState, snapshot</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="built_in">this</span>.state.message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="setState一定是异步？"><a href="#setState一定是异步？" class="headerlink" title="setState一定是异步？"></a>setState一定是异步？</h3><p>疑惑：setState一定是异步更新的吗？</p><p>验证一：在setTimeout中的更新：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">changeText</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      message: <span class="string">&quot;你好啊,李银河&quot;</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.state.message); <span class="comment">// 你好啊,李银河</span></span><br><span class="line">  &#125;, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>验证二：原生DOM事件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> btnEl = <span class="built_in">document</span>.getElementById(<span class="string">&quot;btn&quot;</span>);</span><br><span class="line">  btnEl.addEventListener(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      message: <span class="string">&quot;你好啊,李银河&quot;</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.state.message); <span class="comment">// 你好啊,李银河</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其实分成两种情况：</p><ul><li>在组件生命周期或React合成事件中，setState是异步；</li><li>在setTimeout或者原生dom事件中，setState是同步；</li></ul><p>React中其实是通过一个函数来确定的：enqueueSetState部分实现（react-reconciler/ReactFiberClassComponent.js）</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">enqueueSetState</span>(<span class="params">inst, payload, callback</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> fiber = getInstance(inst);</span><br><span class="line">  <span class="comment">// 会根据React上下文计算一个当前时间</span></span><br><span class="line">  <span class="keyword">const</span> currentTime = requestCurrentTimeForUpdate();</span><br><span class="line">  <span class="keyword">const</span> suspenseConfig = requestCurrentSuspenseConfig();</span><br><span class="line">  <span class="comment">// 这个函数会返回当前是同步还是异步更新（准确的说是优先级）</span></span><br><span class="line">  <span class="keyword">const</span> expirationTime = computeExpirationForFiber(</span><br><span class="line">    currentTime,</span><br><span class="line">    fiber,</span><br><span class="line">    suspenseConfig,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> update = createUpdate(expirationTime, suspenseConfig);</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/08003" alt="图片">enqueueSetState源码</p><p>computeExpirationForFiber函数的部分实现：</p><ul><li>Sync是优先级最高的，即创建就更新；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  currentTime: ExpirationTime,</span><br><span class="line">  fiber: Fiber,</span><br><span class="line">  suspenseConfig: <span class="literal">null</span> | SuspenseConfig,</span><br><span class="line">): ExpirationTime &#123;</span><br><span class="line">  <span class="keyword">const</span> mode = fiber.mode;</span><br><span class="line">  <span class="keyword">if</span> ((mode &amp; BlockingMode) === NoMode) &#123;</span><br><span class="line">    <span class="keyword">return</span> Sync;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> priorityLevel = getCurrentPriorityLevel();</span><br><span class="line">  <span class="keyword">if</span> ((mode &amp; ConcurrentMode) === NoMode) &#123;</span><br><span class="line">    <span class="keyword">return</span> priorityLevel === ImmediatePriority ? Sync : Batched;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/08004" alt="图片">computeExpirationForFiber</p><h3 id="setState的合并"><a href="#setState的合并" class="headerlink" title="setState的合并"></a>setState的合并</h3><h4 id="数据的合并"><a href="#数据的合并" class="headerlink" title="数据的合并"></a>数据的合并</h4><p>假如我们有这样的数据：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.state = &#123;</span><br><span class="line">  name: <span class="string">&quot;coderwhy&quot;</span>,</span><br><span class="line">  message: <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们需要更新message：</p><ul><li>我通过setState去修改message，是不会对name产生影响的；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">changeText</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">    message: <span class="string">&quot;你好啊,李银河&quot;</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为什么不会产生影响呢？源码中其实是有对 <code>原对象</code> 和 <code>新对象进行合并的：</code></p><ul><li>事实上就是使用 <code>Object.assign(target, ...sources)</code> 来完成的；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/08005" alt="图片">React源码合并数据</p><h4 id="多个setState合并"><a href="#多个setState合并" class="headerlink" title="多个setState合并"></a>多个setState合并</h4><p>比如我们还是有一个counter属性，记录当前的数字：</p><ul><li>如果进行如下操作，那么counter会变成几呢？答案是1；</li><li>为什么呢？因为它会对多个state进行合并；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">increment</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">    counter: <span class="built_in">this</span>.state.counter + <span class="number">1</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">    counter: <span class="built_in">this</span>.state.counter + <span class="number">1</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">    counter: <span class="built_in">this</span>.state.counter + <span class="number">1</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其实在源码的processUpdateQueue中有一个do…while循环，就是从队列中取出多个state进行合并的；</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/08006" alt="图片">React源码</p><p>如何可以做到，让counter最终变成3呢？</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">increment</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.setState(<span class="function">(<span class="params">state, props</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      counter: state.counter + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">this</span>.setState(<span class="function">(<span class="params">state, props</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      counter: state.counter + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">this</span>.setState(<span class="function">(<span class="params">state, props</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      counter: state.counter + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>为什么传入一个函数就可以变出3呢？</p><ul><li>原因是多个state进行合并时，每次遍历，都会执行一次函数：</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/08007" alt="图片">传入的函数被多次执行</p><h2 id="setState性能优化"><a href="#setState性能优化" class="headerlink" title="setState性能优化"></a>setState性能优化</h2><h3 id="React更新机制"><a href="#React更新机制" class="headerlink" title="React更新机制"></a>React更新机制</h3><p>我们在前面已经学习React的渲染流程：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/08008" alt="图片">jsx到虚拟DOM到真实DOM</p><p>那么React的更新流程呢？</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/08009" alt="图片"></p><p>React在props或state发生改变时，会调用React的render方法，会创建一颗不同的树。</p><p>React需要基于这两颗不同的树之间的差别来判断如何有效的更新UI：</p><ul><li>如果一棵树参考另外一棵树进行完全比较更新，那么即使是最先进的算法，该算法的复杂程度为 O(n 3 )，其中 n 是树中元素的数量；</li><li><a href="https://grfia.dlsi.ua.es/ml/algorithms/references/editsurvey_bille.pdf；">https://grfia.dlsi.ua.es/ml/algorithms/references/editsurvey_bille.pdf；</a></li><li>如果在 React 中使用了该算法，那么展示 1000 个元素所需要执行的计算量将在十亿的量级范围；</li><li>这个开销太过昂贵了，React的更新性能会变得非常低效；</li></ul><p>于是，React对这个算法进行了优化，将其优化成了O(n)，如何优化的呢？</p><ul><li>同层节点之间相互比较，不会垮节点比较；</li><li>不同类型的节点，产生不同的树结构；</li><li>开发中，可以通过key来指定哪些节点在不同的渲染下保持稳定；</li></ul><h3 id="Diffing算法"><a href="#Diffing算法" class="headerlink" title="Diffing算法"></a>Diffing算法</h3><h4 id="对比不同类型的元素"><a href="#对比不同类型的元素" class="headerlink" title="对比不同类型的元素"></a>对比不同类型的元素</h4><p>当节点为不同的元素，React会拆卸原有的树，并且建立起新的树：</p><ul><li>当一个元素从 <code>变成</code>，从 <code>变成</code>，或从 <code>变成</code> 都会触发一个完整的重建流程；</li><li>当卸载一棵树时，对应的DOM节点也会被销毁，组件实例将执行<code>componentWillUnmount()</code> 方法；</li><li>当建立一棵新的树时，对应的 DOM 节点会被创建以及插入到 DOM 中，组件实例将执行 <code>componentWillMount()</code> 方法，紧接着 <code>componentDidMount()</code> 方法；</li></ul><p>比如下面的代码更改：</p><ul><li>React 会销毁 <code>Counter</code> 组件并且重新装载一个新的组件，而不会对Counter进行复用；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;</span><br><span class="line">  &lt;Counter /&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;span&gt;</span><br><span class="line">  &lt;Counter /&gt;</span><br><span class="line">&lt;/span&gt;</span><br></pre></td></tr></table></figure><h4 id="对比同一类型的元素"><a href="#对比同一类型的元素" class="headerlink" title="对比同一类型的元素"></a>对比同一类型的元素</h4><p>当比对两个相同类型的 React 元素时，React 会保留 DOM 节点，仅比对及更新有改变的属性。</p><p>比如下面的代码更改：</p><ul><li>通过比对这两个元素，React 知道只需要修改 DOM 元素上的 <code>className</code> 属性；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div className=<span class="string">&quot;before&quot;</span> title=<span class="string">&quot;stuff&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">&lt;div className=<span class="string">&quot;after&quot;</span> title=<span class="string">&quot;stuff&quot;</span> /&gt;</span><br></pre></td></tr></table></figure><p>比如下面的代码更改：</p><ul><li>当更新 <code>style</code> 属性时，React 仅更新有所更变的属性。</li><li>通过比对这两个元素，React 知道只需要修改 DOM 元素上的 <code>color</code> 样式，无需修改 <code>fontWeight</code>。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div style=&#123;&#123;<span class="attr">color</span>: <span class="string">&#x27;red&#x27;</span>, <span class="attr">fontWeight</span>: <span class="string">&#x27;bold&#x27;</span>&#125;&#125; /&gt;</span><br><span class="line"></span><br><span class="line">&lt;div style=&#123;&#123;<span class="attr">color</span>: <span class="string">&#x27;green&#x27;</span>, <span class="attr">fontWeight</span>: <span class="string">&#x27;bold&#x27;</span>&#125;&#125; /&gt;</span><br></pre></td></tr></table></figure><p>如果是同类型的组件元素：</p><ul><li>组件会保持不变，React会更新该组件的props，并且调用<code>componentWillReceiveProps()</code>和 <code>componentWillUpdate()</code> 方法；</li><li>下一步，调用 <code>render()</code> 方法，diff 算法将在之前的结果以及新的结果中进行递归；</li></ul><h4 id="对子节点进行递归"><a href="#对子节点进行递归" class="headerlink" title="对子节点进行递归"></a>对子节点进行递归</h4><p>在默认条件下，当递归 DOM 节点的子元素时，React 会同时遍历两个子元素的列表；当产生差异时，生成一个 mutation。</p><p>我们来看一下在最后插入一条数据的情况：</p><ul><li>前面两个比较是完全相同的，所以不会产生mutation；</li><li>最后一个比较，产生一个mutation，将其插入到新的DOM树中即可；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul&gt;</span><br><span class="line">  &lt;li&gt;first&lt;/li&gt;</span><br><span class="line">  &lt;li&gt;second&lt;/li&gt;</span><br><span class="line">&lt;/ul&gt;</span><br><span class="line"></span><br><span class="line">&lt;ul&gt;</span><br><span class="line">  &lt;li&gt;first&lt;/li&gt;</span><br><span class="line">  &lt;li&gt;second&lt;/li&gt;</span><br><span class="line">  &lt;li&gt;third&lt;/li&gt;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure><p>但是如果我们是在中间插入一条数据：</p><ul><li>React会对每一个子元素产生一个mutation，而不是保持 <code>星际穿越</code>和<code>盗梦空间</code>的不变；</li><li>这种低效的比较方式会带来一定的性能问题；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul&gt;</span><br><span class="line">  &lt;li&gt;星际穿越&lt;/li&gt;</span><br><span class="line">  &lt;li&gt;盗梦空间&lt;/li&gt;</span><br><span class="line">&lt;/ul&gt;</span><br><span class="line"></span><br><span class="line">&lt;ul&gt;</span><br><span class="line">  &lt;li&gt;大话西游&lt;/li&gt;</span><br><span class="line">  &lt;li&gt;星际穿越&lt;/li&gt;</span><br><span class="line">  &lt;li&gt;盗梦空间&lt;/li&gt;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure><h3 id="keys的优化"><a href="#keys的优化" class="headerlink" title="keys的优化"></a>keys的优化</h3><p>我们在前面遍历列表时，总是会提示一个警告，让我们加入一个key属性：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/08010" alt="图片">key的警告</p><p>我们来看一个案例：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      movies: [<span class="string">&quot;星际穿越&quot;</span>, <span class="string">&quot;盗梦空间&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;电影列表&lt;/h2&gt;</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">this</span>.state.movies.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;item&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.insertMovie()&#125;&gt;插入数据&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">insertMovie</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>方式一：在最后位置插入数据</p><ul><li>这种情况，有无key意义并不大</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">insertMovie</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> newMovies = [...this.state.movies, <span class="string">&quot;大话西游&quot;</span>];</span><br><span class="line">  <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">    movies: newMovies</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>方式二：在前面插入数据</p><ul><li>这种做法，在没有key的情况下，所有的li都需要进行修改；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">insertMovie</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> newMovies = [<span class="string">&quot;大话西游&quot;</span>, ...this.state.movies];</span><br><span class="line">  <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">    movies: newMovies</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当子元素(这里的li)拥有 key 时，React 使用 key 来匹配原有树上的子元素以及最新树上的子元素：</p><ul><li>在下面这种场景下，key为111和222的元素仅仅进行位移，不需要进行任何的修改；</li><li>将key为333的元素插入到最前面的位置即可；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul&gt;</span><br><span class="line">  &lt;li key=<span class="string">&quot;111&quot;</span>&gt;星际穿越&lt;/li&gt;</span><br><span class="line">  &lt;li key=<span class="string">&quot;222&quot;</span>&gt;盗梦空间&lt;/li&gt;</span><br><span class="line">&lt;/ul&gt;</span><br><span class="line"></span><br><span class="line">&lt;ul&gt;</span><br><span class="line">  &lt;li key=<span class="string">&quot;333&quot;</span>&gt;Connecticut&lt;/li&gt;</span><br><span class="line">  &lt;li key=<span class="string">&quot;111&quot;</span>&gt;星际穿越&lt;/li&gt;</span><br><span class="line">  &lt;li key=<span class="string">&quot;222&quot;</span>&gt;盗梦空间&lt;/li&gt;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure><p>key的注意事项：</p><ul><li>key应该是唯一的；</li><li>key不要使用随机数（随机数在下一次render时，会重新生成一个数字）；</li><li>使用index作为key，对性能是没有优化的；</li></ul><h3 id="SCU的优化"><a href="#SCU的优化" class="headerlink" title="SCU的优化"></a>SCU的优化</h3><h4 id="render函数被调用"><a href="#render函数被调用" class="headerlink" title="render函数被调用"></a>render函数被调用</h4><p>我们使用之前的一个嵌套案例：</p><ul><li>在App中，我们增加了一个计数器的代码；</li><li>当点击+1时，会重新调用App的render函数；</li><li>而当App的render函数被调用时，所有的子组件的render函数都会被重新调用；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Header</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;Header Render 被调用&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Header<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Main Render 被调用&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Banner/&gt;</span><br><span class="line">        &lt;ProductList/&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Banner</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;Banner Render 被调用&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Banner<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProductList</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;ProductList Render 被调用&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &lt;li&gt;商品<span class="number">1</span>&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;商品<span class="number">2</span>&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;商品<span class="number">3</span>&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;商品<span class="number">4</span>&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;商品<span class="number">5</span>&lt;/li&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Footer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;Footer Render 被调用&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Footer<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      counter: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;App Render 被调用&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;当前计数: &#123;<span class="built_in">this</span>.state.counter&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.increment()&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">        &lt;Header/&gt;</span><br><span class="line">        &lt;Main/&gt;</span><br><span class="line">        &lt;Footer/&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">increment</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      counter: <span class="built_in">this</span>.state.counter + <span class="number">1</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/08011" alt="图片">嵌套树结构</p><p>那么，我们可以思考一下，在以后的开发中，我们只要是修改了App中的数据，所有的组件都需要重新render，进行diff算法，性能必然是很低的：</p><ul><li>事实上，很多的组件没有必须要重新render；</li><li>它们调用render应该有一个前提，就是依赖的数据（state、props）发生改变时，再调用自己的render方法；</li></ul><p>如何来控制render方法是否被调用呢？</p><ul><li>通过<code>shouldComponentUpdate</code>方法即可；</li></ul><h4 id="shouldComponentUpdate"><a href="#shouldComponentUpdate" class="headerlink" title="shouldComponentUpdate"></a>shouldComponentUpdate</h4><p>React给我们提供了一个生命周期方法 <code>shouldComponentUpdate</code>（很多时候，我们简称为SCU），这个方法接受参数，并且需要有返回值：</p><ul><li><p>该方法有两个参数：</p></li><li><ul><li>参数一：nextProps 修改之后，最新的props属性</li><li>参数二：nextState 修改之后，最新的state属性</li></ul></li><li><p>该方法返回值是一个boolean类型</p></li><li><ul><li>返回值为true，那么就需要调用render方法；</li><li>返回值为false，那么久不需要调用render方法；</li><li>默认返回的是true，也就是只要state发生改变，就会调用render方法；</li></ul></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">shouldComponentUpdate</span>(<span class="params">nextProps, nextState</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们可以控制它返回的内容，来决定是否需要重新渲染。</p><p>比如我们在App中增加一个message属性：</p><ul><li>jsx中并没有依赖这个message，那么它的改变不应该引起重新渲染；</li><li>但是因为render监听到state的改变，就会重新render，所以最后render方法还是被重新调用了；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      counter: <span class="number">0</span>,</span><br><span class="line">      message: <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;App Render 被调用&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;当前计数: &#123;<span class="built_in">this</span>.state.counter&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.increment()&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.changeText()&#125;&gt;改变文本&lt;/button&gt;</span><br><span class="line">        &lt;Header/&gt;</span><br><span class="line">        &lt;Main/&gt;</span><br><span class="line">        &lt;Footer/&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">increment</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      counter: <span class="built_in">this</span>.state.counter + <span class="number">1</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">changeText</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      message: <span class="string">&quot;你好啊,李银河&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个时候，我们可以通过实现shouldComponentUpdate来决定要不要重新调用render方法：</p><ul><li>这个时候，我们改变counter时，会重新渲染；</li><li>如果，我们改变的是message，那么默认返回的是false，那么就不会重新渲染；</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">shouldComponentUpdate(nextProps, nextState) &#123;</span><br><span class="line">  if (nextState.counter !&#x3D;&#x3D; this.state.counter) &#123;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是我们的代码依然没有优化到最好，因为当counter改变时，所有的子组件依然重新渲染了：</p><ul><li>所以，事实上，我们应该实现所有的子组件的shouldComponentUpdate；</li></ul><p>比如Main组件，可以进行如下实现：</p><ul><li><code>shouldComponentUpdate</code>默认返回一个false；</li><li>在特定情况下，需要更新时，我们在上面添加对应的条件即可；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">shouldComponentUpdate</span>(<span class="params">nextProps, nextState</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Main Render 被调用&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Banner/&gt;</span><br><span class="line">        &lt;ProductList/&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="PureComponent和memo"><a href="#PureComponent和memo" class="headerlink" title="PureComponent和memo"></a>PureComponent和memo</h4><p>如果所有的类，我们都需要手动来实现 shouldComponentUpdate，那么会给我们开发者增加非常多的工作量。</p><p>我们来设想一下shouldComponentUpdate中的各种判断的目的是什么？</p><ul><li>props或者state中的数据是否发生了改变，来决定shouldComponentUpdate返回true或者false；</li></ul><p>事实上React已经考虑到了这一点，所以React已经默认帮我们实现好了，如何实现呢？</p><ul><li>将class基础自PureComponent。</li></ul><p>比如我们修改Main组件的代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Main Render 被调用&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Banner/&gt;</span><br><span class="line">        &lt;ProductList/&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PureComponent的原理是什么呢？</p><ul><li>对props和state进行浅层比较；</li></ul><p><strong>查看PureComponent相关的源码：</strong></p><p>react/ReactBaseClasses.js中：</p><ul><li>在PureComponent的原型上增加一个isPureReactComponent为true的属性</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/08012" alt="图片">PureComponent</p><p>React-reconcilier/ReactFiberClassComponent.js：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/08013" alt="图片">checkShouldComponentUpdate</p><p>这个方法中，调用 <code>!shallowEqual(oldProps, newProps) || !shallowEqual(oldState, newState)</code>，这个shallowEqual就是进行浅层比较：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/08014" alt="图片">shallowEqual</p><p><strong>那么，如果是一个函数式组件呢？</strong></p><p>我们需要使用一个高阶组件memo：</p><ul><li>我们将之前的Header、Banner、ProductList都通过memo函数进行一层包裹；</li><li>Footer没有使用memo函数进行包裹；</li><li>最终的效果是，当counter发生改变时，Header、Banner、ProductList的函数不会重新执行，而Footer的函数会被重新执行；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component, PureComponent, memo &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> MemoHeader = memo(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;Header Render 被调用&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Header<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Main Render 被调用&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;MemoBanner/&gt;</span><br><span class="line">        &lt;MemoProductList/&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> MemoBanner = memo(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;Banner Render 被调用&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Banner<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> MemoProductList = memo(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;ProductList Render 被调用&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &lt;li&gt;商品<span class="number">1</span>&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;商品<span class="number">2</span>&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;商品<span class="number">3</span>&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;商品<span class="number">4</span>&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;商品<span class="number">5</span>&lt;/li&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Footer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;Footer Render 被调用&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Footer<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      counter: <span class="number">0</span>,</span><br><span class="line">      message: <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;App Render 被调用&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;当前计数: &#123;<span class="built_in">this</span>.state.counter&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.increment()&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.changeText()&#125;&gt;改变文本&lt;/button&gt;</span><br><span class="line">        &lt;MemoHeader/&gt;</span><br><span class="line">        &lt;Main/&gt;</span><br><span class="line">        &lt;Footer/&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">increment</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      counter: <span class="built_in">this</span>.state.counter + <span class="number">1</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">shouldComponentUpdate</span>(<span class="params">nextProps, nextState</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextState.counter !== <span class="built_in">this</span>.state.counter) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">changeText</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      message: <span class="string">&quot;你好啊,李银河&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>memo的原理是什么呢？</strong></p><p>react/memo.js：</p><ul><li>最终返回一个对象，这个对象中有一个compare函数</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/08015" alt="图片">memo函数</p><h4 id="不可变数据的力量"><a href="#不可变数据的力量" class="headerlink" title="不可变数据的力量"></a>不可变数据的力量</h4><p>我们通过一个案例来演练我们之前说的不可变数据的重要性：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      friends: [</span><br><span class="line">        &#123; <span class="attr">name</span>: <span class="string">&quot;lilei&quot;</span>, <span class="attr">age</span>: <span class="number">20</span>, <span class="attr">height</span>: <span class="number">1.76</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">name</span>: <span class="string">&quot;lucy&quot;</span>, <span class="attr">age</span>: <span class="number">18</span>, <span class="attr">height</span>: <span class="number">1.65</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">name</span>: <span class="string">&quot;tom&quot;</span>, <span class="attr">age</span>: <span class="number">30</span>, <span class="attr">height</span>: <span class="number">1.78</span> &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;朋友列表&lt;/h2&gt;</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">this</span>.state.friends.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">return</span> (</span><br><span class="line">                &lt;li key=&#123;item.name&#125;&gt;</span><br><span class="line">                  &lt;span&gt;&#123;<span class="string">`姓名:<span class="subst">$&#123;item.name&#125;</span> 年龄: <span class="subst">$&#123;item.age&#125;</span>`</span>&#125;&lt;/span&gt;</span><br><span class="line">                  &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.incrementAge(index)&#125;&gt;年龄+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">                &lt;/li&gt;</span><br><span class="line">              )</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.insertFriend()&#125;&gt;添加新数据&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">insertFriend</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">     </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">incrementAge</span>(<span class="params">index</span>)</span> &#123;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>我们来思考一下inertFriend应该如何实现？</strong></p><p>实现方式一：</p><ul><li>这种方式会造成界面不会发生刷新，添加新的数据；</li><li>原因是继承自PureComponent，会进行浅层比较，浅层比较过程中两个friends是相同的对象；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">insertFriend</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.state.friends.push(&#123;<span class="attr">name</span>: <span class="string">&quot;why&quot;</span>, <span class="attr">age</span>: <span class="number">18</span>, <span class="attr">height</span>: <span class="number">1.88</span>&#125;);</span><br><span class="line">  <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">    friends: <span class="built_in">this</span>.state.friends</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现方式二：</p><ul><li><code>[...this.state.friends, &#123;name: &quot;why&quot;, age: 18, height: 1.88&#125;]</code>会生成一个新的数组引用；</li><li>在进行浅层比较时，两个引用的是不同的数组，所以它们是不相同的；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">insertFriend</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">    friends: [...this.state.friends, &#123;<span class="attr">name</span>: <span class="string">&quot;why&quot;</span>, <span class="attr">age</span>: <span class="number">18</span>, <span class="attr">height</span>: <span class="number">1.88</span>&#125;]</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>我们再来思考一下incrementAge应该如何实现？</strong></p><p>实现方式一：</p><ul><li>和上面方式一类似</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">incrementAge</span>(<span class="params">index</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.state.friends[index].age += <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">    friends: <span class="built_in">this</span>.state.friends</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现方式二：</p><ul><li>和上面方式二类似</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">incrementAge</span>(<span class="params">index</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> newFriends = [...this.state.friends];</span><br><span class="line">  newFriends[index].age += <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">    friends: newFriends</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以，在真实开发中，我们要尽量保证state、props中的数据不可变性，这样我们才能合理和安全的使用PureComponent和memo。</p><p>当然，后面项目中我会结合immutable.js来保证数据的不可变性。</p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列七-非父子组件通信</title>
      <link href="/blog/2020/12/14/React%E7%B3%BB%E5%88%97%E4%B8%83-%E9%9D%9E%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1/"/>
      <url>/blog/2020/12/14/React%E7%B3%BB%E5%88%97%E4%B8%83-%E9%9D%9E%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1/</url>
      
        <content type="html"><![CDATA[<h2 id="Context使用"><a href="#Context使用" class="headerlink" title="Context使用"></a>Context使用</h2><h3 id="Context应用场景"><a href="#Context应用场景" class="headerlink" title="Context应用场景"></a>Context应用场景</h3><p>非父子组件数据的共享：</p><ul><li>在开发中，比较常见的数据传递方式是通过props属性自上而下（由父到子）进行传递。</li><li>但是对于有一些场景：比如一些数据需要在多个组件中进行共享（地区偏好、UI主题、用户登录状态、用户信息等）。</li><li>如果我们在顶层的App中定义这些信息，之后一层层传递下去，那么对于一些中间层不需要数据的组件来说，是一种冗余的操作。</li></ul><a id="more"></a><p>我们来看一个例子：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfileHeader</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;用户昵称: &#123;props.nickname&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;h2&gt;用户等级: &#123;props.level&#125;&lt;/h2&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;ProfileHeader nickname=&#123;<span class="built_in">this</span>.props.nickname&#125; level=&#123;<span class="built_in">this</span>.props.level&#125; /&gt;</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">          &lt;li&gt;设置<span class="number">1</span>&lt;/li&gt;</span><br><span class="line">          &lt;li&gt;设置<span class="number">2</span>&lt;/li&gt;</span><br><span class="line">          &lt;li&gt;设置<span class="number">3</span>&lt;/li&gt;</span><br><span class="line">          &lt;li&gt;设置<span class="number">4</span>&lt;/li&gt;</span><br><span class="line">          &lt;li&gt;设置<span class="number">5</span>&lt;/li&gt;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      nickname: <span class="string">&quot;coderwhy&quot;</span>,</span><br><span class="line">      level: <span class="number">99</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; nickname, level &#125; = <span class="built_in">this</span>.state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Profile nickname=&#123;nickname&#125; level=&#123;level&#125; /&gt;</span><br><span class="line">        &lt;h2&gt;其他内容&lt;/h2&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我这边顺便补充一个小的知识点：Spread Attributes</p><ul><li><a href="https://zh-hans.reactjs.org/docs/jsx-in-depth.html">https://zh-hans.reactjs.org/docs/jsx-in-depth.html</a></li></ul><p>下面两种写法是等价的：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Greeting</span> <span class="attr">firstName</span>=<span class="string">&quot;Ben&quot;</span> <span class="attr">lastName</span>=<span class="string">&quot;Hector&quot;</span> /&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> props = &#123;<span class="attr">firstName</span>: <span class="string">&#x27;Ben&#x27;</span>, <span class="attr">lastName</span>: <span class="string">&#x27;Hector&#x27;</span>&#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Greeting</span> &#123;<span class="attr">...props</span>&#125; /&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么我们上面的Profile的传递代码可以修改为如下代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;ProfileHeader &#123;...this.props&#125;/&gt;</span><br></pre></td></tr></table></figure><p>但是，如果层级更多的话，一层层传递是非常麻烦，并且代码是非常冗余的：</p><ul><li>React提供了一个API：Context；</li><li>Context 提供了一种在组件之间共享此类值的方式，而不必显式地通过组件树的逐层传递 props；</li><li>Context 设计目的是为了共享那些对于一个组件树而言是“全局”的数据，例如当前认证的用户、主题或首选语言；</li></ul><h3 id="Context相关的API"><a href="#Context相关的API" class="headerlink" title="Context相关的API"></a>Context相关的API</h3><p><strong>React.createContext</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MyContext = React.createContext(defaultValue);</span><br></pre></td></tr></table></figure><p>创建一个需要共享的Context对象：</p><ul><li>如果一个组件订阅了Context，那么这个组件会从离自身最近的那个匹配的 <code>Provider</code> 中读取到当前的context值；</li><li>defaultValue是组件在顶层查找过程中没有找到对应的<code>Provider</code>，那么就使用默认值</li></ul><p><strong>Context.Provider</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;MyContext.Provider value=&#123;<span class="comment">/* 某个值 */</span>&#125;&gt;</span><br></pre></td></tr></table></figure><p>每个 Context 对象都会返回一个 Provider React 组件，它允许消费组件订阅 context 的变化：</p><ul><li>Provider 接收一个 <code>value</code> 属性，传递给消费组件；</li><li>一个 Provider 可以和多个消费组件有对应关系；</li><li>多个 Provider 也可以嵌套使用，里层的会覆盖外层的数据；</li></ul><p>当 Provider 的 <code>value</code> 值发生变化时，它内部的所有消费组件都会重新渲染；</p><p><strong>Class.contextType</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> value = <span class="built_in">this</span>.context;</span><br><span class="line">    <span class="comment">/* 在组件挂载完成后，使用 MyContext 组件的值来执行一些有副作用的操作 */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">componentDidUpdate</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> value = <span class="built_in">this</span>.context;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">componentWillUnmount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> value = <span class="built_in">this</span>.context;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> value = <span class="built_in">this</span>.context;</span><br><span class="line">    <span class="comment">/* 基于 MyContext 组件的值进行渲染 */</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">MyClass.contextType = MyContext;</span><br></pre></td></tr></table></figure><p>挂载在 class 上的 <code>contextType</code> 属性会被重赋值为一个由 <code>React.createContext()</code> 创建的 Context 对象：</p><ul><li>这能让你使用 <code>this.context</code> 来消费最近 Context 上的那个值；</li><li>你可以在任何生命周期中访问到它，包括 render 函数中；</li></ul><p><strong>Context.Consumer</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;MyContext.Consumer&gt;</span><br><span class="line">  &#123;<span class="function"><span class="params">value</span> =&gt;</span> <span class="comment">/* 基于 context 值进行渲染*/</span>&#125;</span><br><span class="line">&lt;/MyContext.Consumer&gt;</span><br></pre></td></tr></table></figure><p>这里，React 组件也可以订阅到 context 变更。这能让你在 <code>函数式组件</code> 中完成订阅 context。</p><ul><li>这里需要 函数作为子元素（function as child）这种做法；</li><li>这个函数接收当前的 context 值，返回一个 React 节点；</li></ul><h3 id="Context使用过程"><a href="#Context使用过程" class="headerlink" title="Context使用过程"></a>Context使用过程</h3><p>我们先按照前面三个步骤来使用一个Context：</p><ul><li>我们就会发现，这个过程中Profile是不需要有任何的数据传递的</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UserContext = React.createContext(&#123; <span class="attr">nickname</span>: <span class="string">&quot;默认&quot;</span>, <span class="attr">level</span>: -<span class="number">1</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProfileHeader</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;用户昵称: &#123;<span class="built_in">this</span>.context.nickname&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;h2&gt;用户等级: &#123;<span class="built_in">this</span>.context.level&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ProfileHeader.contextType = UserContext;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;ProfileHeader /&gt;</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">          &lt;li&gt;设置<span class="number">1</span>&lt;/li&gt;</span><br><span class="line">          &lt;li&gt;设置<span class="number">2</span>&lt;/li&gt;</span><br><span class="line">          &lt;li&gt;设置<span class="number">3</span>&lt;/li&gt;</span><br><span class="line">          &lt;li&gt;设置<span class="number">4</span>&lt;/li&gt;</span><br><span class="line">          &lt;li&gt;设置<span class="number">5</span>&lt;/li&gt;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;UserContext.Provider value=&#123;&#123; <span class="attr">nickname</span>: <span class="string">&quot;why&quot;</span>, <span class="attr">level</span>: <span class="number">99</span> &#125;&#125;&gt;</span><br><span class="line">          &lt;Profile /&gt;</span><br><span class="line">        &lt;/UserContext.Provider&gt;</span><br><span class="line">        &lt;h2&gt;其他内容&lt;/h2&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>什么时候使用默认值defaultValue呢？</strong>如果出现了如下代码：</p><ul><li><code>`并没有作为</code>UserContext.Provider` 的子组件；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Profile /&gt;</span><br><span class="line">&lt;UserContext.Provider value=&#123;&#123; <span class="attr">nickname</span>: <span class="string">&quot;why&quot;</span>, <span class="attr">level</span>: <span class="number">99</span> &#125;&#125;&gt;</span><br><span class="line">&lt;/UserContext.Provider&gt;</span><br></pre></td></tr></table></figure><p><strong>什么时候使用Context.Consumer呢？</strong></p><ul><li>1.当使用value的组件是一个函数式组件时；</li><li>2.当组件中需要使用多个Context时；</li></ul><p>演练一：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfileHeader</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;UserContext.Consumer&gt;</span><br><span class="line">        &#123;<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">              &lt;h2&gt;用户昵称: &#123;value.nickname&#125;&lt;/h2&gt;</span><br><span class="line">              &lt;h2&gt;用户等级: &#123;value.level&#125;&lt;/h2&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">          )</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      &lt;/UserContext.Consumer&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>演练二：当使用value的组件是一个函数式组件时；</p><p>1.创建一个新的Context</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ThemeContext = React.createContext(&#123; <span class="attr">color</span>: <span class="string">&quot;black&quot;</span> &#125;);</span><br></pre></td></tr></table></figure><p>2.Provider的嵌套</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;UserContext.Provider value=&#123;&#123; <span class="attr">nickname</span>: <span class="string">&quot;why&quot;</span>, <span class="attr">level</span>: <span class="number">99</span> &#125;&#125;&gt;</span><br><span class="line">  &lt;ThemeContext.Provider value=&#123;&#123;<span class="attr">color</span>: <span class="string">&quot;red&quot;</span>&#125;&#125;&gt;</span><br><span class="line">    &lt;Profile /&gt;</span><br><span class="line">  &lt;/ThemeContext.Provider&gt;</span><br><span class="line">&lt;/UserContext.Provider&gt;</span><br></pre></td></tr></table></figure><p>3.使用Consumer的嵌套</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;UserContext.Consumer&gt;</span><br><span class="line">  &#123;<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;ThemeContext.Consumer&gt;</span><br><span class="line">        &#123;</span><br><span class="line">          theme =&gt; (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">              &lt;h2 style=&#123;theme&#125;&gt;用户昵称: &#123;value.nickname&#125;&lt;/h2&gt;</span><br><span class="line">              &lt;h2 style=&#123;theme&#125;&gt;用户等级: &#123;value.level&#125;&lt;/h2&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &lt;/ThemeContext.Consumer&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&lt;/UserContext.Consumer&gt;</span><br></pre></td></tr></table></figure><p>更多用法可以参考官网：<a href="https://zh-hans.reactjs.org/docs/context.html">https://zh-hans.reactjs.org/docs/context.html</a></p><p>后续我们会学习Redux来进行全局的状态管理。</p><h2 id="事件总线"><a href="#事件总线" class="headerlink" title="事件总线"></a>事件总线</h2><h3 id="事件总线的概述"><a href="#事件总线的概述" class="headerlink" title="事件总线的概述"></a>事件总线的概述</h3><p>前面通过Context主要实现的是数据的共享，但是在开发中如果有跨组件之间的事件传递，应该如何操作呢？</p><ul><li>在Vue中我们可以通过Vue的实例，快速实现一个事件总线（EventBus），来完成操作；</li><li>在React中，我们可以依赖一个使用较多的库 <code>events</code> 来完成对应的操作；</li></ul><p>我们可以通过npm或者yarn来安装events：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add events;</span><br></pre></td></tr></table></figure><p>events常用的API：</p><ul><li>创建EventEmitter对象：eventBus对象；</li><li>发出事件：<code>eventBus.emit(&quot;事件名称&quot;, 参数列表);</code></li><li>监听事件：<code>eventBus.addListener(&quot;事件名称&quot;, 监听函数)</code>；</li><li>移除事件：<code>eventBus.removeListener(&quot;事件名称&quot;, 监听函数)</code>；</li></ul><h3 id="2-2-案例演练"><a href="#2-2-案例演练" class="headerlink" title="2.2. 案例演练"></a>2.2. 案例演练</h3><p>我们通过一个案例来进行演练：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; EventEmitter &#125; <span class="keyword">from</span> <span class="string">&quot;events&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> eventBus = <span class="keyword">new</span> EventEmitter();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProfileHeader</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.btnClick()&#125;&gt;按钮&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">btnClick</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    eventBus.emit(<span class="string">&quot;headerClick&quot;</span>, <span class="string">&quot;why&quot;</span>, <span class="number">18</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;ProfileHeader /&gt;</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">          &lt;li&gt;设置<span class="number">1</span>&lt;/li&gt;</span><br><span class="line">          &lt;li&gt;设置<span class="number">2</span>&lt;/li&gt;</span><br><span class="line">          &lt;li&gt;设置<span class="number">3</span>&lt;/li&gt;</span><br><span class="line">          &lt;li&gt;设置<span class="number">4</span>&lt;/li&gt;</span><br><span class="line">          &lt;li&gt;设置<span class="number">5</span>&lt;/li&gt;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    eventBus.addListener(<span class="string">&quot;headerClick&quot;</span>, <span class="built_in">this</span>.headerClick)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">headerClick</span>(<span class="params">name, age</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, age);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentWillUnmount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    eventBus.removeListener(<span class="string">&quot;headerClick&quot;</span>, <span class="built_in">this</span>.headerClick);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Profile/&gt;</span><br><span class="line">        &lt;h2&gt;其他内容&lt;/h2&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="临时知识补充"><a href="#临时知识补充" class="headerlink" title="临时知识补充"></a>临时知识补充</h2><h3 id="为什么constructor中不是必须传入props也能使用"><a href="#为什么constructor中不是必须传入props也能使用" class="headerlink" title="为什么constructor中不是必须传入props也能使用"></a>为什么constructor中不是必须传入props也能使用</h3><p>在进行React开发中，有一个很奇怪的现象：</p><ul><li>在调用super()的时候，我没有传入props，但是在下面的render函数中我依然可以使用；</li><li>如果你自己编写一个基础的类，可以尝试一下：这种情况props应该是undefined的；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChildCpn</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;name, age, height&#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;h2&gt;子组件展示数据: &#123;name + <span class="string">&quot; &quot;</span> + age + <span class="string">&quot; &quot;</span> + height&#125;&lt;/h2&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为什么这么神奇呢？</p><ul><li>我一直喜欢说：计算机中没有黑魔法；</li><li>之所以可以，恰恰是因为React担心你的代码会出现上面这种写法而进行了一些 <code>骚操作</code>；</li><li>React不管你有没有通过super将props设置到当前的对象中，它都会重新给你设置一遍；</li></ul><p>如何验证呢？</p><ul><li>这就需要通过源码来验证了；</li><li>React的源码packages中有提供一个Test Renderer的package；</li><li>这个 package 提供了一个 React 渲染器，用于将 React 组件渲染成纯 JavaScript 对象，不需要依赖 DOM 或原生移动环境；</li></ul><p>查看源码：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/07001" alt="图片">源码位置</p><p>我们来看一下这个组件是怎么被创建出来的：</p><ul><li>我们找到其中的render函数；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/07002" alt="图片">render函数</p><ul><li><p>render函数中有这样的一段代码；</p></li><li><ul><li>这个_instance实例就是组件对象；</li></ul></li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/07003" alt="图片">创建_instance实例</p><ul><li><p>我们再看一下，它在哪里重新赋值的：</p></li><li><ul><li>这里还包括通过this._instance的方式回调生命周期函数；</li></ul></li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/07004" alt="图片">重新赋值的地方</p><p><strong>结论：你无论是否手动的将props保存到组件的实例上，React内部都会帮你保存的，我只能说：骚操作；</strong></p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列六-父子组件通信</title>
      <link href="/blog/2020/12/14/React%E7%B3%BB%E5%88%97%E5%85%AD-%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1/"/>
      <url>/blog/2020/12/14/React%E7%B3%BB%E5%88%97%E5%85%AD-%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1/</url>
      
        <content type="html"><![CDATA[<h2 id="认识组件的嵌套"><a href="#认识组件的嵌套" class="headerlink" title="认识组件的嵌套"></a>认识组件的嵌套</h2><p>组件之间存在嵌套关系：</p><ul><li>在之前的案例中，我们只是创建了一个组件App；</li><li>如果我们一个应用程序将所有的逻辑都放在一个组件中，那么这个组件就会变成非常的臃肿和难以维护；</li><li>所以组件化的核心思想应该是对组件进行拆分，拆分成一个个小的组件；</li><li>再将这些组件组合嵌套在一起，最终形成我们的应用程序；</li></ul><p>我们来分析一下下面代码的嵌套逻辑：</p><a id="more"></a><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Header</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Header<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Banner/&gt;</span><br><span class="line">      &lt;ProductList/&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Banner</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Banner<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProductList</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &lt;li&gt;商品<span class="number">1</span>&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;商品<span class="number">2</span>&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;商品<span class="number">3</span>&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;商品<span class="number">4</span>&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;商品<span class="number">5</span>&lt;/li&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Footer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Footer<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Header/&gt;</span><br><span class="line">        &lt;Main/&gt;</span><br><span class="line">        &lt;Footer/&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的嵌套逻辑如下，它们存在如下关系：</p><ul><li>App组件是Header、Main、Footer组件的父组件；</li><li>Main组件是Banner、ProductList组件的父组件；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/06001" alt="图片">自定义组件的嵌套逻辑</p><p>在开发过程中，我们会经常遇到需要组件之间相互进行通信：</p><ul><li>比如App可能使用了多个Header，每个地方的Header展示的内容不同，那么我们就需要使用者传递给Header一些数据，让其进行展示；</li><li>又比如我们在Main中一次性请求了Banner数据和ProductList数据，那么就需要传递给他们来进行展示；</li><li>也可能是子组件中发生了事件，需要由父组件来完成某些操作，那就需要子组件向父组件传递事件；</li></ul><p>总之，在一个React项目中，组件之间的通信是非常重要的环节；</p><p>父组件在展示子组件，可能会传递一些数据给子组件：</p><ul><li>父组件通过 <strong>属性=值</strong> 的形式来传递给子组件数据；</li><li>子组件通过 <strong>props</strong> 参数获取父组件传递过来的数据；</li></ul><h2 id="父组件传递子组件"><a href="#父组件传递子组件" class="headerlink" title="父组件传递子组件"></a>父组件传递子组件</h2><h3 id="子组件是class组件"><a href="#子组件是class组件" class="headerlink" title="子组件是class组件"></a>子组件是class组件</h3><p>我们这里先演示子组件是class组件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.类子组件</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChildCpn1</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    <span class="built_in">this</span>.props = props;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; name, age, height &#125; = <span class="built_in">this</span>.props;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;我是<span class="class"><span class="keyword">class</span>的组件&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line">        &lt;p&gt;展示父组件传递过来的数据: &#123;name + &quot; &quot; + age + &quot; &quot; + height&#125;&lt;/p&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;ChildCpn1 name=<span class="string">&quot;why&quot;</span> age=<span class="string">&quot;18&quot;</span> height=<span class="string">&quot;1.88&quot;</span> /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>按照上面的结构，我们每一个子组件都需要写构造器来完成：<code>this.props = props;</code></p><p>其实呢，大可不必，因为我们可以调用<code>super(props)</code>，我们来看一下Component的源码：</p><ul><li>这里我们先不关心context、updater；</li><li>我们发现传入的props会被Component设置到this中（父类的对象），那么子类就可以继承过来；</li><li>补充一个思考题：为什么子类可以继承过来呢？</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Component</span>(<span class="params">props, context, updater</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.props = props;</span><br><span class="line">  <span class="built_in">this</span>.context = context;</span><br><span class="line">  <span class="comment">// If a component has string refs, we will assign a different object later.</span></span><br><span class="line">  <span class="built_in">this</span>.refs = emptyObject;</span><br><span class="line">  <span class="comment">// We initialize the default updater but the real one gets injected by the</span></span><br><span class="line">  <span class="comment">// renderer.</span></span><br><span class="line">  <span class="built_in">this</span>.updater = updater || ReactNoopUpdateQueue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以我们的构造方法可以换成下面的写法：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">super</span>(props);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>甚至我们可以省略，为什么可以省略呢？</p><p>如果不指定构造方法，则使用默认构造函数。对于基类，默认构造函数是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">constructor() &#123;&#125;</span><br></pre></td></tr></table></figure><p>对于派生类，默认构造函数是：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">constructor</span>(<span class="params">...args</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">super</span>(...args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="子组件是function组件"><a href="#子组件是function组件" class="headerlink" title="子组件是function组件"></a>子组件是function组件</h3><p>我们再来演练一下，如果子组件是一个function组件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ChildCpn2</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;name, age, height&#125; = props;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2&gt;我是<span class="function"><span class="keyword">function</span>的组件&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line"><span class="function">      &lt;<span class="title">p</span>&gt;展示父组件传递过来的数据: </span>&#123;name + <span class="string">&quot; &quot;</span> + age + <span class="string">&quot; &quot;</span> + height&#125;&lt;/p&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;ChildCpn1 name=<span class="string">&quot;why&quot;</span> age=<span class="string">&quot;18&quot;</span> height=<span class="string">&quot;1.88&quot;</span>/&gt;</span><br><span class="line">        &lt;ChildCpn2 name=<span class="string">&quot;kobe&quot;</span> age=<span class="string">&quot;30&quot;</span> height=<span class="string">&quot;1.98&quot;</span>/&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>functional组件相对来说比较简单，因为不需要有构造方法，也不需要有this的问题。</p><h3 id="参数验证propTypes"><a href="#参数验证propTypes" class="headerlink" title="参数验证propTypes"></a>参数验证propTypes</h3><p>对于传递给子组件的数据，有时候我们可能希望进行验证，特别是对于大型项目来说：</p><ul><li>当然，如果你项目中默认继承了Flow或者TypeScript，那么直接就可以进行类型验证；</li><li>但是，即使我们没有使用Flow或者TypeScript，也可以通过 <code>prop-types</code> 库来进行参数验证；</li></ul><p>从 React v15.5 开始，<code>React.PropTypes</code> 已移入另一个包中：<code>prop-types</code> 库</p><p>我们对之前的class组件进行验证：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ChildCpn1.propTypes = &#123;</span><br><span class="line">  name: PropTypes.string,</span><br><span class="line">  age: PropTypes.number,</span><br><span class="line">  height: PropTypes.number</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个时候，控制台就会报警告：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/06002" alt="图片">类型验证警告</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;ChildCpn1 name&#x3D;&quot;why&quot; age&#x3D;&#123;18&#125; height&#x3D;&#123;1.88&#125;&#x2F;&gt;</span><br></pre></td></tr></table></figure><p>更多的验证方式，可以参考官网：<a href="https://zh-hans.reactjs.org/docs/typechecking-with-proptypes.html">https://zh-hans.reactjs.org/docs/typechecking-with-proptypes.html</a></p><ul><li>比如验证数组，并且数组中包含哪些元素；</li><li>比如验证对象，并且对象中包含哪些key以及value是什么类型；</li><li>比如某个原生是必须的，使用 <code>requiredFunc: PropTypes.func.isRequired</code></li></ul><p><strong>如果没有传递，我们希望有默认值呢？</strong></p><ul><li>我们使用<code>defaultProps</code>就可以了</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ChildCpn1.defaultProps = &#123;</span><br><span class="line">  name: <span class="string">&quot;王小波&quot;</span>,</span><br><span class="line">  age: <span class="number">40</span>,</span><br><span class="line">  height: <span class="number">1.92</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="子组件传递父组件"><a href="#子组件传递父组件" class="headerlink" title="子组件传递父组件"></a>子组件传递父组件</h2><p>某些情况，我们也需要子组件向父组件传递消息：</p><ul><li>在vue中是通过自定义事件来完成的；</li><li>在React中同样是通过props传递消息，只是让<code>父组件</code>给<code>子组件</code>传递一个<code>回调函数</code>，在子组件中调用这个函数即可；</li></ul><p>我们这里来完成一个案例：</p><ul><li>将计数器案例进行拆解；</li><li>将按钮封装到子组件中：CounterButton；</li><li>CounterButton发生点击事件，将内容传递到父组件中，修改counter的值；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/06003" alt="图片">Counter案例</p><p>案例代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CounterButton</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; operator, btnClick &#125; = props;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;btnClick&#125;</span>&gt;</span>&#123;operator&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      counter: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">changeCounter</span>(<span class="params">count</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      counter: <span class="built_in">this</span>.state.counter + count</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;当前计数: &#123;<span class="built_in">this</span>.state.counter&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;CounterButton operator=<span class="string">&quot;+1&quot;</span> btnClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.changeCounter(<span class="number">1</span>)&#125; /&gt;</span><br><span class="line">        &lt;CounterButton operator=<span class="string">&quot;-1&quot;</span> btnClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.changeCounter(-<span class="number">1</span>)&#125; /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="组件通信案例练习"><a href="#组件通信案例练习" class="headerlink" title="组件通信案例练习"></a>组件通信案例练习</h2><p>我们来做一个相对综合的练习：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/06004" alt="图片">TabControl案例练习</p><p>index.js代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./style.css&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">&#x27;./App&#x27;</span>;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span>/&gt;</span></span>, <span class="built_in">document</span>.getElementById(<span class="string">&quot;root&quot;</span>));</span><br></pre></td></tr></table></figure><p>App.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> TabControl <span class="keyword">from</span> <span class="string">&#x27;./TabControl&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.titles = [<span class="string">&quot;流行&quot;</span>, <span class="string">&quot;新款&quot;</span>, <span class="string">&quot;精选&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      currentTitle: <span class="string">&quot;流行&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">itemClick</span>(<span class="params">index</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      currentTitle: <span class="built_in">this</span>.titles[index]</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;TabControl titles=&#123;<span class="built_in">this</span>.titles&#125; itemClick=&#123;<span class="function"><span class="params">index</span> =&gt;</span> <span class="built_in">this</span>.itemClick(index)&#125; /&gt;</span><br><span class="line">        &lt;h2&gt;&#123;<span class="built_in">this</span>.state.currentTitle&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>TabControl.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">TabControl</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      currentIndex: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;titles&#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> &#123;currentIndex&#125; = <span class="built_in">this</span>.state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div className=<span class="string">&quot;tab-control&quot;</span>&gt;</span><br><span class="line">        &#123;</span><br><span class="line">          titles.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">              &lt;div className=<span class="string">&quot;tab-item&quot;</span> onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.itemClick(index)&#125;&gt;</span><br><span class="line">                &lt;span className=&#123;<span class="string">&quot;title &quot;</span> + (index === currentIndex ? <span class="string">&quot;active&quot;</span>: <span class="string">&quot;&quot;</span>)&#125;&gt;&#123;item&#125;&lt;/span&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">            )</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">itemClick</span>(<span class="params">index</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      currentIndex: index</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">this</span>.props.itemClick(index);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>style.css</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.tab-control</span> &#123;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">40px</span>;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">40px</span>;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.tab-control</span> <span class="selector-class">.tab-item</span> &#123;</span><br><span class="line">  <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.tab-control</span> <span class="selector-class">.title</span> &#123;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">3px</span> <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.tab-control</span> <span class="selector-class">.title</span><span class="selector-class">.active</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: red;</span><br><span class="line">  <span class="attribute">border-bottom</span>: <span class="number">3px</span> solid red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="React插槽实现"><a href="#React插槽实现" class="headerlink" title="React插槽实现"></a>React插槽实现</h2><h3 id="为什么使用插槽？"><a href="#为什么使用插槽？" class="headerlink" title="为什么使用插槽？"></a>为什么使用插槽？</h3><p>在开发中，我们抽取了一个组件，但是为了让这个组件具备更强的通用性，我们不能将组件中的内容限制为固定的div、span等等这些元素。</p><p>我们应该让使用者可以决定某一块区域到底存放什么内容。</p><p>举个栗子：假如我们定制一个通用的导航组件 - NavBar</p><ul><li>这个组件分成三块区域：左边-中间-右边，每块区域的内容是不固定；</li><li>左边区域可能显示一个菜单图标，也可能显示一个返回按钮，可能什么都不显示；</li><li>中间区域可能显示一个搜索框，也可能是一个列表，也可能是一个标题，等等；</li><li>右边可能是一个文字，也可能是一个图标，也可能什么都不显示；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/06005" alt="图片">京东导航</p><p>这种需求在Vue当中有一个固定的做法是通过slot来完成的，React呢？</p><ul><li>React对于这种需要插槽的情况非常灵活；</li><li>有两种方案可以实现：children和props；</li></ul><p>我这里先提前给出NavBar的样式：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.nav-bar</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">44px</span>;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">44px</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.nav-bar</span> <span class="selector-class">.left</span>, <span class="selector-class">.nav-bar</span> <span class="selector-class">.right</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">80px</span>;</span><br><span class="line">  <span class="attribute">background</span>: red;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.nav-bar</span> <span class="selector-class">.center</span> &#123;</span><br><span class="line">  <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">  <span class="attribute">background</span>: blue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="children实现"><a href="#children实现" class="headerlink" title="children实现"></a>children实现</h3><p>每个组件都可以获取到 <code>props.children</code>：它包含组件的开始标签和结束标签之间的内容。</p><p>比如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Welcome&gt;Hello world!&lt;&#x2F;Welcome&gt;</span><br></pre></td></tr></table></figure><p>在 <code>Welcome</code> 组件中获取 <code>props.children</code>，就可以得到字符串 <code>Hello world!</code>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Welcome</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;props.children&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然，我们之前看过props.children的源码：</p><ul><li>如果只有一个元素，那么children指向该元素；</li><li>如果有多个元素，那么children指向的是数组，数组中包含多个元素；</li></ul><p>那么，我们的NavBar可以进行如下的实现：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NavBar</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div className=<span class="string">&quot;nav-bar&quot;</span>&gt;</span><br><span class="line">        &lt;div className=<span class="string">&quot;item left&quot;</span>&gt;&#123;<span class="built_in">this</span>.props.children[<span class="number">0</span>]&#125;&lt;/div&gt;</span><br><span class="line">        &lt;div className=<span class="string">&quot;item center&quot;</span>&gt;&#123;<span class="built_in">this</span>.props.children[<span class="number">1</span>]&#125;&lt;/div&gt;</span><br><span class="line">        &lt;div className=<span class="string">&quot;item right&quot;</span>&gt;&#123;<span class="built_in">this</span>.props.children[<span class="number">2</span>]&#125;&lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;NavBar&gt;</span><br><span class="line">          &lt;div&gt;返回&lt;/div&gt;</span><br><span class="line">          &lt;div&gt;购物街&lt;/div&gt;</span><br><span class="line">          &lt;div&gt;更多&lt;/div&gt;</span><br><span class="line">        &lt;/NavBar&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="props实现"><a href="#props实现" class="headerlink" title="props实现"></a>props实现</h3><p>通过children实现的方案虽然可行，但是有一个弊端：通过索引值获取传入的元素很容易出错，不能精准的获取传入的原生；</p><p>另外一个种方案就是使用 props 实现：</p><ul><li>通过具体的属性名，可以让我们在传入和获取时更加的精准；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NavBar</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; leftSlot, centerSlot, rightSlot &#125; = <span class="built_in">this</span>.props;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div className=<span class="string">&quot;nav-bar&quot;</span>&gt;</span><br><span class="line">        &lt;div className=<span class="string">&quot;item left&quot;</span>&gt;&#123;leftSlot&#125;&lt;/div&gt;</span><br><span class="line">        &lt;div className=<span class="string">&quot;item center&quot;</span>&gt;&#123;centerSlot&#125;&lt;/div&gt;</span><br><span class="line">        &lt;div className=<span class="string">&quot;item right&quot;</span>&gt;&#123;rightSlot&#125;&lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> navLeft = <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>返回<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">    <span class="keyword">const</span> navCenter = <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>购物街<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">    <span class="keyword">const</span> navRight = <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>更多<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;NavBar leftSlot=&#123;navLeft&#125; centerSlot=&#123;navCenter&#125; rightSlot=&#123;navRight&#125; /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列五-组件化开发(一)</title>
      <link href="/blog/2020/12/14/React%E7%B3%BB%E5%88%97%E4%BA%94-%E7%BB%84%E4%BB%B6%E5%8C%96%E5%BC%80%E5%8F%91-%E4%B8%80/"/>
      <url>/blog/2020/12/14/React%E7%B3%BB%E5%88%97%E4%BA%94-%E7%BB%84%E4%BB%B6%E5%8C%96%E5%BC%80%E5%8F%91-%E4%B8%80/</url>
      
        <content type="html"><![CDATA[<blockquote><p>现在可以说整个的大前端开发都是组件化的天下，无论从三大框架（Vue、React、Angular），还是跨平台方案的Flutter，甚至是移动端都在转向组件化开发。</p><p>所以，学习组件化最重要的是它的思想，每个框架或者平台可能实现方法不同，但是思想都是一样的。</p></blockquote><a id="more"></a><h2 id="认识组件化开发"><a href="#认识组件化开发" class="headerlink" title="认识组件化开发"></a>认识组件化开发</h2><h3 id="什么是组件化？"><a href="#什么是组件化？" class="headerlink" title="什么是组件化？"></a>什么是组件化？</h3><p>人面对复杂问题的处理方式：</p><ul><li>任何一个人处理信息的逻辑能力都是有限的</li><li>所以，当面对一个非常复杂的问题时，我们不太可能一次性搞定一大堆的内容。</li><li>但是，我们人有一种天生的能力，就是将问题进行拆解。</li><li>如果将一个复杂的问题，拆分成很多个可以处理的小问题，再将其放在整体当中，你会发现大的问题也会迎刃而解。</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/05001" alt="图片"></p><p>组件化也是类似的思想：</p><ul><li>如果我们将一个页面中所有的处理逻辑全部放在一起，处理起来就会变得非常复杂，而且不利于后续的管理以及扩展。</li><li>但如果，我们讲一个页面拆分成一个个小的功能块，每个功能块完成属于自己这部分独立的功能，那么之后整个页面的管理和维护就变得非常容易了。</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/05002" alt="图片"></p><p>我们需要通过组件化的思想来思考整个应用程序：</p><ul><li>我们将一个完整的页面分成很多个组件；</li><li>每个组件都用于实现页面的一个功能块；</li><li>而每一个组件又可以进行细分；</li><li>而组件本身又可以在多个地方进行复用；</li></ul><h3 id="React的组件化"><a href="#React的组件化" class="headerlink" title="React的组件化"></a>React的组件化</h3><p>组件化是React的核心思想，也是我们后续课程的重点，前面我们封装的App本身就是一个组件：</p><ul><li>组件化提供了一种抽象，让我们可以开发出一个个独立可复用的小组件来构造我们的应用。</li><li>任何的应用都会被抽象成一颗组件树。</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/05003" alt="图片"></p><p>组件化思想的应用：</p><ul><li>有了组件化的思想，我们在之后的开发中就要充分的利用它。</li><li>尽可能的将页面拆分成一个个小的、可复用的组件。</li><li>这样让我们的代码更加方便组织和管理，并且扩展性也更强。</li></ul><p>React的组件相对于Vue更加的灵活和多样，按照不同的方式可以分成很多类组件：</p><ul><li>根据组件的定义方式，可以分为：函数组件(Functional Component )和类组件(Class Component)；</li><li>根据组件内部是否有状态需要维护，可以分成：无状态组件(Stateless Component )和有状态组件(Stateful Component)；</li><li>根据组件的不同职责，可以分成：展示型组件(Presentational Component)和容器型组件(Container Component)；</li></ul><p>这些概念有很多重叠，但是他们最主要是关注数据逻辑和UI展示的分离：</p><ul><li>函数组件、无状态组件、展示型组件主要关注UI的展示；</li><li>类组件、有状态组件、容器型组件主要关注数据逻辑；</li></ul><p>当然还有很多组件的其他概念：比如异步组件、高阶组件等，我们后续再学习。</p><h2 id="创建React组件"><a href="#创建React组件" class="headerlink" title="创建React组件"></a>创建React组件</h2><h3 id="创建类组件"><a href="#创建类组件" class="headerlink" title="创建类组件"></a>创建类组件</h3><p>类组件的定义有如下要求：</p><ul><li>类组件需要继承自 <code>React.Component</code></li><li>类组件必须实现<code>render</code>函数</li></ul><p>在ES6之前，可以通过<code>create-react-class</code> 模块来定义类组件，但是目前官网建议我们使用ES6的class类定义。</p><p>使用class定义一个组件：</p><ul><li>constructor是可选的，我们通常在constructor中初始化一些数据；</li><li>this.state中维护的就是我们组件内部的数据；</li><li><code>render()</code> 方法是 class 组件中唯一必须实现的方法；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Hello App<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当 <code>render</code> 被调用时，它会检查 <code>this.props</code> 和 <code>this.state</code> 的变化并返回以下类型之一：</p><ul><li><p><strong>React 元素</strong>：</p></li><li><ul><li>通常通过 JSX 创建。</li><li>例如，<code>会被 React 渲染为 DOM 节点，</code> 会被 React 渲染为自定义组件；</li><li>无论是 <code>还是</code> 均为 React 元素。</li></ul></li><li><p><strong>数组或 fragments</strong>：使得 render 方法可以返回多个元素。</p></li><li><p><strong>Portals</strong>：可以渲染子节点到不同的 DOM 子树中。</p></li><li><p><strong>字符串或数值类型</strong>：它们在 DOM 中会被渲染为文本节点</p></li><li><p><strong>布尔类型或 <code>null</code></strong>：什么都不渲染。</p></li></ul><p>另外类组件有自己的生命周期，我们会在后面的章节中详细介绍。</p><h3 id="创建函数组件"><a href="#创建函数组件" class="headerlink" title="创建函数组件"></a>创建函数组件</h3><p>函数组件是使用function来进行定义的函数，只是这个函数会返回和类组件中render函数返回一样的内容。</p><p>函数组件有自己的特点（当然，后面我们会讲hooks，就不一样了）：</p><ul><li>没有生命周期，也会被更新并挂载，但是没有生命周期函数；</li><li>没有this(组件实例）；</li><li>没有内部状态（state）；</li></ul><p>我们来定义一个函数组件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;Hello World&lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="组件的生命周期"><a href="#组件的生命周期" class="headerlink" title="组件的生命周期"></a>组件的生命周期</h2><h3 id="认识生命周期"><a href="#认识生命周期" class="headerlink" title="认识生命周期"></a>认识生命周期</h3><p>很多的事物都有从创建到销毁的整个过程，这个过程称之为是<strong>生命周期</strong>；</p><p>React组件也有自己的生命周期，了解组件的生命周期可以让我们在最合适的地方完成自己想要的功能；</p><p>生命周期和生命周期函数的关系：</p><ul><li><p>生命周期是一个抽象的概念，在生命周期的整个过程，分成了很多个阶段；</p></li><li><ul><li>比如装载阶段（Mount），组件第一次在DOM树中被渲染的过程；</li><li>比如更新过程（Update），组件状态发生变化，重新更新渲染的过程；</li><li>比如卸载过程（Unmount），组件从DOM树中被移除的过程；</li></ul></li><li><p>React内部为了告诉我们当前处于哪些阶段，会对我们组件内部实现的某些函数进行回调，这些函数就是生命周期函数：</p></li><li><ul><li>比如实现componentDidMount函数：组件已经挂载到DOM上时，就会回调；</li><li>比如实现componentDidUpdate函数：组件已经发生了更新时，就会回调；</li><li>比如实现componentWillUnmount函数：组件即将被移除时，就会回调；</li><li>我们可以在这些回调函数中编写自己的逻辑代码，来完成自己的需求功能；</li></ul></li></ul><p>我们谈React生命周期时，主要谈的类的生命周期，因为函数式组件是没有生命周期函数的；（后面我们可以通过hooks来模拟一些生命周期的回调）</p><h3 id="生命周期解析"><a href="#生命周期解析" class="headerlink" title="生命周期解析"></a>生命周期解析</h3><p>我们先来学习一下最基础、最常用的生命周期函数：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/05004" alt="图片">React基本生命周期</p><p>上图第一个区域解析：</p><ul><li>当我们挂载一个组件时，会先执行constructor构造方法来创建组件；</li><li>紧接着调用render函数，获取要渲染的DOM结构（jsx），并且开始渲染DOM；</li><li>当组件挂载成功（DOM渲染完成），会执行componentDidMount生命周期函数；</li></ul><p>上图第二个区域解析：</p><ul><li>当我们通过修改props，或者调用setState修改内部状态，或者直接调用forceUpdate时会重新调用render函数，进行更新操作；</li><li>当更新完成时，会回调componentDidUpdate生命周期函数；</li></ul><p>上图第三个区域解析：</p><ul><li>当我们的组件不再使用，会被从DOM中移除掉（卸载）；</li><li>这个时候会回调componentWillUnmount生命周期函数；</li></ul><h3 id="生命周期函数"><a href="#生命周期函数" class="headerlink" title="生命周期函数"></a>生命周期函数</h3><p><strong>constructor</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">constructor(props)</span><br></pre></td></tr></table></figure><p>如果不初始化 state 或不进行方法绑定，则不需要为 React 组件实现构造函数。</p><p>constructor中通常只做两件事情：</p><ul><li>通过给 <code>this.state</code> 赋值对象来初始化内部的state；</li><li>为事件绑定实例（this）；</li></ul><p><strong>componentDidMount</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">componentDidMount()</span><br></pre></td></tr></table></figure><p><code>componentDidMount()</code> 会在组件挂载后（插入 DOM 树中）立即调用。</p><p>componentDidMount中通常进行哪里操作呢？</p><ul><li>依赖于DOM的操作可以在这里进行；</li><li>在此处发送网络请求就最好的地方；（官方建议）</li><li>可以在此处添加一些订阅（会在componentWillUnmount取消订阅）；</li></ul><p><strong>componentDidUpdate</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">componentDidUpdate(prevProps, prevState, snapshot)</span><br></pre></td></tr></table></figure><p><code>componentDidUpdate()</code> 会在更新后会被立即调用，首次渲染不会执行此方法。</p><ul><li>当组件更新后，可以在此处对 DOM 进行操作；</li><li>如果你对更新前后的 props 进行了比较，也可以选择在此处进行网络请求；（例如，当 props 未发生变化时，则不会执行网络请求）。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">componentDidUpdate</span>(<span class="params">prevProps</span>)</span> &#123;</span><br><span class="line">  <span class="comment">// 典型用法（不要忘记比较 props）：</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.props.userID !== prevProps.userID) &#123;</span><br><span class="line">    <span class="built_in">this</span>.fetchData(<span class="built_in">this</span>.props.userID);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>componentWillUnmount</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">componentWillUnmount()</span><br></pre></td></tr></table></figure><p><code>componentWillUnmount()</code> 会在组件卸载及销毁之前直接调用。</p><ul><li>在此方法中执行必要的清理操作；</li><li>例如，清除 timer，取消网络请求或清除在 <code>componentDidMount()</code> 中创建的订阅等；</li></ul><p><strong>代码验证所有的生命周期函数：</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HYTestCpn</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>HYTestCpn<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentWillUnmount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;HYTestCpn componentWillUnmount&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      counter: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;调用constructor方法&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;调用render方法&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;当前计数: &#123;<span class="built_in">this</span>.state.counter&#125;&lt;/h2&gt;</span><br><span class="line">        &#123;<span class="built_in">this</span>.state.counter &lt;= <span class="number">5</span> &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">HYTestCpn</span>/&gt;</span></span>&#125;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.increment()&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">increment</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      counter: <span class="built_in">this</span>.state.counter + <span class="number">1</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;调用componentDidMount方法&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentDidUpdate</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;调用componentDidUpdate方法&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentWillUnmount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;调用componentWillUnmount方法&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="不常用生命周期"><a href="#不常用生命周期" class="headerlink" title="不常用生命周期"></a>不常用生命周期</h3><p>除了上面介绍的生命周期函数之外，还有一些不常用的生命周期函数：</p><ul><li>getDerivedStateFromProps：state 的值在任何时候都依赖于 props时使用；该方法返回一个对象来更新state；</li><li>getSnapshotBeforeUpdate：在React更新DOM之前回调的一个函数，可以获取DOM更新前的一些信息（比如说滚动位置）；</li><li>shouldComponentUpdate：该生命周期函数很常用，但是我们等待讲性能优化时再来详细讲解；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/05005" alt="图片">完整的生命周期图</p><p>另外，React中还提供了一些过期的生命周期函数，这些函数已经不推荐使用。</p><p>更详细的生命周期相关的内容，可以参考官网：<a href="https://zh-hans.reactjs.org/docs/react-component.html">https://zh-hans.reactjs.org/docs/react-component.html</a></p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列四-React脚手架</title>
      <link href="/blog/2020/12/14/React%E7%B3%BB%E5%88%97%E5%9B%9B-React%E8%84%9A%E6%89%8B%E6%9E%B6/"/>
      <url>/blog/2020/12/14/React%E7%B3%BB%E5%88%97%E5%9B%9B-React%E8%84%9A%E6%89%8B%E6%9E%B6/</url>
      
        <content type="html"><![CDATA[<h2 id="认识脚手架"><a href="#认识脚手架" class="headerlink" title="认识脚手架"></a>认识脚手架</h2><h3 id="前端工程的复杂化"><a href="#前端工程的复杂化" class="headerlink" title="前端工程的复杂化"></a>前端工程的复杂化</h3><p>如果我们只是开发几个小的demo程序，那么永远不需要考虑一些复杂的问题：</p><ul><li>比如目录结构如何组织划分；</li><li>比如如何管理文件之间的相互依赖；</li><li>比如如何管理第三方模块的依赖；</li><li>比如项目发布前如何压缩、打包项目；</li><li>等等…</li></ul><a id="more"></a><p>现代的前端项目已经越来越复杂了：</p><ul><li>不会再是在HTML中引入几个css文件，引入几个编写的js文件或者第三方的js文件这么简单；</li><li>比如css可能是使用less、sass等预处理器进行编写，我们需要将它们转成普通的css才能被浏览器解析；</li><li>比如JavaScript代码不再只是编写在几个文件中，而是通过模块化的方式，被组成在<strong>成百上千</strong>个文件中，我们需要通过模块化的技术来管理它们之间的相互依赖；</li><li>比如项目需要依赖很多的第三方库，如何更好的管理它们（比如管理它们的依赖、版本升级等）；</li></ul><p>为了解决上面这些问题，我们需要再去学习一些工具：</p><ul><li>比如babel、webpack、gulp。配置它们转换规则、打包依赖、热更新等等一些的内容；</li><li>你会发现，你还没有开始做项目，你就面临一系列的工程化问题；</li></ul><p><strong>脚手架的出现，就是帮助我们解决这一系列问题的；</strong></p><h3 id="脚手架是什么呢？"><a href="#脚手架是什么呢？" class="headerlink" title="脚手架是什么呢？"></a>脚手架是什么呢？</h3><p>传统的脚手架指的是建筑学的一种结构：在搭建楼房、建筑物时，临时搭建出来的一个框架；</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/04001" alt="脚手架">脚手架</p><p>编程中提到的脚手架（Scaffold），其实是一种工具，帮我们可以快速生成项目的工程化结构；</p><ul><li>每个项目作出完成的效果不同，但是它们的基本工程化结构是相似的；</li><li>既然相似，就没有必要每次都从零开始搭建，完全可以使用一些工具，帮助我们生产基本的工程化模板；</li><li>不同的项目，在这个模板的基础之上进行项目开发或者进行一些配置的简单修改即可；</li><li>这样也可以间接保证项目的基本机构一致性，方便后期的维护；</li></ul><p>总结：<strong>脚手架让项目从搭建到开发，再到部署，整个流程变得快速和便捷；</strong></p><p>对于现在比较流行的三大框架都有属于自己的脚手架：</p><ul><li>Vue的脚手架：vue-cli</li><li>Angular的脚手架：angular-cli</li><li>React的脚手架：create-react-app</li></ul><p>它们的作用都是帮助我们生成一个通用的目录结构，并且已经将我们所需的工程环境配置好。</p><p>使用这些脚手架需要依赖什么呢？</p><ul><li>目前这些脚手架都是使用node编写的，并且都是基于webpack的；</li><li>所以我们必须在自己的电脑上安装node环境；</li></ul><p>这里我们主要是学习React，所以我们还是以React的脚手架工具：create-react-app作为讲解；</p><h2 id="create-react-app"><a href="#create-react-app" class="headerlink" title="create-react-app"></a>create-react-app</h2><h3 id="安装相关的依赖"><a href="#安装相关的依赖" class="headerlink" title="安装相关的依赖"></a>安装相关的依赖</h3><h4 id="安装node"><a href="#安装node" class="headerlink" title="安装node"></a>安装node</h4><p>React脚手架本身需要依赖node，所以我们需要安装node环境：</p><ul><li>无论是windows还是Mac OS，都可以通过node官网直接下载；</li><li>官网地址：<a href="https://nodejs.org/en/download/">https://nodejs.org/en/download/</a></li><li>注意：这里推荐大家下载LTS（<em>Long-term support</em> ）版本，是长期支持版本，会比较稳定；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/04002" alt="图片">nodejs下载</p><p>下载后，双击安装即可：</p><ul><li>1.安装过程中，会自动配置环境变量；</li><li>2.安装时，会同时帮助我们安装npm管理工具；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/04003" alt="图片"></p><h4 id="包管理工具"><a href="#包管理工具" class="headerlink" title="包管理工具"></a>包管理工具</h4><p><strong>什么是npm？</strong></p><ul><li>全称 Node Package Manager，即“node包管理器”；</li><li>作用肯定是帮助我们管理一下依赖的工具包（比如react、react-dom、axios、babel、webpack等等）；</li><li>作者开发的目的就是为了解决“模块管理很糟糕”的问题；</li></ul><p><strong>另外，还有一个大名鼎鼎的node包管理工具yarn：</strong></p><ul><li>Yarn是由Facebook、Google、Exponent 和 Tilde 联合推出了一个新的 JS 包管理工具；</li><li>Yarn 是为了弥补 npm 的一些缺陷而出现的；</li><li>早期的npm存在很多的缺陷，比如安装依赖速度很慢、版本依赖混乱等等一系列的问题；</li><li>虽然从npm5版本开始，进行了很多的升级和改进，但是依然很多人喜欢使用yarn；</li><li>React脚手架默认也是使用yarn；</li></ul><p>安装yarn：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g yarn</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/04004" alt="图片"></p><p><strong>yarn和npm的命令对比</strong></p><div class="table-container"><table><thead><tr><th style="text-align:left">Npm</th><th style="text-align:left">Yarn</th></tr></thead><tbody><tr><td style="text-align:left">npm install</td><td style="text-align:left">yarn install</td></tr><tr><td style="text-align:left">npm install [package]</td><td style="text-align:left">yarn add [package]</td></tr><tr><td style="text-align:left">npm install —save [package]</td><td style="text-align:left">yarn add [package]</td></tr><tr><td style="text-align:left">npm install —save-dev [package]</td><td style="text-align:left">yarn add [package] [—dev/-D]</td></tr><tr><td style="text-align:left">npm rebuild</td><td style="text-align:left">yarn install —force</td></tr><tr><td style="text-align:left">npm uninstall [package]</td><td style="text-align:left">yarn remove [package]</td></tr><tr><td style="text-align:left">npm uninstall —save [package]</td><td style="text-align:left">yarn remove [package]</td></tr><tr><td style="text-align:left">npm uninstall —save-dev [package]</td><td style="text-align:left">yarn remove [package]</td></tr><tr><td style="text-align:left">npm uninstall —save-optional [package]</td><td style="text-align:left">yarn remove [package]</td></tr><tr><td style="text-align:left">npm cache clean</td><td style="text-align:left">yarn cache clean</td></tr><tr><td style="text-align:left">rm -rf node_modules &amp;&amp; npm install</td><td style="text-align:left">yarn upgrade</td></tr></tbody></table></div><p><strong>cnpm的使用</strong></p><p>在国内，某些情况使用npm和yarn可能无法正常安装一个库，这个时候我们可以选择使用cnpm</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g cnpm --registry&#x3D;https:&#x2F;&#x2F;registry.npm.taobao.org</span><br></pre></td></tr></table></figure><h4 id="安装脚手架"><a href="#安装脚手架" class="headerlink" title="安装脚手架"></a>安装脚手架</h4><p>最后一个需要安装的是创建React项目的脚手架：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g create-react-app</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/04005" alt="图片"></p><h3 id="创建React项目"><a href="#创建React项目" class="headerlink" title="创建React项目"></a>创建React项目</h3><h4 id="创建React项目-1"><a href="#创建React项目-1" class="headerlink" title="创建React项目"></a>创建React项目</h4><p>现在，我们就可以通过脚手架来创建React项目了。</p><p>创建React项目的命令如下：</p><ul><li>注意：项目名称不能包含大写字母</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create-react-app 项目名称</span><br></pre></td></tr></table></figure><p>另外还有更多创建项目的方式，可以参考GitHub的readme</p><ul><li><a href="https://github.com/facebook/create-react-app；">https://github.com/facebook/create-react-app；</a></li><li>上面的创建方式，默认使用的yarn来管理整个项目包相关的依赖的；</li><li>如果希望使用npm，也可以在参数后面加上 —use-npm；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/04006" alt="图片"></p><p>创建完成后，进入对应的目录，就可以将项目跑起来：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd 01-test-react</span><br><span class="line">yarn start</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/04007" alt="图片">项目效果</p><h4 id="目录结构分析"><a href="#目录结构分析" class="headerlink" title="目录结构分析"></a>目录结构分析</h4><p>我们可以通过VSCode打开项目：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/04008" alt="图片">项目目录结构</p><p>目录结构分析：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">test-react</span><br><span class="line">├─ README.md &#x2F;&#x2F; readme说明文档</span><br><span class="line">├─ package.json &#x2F;&#x2F; 对整个应用程序的描述：包括应用名称、版本号、一些依赖包、以及项目的启动、打包等等（node管理项目必备文件）</span><br><span class="line">├─ public</span><br><span class="line">│    ├─ favicon.ico &#x2F;&#x2F; 应用程序顶部的icon图标</span><br><span class="line">│    ├─ index.html &#x2F;&#x2F; 应用的index.html入口文件</span><br><span class="line">│    ├─ logo192.png &#x2F;&#x2F; 被在manifest.json中使用</span><br><span class="line">│    ├─ logo512.png &#x2F;&#x2F; 被在manifest.json中使用</span><br><span class="line">│    ├─ manifest.json &#x2F;&#x2F; 和Web app配置相关</span><br><span class="line">│    └─ robots.txt &#x2F;&#x2F; 指定搜索引擎可以或者无法爬取哪些文件</span><br><span class="line">├─ src</span><br><span class="line">│    ├─ App.css &#x2F;&#x2F; App组件相关的样式</span><br><span class="line">│    ├─ App.js &#x2F;&#x2F; App组件的代码文件</span><br><span class="line">│    ├─ App.test.js &#x2F;&#x2F; App组件的测试代码文件</span><br><span class="line">│    ├─ index.css &#x2F;&#x2F; 全局的样式文件</span><br><span class="line">│    ├─ index.js &#x2F;&#x2F; 整个应用程序的入口文件</span><br><span class="line">│    ├─ logo.svg &#x2F;&#x2F; 刚才启动项目，所看到的React图标</span><br><span class="line">│    ├─ serviceWorker.js &#x2F;&#x2F; 默认帮助我们写好的注册PWA相关的代码</span><br><span class="line">│    └─ setupTests.js &#x2F;&#x2F; 测试初始化文件</span><br><span class="line">└─ yarn.lock</span><br></pre></td></tr></table></figure><p>整个目录结构都非常好理解，只是有一个PWA相关的概念：</p><ul><li>PWA全称Progressive Web App，即渐进式WEB应用；</li><li>一个 PWA 应用首先是一个网页, 可以通过 Web 技术编写出一个网页应用. 随后添加上 App Manifest 和 Service Worker 来实现 PWA 的安装和离线等功能；</li><li>这种Web存在的形式，我们也称之为是 Web App；</li></ul><p>PWA解决了哪些问题呢？</p><ul><li>可以添加至主屏幕，点击主屏幕图标可以实现启动动画以及隐藏地址栏；</li><li>实现离线缓存功能，即使用户手机没有网络，依然可以使用一些离线功能；</li><li>实现了消息推送；</li><li>等等一系列类似于Native App相关的功能；</li></ul><p>更多PWA相关的知识，可以自行去学习更多；</p><h4 id="webpack配置"><a href="#webpack配置" class="headerlink" title="webpack配置"></a>webpack配置</h4><p>我们说过React的脚手架是基于Webpack来配置的：</p><ul><li><em>webpack</em> 是一个现代 JavaScript 应用程序的<em>静态模块打包器(module bundler)</em>；</li><li>当 webpack 处理应用程序时，它会递归地构建一个<em>依赖关系图(dependency graph)</em>，其中包含应用程序需要的每个模块，然后将所有这些模块打包成一个或多个 <em>bundle</em>；</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/04009" alt="图片"></p><p>在这里我们暂时不展开来讲webpack，因为里面的内容是非常多的（后续会有专门讲webpack的专题）；</p><p>但是，很奇怪：我们并没有在目录结构中看到任何webpack相关的内容？</p><ul><li>原因是React脚手架讲webpack相关的配置隐藏起来了（其实从Vue CLI3开始，也是进行了隐藏）；</li></ul><p>如果我们希望看到webpack的配置信息，应该怎么来做呢？</p><ul><li>我们可以执行一个package.json文件中的一个脚本：<code>&quot;eject&quot;: &quot;react-scripts eject&quot;</code></li><li>这个操作是不可逆的，所以在执行过程中会给与我们提示；</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn eject</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/04010" alt="图片"></p><p>查看和学习webpack相关的配置信息：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/04011" alt="图片"></p><h3 id="从零编写项目"><a href="#从零编写项目" class="headerlink" title="从零编写项目"></a>从零编写项目</h3><h4 id="文件的删减"><a href="#文件的删减" class="headerlink" title="文件的删减"></a>文件的删减</h4><p>通过脚手架创建完项目，很多同学还是会感觉目录结构过于复杂，所以我打算从零带着大家来编写代码。</p><p>我们先将不需要的文件统统删掉：</p><ul><li>1.将src下的所有文件都删除</li><li>2.将public文件下出列favicon.ico和index.html之外的文件都删除掉</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/04012" alt="图片"></p><p>修改index.html文件：</p><ul><li>我们需要删除选中的内容；</li><li>这两行内容是我们之前引入的一个图标和manifest文件</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/04013" alt="图片">删除选中的两行内容</p><h4 id="开始编写代码"><a href="#开始编写代码" class="headerlink" title="开始编写代码"></a>开始编写代码</h4><p>在src目录下，创建一个index.js文件，因为这是webpack打包的入口。</p><p>在index.js中开始编写React代码：</p><ul><li>我们会发现和写的代码是逻辑是一致的；</li><li>只是在模块化开发中，我们需要手动的来导入React、ReactDOM，因为它们都是在我们安装的模块中；</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import React from &quot;react&quot;;</span><br><span class="line">import ReactDOM from &#39;react-dom&#39;;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(&lt;h2&gt;Hello React&lt;&#x2F;h2&gt;, document.getElementById(&quot;root&quot;));</span><br></pre></td></tr></table></figure><ul><li>[ ] <img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/04014" alt="图片"></li></ul><p>如果我们不希望直接在 <code>ReactDOM.render</code> 中编写过多的代码，就可以单独抽取一个组件App.js：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Hello App<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在index.js中引入App，并且使用它：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">&#x27;./App&#x27;</span>;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span>/&gt;</span></span>, <span class="built_in">document</span>.getElementById(<span class="string">&quot;root&quot;</span>));</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/04015" alt="图片"></p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列三-阶段案例练习</title>
      <link href="/blog/2020/12/14/React%E7%B3%BB%E5%88%97%E4%B8%89-%E9%98%B6%E6%AE%B5%E6%A1%88%E4%BE%8B%E7%BB%83%E4%B9%A0/"/>
      <url>/blog/2020/12/14/React%E7%B3%BB%E5%88%97%E4%B8%89-%E9%98%B6%E6%AE%B5%E6%A1%88%E4%BE%8B%E7%BB%83%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h2 id="书籍购物车说明"><a href="#书籍购物车说明" class="headerlink" title="书籍购物车说明"></a>书籍购物车说明</h2><h3 id="案例介绍"><a href="#案例介绍" class="headerlink" title="案例介绍"></a>案例介绍</h3><p>现在我们来做一个相对综合一点的练习：书籍购物车；</p><p>案例效果如下：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/03001.jpg" alt="图片"></p><a id="more"></a><p>案例效果</p><p>案例说明：</p><ul><li>1.在界面上以表格的形式，显示一些书籍的数据；</li><li>2.在底部显示书籍的总价格；</li><li>3.点击+或者-可以增加或减少书籍数量（如果为1，那么不能继续-）；</li><li>4.点击移除按钮，可以将书籍移除（当所有的书籍移除完毕时，显示：购物车为空~）；</li></ul><h3 id="项目的搭建"><a href="#项目的搭建" class="headerlink" title="项目的搭建"></a>项目的搭建</h3><p>这里，我们使用React将默认的数据先展示出来：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">  &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">  &lt;title&gt;Document&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">  &lt;style&gt;</span><br><span class="line">    table &#123;</span><br><span class="line">      border: <span class="number">1</span>px solid #e9e9e9;</span><br><span class="line">      border-collapse: collapse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    td, th &#123;</span><br><span class="line">      border: <span class="number">1</span>px solid #e9e9e9;</span><br><span class="line">      padding: <span class="number">8</span>px <span class="number">16</span>px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    th &#123;</span><br><span class="line">      background-color: #f7f7f7;</span><br><span class="line">      color: #5c6b77;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .counter &#123;</span><br><span class="line">      margin: <span class="number">0</span> <span class="number">5</span>px;</span><br><span class="line">    &#125;</span><br><span class="line">  &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    </span><br><span class="line">  &lt;div id=<span class="string">&quot;app&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;script src=<span class="string">&quot;../react/react.development.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script src=<span class="string">&quot;../react/react-dom.development.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script src=<span class="string">&quot;../react/babel.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">  &lt;script type=<span class="string">&quot;text/babel&quot;</span>&gt;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">      <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(props);</span><br><span class="line">        <span class="built_in">this</span>.state = &#123;</span><br><span class="line">          books: [</span><br><span class="line">            &#123;</span><br><span class="line">              id: <span class="number">1</span>,</span><br><span class="line">              name: <span class="string">&#x27;《算法导论》&#x27;</span>,</span><br><span class="line">              date: <span class="string">&#x27;2006-9&#x27;</span>,</span><br><span class="line">              price: <span class="number">85.00</span>,</span><br><span class="line">              count: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              id: <span class="number">2</span>,</span><br><span class="line">              name: <span class="string">&#x27;《UNIX编程艺术》&#x27;</span>,</span><br><span class="line">              date: <span class="string">&#x27;2006-2&#x27;</span>,</span><br><span class="line">              price: <span class="number">59.00</span>,</span><br><span class="line">              count: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              id: <span class="number">3</span>,</span><br><span class="line">              name: <span class="string">&#x27;《编程珠玑》&#x27;</span>,</span><br><span class="line">              date: <span class="string">&#x27;2008-10&#x27;</span>,</span><br><span class="line">              price: <span class="number">39.00</span>,</span><br><span class="line">              count: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              id: <span class="number">4</span>,</span><br><span class="line">              name: <span class="string">&#x27;《代码大全》&#x27;</span>,</span><br><span class="line">              date: <span class="string">&#x27;2006-3&#x27;</span>,</span><br><span class="line">              price: <span class="number">128.00</span>,</span><br><span class="line">              count: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; books &#125; = <span class="built_in">this</span>.state;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">          &lt;div&gt;</span><br><span class="line">            &lt;table&gt;</span><br><span class="line">              &lt;thead&gt;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                  &lt;th&gt;&lt;/th&gt;</span><br><span class="line">                  &lt;th&gt;书籍名称&lt;/th&gt;</span><br><span class="line">                  &lt;th&gt;出版日期&lt;/th&gt;</span><br><span class="line">                  &lt;th&gt;价格&lt;/th&gt;</span><br><span class="line">                  &lt;th&gt;购买数量&lt;/th&gt;</span><br><span class="line">                  &lt;th&gt;操作&lt;/th&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">              &lt;/thead&gt;</span><br><span class="line">              &lt;tbody&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                  books.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> (</span><br><span class="line">                      &lt;tr&gt;</span><br><span class="line">                        &lt;td&gt;&#123;index + <span class="number">1</span>&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;item.name&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;item.date&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;<span class="string">&quot;¥&quot;</span> + item.price&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;</span><br><span class="line">                          &lt;button&gt;-&lt;/button&gt;</span><br><span class="line">                          &lt;span className=<span class="string">&quot;counter&quot;</span>&gt;&#123;item.count&#125;&lt;/span&gt;</span><br><span class="line">                          &lt;button&gt;+&lt;/button&gt;</span><br><span class="line">                        &lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;<span class="xml"><span class="tag">&lt;<span class="name">button</span>&gt;</span>移除<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span>&lt;/td&gt;</span><br><span class="line">                      &lt;/tr&gt;</span><br><span class="line">                    )</span><br><span class="line">                  &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">              &lt;/tbody&gt;</span><br><span class="line">            &lt;/table&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span>/&gt;</span></span>, <span class="built_in">document</span>.getElementById(<span class="string">&quot;app&quot;</span>));</span><br><span class="line">  &lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h2 id="书籍购物车功能"><a href="#书籍购物车功能" class="headerlink" title="书籍购物车功能"></a>书籍购物车功能</h2><h3 id="价格的显示"><a href="#价格的显示" class="headerlink" title="价格的显示"></a>价格的显示</h3><p>我们可以封装一个工具函数，用于格式化价格：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatPrice</span>(<span class="params">price</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> price !== <span class="string">&quot;number&quot;</span>) &#123;</span><br><span class="line">    price = <span class="built_in">Number</span>(price) || <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;¥&quot;</span> + price.toFixed(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对之前显示的价格进行格式化：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;td&gt;&#123;formatPrice(item.price)&#125;&lt;/td&gt;</span><br></pre></td></tr></table></figure><p>封装一个App中的方法，用于获取商品总价格显示的内容：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">getTotalPrice</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> totalPrice = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> book <span class="keyword">of</span> <span class="built_in">this</span>.state.books) &#123;</span><br><span class="line">    totalPrice += book.count * book.price</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;总价格：&quot;</span> + formatPrice(totalPrice);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用一个h2元素显示总价格：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;h2&gt;</span><br><span class="line">  &#123;<span class="built_in">this</span>.getTotalPrice()&#125;</span><br><span class="line">&lt;/h2&gt;</span><br></pre></td></tr></table></figure><h3 id="数量的变化"><a href="#数量的变化" class="headerlink" title="数量的变化"></a>数量的变化</h3><p>封装一个方法，用于改变书籍的数量：</p><ul><li>注意：在React中，要保证数据的不可变性；</li><li>所以，我们是先复制一份books，对其进行修改，再通过setState更新到最新的状态；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">changeItem</span>(<span class="params">index, counter</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> books = [...this.state.books];</span><br><span class="line">  <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">    books: books.map(<span class="function">(<span class="params">item, indey</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (indey == index) &#123;</span><br><span class="line">        item.count += counter;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> item;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改jsx对应位置的代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;td&gt;</span><br><span class="line">  &lt;button disabled=&#123;item.count &lt;= <span class="number">1</span>&#125; onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.changeItem(index, -<span class="number">1</span>)&#125;&gt;-&lt;/button&gt;</span><br><span class="line">  &lt;span className=<span class="string">&quot;counter&quot;</span>&gt;&#123;item.count&#125;&lt;/span&gt;</span><br><span class="line">  &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.changeItem(index, <span class="number">1</span>)&#125;&gt;+&lt;/button&gt;</span><br><span class="line">&lt;/td&gt;</span><br></pre></td></tr></table></figure><h3 id="移除的操作"><a href="#移除的操作" class="headerlink" title="移除的操作"></a>移除的操作</h3><p>封装一个方法，用于移除对应的书籍：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">removeItem</span>(<span class="params">index</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> books = [...this.state.books];</span><br><span class="line">  <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">    books: books.filter(<span class="function">(<span class="params">item, indey</span>) =&gt;</span> index !== indey)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改对应的移除jsx代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;td&gt;<span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;e</span> =&gt;</span> this.removeItem(index)&#125;&gt;移除<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span>&lt;/td&gt;</span><br></pre></td></tr></table></figure><p>如果所有的书籍移除完毕，那么要显示购物车为空：</p><ul><li>封装两个方法，一个用于获取显示购物车的jsx代码（后期会封装成一个组件），一个用于获取显示购物车为空的jsx代码（后期也可以封装为一个组件）</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">renderBooks</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; books &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;table&gt;</span><br><span class="line">        &lt;thead&gt;</span><br><span class="line">          &lt;tr&gt;</span><br><span class="line">            &lt;th&gt;&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;书籍名称&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;出版日期&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;价格&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;购买数量&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;操作&lt;/th&gt;</span><br><span class="line">          &lt;/tr&gt;</span><br><span class="line">        &lt;/thead&gt;</span><br><span class="line">        &lt;tbody&gt;</span><br><span class="line">          &#123;</span><br><span class="line">            books.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">return</span> (</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                  &lt;td&gt;&#123;index + <span class="number">1</span>&#125;&lt;/td&gt;</span><br><span class="line">                  &lt;td&gt;&#123;item.name&#125;&lt;/td&gt;</span><br><span class="line">                  &lt;td&gt;&#123;item.date&#125;&lt;/td&gt;</span><br><span class="line">                  &lt;td&gt;&#123;formatPrice(item.price)&#125;&lt;/td&gt;</span><br><span class="line">                  &lt;td&gt;</span><br><span class="line">                    &lt;button&gt;-&lt;/button&gt;</span><br><span class="line">                    &lt;span className=<span class="string">&quot;counter&quot;</span>&gt;&#123;item.count&#125;&lt;/span&gt;</span><br><span class="line">                    &lt;button&gt;+&lt;/button&gt;</span><br><span class="line">                  &lt;/td&gt;</span><br><span class="line">                  &lt;td&gt;<span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;e</span> =&gt;</span> this.removeItem(index)&#125;&gt;移除<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span>&lt;/td&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">              )</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &lt;/tbody&gt;</span><br><span class="line">      &lt;/table&gt;</span><br><span class="line">      &lt;h2&gt;</span><br><span class="line">        &#123;<span class="built_in">this</span>.getTotalPrice()&#125;</span><br><span class="line">      &lt;/h2&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">renderEmpty</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>购物车为空~<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重新编写render方法代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; books &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">  <span class="keyword">return</span> books.length ? <span class="built_in">this</span>.renderBooks() : <span class="built_in">this</span>.renderEmpty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列二-JSX语法二</title>
      <link href="/blog/2020/12/14/React%E7%B3%BB%E5%88%97%E4%BA%8C-JSX%E8%AF%AD%E6%B3%95%E4%BA%8C/"/>
      <url>/blog/2020/12/14/React%E7%B3%BB%E5%88%97%E4%BA%8C-JSX%E8%AF%AD%E6%B3%95%E4%BA%8C/</url>
      
        <content type="html"><![CDATA[<h2 id="条件渲染"><a href="#条件渲染" class="headerlink" title="条件渲染"></a>条件渲染</h2><p>某些情况下，界面的内容会根据不同的情况显示不同的内容，或者决定是否渲染某部分内容：</p><ul><li>在vue中，我们会通过指令来控制：比如v-if、v-show；</li><li>在React中，所有的条件判断都和普通的JavaScript代码一致；</li></ul><p>常见的条件渲染的方式有哪些呢？</p><a id="more"></a><h3 id="条件判断语句"><a href="#条件判断语句" class="headerlink" title="条件判断语句"></a>条件判断语句</h3><p>一种方式是当逻辑较多时，通过条件判断：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      isLogin: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> titleJsx = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.state.isLogin) &#123;</span><br><span class="line">      titleJsx = <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>欢迎回来~<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      titleJsx = <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>请先登录~<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &#123;titleJsx&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然，我们也可以将其封装到一个独立的函数中：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      isLogin: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &#123;<span class="built_in">this</span>.getTitleJsx()&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">getTitleJsx</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> titleJsx = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.state.isLogin) &#123;</span><br><span class="line">      titleJsx = <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>欢迎回来~<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      titleJsx = <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>请先登录~<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> titleJsx;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="三元运算符"><a href="#三元运算符" class="headerlink" title="三元运算符"></a>三元运算符</h3><p>另外一种实现条件渲染的方法就是三元运算符：<code>condition ? true : false;</code></p><p>三元运算符适用于没有太多逻辑的代码：只是根据不同的条件直接返回不同的结果</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      isLogin: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;&#123;<span class="built_in">this</span>.state.isLogin ? <span class="string">&quot;欢迎回来~&quot;</span>: <span class="string">&quot;请先登录~&quot;</span>&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.loginBtnClick()&#125;&gt;&#123;<span class="built_in">this</span>.state.isLogin ? <span class="string">&quot;退出&quot;</span>: <span class="string">&quot;登录&quot;</span>&#125;&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">loginBtnClick</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      isLogin: !<span class="built_in">this</span>.state.isLogin</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="与运算符-amp-amp"><a href="#与运算符-amp-amp" class="headerlink" title="与运算符&amp;&amp;"></a>与运算符&amp;&amp;</h3><p>在某些情况下，我们会遇到这样的场景：</p><ul><li>如果条件成立，渲染某一个组件；</li><li>如果条件不成立，什么内容也不渲染；</li></ul><p>如果我们使用三元运算符，是如何做呢？</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="built_in">this</span>.state.isLogin ? <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>&#123;this.state.username&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span>: <span class="literal">null</span>&#125;</span><br></pre></td></tr></table></figure><p>其实我们可以通过<code>逻辑与&amp;&amp;</code>来简化操作：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="built_in">this</span>.state.isLogin &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>&#123;this.state.username&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span>&#125;</span><br></pre></td></tr></table></figure><h3 id="v-show效果"><a href="#v-show效果" class="headerlink" title="v-show效果"></a>v-show效果</h3><p>针对一个HTML原生，渲染和不渲染之间，如果切换的非常频繁，那么会相对比较损耗性能：</p><ul><li>在开发中，其实我们可以通过display的属性来控制它的显示和隐藏；</li><li>在控制方式在vue中有一个专门的指令：v-show；</li><li>React没有指令，但是React会更加灵活（灵活带来的代价就是需要自己去实现）；</li></ul><p>我来看一下如何实现：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; isLogin, username &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">  <span class="keyword">const</span> nameDisplay = isLogin ? <span class="string">&quot;block&quot;</span>: <span class="string">&quot;none&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h2 style=&#123;&#123;<span class="attr">display</span>: nameDisplay&#125;&#125;&gt;&#123;username&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.loginBtnClick()&#125;&gt;&#123;isLogin ? <span class="string">&quot;退出&quot;</span>: <span class="string">&quot;登录&quot;</span>&#125;&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="jsx列表渲染"><a href="#jsx列表渲染" class="headerlink" title="jsx列表渲染"></a>jsx列表渲染</h2><h3 id="列表渲染"><a href="#列表渲染" class="headerlink" title="列表渲染"></a>列表渲染</h3><p>真实开发中我们会从服务器请求到大量的数据，数据会以列表的形式存储：</p><ul><li>比如歌曲、歌手、排行榜列表的数据；</li><li>比如商品、购物车、评论列表的数据；</li><li>比如好友消息、动态、联系人列表的数据；</li></ul><p>在React中并没有像Vue模块语法中的v-for指令，而且需要我们通过JavaScript代码的方式组织数据，转成JSX：</p><ul><li>很多从Vue转型到React的同学非常不习惯，认为Vue的方式更加的简洁明了；</li><li>但是React中的JSX正是因为和JavaScript无缝的衔接，让它可以更加的灵活；</li><li>另外我经常会提到React是真正可以提高我们编写代码能力的一种方式；</li></ul><p>如何展示列表呢？</p><ul><li>在React中，展示列表最多的方式就是使用数组的map高阶函数；</li></ul><p>数组的map函数语法如下：</p><ul><li><p>callback：生成新数组元素的函数，使用三个参数：</p></li><li><ul><li><p><code>currentValue</code></p><p><code>callback</code> 数组中正在处理的当前元素。</p></li><li><p><code>index</code>可选</p><p><code>callback</code> 数组中正在处理的当前元素的索引。</p></li><li><p><code>array</code>可选</p><p><code>map</code> 方法调用的数组。</p></li></ul></li><li><p><code>thisArg</code>可选：执行 <code>callback</code> 函数时值被用作<code>this</code>。</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> new_array = arr.map(<span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params">currentValue[, index[, array]]</span>) </span>&#123;</span><br><span class="line"> <span class="comment">// Return element for new_array </span></span><br><span class="line">&#125;[, thisArg])</span><br></pre></td></tr></table></figure><p>我们来演练一下之前的案例：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      movies: [<span class="string">&quot;盗梦空间&quot;</span>, <span class="string">&quot;大话西游&quot;</span>, <span class="string">&quot;流浪地球&quot;</span>, <span class="string">&quot;少年派&quot;</span>, <span class="string">&quot;食神&quot;</span>, <span class="string">&quot;美人鱼&quot;</span>, <span class="string">&quot;海王&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;电影列表&lt;/h2&gt;</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">this</span>.state.movies.map(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;item&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span>/&gt;</span></span>, <span class="built_in">document</span>.getElementById(<span class="string">&quot;app&quot;</span>));</span><br></pre></td></tr></table></figure><h3 id="数组处理"><a href="#数组处理" class="headerlink" title="数组处理"></a>数组处理</h3><p>很多时候我们在展示一个数组中的数据之前，需要先对它进行一些处理：</p><ul><li>比如过滤掉一些内容：filter函数</li><li>比如截取数组中的一部分内容：slice函数</li></ul><p>比如我当前有一个数组中存放了一系列的数字：[10, 30, 120, 453, 55, 78, 111, 222]</p><p>案例需求：获取所有大于50的数字，并且展示前3个数组</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      numbers: [<span class="number">10</span>, <span class="number">30</span>, <span class="number">120</span>, <span class="number">453</span>, <span class="number">55</span>, <span class="number">78</span>, <span class="number">111</span>, <span class="number">222</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;数字列表&lt;/h2&gt;</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">this</span>.state.numbers.filter(<span class="function"><span class="params">item</span> =&gt;</span> item &gt;= <span class="number">50</span>).slice(<span class="number">0</span>, <span class="number">3</span>).map(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;item&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span>/&gt;</span></span>, <span class="built_in">document</span>.getElementById(<span class="string">&quot;app&quot;</span>));</span><br></pre></td></tr></table></figure><h3 id="列表的key"><a href="#列表的key" class="headerlink" title="列表的key"></a>列表的key</h3><p>我们会发现在前面的代码中只要展示列表都会报一个警告：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/02001.jpg" alt="02001"></p><p>列表展示警告</p><p>这个警告是告诉我们需要在列表展示的jsx中添加一个key。</p><p>至于如何添加一个key，为什么要添加一个key，这个我们放到后面讲解setState时再来讨论；</p><h2 id="JSX原理解析"><a href="#JSX原理解析" class="headerlink" title="JSX原理解析"></a>JSX原理解析</h2><h3 id="JSX转换本质"><a href="#JSX转换本质" class="headerlink" title="JSX转换本质"></a>JSX转换本质</h3><p>实际上，jsx 仅仅只是 <code>React.createElement(component, props, ...children)</code> 函数的语法糖。</p><ul><li>所有的jsx最终都会被转换成<code>React.createElement</code>的函数调用。</li></ul><p>React.createElement在源码的什么位置呢？</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/02002.jpg" alt="图片">React.createElement源码</p><p>createElement需要传递三个参数：</p><ul><li><p>参数一：type</p></li><li><ul><li>当前ReactElement的类型；</li><li>如果是标签元素，那么就使用字符串表示 “div”；</li><li>如果是组件元素，那么就直接使用组件的名称；</li></ul></li><li><p>参数二：config</p></li><li><ul><li>所有jsx中的属性都在config中以对象的属性和值的形式存储</li></ul></li><li><p>参数三：children</p></li><li><ul><li>存放在标签中的内容，以children数组的方式进行存储；</li><li>当然，如果是多个元素呢？React内部有对它们进行处理，处理的源码在下方</li></ul></li></ul><p>对children进行的处理：</p><ul><li>从第二个参数开始，将其他所有的参数，放到props对象的children中</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> childrenLength = <span class="built_in">arguments</span>.length - <span class="number">2</span>;</span><br><span class="line"><span class="keyword">if</span> (childrenLength === <span class="number">1</span>) &#123;</span><br><span class="line">  props.children = children;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (childrenLength &gt; <span class="number">1</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> childArray = <span class="built_in">Array</span>(childrenLength);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; childrenLength; i++) &#123;</span><br><span class="line">    childArray[i] = <span class="built_in">arguments</span>[i + <span class="number">2</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Object</span>.freeze) &#123;</span><br><span class="line">      <span class="built_in">Object</span>.freeze(childArray);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  props.children = childArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>真实的转换过程到底长什么样子呢？我们可以从多个角度来查看。</p><h4 id="Babel官网查看"><a href="#Babel官网查看" class="headerlink" title="Babel官网查看"></a>Babel官网查看</h4><p>我们知道默认jsx是通过babel帮我们进行语法转换的，所以我们之前写的jsx代码都需要依赖babel。</p><ul><li>可以在babel的官网中快速查看转换的过程：<a href="https://babeljs.io/repl/#?presets=react">https://babeljs.io/repl/#?presets=react</a></li></ul><p>在这里我们编写一些jsx代码，来查看运行后的结果：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;div className=<span class="string">&quot;app&quot;</span>&gt;</span><br><span class="line">  &lt;div className=<span class="string">&quot;header&quot;</span>&gt;</span><br><span class="line">    &lt;h1 title=<span class="string">&quot;标题&quot;</span>&gt;我是网站标题&lt;/h1&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;div className=<span class="string">&quot;content&quot;</span>&gt;</span><br><span class="line">    &lt;h2&gt;我是h2元素&lt;/h2&gt;</span><br><span class="line">    &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&quot;+1&quot;</span>)&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">    &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&quot;+1&quot;</span>)&#125;&gt;-<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;div className=<span class="string">&quot;footer&quot;</span>&gt;</span><br><span class="line">    &lt;p&gt;我是网站的尾部&lt;/p&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/02003.jpg" alt="图片">babel转换</p><h4 id="编写createElement"><a href="#编写createElement" class="headerlink" title="编写createElement"></a>编写createElement</h4><p>还有一种办法是我们自己来编写React.createElement代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">/*#__PURE__*/</span></span><br><span class="line">    <span class="keyword">const</span> result = React.createElement(<span class="string">&quot;div&quot;</span>, &#123;</span><br><span class="line">      className: <span class="string">&quot;app&quot;</span></span><br><span class="line">    &#125;, <span class="comment">/*#__PURE__*/</span>React.createElement(<span class="string">&quot;div&quot;</span>, &#123;</span><br><span class="line">      className: <span class="string">&quot;header&quot;</span></span><br><span class="line">    &#125;, <span class="comment">/*#__PURE__*/</span>React.createElement(<span class="string">&quot;h1&quot;</span>, &#123;</span><br><span class="line">      title: <span class="string">&quot;/u6807/u9898&quot;</span></span><br><span class="line">    &#125;, <span class="string">&quot;/u6211/u662F/u7F51/u7AD9/u6807/u9898&quot;</span>)), <span class="comment">/*#__PURE__*/</span>React.createElement(<span class="string">&quot;div&quot;</span>, &#123;</span><br><span class="line">      className: <span class="string">&quot;content&quot;</span></span><br><span class="line">    &#125;, <span class="comment">/*#__PURE__*/</span>React.createElement(<span class="string">&quot;h2&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;/u6211/u662Fh2/u5143/u7D20&quot;</span>), <span class="comment">/*#__PURE__*/</span>React.createElement(<span class="string">&quot;button&quot;</span>, &#123;</span><br><span class="line">      onClick: <span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&quot;+1&quot;</span>)</span><br><span class="line">    &#125;, <span class="string">&quot;+1&quot;</span>), <span class="comment">/*#__PURE__*/</span>React.createElement(<span class="string">&quot;button&quot;</span>, &#123;</span><br><span class="line">      onClick: <span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&quot;+1&quot;</span>)</span><br><span class="line">    &#125;, <span class="string">&quot;-1&quot;</span>)), <span class="comment">/*#__PURE__*/</span>React.createElement(<span class="string">&quot;div&quot;</span>, &#123;</span><br><span class="line">      className: <span class="string">&quot;footer&quot;</span></span><br><span class="line">    &#125;, <span class="comment">/*#__PURE__*/</span>React.createElement(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;/u6211/u662F/u7F51/u7AD9/u7684/u5C3E/u90E8&quot;</span>)));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(React.createElement(App, <span class="literal">null</span>) , <span class="built_in">document</span>.getElementById(<span class="string">&quot;app&quot;</span>));</span><br></pre></td></tr></table></figure><p>上面的整个代码，我们就没有通过jsx来书写了，界面依然是可以正常的渲染。</p><p>另外，在这样的情况下，你还需要babel相关的内容吗？不需要了</p><ul><li>所以，<code>type=&quot;text/babel&quot;</code>可以被我们删除掉了；</li><li>所以，``可以被我们删除掉了；</li></ul><h3 id="虚拟DOM"><a href="#虚拟DOM" class="headerlink" title="虚拟DOM"></a>虚拟DOM</h3><h4 id="虚拟DOM的创建过程"><a href="#虚拟DOM的创建过程" class="headerlink" title="虚拟DOM的创建过程"></a>虚拟DOM的创建过程</h4><p>我们通过 <code>React.createElement</code> 最终创建出来一个 ReactElement对象：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> ReactElement(</span><br><span class="line">  type,</span><br><span class="line">  key,</span><br><span class="line">  ref,</span><br><span class="line">  self,</span><br><span class="line">  source,</span><br><span class="line">  ReactCurrentOwner.current,</span><br><span class="line">  props,</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>这个ReactElement对象是什么作用呢？React为什么要创建它呢？</p><ul><li>原因是React利用ReactElement对象组成了一个JavaScript的对象树；</li><li>JavaScript的对象树就是大名鼎鼎的虚拟DOM（Virtual DOM）；</li></ul><p>如何查看ReactElement的树结构呢？</p><ul><li>我们可以将之前的jsx返回结果进行打印；</li><li>注意下面代码中我打jsx的打印；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> jsx = (</span><br><span class="line">    &lt;div className=<span class="string">&quot;app&quot;</span>&gt;</span><br><span class="line">      &lt;div className=<span class="string">&quot;header&quot;</span>&gt;</span><br><span class="line">        &lt;h1 title=<span class="string">&quot;标题&quot;</span>&gt;我是网站标题&lt;/h1&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div className=<span class="string">&quot;content&quot;</span>&gt;</span><br><span class="line">        &lt;h2&gt;我是h2元素&lt;/h2&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&quot;+1&quot;</span>)&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&quot;+1&quot;</span>)&#125;&gt;-<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div className=<span class="string">&quot;footer&quot;</span>&gt;</span><br><span class="line">        &lt;p&gt;我是网站的尾部&lt;/p&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">  <span class="built_in">console</span>.log(jsx);</span><br><span class="line">  <span class="keyword">return</span> jsx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>打印结果，在浏览器中查看：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/02004.jpg" alt="图片">ReactElement对象结构</p><p>而ReactElement最终形成的树结构就是Virtual DOM；</p><p>整体的转换过程如下：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-12-14-React系列/02005.jpg" alt="图片">jsx转换流程</p><h4 id="为什么采用虚拟DOM"><a href="#为什么采用虚拟DOM" class="headerlink" title="为什么采用虚拟DOM"></a>为什么采用虚拟DOM</h4><p>为什么要采用虚拟DOM，而不是直接修改真实的DOM呢？</p><ul><li>很难跟踪状态发生的改变：原有的开发模式，我们很难跟踪到状态发生的改变，不方便针对我们应用程序进行调试；</li><li>操作真实DOM性能较低：传统的开发模式会进行频繁的DOM操作，而这一的做法性能非常的低；</li></ul><p><strong>DOM操作性能非常低：</strong></p><p>首先，document.createElement本身创建出来的就是一个非常复杂的对象；</p><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/createElement">https://developer.mozilla.org/zh-CN/docs/Web/API/Document/createElement</a></li></ul><p>其次，DOM操作会引起浏览器的回流和重绘，所以在开发中应该避免频繁的DOM操作；</p><p><strong>这里我们举一个例子：</strong></p><p>比如我们有一组数组需要渲染：[0, 1, 2, 3, 4]，我们会怎么做呢？</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul&gt;</span><br><span class="line">  &lt;li&gt;<span class="number">0</span>&lt;/li&gt;</span><br><span class="line">  &lt;li&gt;<span class="number">1</span>&lt;/li&gt;</span><br><span class="line">  &lt;li&gt;<span class="number">2</span>&lt;/li&gt;</span><br><span class="line">  &lt;li&gt;<span class="number">3</span>&lt;/li&gt;</span><br><span class="line">  &lt;li&gt;<span class="number">4</span>&lt;/li&gt;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure><p>后来，我们又增加了5条数据：[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">5</span>; i&lt;<span class="number">10</span>; i++) &#123;</span><br><span class="line">  <span class="keyword">var</span> li = <span class="built_in">document</span>.createElement(<span class="string">&quot;li&quot;</span>);</span><br><span class="line">  li.innerHTML = arr[i];</span><br><span class="line">  ul.appendChild(li);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面这段代码的性能怎么样呢？非常低效</p><ul><li>因为我们通过 <code>document.createElement</code> 创建元素，再通过 <code>ul.appendChild(li)</code> 渲染到DOM上，进行了多次DOM操作；</li><li>对于批量操作的，最好的办法不是一次次修改DOM，而是对批量的操作进行合并；（比如可以通过DocumentFragment进行合并）；</li></ul><p><strong>虚拟DOM帮助我们从命令式编程转到了声明式编程的模式</strong></p><p>React官方的说法：Virtual DOM 是一种编程理念。</p><p>在这个理念中，UI以一种理想化或者说虚拟化的方式保存在内存中，并且它是一个相对简单的JavaScript对象，我们可以通过ReactDOM.render让 <code>虚拟DOM</code> 和 <code>真实DOM</code>同步起来，这个过程中叫做协调（Reconciliation）；</p><p>这种编程的方式赋予了React声明式的API：你只需要告诉React希望让UI是什么状态，React来确保DOM和这些状态是匹配的。</p><p>你不需要直接进行DOM操作，只可以从手动更改DOM、属性操作、事件处理中解放出来；</p><p><strong>关于虚拟DOM的一些其他内容，在后续的学习中还会再次讲到；</strong></p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列-目录</title>
      <link href="/blog/2020/12/14/React%E7%B3%BB%E5%88%97-%E7%9B%AE%E5%BD%95/"/>
      <url>/blog/2020/12/14/React%E7%B3%BB%E5%88%97-%E7%9B%AE%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<p><img src="F:\ImageBed\images_blog\2020-12-14-React系列\React.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列二-JSX语法</title>
      <link href="/blog/2020/12/14/React%E7%B3%BB%E5%88%97%E4%BA%8C-JSX%E8%AF%AD%E6%B3%95/"/>
      <url>/blog/2020/12/14/React%E7%B3%BB%E5%88%97%E4%BA%8C-JSX%E8%AF%AD%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h2 id="ES6的class"><a href="#ES6的class" class="headerlink" title="ES6的class"></a>ES6的class</h2><blockquote><p>虽然目前React开发模式中更加流行hooks，但是依然有很多的项目依然是使用类组件（包括AntDesign库中）</p></blockquote><h3 id="类的定义"><a href="#类的定义" class="headerlink" title="类的定义"></a>类的定义</h3><p>在ES6之前，我们通过function来定义类，但是这种模式一直被很多从其他编程语言（比如Java、C++、OC等等）转到JavaScript的人所不适应。</p><p>原因是，大多数面向对象的语言，都是使用class关键字来定义类的。</p><p>而JavaScript也从ES6开始引入了class关键字，用于定义一个类。</p><p>ES6之前定义一个Person类：</p><a id="more"></a><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name, age</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.name = name;</span><br><span class="line">  <span class="built_in">this</span>.age = age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Person.prototype.running = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="built_in">this</span>.name + <span class="built_in">this</span>.age + <span class="string">&quot;running&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> Person(<span class="string">&quot;why&quot;</span>, <span class="number">18</span>);</span><br><span class="line">p.running();</span><br></pre></td></tr></table></figure><p>转换成ES6中的类如何定义呢？</p><ul><li><p>类中有一个constructor构造方法，当我们通过new关键字调用时，就会默认执行这个构造方法</p></li><li><ul><li>构造方法中可以给当前对象添加属性</li></ul></li><li><p>类中也可以定义其他方法，这些方法会被放到Person类的prototype上</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">name, age</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">    <span class="built_in">this</span>.age = age;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">running</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.name + <span class="built_in">this</span>.age + <span class="string">&quot;running&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> Person(<span class="string">&quot;why&quot;</span>, <span class="number">18</span>);</span><br><span class="line">p.running();</span><br></pre></td></tr></table></figure><p>另外，属性也可以直接定义在类中：</p><ul><li>height和address是直接定义在类中</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  height = <span class="number">1.88</span>;</span><br><span class="line">  address = <span class="string">&quot;北京市&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">name, age</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">    <span class="built_in">this</span>.age = age;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">studying</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.name + <span class="built_in">this</span>.age + <span class="string">&quot;studying&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="类的继承"><a href="#类的继承" class="headerlink" title="类的继承"></a>类的继承</h3><p>继承是面向对象的一大特性，可以减少我们重复代码的编写，方便公共内容的抽取（也是很多面向对象语言中，多态的前提）。</p><p>ES6中增加了extends关键字来作为类的继承。</p><p>我们先写两个类没有继承的情况下，它们存在的重复代码：</p><ul><li>Persion类和Student类</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">name, age</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">    <span class="built_in">this</span>.age = age;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">running</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.name, <span class="built_in">this</span>.age, <span class="string">&quot;running&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">name, age, sno, score</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">    <span class="built_in">this</span>.age = age;</span><br><span class="line">    <span class="built_in">this</span>.sno = sno;</span><br><span class="line">    <span class="built_in">this</span>.score = score;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">running</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.name, <span class="built_in">this</span>.age, <span class="string">&quot;running&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">studying</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.name, <span class="built_in">this</span>.age, <span class="built_in">this</span>.sno, <span class="built_in">this</span>.score, <span class="string">&quot;studing&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们可以使用继承来简化代码：</p><ul><li>注意：在constructor中，子类必须通过super来调用父类的构造方法，对父类进行初始化，否则会报错</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student1</span> <span class="keyword">extends</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">name, age, sno, score</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(name, age);</span><br><span class="line">    <span class="built_in">this</span>.sno = sno;</span><br><span class="line">    <span class="built_in">this</span>.score = score;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">studying</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.name, <span class="built_in">this</span>.age, <span class="built_in">this</span>.sno, <span class="built_in">this</span>.score, <span class="string">&quot;studing&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> stu1 = <span class="keyword">new</span> Student1(<span class="string">&quot;why&quot;</span>, <span class="number">18</span>, <span class="number">110</span>, <span class="number">100</span>);</span><br><span class="line">stu1.studying();</span><br></pre></td></tr></table></figure><h2 id="案例练习"><a href="#案例练习" class="headerlink" title="案例练习"></a>案例练习</h2><h3 id="列表展示"><a href="#列表展示" class="headerlink" title="列表展示"></a>列表展示</h3><p>真实开发中，我们的数据通常会从服务器获取，比较常见的是获取一个列表数据，保存到一个数组中进行展示</p><ul><li>比如现在有一个电影列表，我们如何通过React进行展示呢？</li></ul><p>我们还是通过一个组件来完成：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      movies: [<span class="string">&quot;星际穿越&quot;</span>, <span class="string">&quot;大话西游&quot;</span>, <span class="string">&quot;盗梦空间&quot;</span>, <span class="string">&quot;少年派&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// var movieLis = [];</span></span><br><span class="line">    <span class="comment">// for (var i in this.state.movies) &#123;</span></span><br><span class="line">    <span class="comment">//   movieLis.push((&lt;li&gt;&#123;this.state.movies[i]&#125;&lt;/li&gt;));</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;电影列表&lt;/h2&gt;</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">this</span>.state.movies.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;item&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span>)</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span>/&gt;</span></span>, <span class="built_in">document</span>.getElementById(<span class="string">&quot;app&quot;</span>));</span><br></pre></td></tr></table></figure><h3 id="计数器案例"><a href="#计数器案例" class="headerlink" title="计数器案例"></a>计数器案例</h3><p>电影列表的案例中并没有交互，我们再来实现一个计数器的案例：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      counter: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;当前计数:&#123;<span class="built_in">this</span>.state.counter&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="built_in">this</span>.increment.bind(<span class="built_in">this</span>)&#125;&gt;+<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="built_in">this</span>.decrement.bind(<span class="built_in">this</span>)&#125;&gt;-<span class="number">1</span>&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">increment</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      counter: <span class="built_in">this</span>.state.counter+<span class="number">1</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">decrement</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      counter: <span class="built_in">this</span>.state.counter-<span class="number">1</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span>/&gt;</span></span>, <span class="built_in">document</span>.getElementById(<span class="string">&quot;app&quot;</span>));</span><br></pre></td></tr></table></figure><h2 id="JSX语法解析"><a href="#JSX语法解析" class="headerlink" title="JSX语法解析"></a>JSX语法解析</h2><h3 id="认识JSX的语法"><a href="#认识JSX的语法" class="headerlink" title="认识JSX的语法"></a>认识JSX的语法</h3><p>我们先来看一段代码：</p><ul><li><p>这段element变量的声明右侧赋值的标签语法是什么呢？</p></li><li><ul><li>它不是一段字符串（因为没有使用引号包裹），它看起来是一段HTML原生，但是我们能在js中直接给一个变量赋值html吗？</li><li>其实是不可以的，如果我们将 <code>type=&quot;text/babel&quot;</code> 去除掉，那么就会出现语法错误；</li><li>它到底是什么呢？其实它是一段jsx的语法；</li></ul></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">&quot;text/babel&quot;</span>&gt;</span><br><span class="line">  <span class="keyword">const</span> element = <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"> ReactDOM.render(element, <span class="built_in">document</span>.getElementById(<span class="string">&quot;app&quot;</span>));</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>JSX是什么？</p><ul><li>JSX是一种JavaScript的语法扩展（eXtension），也在很多地方称之为JavaScript XML，因为看起就是一段XML语法；</li><li>它用于描述我们的UI界面，并且其完全可以和JavaScript融合在一起使用；</li><li>它不同于Vue中的模块语法，你不需要专门学习模块语法中的一些指令（比如v-for、v-if、v-else、v-bind）；</li></ul><p>为什么React选择了JSX？</p><ul><li><p>React认为渲染逻辑本质上与其他UI逻辑存在内在耦合</p></li><li><ul><li>比如UI需要绑定事件（button、a原生等等）；</li><li>比如UI中需要展示数据状态，在某些状态发生改变时，又需要改变UI；</li></ul></li><li><p>他们之间是密不可分，所以React没有将标记分离到不同的文件中，而是将它们组合到了一起，这个地方就是组件（Component）；</p></li><li><ul><li>当然，后面我们还是会继续学习更多组件相关的东西；</li></ul></li><li><p>在这里，我们只需要知道，JSX其实是嵌入到JavaScript中的一种结构语法；</p></li></ul><p>JSX的书写规范：</p><ul><li><p>JSX的顶层<strong>只能有一个根元素</strong>，所以我们很多时候会在外层包裹一个div原生（或者使用后面我们学习的Fragment）；</p></li><li><p>为了方便阅读，我们通常在jsx的外层包裹一个小括号()，这样可以方便阅读，并且jsx可以进行换行书写；</p></li><li><p>JSX中的标签可以是单标签，也可以是双标签；</p></li><li><ul><li>注意：如果是单标签，必须以/&gt;结尾；</li></ul></li></ul><p>JSX的本质，我们后面再来讨论；</p><h3 id="JSX嵌入表达式"><a href="#JSX嵌入表达式" class="headerlink" title="JSX嵌入表达式"></a>JSX嵌入表达式</h3><p>如果我们jsx中的内容是动态的，我们可以通过表达式来获取：</p><ul><li>书写规则：{表达式}</li><li>大括号内可以是变量、字符串、数组、函数调用等任意js表达式；</li></ul><h4 id="jsx中的注释"><a href="#jsx中的注释" class="headerlink" title="jsx中的注释"></a>jsx中的注释</h4><p>jsx是嵌入到JavaScript中的一种语法，所以在编写注释时，需要通过JSX的语法来编写：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;</span><br><span class="line">  &#123;&#x2F;* 我是一段注释 *&#x2F;&#125;</span><br><span class="line">  &lt;h2&gt;Hello World&lt;&#x2F;h2&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure><h4 id="JSX嵌入变量"><a href="#JSX嵌入变量" class="headerlink" title="JSX嵌入变量"></a>JSX嵌入变量</h4><ul><li><p>情况一：当变量是Number、String、Array类型时，可以直接显示</p></li><li><p>情况二：当变量是null、undefined、Boolean类型时，内容为空；</p></li><li><ul><li>如果希望可以显示null、undefined、Boolean，那么需要转成字符串；</li><li>转换的方式有很多，比如toString方法、和空字符串拼接，String(变量)等方式；</li></ul></li><li><p>情况三：对象类型不能作为子元素（not valid as a React child）</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      name: <span class="string">&quot;why&quot;</span>,</span><br><span class="line">      age: <span class="number">18</span>,</span><br><span class="line">      hobbies: [<span class="string">&quot;篮球&quot;</span>, <span class="string">&quot;唱跳&quot;</span>, <span class="string">&quot;rap&quot;</span>],</span><br><span class="line">      </span><br><span class="line">      test1: <span class="literal">null</span>,</span><br><span class="line">      test2: <span class="literal">undefined</span>,</span><br><span class="line">      flag: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      friend: &#123;</span><br><span class="line">        name: <span class="string">&quot;kobe&quot;</span>,</span><br><span class="line">        age: <span class="number">40</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &#123;<span class="comment">/* 我是一段注释 */</span>&#125;</span><br><span class="line">        &lt;h2&gt;Hello World&lt;/h2&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &#123;<span class="comment">/* 1.可以直接显示 */</span>&#125;</span><br><span class="line">        &lt;h2&gt;&#123;<span class="built_in">this</span>.state.name&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;h2&gt;&#123;<span class="built_in">this</span>.state.age&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;h2&gt;&#123;<span class="built_in">this</span>.state.hobbies&#125;&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        &#123;<span class="comment">/* 2.不显示 */</span>&#125;</span><br><span class="line">        &lt;h2&gt;&#123;<span class="built_in">this</span>.state.test1&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;h2&gt;&#123;<span class="built_in">this</span>.state.test1 + <span class="string">&quot;&quot;</span>&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;h2&gt;&#123;<span class="built_in">this</span>.state.test2&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;h2&gt;&#123;<span class="built_in">this</span>.state.test2 + <span class="string">&quot;&quot;</span>&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;h2&gt;&#123;<span class="built_in">this</span>.state.flag&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;h2&gt;&#123;<span class="built_in">this</span>.state.flag + <span class="string">&quot;&quot;</span>&#125;&lt;/h2&gt;</span><br><span class="line">        </span><br><span class="line">        &#123;<span class="comment">/* 3.不显示 */</span>&#125;</span><br><span class="line">        &lt;h2&gt;<span class="number">123</span>&#123;<span class="built_in">this</span>.state.friend&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span>/&gt;</span></span>, <span class="built_in">document</span>.getElementById(<span class="string">&quot;app&quot;</span>));</span><br></pre></td></tr></table></figure><p><strong>补充：为什么null、undefined、Boolean在JSX中要显示为空内容呢？</strong></p><p>原因是在开发中，我们会进行很多的判断；</p><ul><li>在判断结果为false时，不显示一个内容；</li><li>在判断结果为true时，显示一个内容；</li></ul><p>这个时候，我们可以编写如下代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      flag: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &#123;<span class="built_in">this</span>.state.flag ? <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>我是标题<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span>: <span class="literal">null</span>&#125;</span><br><span class="line">        &#123;<span class="built_in">this</span>.state.flag &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>我是标题<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span>&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="JSX嵌入表达式-1"><a href="#JSX嵌入表达式-1" class="headerlink" title="JSX嵌入表达式"></a>JSX嵌入表达式</h4><p>JSX中，也可以是一个表达式。</p><p>这里我们演练三个，其他的大家在开发中灵活运用：</p><ul><li>运算表达式</li><li>三元运算符</li><li>执行一个函数</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      firstName: <span class="string">&quot;kobe&quot;</span>,</span><br><span class="line">      lastName: <span class="string">&quot;bryant&quot;</span>,</span><br><span class="line">      age: <span class="number">20</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &#123;<span class="comment">/* 运算表达式 */</span>&#125;</span><br><span class="line">        &lt;h2&gt;&#123;<span class="built_in">this</span>.state.firstName + <span class="string">&quot; &quot;</span> + <span class="built_in">this</span>.state.lastName&#125;&lt;/h2&gt;</span><br><span class="line">        &#123;<span class="comment">/* 三元运算符 */</span>&#125;</span><br><span class="line">        &lt;h2&gt;&#123;<span class="built_in">this</span>.state.age &gt;= <span class="number">18</span> ? <span class="string">&quot;成年人&quot;</span>: <span class="string">&quot;未成年人&quot;</span>&#125;&lt;/h2&gt;</span><br><span class="line">        &#123;<span class="comment">/* 执行一个函数 */</span>&#125;</span><br><span class="line">        &lt;h2&gt;&#123;<span class="built_in">this</span>.sayHello(<span class="string">&quot;kobe&quot;</span>)&#125;&lt;/h2&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">sayHello</span>(<span class="params">name</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello &quot;</span> + name;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="jsx绑定属性"><a href="#jsx绑定属性" class="headerlink" title="jsx绑定属性"></a>jsx绑定属性</h4><p>很多时候，描述的HTML原生会有一些属性，而我们希望这些属性也是动态的：</p><ul><li><p>比如元素都会有title属性</p></li><li><p>比如img元素会有src属性</p></li><li><p>比如a元素会有href属性</p></li><li><p>比如元素可能需要绑定class</p></li><li><ul><li>注意：绑定class比较特殊，因为class在js中是一个关键字，所以jsx中不允许直接写class</li><li>写法：使用className替代</li></ul></li><li><p>比如原生使用内联样式style</p></li><li><ul><li>style后面跟的是一个对象类型，对象中是样式的属性名和属性值；</li><li>注意：这里会讲属性名转成驼峰标识，而不是连接符-；</li></ul></li></ul><p>我们来演示一下属性的绑定：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      title: <span class="string">&quot;你好啊&quot;</span>,</span><br><span class="line">      imgUrl: <span class="string">&quot;https://upload.jianshu.io/users/upload_avatars/1102036/c3628b478f06.jpeg?imageMogr2/auto-orient/strip|imageView2/1/w/240/h/240&quot;</span>,</span><br><span class="line">      link: <span class="string">&quot;https://www.baidu.com&quot;</span>,</span><br><span class="line">      active: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2 title=&#123;<span class="built_in">this</span>.state.title&#125;&gt;Hello World&lt;/h2&gt;</span><br><span class="line">        &lt;img src=&#123;<span class="built_in">this</span>.state.imgUrl&#125; alt=<span class="string">&quot;&quot;</span>/&gt;</span><br><span class="line">        &lt;a href=&#123;<span class="built_in">this</span>.state.link&#125; target=<span class="string">&quot;_blank&quot;</span>&gt;百度一下&lt;/a&gt;</span><br><span class="line">        &lt;div className=&#123;<span class="string">&quot;message &quot;</span> + (<span class="built_in">this</span>.state.active ? <span class="string">&quot;active&quot;</span>: <span class="string">&quot;&quot;</span>)&#125;&gt;你好啊&lt;/div&gt;</span><br><span class="line">        &lt;div className=&#123;[<span class="string">&quot;message&quot;</span>, (<span class="built_in">this</span>.state.active ? <span class="string">&quot;active&quot;</span>: <span class="string">&quot;&quot;</span>)].join(<span class="string">&quot; &quot;</span>)&#125;&gt;你好啊&lt;/div&gt;</span><br><span class="line">        &lt;div style=&#123;&#123;<span class="attr">fontSize</span>: <span class="string">&quot;30px&quot;</span>, <span class="attr">color</span>: <span class="string">&quot;red&quot;</span>, <span class="attr">backgroundColor</span>: <span class="string">&quot;blue&quot;</span>&#125;&#125;&gt;我是文本&lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="jsx事件监听"><a href="#jsx事件监听" class="headerlink" title="jsx事件监听"></a>jsx事件监听</h3><h4 id="和原生绑定区别"><a href="#和原生绑定区别" class="headerlink" title="和原生绑定区别"></a>和原生绑定区别</h4><p>如果原生DOM原生有一个监听事件，我们可以如何操作呢？</p><ul><li>方式一：获取DOM原生，添加监听事件；</li><li>方式二：在HTML原生中，直接绑定onclick；</li></ul><p>我们这里演练一下方式二：</p><ul><li><code>btnClick()</code>这样写的原因是onclick绑定的后面是跟上JavaScript代码；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;button onclick=<span class="string">&quot;btnClick()&quot;</span>&gt;点我一下&lt;/button&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">btnClick</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;按钮发生了点击&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>在React中是如何操作呢？</p><p>我们来实现一下React中的事件监听，这里主要有两点不同</p><ul><li>React 事件的命名采用小驼峰式（camelCase），而不是纯小写；</li><li>我们需要通过{}传入一个事件处理函数，这个函数会在事件发生时被执行；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="built_in">this</span>.btnClick&#125;&gt;点我一下(React)&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">btnClick</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;React按钮点击了一下&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="this绑定问题"><a href="#this绑定问题" class="headerlink" title="this绑定问题"></a>this绑定问题</h4><p>在事件执行后，我们可能需要获取当前类的对象中相关的属性：</p><ul><li><p>比如我们这里打印：<code>this.state.message</code></p></li><li><ul><li>但是这里会报错：<code>Cannot read property &#39;state&#39; of undefined</code></li><li>原因是this在这里是undefined</li></ul></li><li><p>如果我们这里直接打印this，也会发现它是一个undefined</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      message: <span class="string">&quot;你好啊,李银河&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="built_in">this</span>.btnClick&#125;&gt;点我一下(React)&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">btnClick</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.state.message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为什么是undefined呢？</p><ul><li>原因是<code>btnClick</code>函数并不是我们主动调用的，而且当button发生改变时，React内部调用了<code>btnClick</code>函数；</li><li>而它内部调用时，并不知道要如何绑定正确的this；</li></ul><p><strong>如何解决this的问题呢？</strong></p><p><strong>方案一：bind给btnClick显示绑定this</strong></p><p>在传入函数时，我们可以主动绑定this：</p><ul><li>这里我们主动将btnClick中的this通过bind来进行绑定（显示绑定）</li><li>那么之后React内部调用btnClick函数时，就会有一个this，并且是我们绑定的this；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;button onClick=&#123;<span class="built_in">this</span>.btnClick.bind(<span class="built_in">this</span>)&#125;&gt;点我一下(React)&lt;/button&gt;</span><br></pre></td></tr></table></figure><p>但是呢，如果我有两个函数都需要用到btnClick的绑定：</p><ul><li>我们发现 <code>bind(this)</code> 需要书写两遍；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;button onClick=&#123;<span class="built_in">this</span>.btnClick.bind(<span class="built_in">this</span>)&#125;&gt;点我一下(React)&lt;/button&gt;</span><br><span class="line">&lt;button onClick=&#123;<span class="built_in">this</span>.btnClick.bind(<span class="built_in">this</span>)&#125;&gt;也点我一下(React)&lt;/button&gt;</span><br></pre></td></tr></table></figure><p>这个我们可以通过在构造方法中直接给this.btnClick绑定this来解决：</p><ul><li>注意查看 <code>constructor</code> 中我们的操作：<code>this.btnClick = this.btnClick.bind(this);</code></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      message: <span class="string">&quot;你好啊,李银河&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.btnClick = <span class="built_in">this</span>.btnClick.bind(<span class="built_in">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="built_in">this</span>.btnClick&#125;&gt;点我一下(React)&lt;/button&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="built_in">this</span>.btnClick&#125;&gt;也点我一下(React)&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">btnClick</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.state.message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>方案二：使用 ES6 class fields 语法</strong></p><p>你会发现我这里将btnClick的定义变成了一种赋值语句：</p><ul><li>这是ES6中给类定义属性的方法，称之为class fields语法；</li><li>因为这里我们赋值时，使用了箭头函数，所以在当前函数中的this会去上一个<strong>作用域</strong>中查找；</li><li>而上一个作用域中的this就是当前的对象；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      message: <span class="string">&quot;你好啊,李银河&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="built_in">this</span>.btnClick&#125;&gt;点我一下(React)&lt;/button&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="built_in">this</span>.btnClick&#125;&gt;也点我一下(React)&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  btnClick = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.state.message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>方案三：事件监听时传入箭头函数（推荐）</strong></p><p>因为 <code>onClick</code> 中要求我们传入一个函数，那么我们可以直接定义一个箭头函数传入：</p><ul><li>传入的箭头函数的函数体是我们需要执行的代码，我们直接执行 <code>this.btnClick()</code>；</li><li><code>this.btnClick()</code>中通过this来指定会进行隐式绑定，最终this也是正确的；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      message: <span class="string">&quot;你好啊,李银河&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function">() =&gt;</span> <span class="built_in">this</span>.btnClick()&#125;&gt;点我一下(React)&lt;/button&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="function">() =&gt;</span> <span class="built_in">this</span>.btnClick()&#125;&gt;也点我一下(React)&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">btnClick</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.state.message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="事件参数传递"><a href="#事件参数传递" class="headerlink" title="事件参数传递"></a>事件参数传递</h4><p>在执行事件函数时，有可能我们需要获取一些参数信息：比如event对象、其他参数</p><p>情况一：获取event对象</p><ul><li>很多时候我们需要拿到event对象来做一些事情（比如阻止默认行为）</li><li>假如我们用不到this，那么直接传入函数就可以获取到event对象；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;a href=<span class="string">&quot;http://www.baidu.com&quot;</span> onClick=&#123;<span class="built_in">this</span>.btnClick&#125;&gt;点我一下&lt;/a&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">btnClick</span>(<span class="params">e</span>)</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    <span class="built_in">console</span>.log(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>情况二：获取更多参数</p><ul><li>有更多参数时，我们最好的方式就是传入一个箭头函数，主动执行的事件函数，并且传入相关的其他参数；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      names: [<span class="string">&quot;衣服&quot;</span>, <span class="string">&quot;鞋子&quot;</span>, <span class="string">&quot;裤子&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;a href=<span class="string">&quot;http://www.baidu.com&quot;</span> onClick=&#123;<span class="built_in">this</span>.aClick&#125;&gt;点我一下&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">this</span>.state.names.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">              &lt;a href=<span class="string">&quot;#&quot;</span> onClick=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">this</span>.aClick(e, item, index)&#125;&gt;&#123;item&#125;&lt;/a&gt;</span><br><span class="line">            )</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">aClick</span>(<span class="params">e, item, index</span>)</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    <span class="built_in">console</span>.log(item, index);</span><br><span class="line">    <span class="built_in">console</span>.log(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>转载自</p><blockquote><p><a href="https://mp.weixin.qq.com/s/Ow3KeMuyBSh6sFavOx21_g">https://mp.weixin.qq.com/s/Ow3KeMuyBSh6sFavOx21_g</a>   coderwhy老师的课程</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React系列一-邂逅React开发</title>
      <link href="/blog/2020/12/14/React%E7%B3%BB%E5%88%97%E4%B8%80-%E9%82%82%E9%80%85React%E5%BC%80%E5%8F%91/"/>
      <url>/blog/2020/12/14/React%E7%B3%BB%E5%88%97%E4%B8%80-%E9%82%82%E9%80%85React%E5%BC%80%E5%8F%91/</url>
      
        <content type="html"><![CDATA[<h3 id="React简介"><a href="#React简介" class="headerlink" title="React简介"></a>React简介</h3><h3 id="React开发依赖"><a href="#React开发依赖" class="headerlink" title="React开发依赖"></a>React开发依赖</h3><h4 id="依赖说明"><a href="#依赖说明" class="headerlink" title="依赖说明"></a>依赖说明</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 注意: 部署时，将 <span class="string">&quot;development.js&quot;</span> 替换为 <span class="string">&quot;production.min.js&quot;</span>。--&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;https://unpkg.com/react@16/umd/react.development.js&quot;</span> crossorigin&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;https://unpkg.com/react-dom@16/umd/react-dom.development.js&quot;</span> crossorigin&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 加载我们的 React 组件。--&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;like_button.js&quot;</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>开发React必须依赖三个库：</p><ul><li>react： 包含react所必须的核心代码</li><li>react-dom：react渲染在不同平台所需要的核心代码</li><li>babel：将jsx转换为React代码的工具</li></ul><a id="more"></a><p>第一次接触React会被它繁琐的依赖搞蒙，对于Vue来说，我们只是依赖一个vue.js文件即可，但是react居然要依赖三个库。</p><p>其实呢，这三个库是各司其职的，目的就是让每一个库只单纯做自己的事情：</p><ul><li><p>在React的0.14版本之前是没有react-dom这个概念的，所有功能都包含在react里。</p></li><li><p>为什么要进行拆分呢？原因就是react-native。</p></li><li><p>react包中包含了react和react-native所共同拥有的核心代码。</p></li><li><p>react-dom针对web和native所完成的事情不同：</p></li><li><ul><li>web端：react-dom会讲jsx最终渲染成真实的DOM，显示在浏览器中</li><li>native端：react-dom会讲jsx最终渲染成原生的控件（比如Android中的Button，iOS中的UIButton）。</li></ul></li></ul><p>babel是什么呢？</p><ul><li><strong>Babel</strong> ，又名 <strong>Babel.js</strong>。</li><li>是目前前端使用非常广泛的编辑器、转移器。</li><li>比如当下很多浏览器并不支持ES6的语法，但是确实ES6的语法非常的简洁和方便，我们<strong>开发时</strong>希望使用它。</li><li>那么编写源码时我们就可以使用ES6来编写，之后通过Babel工具，将ES6转成大多数浏览器都支持的ES5的语法。</li></ul><p>React和Babel的关系：</p><ul><li>默认情况下开发React其实可以不使用babel。</li><li>但是前提是我们自己使用 <code>React.createElement</code> 来编写源代码，它编写的代码非常的繁琐和可读性差。</li><li>那么我们就可以直接编写jsx（JavaScript XML）的语法，并且让babel帮助我们转换成React.createElement。</li><li>后续还会讲到；</li></ul><p>所以，我们在编写React代码时，这三个依赖都是必不可少的。</p><h4 id="依赖引用"><a href="#依赖引用" class="headerlink" title="依赖引用"></a>依赖引用</h4><ul><li><p>方式一：直接CDN引入</p></li><li><ul><li>react依赖：<a href="https://unpkg.com/react@16/umd/react.development.js">https://unpkg.com/react@16/umd/react.development.js</a></li><li>react-dom依赖：<a href="https://unpkg.com/react-dom@16/umd/react-dom.development.js">https://unpkg.com/react-dom@16/umd/react-dom.development.js</a></li><li>babel依赖：<a href="https://unpkg.com/babel-standalone@6/babel.min.js">https://unpkg.com/babel-standalone@6/babel.min.js</a></li></ul></li><li><p>方式二：下载后，添加本地依赖</p></li><li><p>方式三：通过npm管理（后续脚手架再使用）</p></li></ul><p>暂时我们直接通过CDN引入，来演练下面的示例程序：</p><ul><li>这里有一个crossorigin的属性，这个属性的目的是为了拿到跨域脚本的错误信息</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">&quot;https://unpkg.com/react@16/umd/react.development.js&quot;</span> crossorigin&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;https://unpkg.com/react-dom@16/umd/react-dom.development.js&quot;</span> crossorigin&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;https://unpkg.com/babel-standalone@6/babel.min.js&quot;</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure><h3 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h3><h4 id="第一版"><a href="#第一版" class="headerlink" title="第一版"></a>第一版</h4><p>需求非常简单：通过React实现浏览器显示Hello World</p><p><code>注意</code>：在script标签中编写React代码时，必须添加<code>type=&quot;text\babel&quot;</code>，作用是可以让babel解析jsx的语法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">方式一：直接CDN引入</span><br><span class="line">react依赖：https:<span class="comment">//unpkg.com/react@16/umd/react.development.js</span></span><br><span class="line">react-dom依赖：https:<span class="comment">//unpkg.com/react-dom@16/umd/react-dom.development.js</span></span><br><span class="line">babel依赖：https:<span class="comment">//unpkg.com/babel-standalone@6/babel.min.js</span></span><br><span class="line">方式二：下载后，添加本地依赖</span><br><span class="line">方式三：通过npm管理（后续脚手架再使用）</span><br><span class="line">暂时我们直接通过CDN引入，来演练下面的示例程序：</span><br><span class="line">这里有一个crossorigin的属性，这个属性的目的是为了拿到跨域脚本的错误信息</span><br><span class="line">&lt;script src=<span class="string">&quot;https://unpkg.com/react@16/umd/react.development.js&quot;</span> crossorigin&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;https://unpkg.com/react-dom@16/umd/react-dom.development.js&quot;</span> crossorigin&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;https://unpkg.com/babel-standalone@6/babel.min.js&quot;</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>代码解析：</p><ul><li><p>依赖不需要多讲，开发React代码必须添加三个依赖；</p></li><li><p>ReactDOM.render函数：</p></li><li><ul><li>这里我们已经提前定义一个id为app的div</li><li>这里我们传入了一个h2元素，后面我们就会使用React组件</li><li>参数一：传递要渲染的内容，这个内容可以是HTML元素，也可以是React的组件</li><li>参数二：将渲染的内容，挂载到哪一个HTML元素上</li></ul></li></ul><h4 id="第二版"><a href="#第二版" class="headerlink" title="第二版"></a>第二版</h4><p>按照我们最初的案例，我们已经实现了Hello World，但是我们希望点击一个按钮后，修改为Hello React</p><h5 id="错误的方式"><a href="#错误的方式" class="headerlink" title="错误的方式"></a>错误的方式</h5><p>下面的代码是我们正常的执行逻辑，但是会报错：</p><ul><li>原因是默认情况下 <code>ReactDOM.render</code> 会覆盖挂载到的app原生中的所有内容；</li><li>所以在执行完 <code>ReactDOM.render</code> 之后，就不存在button原生了；</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;  </span><br><span class="line">  &lt;div id=<span class="string">&quot;app&quot;</span>&gt;</span><br><span class="line">    &lt;button <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;change-btn&quot;</span>&gt;改变文本&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;script src=<span class="string">&quot;https://unpkg.com/react@16/umd/react.development.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script src=<span class="string">&quot;https://unpkg.com/react-dom@16/umd/react-dom.development.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script src=<span class="string">&quot;https://unpkg.com/babel-standalone@6/babel.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">  &lt;script type=<span class="string">&quot;text/babel&quot;</span>&gt;</span><br><span class="line">    <span class="comment">// 将数据定义到变量中</span></span><br><span class="line">    <span class="keyword">let</span> message = <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过ReactDom对象来渲染内容</span></span><br><span class="line">    ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>&#123;message&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span>, <span class="built_in">document</span>.getElementById(<span class="string">&quot;app&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取btn</span></span><br><span class="line">    <span class="keyword">const</span> btnEl = <span class="built_in">document</span>.getElementsByClassName(<span class="string">&quot;change-btn&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">    btnEl.addEventListener(<span class="string">&quot;click&quot;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(e);</span><br><span class="line">    &#125;)</span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure><h5 id="正确的方式"><a href="#正确的方式" class="headerlink" title="正确的方式"></a>正确的方式</h5><p>虽然可以实现，但是整个代码的流程过于繁琐</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;div id=<span class="string">&quot;app&quot;</span>&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;script src=<span class="string">&quot;https://unpkg.com/react@16/umd/react.development.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script src=<span class="string">&quot;https://unpkg.com/react-dom@16/umd/react-dom.development.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script src=<span class="string">&quot;https://unpkg.com/babel-standalone@6/babel.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">  &lt;script type=<span class="string">&quot;text/babel&quot;</span>&gt;</span><br><span class="line">    <span class="comment">// 将数据定义到变量中</span></span><br><span class="line">    <span class="keyword">let</span> message = <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过ReactDom对象来渲染内容</span></span><br><span class="line">    render();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义一个执行的函数</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">btnClick</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      message = <span class="string">&quot;Hello React&quot;</span>;</span><br><span class="line">      render();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      ReactDOM.render((</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;h2&gt;&#123;message&#125;&lt;/h2&gt;</span><br><span class="line">          &lt;button onClick=&#123;btnClick&#125;&gt;改变文本&lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      ), <span class="built_in">document</span>.getElementById(<span class="string">&quot;app&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure><h5 id="组件的方式"><a href="#组件的方式" class="headerlink" title="组件的方式"></a>组件的方式</h5><p>整个逻辑其实可以看做一个整体，那么我们就可以将其封装成一个组件：</p><ul><li>我们说过 <code>ReactDOM.render</code> 第一参数是一个HTML原生或者一个组件；</li><li>所以我们可以先将之前的业务逻辑封装到一个组件中，然后传入到 <code>ReactDOM.render</code> 函数中的第一个参数；</li></ul><p>在React中，如何封装一个组件呢？</p><ul><li><p>这里我们暂时使用类的方式封装组件：</p></li><li><ul><li>render当中返回的jsx内容，就是之后React会帮助我们渲染的内容</li><li>1.定义一个类，继承自React.Component</li><li>2.实现当前组件的render函数</li></ul></li></ul><p>具体的代码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class App extends React.Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (&lt;h2&gt;Hello World&lt;&#x2F;h2&gt;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(&lt;App&#x2F;&gt;, document.getElementById(&quot;app&quot;));</span><br></pre></td></tr></table></figure><p>如果我们的Hello World是依赖变量的，并且会根据按钮的点击而改变呢？这里涉及到几个核心点</p><p>1.数据在哪里定义</p><ul><li><p>在组件中的数据，我们可以分成两类：</p></li><li><ul><li>参与界面更新的数据：当数据变量时，需要更新组件渲染的内容</li><li>不参与界面更新的数据：当数据变量时，不需要更新将组建渲染的内容</li></ul></li><li><p>参与界面更新的数据我们也可以称之为是参与数据流，这个数据是定义在当前对象的state中</p></li><li><ul><li>我们可以通过在构造函数中 <code>this.state = &#123;定义的数据&#125;</code></li></ul></li><li><p>当我们的数据发生变化时，我们可以调用 <code>this.setState</code> 来更新数据，并且通知React进行update操作</p></li><li><ul><li>在进行update操作时，就会重新调用render函数，并且使用最新的数据，来渲染界面</li></ul></li></ul><p>2.事件绑定中的this</p><ul><li><p>在类中直接定义一个函数，并且将这个函数绑定到html原生的onClick事件上，当前这个函数的this指向的是谁呢？</p></li><li><p>默认情况下是undefined</p></li><li><ul><li>很奇怪，居然是undefined；</li><li>因为在正常的DOM操作中，监听点击，监听函数中的this其实是节点对象（比如说是button对象）；</li><li>这次因为React并不是直接渲染成真实的DOM，我们所编写的button只是一个语法糖，它的本质React的Element对象；</li><li>那么在这里发生监听的时候，react给我们的函数绑定的this，默认情况下就是一个undefined；</li></ul></li><li><p>我们在绑定的函数中，可能想要使用当前对象，比如执行 <code>this.setState</code> 函数，就必须拿到当前对象的this</p></li><li><ul><li>我们就需要在传入函数时，给这个函数直接绑定this</li><li>类似于下面的写法：<code>改变文本</code></li></ul></li></ul><p>我们一起来看一下代码是如何实现的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">class App extends React.Component &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    super();</span><br><span class="line">    this.state &#x3D; &#123;</span><br><span class="line">      message: &quot;Hello World&quot;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;&#123;this.state.message&#125;&lt;&#x2F;h2&gt;</span><br><span class="line">        &lt;button onClick&#x3D;&#123;this.changeText.bind(this)&#125;&gt;改变文本&lt;&#x2F;button&gt;</span><br><span class="line">     &lt;&#x2F;div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  changeText() &#123;</span><br><span class="line">    this.setState(&#123;</span><br><span class="line">      message: &quot;Hello React&quot;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(&lt;App&#x2F;&gt;, document.getElementById(&quot;app&quot;));</span><br></pre></td></tr></table></figure><p>转载自</p><blockquote><p><a href="https://mp.weixin.qq.com/s/zCt4l31aqf4v1qGorG6tcA">https://mp.weixin.qq.com/s/zCt4l31aqf4v1qGorG6tcA</a>   coderwhy老师的课程</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
          <category> React基础知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>正则表达式</title>
      <link href="/blog/2020/12/07/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
      <url>/blog/2020/12/07/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>数据链路层</title>
      <link href="/blog/2020/11/17/%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82/"/>
      <url>/blog/2020/11/17/%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82/</url>
      
        <content type="html"><![CDATA[<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><ul><li>链路：就是从一个结点到相邻结点的一段物理路线，而中间没有任何其他的交换结点</li><li>数据链路：是指把实现通信协议的硬件和软件加到链路上，就构成了数据链路</li><li>数据链路层以帧为单位传输和处理数据</li><li>数据链路层的三个重要问题<ul><li>封装成帧</li><li>差错检测</li><li>可靠传输</li></ul></li><li>使用广播信道的数据链路层<ul><li>共享式以太网的媒体接入控制协议CSMA/CD</li><li>802.11局域网的媒体接入控制协议CSMA/CA</li></ul></li><li>数据链路层的互连设备<ul><li>网桥和交换机的工作原理</li><li>集线器（物理层互连设备）与交换机的区别</li></ul></li></ul><p>数据链路层的功能：在物理层提供服务的基础上<strong>向网络层提供服务</strong>，其最基本的服务是将源自网络层来的数据可靠的传输到相邻节点的目标机网络层。其主要作用是<strong>加强物理层传输原始比特流的功能</strong>，将物理层提供的可能出错的物理连接改造成<strong>逻辑上无差错的数据链路</strong>，使之对网络层表现为一条无差错的链路。</p><h3 id="封装成帧"><a href="#封装成帧" class="headerlink" title="封装成帧"></a>封装成帧</h3><p>封装成帧是指数据链路层给上层交互的协议数据单元添加帧头和帧尾使之成为帧</p><ul><li>帧头和帧尾中包含有重要的控制信息</li><li>帧头和帧尾的作用之一就是<code>帧定界</code></li></ul><p>透明传输是指<code>数据链路层对上层交互的传输数据没有任何限制</code>，就好像数据链路层不存在一样</p><p>当所传的数据中的比特组恰巧与某一个控制信息完全一样时，就必须采取适当的措施，使接收方不会将这样的错误认为是某种控制信息。这样才能保证数据链路层的传输是透明的。</p><blockquote><p>例如如果传送的比特流中数据部分的数据恰好和帧尾部相同，那么在传输过程碰到该部分数据时，接收端可能误认为到这里传输结束了，那直接丢弃之后的数据了，这就会导致数据传输不完整，所以就要采取适当的措施，即使有这些问题也要保证数据能正确的传输，保证链路层对任何数据都能传送，在数据看来，链路层没有东西妨碍自己传送或者说链路层对数据是透明的。</p></blockquote><h4 id="组帧的四种方式"><a href="#组帧的四种方式" class="headerlink" title="组帧的四种方式"></a>组帧的四种方式</h4><h5 id="字符计数法"><a href="#字符计数法" class="headerlink" title="字符计数法"></a>字符计数法</h5><p> 字符计数法：帧首部使用一个计数字段（第一个字节）来表明帧的长度。在接收时根据帧首部的字数计数就可以知道一个帧的长度。</p><p><img src="F:\ImageBed\images_blog\2020-11-17-数据链路层\001.webp" alt="001"></p><p> 缺点：如果其中某个帧的计数错误，那么会导致之后传输的数据全部错误。</p><h5 id="字符填充法"><a href="#字符填充法" class="headerlink" title="字符填充法"></a>字符填充法</h5><p>当数据时由可打印的ASCII码组成的文本文件时，帧定界可以使用特殊的<strong>帧定界符</strong>。控制字符<strong>SOH（Start Of Header）</strong>放在一帧的最前面，表示帧的首部开始。另一个控制符<strong>EOT（End Of Transmission）</strong>表示帧结束。SOH和EOT是控制符的名称，它们的二进制编码分别是0000 0001和0000 0100。</p><blockquote><p>当使用ASCII编码时，一共有128个不同的ASCII码，其中可打印的有95个，有33个是不可打印的，，SOH和EOT就是不可打印的编码，所以可以用来作为控制符。</p></blockquote><p><img src="F:\ImageBed\images_blog\2020-11-17-数据链路层\002.webp" alt="002" style="zoom:80%;" /></p><p>当传送到帧是用文本文件组成的帧时（文本文件中的字符都是从键盘上输入的），其数据部分显然不会出现像SOH或EOT这样的帧定界控制符，可见不管从键盘上输入什么字符都可以放在帧上传输过去，因此这样的传输就是透明传输。<br>  但是当数据部分是非ASCII码的文本文件时（如二进制代码的计算机程序或图像等），数据中的某个字节的二进制代码恰好和SOH或EOT这样的控制字符一样。这样接收端就会错误的找到帧的边界，把部分帧收下，丢弃部分数据。</p><p><img src="F:\ImageBed\images_blog\2020-11-17-数据链路层\003.webp" alt="003" style="zoom:80%;" /></p><p> 为了解决透明传输问题，<strong>在发送端的数据链路层中出现控制字符SOH或EOT的前面插入一个转义字符“ESC”（其二进制编码为0001 1011）。而在接收端的数据链路层在把数据送往网络层之前删除这个插入的转入字符。</strong></p><p><img src="F:\ImageBed\images_blog\2020-11-17-数据链路层\004.webp" alt="004" style="zoom:80%;" /></p><p><img src="F:\ImageBed\images_blog\2020-11-17-数据链路层\005.webp" alt="005" style="zoom:80%;" /></p><h5 id="零比特填充法"><a href="#零比特填充法" class="headerlink" title="零比特填充法"></a>零比特填充法</h5><p><img src="F:\ImageBed\images_blog\2020-11-17-数据链路层\006.webp" alt="006" style="zoom:80%;" /></p><blockquote><p>零比特填充法帧的控制信息的首部和尾部是相同的。</p></blockquote><p>零比特填充法：<strong>在发送端，扫描整个信息字段，只要有连续的5个1，就立即填入1个0。在接收端收到一个帧时，先找到标志字段确定边界，再用硬件对比特流进行扫描。发现连续5个1时，就把后面的0删除。</strong></p><p><img src="F:\ImageBed\images_blog\2020-11-17-数据链路层\007.webp" alt="007" style="zoom:80%;" /></p><p><strong>零比特填充保证了透明传输，在传送的比特流中可以传送任意比特组合，而不会引起对帧边界的判断错误。</strong></p><h5 id="违规编码法"><a href="#违规编码法" class="headerlink" title="违规编码法"></a>违规编码法</h5><p> 在曼彻斯特编码中，一个码元可以用前高后低表示1，前低后高表示0，只有这两种情况，不存在前高后高和前低后低这两种情况。所以可以使用这两种不存在的情况作为定界帧的起始和终止。</p><p><img src="F:\ImageBed\images_blog\2020-11-17-数据链路层\008.webp" alt="008" style="zoom:80%;" /></p><p>由于字节计数法中的count字段的脆弱性（其值若有差错将导致灾难性后果）及字符填充实现上的复杂性和不兼容性，目前普遍使用的是<strong>比特填充</strong>和<strong>违规编码法</strong>。</p><h4 id="差错检测"><a href="#差错检测" class="headerlink" title="差错检测"></a>差错检测</h4><blockquote><p><a href="https://www.jianshu.com/p/58dec9767b90" >参考</a> </p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 计算机网络 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 计算机网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>简单句</title>
      <link href="/blog/2020/11/17/%E7%AE%80%E5%8D%95%E5%8F%A5/"/>
      <url>/blog/2020/11/17/%E7%AE%80%E5%8D%95%E5%8F%A5/</url>
      
        <content type="html"><![CDATA[<h3 id="英汉差异"><a href="#英汉差异" class="headerlink" title="英汉差异"></a>英汉差异</h3><ul><li>英语重形合：英语讲究“结构美”，强调语法和句法的完整性和合理性</li><li>汉语重意合：讲究意境美</li></ul><p>例：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">If there is anyone out there who still doubts that America is a place where all things are possible,who still wonders <span class="keyword">if</span> the dream of our founders is alive in our time, who still questions the power ofour democracy, tonight is your answer.</span><br></pre></td></tr></table></figure><p><code>翻译</code>:</p><p>如果现在依然有人怀疑美国是不是任何事情都可能发生的地方，依然有人疑惑我们国家的缔造者们的梦想是否还鲜活地存在于这个时代，依然有人质疑我们民主的力量，那么今夜你将得到答案。</p><p><code>解析</code>：</p><p>这是奥巴马发表演讲时讲过的一段话，主句是if there is anyone out there，从句是用了3个who引导的定语从句,可谓“果实累累”。但是汉语就没有从句,汉语都是简单句。译文语言简洁工整,音韵铿锵,充分发挥了汉语的优势。</p><h3 id="何为主谓宾"><a href="#何为主谓宾" class="headerlink" title="何为主谓宾"></a>何为主谓宾</h3><ul><li>主语：动作的发出者</li><li>谓语：动词</li><li>宾语：动作的承受者</li></ul><h3 id="英语句子"><a href="#英语句子" class="headerlink" title="英语句子"></a>英语句子</h3><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><p>英语句子必须要有主语和谓语，并且主语应该是谓语动作的发出者；如果有宾语的话，宾语应该是谓语动作的承受者</p><p><code>例</code>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">I spent with you.</span><br><span class="line">思考:这句英文的宾语是什么?with you吗?不是。因为spend指“度过”，你度过的应该是时间或美好的日子吧,怎么是“和你”呢?</span><br><span class="line">所以这个英文句子错了,其没有宾语，正确的写法应该是:I spent a good day with you.</span><br></pre></td></tr></table></figure><h4 id="句子基本结构"><a href="#句子基本结构" class="headerlink" title="句子基本结构"></a>句子基本结构</h4><h5 id="主谓"><a href="#主谓" class="headerlink" title="主谓"></a>主谓</h5><p>主语是谓语的发出者，且谓语必须具有时态</p><h5 id="主谓宾和主谓表"><a href="#主谓宾和主谓表" class="headerlink" title="主谓宾和主谓表"></a>主谓宾和主谓表</h5><p>两者的区别在于谓语动词， 主谓宾的谓语一定是“<code>实义动词</code>”（凡是能够表达动作的词都叫实义动词）；主谓表的谓语一定是“<code>系动词</code>/<code>连系动词</code>”</p><p>系动词分类</p><ul><li>表状态：be动词（连接主语和表语，无意义，用于构成句子）</li><li>表感官：look, sound, taste, smell, feel (感官动词后只能加adj)</li><li>表变化：get, become, turn, grow, fall </li><li>表保持：keep, stay, remain, stand</li><li>表表象：seem, appear</li><li>表终止：prove</li></ul><p>一些系动词也可以是实义动词，根据在句子中的意思来判断</p><h5 id="主谓双宾"><a href="#主谓双宾" class="headerlink" title="主谓双宾"></a>主谓双宾</h5><p>主语 + 谓语 + 间接宾语 + 直接宾语</p><p>对于区分那个是直接宾语，间接宾语，影响不大</p><h5 id="主谓宾宾补"><a href="#主谓宾宾补" class="headerlink" title="主谓宾宾补"></a>主谓宾宾补</h5><p>这种句型中的“宾语＋补语”统称为“复合宾语”。宾语补足语的主要作用为补充说明宾语的特点、身份，或让宾语完成某个动作。担任补语的常常是名词、形容词、副词、介词短语、分词、动词不定式等。具体用哪一个需要根据句子的意思来决定。</p><h4 id="句子的成分"><a href="#句子的成分" class="headerlink" title="句子的成分"></a>句子的成分</h4><h5 id="谓语"><a href="#谓语" class="headerlink" title="谓语"></a>谓语</h5><p>​    谓语动词就是具有<code>时态</code>和<code>语态</code>的实义动词（词组）或者系动词。一句话中动词（词组）有且只能有一个，多余的变成非谓语结构，少了就加be动词</p><p>​    谓语只能是动词（词组），动词（词组）只能充当谓语，那些不作谓语的动词（词组）要变成非动词结构，方法有</p><ul><li>+ing, 表示主动或进行（主动居多）</li><li>+ed, 表示被动或完成（被动居多）</li><li>动词前+to, 表示目的或者将来（目的居多）</li></ul><p><code>这些结构被称为非谓语动词</code></p><p>​    一句话中如何确定那个作谓语，那个作非谓语？</p><p>​        句子主要想表达那个动作，就留那个动作为谓语。一般跟在主语后面的就是主要动作，剩下的都变成非谓语</p><p><code>例</code>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">①中美双方抓住了关键的机会，展开了一系列的密集互动，促进了两国的发展。</span><br><span class="line">【思路分析】根据句子的意思可知，“抓住”是跟在主语后的主要动作，因此“抓住”是谓语,剩下的动作作非谓语。</span><br><span class="line">【翻译】Both parties of China and America seized the key opportunity, having a successionof interactions and facilitating the two&#39;s relationship.</span><br><span class="line">【解析】该句要使用一般过去时，“展开”和“促进”都是主动的,所以加-ing</span><br></pre></td></tr></table></figure><h5 id="主语"><a href="#主语" class="headerlink" title="主语"></a>主语</h5>]]></content>
      
      
      <categories>
          
          <category> English </category>
          
          <category> 语法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> English </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>物理层</title>
      <link href="/blog/2020/11/16/%E7%89%A9%E7%90%86%E5%B1%82/"/>
      <url>/blog/2020/11/16/%E7%89%A9%E7%90%86%E5%B1%82/</url>
      
        <content type="html"><![CDATA[<p><img src="https://guixu40.github.io/images_bed/images_blog/2020-11-16-物理层/014.PNG" alt="014" style="zoom:80%;" /></p><a id="more"></a><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><ul><li>物理层考虑的是怎样才能在连接各种计算机的传输媒体上传输数据比特流</li><li><p>物理层为数据链路层屏蔽了各种传输媒体的差异，使数据链路层只需要考虑如何完成本层的协议和服务，而不考虑网络具体的传输媒体是什么</p></li><li><p>传输媒体基本分为两类</p><ul><li>引导型传输媒体<ul><li>双绞线</li><li>同轴电缆</li><li>光纤</li></ul></li><li>非传导性传输媒体<ul><li>微波通信（2-40GHz）</li></ul></li></ul></li><li>物理层协议的主要任务<ul><li>机械特性：指明接口所用接线器的<code>形状</code>和<code>尺寸</code>，<code>引脚数目</code>和<code>排列</code>，<code>固定</code>和<code>锁定</code>装置</li><li>电气特性：指明在接口电缆的各条线上出现的电压的范围</li><li>功能特性：指明某条线上出现的某一电平的电压表示何种意义</li><li>过程特性：指明对于不同功能的各种可能事件的出现顺序</li></ul></li></ul><blockquote><p><code>注意</code>：物理层协议比较多，不必太要求，只需知道物理层协议的4个主要任务</p></blockquote><h3 id="传输方式"><a href="#传输方式" class="headerlink" title="传输方式"></a>传输方式</h3><h5 id="串行和并行"><a href="#串行和并行" class="headerlink" title="串行和并行"></a>串行和并行</h5><ul><li>串行：是在传输中只有1个数据位在设备之间进行的传输.对任何一个由若干位二进制表示的字符,串行传输都是用一个传输信道,按位有序的对字符进行传输.</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-11-16-物理层/001.PNG" alt="001"></p><ul><li>并行：是在传输中有多个数据位同时在设备之间进行的传输.一个编了码的字符通常是由若干位二进制数表示,如用ASCII码编码的符号是由8位二进制数表示的,则并行传输ASCII编码符号就需要8个传输信道,使表示一个符号的所有数据位能同时沿着各自的信道并排的传输.</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-11-16-物理层/002.PNG" alt="002"></p><p>当前网络中通信一般是串行通信，而计算机内部是并行</p><h5 id="同步和异步"><a href="#同步和异步" class="headerlink" title="同步和异步"></a>同步和异步</h5><ul><li>同步传输：数据块以稳定比特流的形式传输，字节之间没有间隔，接收端在每个时段的中间时刻进行检测。由于不同设备的时钟频率存在一定差异，不可能做到完全相同，在传输大量数据过程中，所产生的判别时刻的累计误差，会导致接收端对比特信号的判别错位，因此需要采取方法使接收发双方的时钟保持同步，实现同步的方法有两种<ul><li>外同步：在收发双方之间添加一条单独的时钟信号线</li><li>内同步：发送端将时钟同步信号编码发送到发送数据中一起传输（例如：曼切斯特编码）</li></ul></li><li>异步传输：以字节为独立单位，字节之间的时间间隔不是固定的，接收端仅在每个字节的起始处对字节内的比特实现同步，为此，通常要在每个字节前后分别加上起始位和结束位<ul><li>异步是指字节之间异步（字节之间的时间间隔不固定）</li><li>字节中的每个比特仍然要同步（各比特的持续时间是相同的）</li></ul></li></ul><h5 id="单向，双向，双向同时"><a href="#单向，双向，双向同时" class="headerlink" title="单向，双向，双向同时"></a>单向，双向，双向同时</h5><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-11-16-物理层/003.PNG" alt="003" style="zoom:50%;" /></p><ul><li>1、单工通信</li></ul><p>　　单工通信只有一根数据线，通信只在一个方向上进行，这种方式的应用实例有：监视器、打印机、电视机等。</p><ul><li>2、半双工通信</li></ul><p>　　半双工通信也只有一根数据线，它也单工的区别是这根数据线既可作发送又可作发接收，虽然数据可在两个方向上传送，但通信双方不能同时收发数据。</p><ul><li>3、全双工通信</li></ul><p>　　数据的发送和接收用两根不同的数据线，通信双方在同一时刻都能进行发送和接收，这一工作方式称为全双工通信。在这种方式下，通信双方都有发送器和接收器，发送和接收可同时进行，没有时间延迟。</p><h3 id="编码与调制"><a href="#编码与调制" class="headerlink" title="编码与调制"></a>编码与调制</h3><p>消息传输过程</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-11-16-物理层/004.PNG" alt="004" style="zoom:80%;" /></p><blockquote><p>码元：在使用时间域的波形表示数字信号时，<code>代表不同离散数值的基本波形</code></p></blockquote><h5 id="常用编码"><a href="#常用编码" class="headerlink" title="常用编码"></a>常用编码</h5><ul><li>不归零编码</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-11-16-物理层/005.PNG" alt="005" style="zoom:50%;" /></p><p>接收端如何判断码元是否重叠？</p><p>需要额外一根传输线来传输时钟信号，使发送方和接收方同步</p><p>对于计算机网络，宁愿利用这根传输线传输数据信号，而不是传输时钟信号，所以不使用该编码方式</p><ul><li>归零编码</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-11-16-物理层/006.PNG" alt="006" style="zoom:50%;" /></p><p>每个码元传输结束后信号都要“<code>归零</code>”， 所以接收方只要在信号归零后进行采样即可，不需要单独的时钟信号。</p><p>实际上，归零编码相当于把时钟信号用“归零”方式编码了数据之内，这称为“<code>自同步</code>”信号。</p><p>但是，归零编码中大部分的户数带宽都用来传输“归零”而浪费掉了</p><ul><li>曼切斯特编码</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-11-16-物理层/007.PNG" alt="007" style="zoom:50%;" /></p><p>码元中间时刻的跳转即表示时钟，又表示为数据</p><blockquote><p>传统以太网10Mb/s 使用的就是曼切斯特编码</p></blockquote><ul><li><p>差分曼切斯特编码</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-11-16-物理层/008.PNG" alt="008" style="zoom: 80%;" /></p></li></ul><p>跳变仅表示时钟，码元开始电平是否发生变化表示数据</p><h5 id="基本调制方法"><a href="#基本调制方法" class="headerlink" title="基本调制方法"></a>基本调制方法</h5><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-11-16-物理层/009.PNG" alt="009" style="zoom:80%;" /></p><p>使用基本调制方法，一个码元只能包含一个比特信息，如何能使一个码元包含更多的比特呢？</p><h5 id="混合调制"><a href="#混合调制" class="headerlink" title="混合调制"></a>混合调制</h5><p>因为<code>频率和相位是相关的</code>，即频率是相位随时间的变化率，所以一次只能调制频率和相位两个中的一个</p><p>通常情况下，相位和振幅可以结合起来一起调制，称为<code>正交振幅调制QAM</code></p><ul><li>QAM-16<ul><li>12种相位</li><li>每种相位有1或2种振幅可选</li><li>可以调制出16种码元（波形），每种码元可以对应4个比特</li><li>码元与4个比特的对应关系应采用格雷码（任意两个相邻马鞍只有一个比特不同）</li></ul></li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-11-16-物理层/010.PNG" alt="010" style="zoom: 80%;" /></p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-11-16-物理层/011.PNG" alt="011" style="zoom:80%;" /></p><h3 id="信道的极限容量"><a href="#信道的极限容量" class="headerlink" title="信道的极限容量"></a>信道的极限容量</h3><p>在显示网络环境中会出现失真的情况</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-11-16-物理层/012.PNG" alt="012" style="zoom:80%;" /></p><h5 id="失真因素"><a href="#失真因素" class="headerlink" title="失真因素"></a>失真因素</h5><ul><li>码元传输速率</li><li>信号传输距离</li><li>噪声干扰</li><li>传输媒体质量</li></ul><h5 id="奈氏准则"><a href="#奈氏准则" class="headerlink" title="奈氏准则"></a>奈氏准则</h5><p>在假定的理想条件下，<code>为了避免码间串扰，码元传输速率是有上限的</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">理想低通信道的最高码元传输速率 &#x3D; 2W Baud &#x3D; 2W码元&#x2F;秒</span><br><span class="line">理想带通信道的最高码元传输速率 &#x3D; W Baud &#x3D; W码元&#x2F;秒</span><br><span class="line"></span><br><span class="line">W: 信道带宽（单位为Hz）</span><br><span class="line">Baud: 波特，即码元&#x2F;秒</span><br></pre></td></tr></table></figure><ul><li>码元传输速率又称为波特率，调制速率，波形速率或符号速率，他与比特率有一定关系：<ul><li>当一个码元只携带1比特信息量时，则波特率（码元/秒）在数值上是相等的；</li><li>当一个码元携带n比特信息量时，则波特率转换为比特率时，数值要乘以n</li></ul></li><li>要提高信息传输速率（比特率），就必须设法使每一个码元都能携带更多个比特的信息量，这需要采用多元制</li><li>实际的信道所能传输的最高码元速率，要明显低于奈氏准则给出的这个上限数值</li></ul><blockquote><p>只要采用更好的调制方法，让码元可以携带更多的比特，岂不是可以无限制的提高信息的传输效率？</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">答案是否定的，因为信道的极限信息传输速率还要受限于实际的信号在信道中传输时的信噪比</span><br></pre></td></tr></table></figure><h5 id="香农公式"><a href="#香农公式" class="headerlink" title="香农公式"></a>香农公式</h5><p>香农公式：带宽受限且有高斯白噪声干扰的信道的极限信息传输速率</p><p>$c = W \times \log_2(1+  \frac{S}{N} )$</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">c: 信道的极限信息传输速率（单位： b&#x2F;s）</span><br><span class="line">W: 信道带宽（单位：Hz）</span><br><span class="line">S: 信道内所传信号的平均功率</span><br><span class="line">N: 信道内的高斯噪声功率</span><br><span class="line">S&#x2F;N: 信噪比，使用分贝（dB）作为度量单位</span><br></pre></td></tr></table></figure><ul><li>信道带宽或信道中信噪比越大，信息的极限传输速率越大</li><li>在实际信道上能够达到的信息传输速率要比该公式的极限传输速率低不少，这是因为在实际信道中，信息还要受到其他一些损伤，如各种脉冲干扰，信号在传输中的衰减和失真等，这些因素在香农公式中并没有考虑</li></ul><h5 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h5><p>【2009年题34】在无噪声情况下，若某通信链路的带宽为3kHz，采用4个相位，每个相位具有4种振幅的QAM调制技术，则该通信链路的最大数据传输速率是（24 bit/s）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(1）根据奈氏准则可知，该通信链路的最高码元传输速率&#x3D;2x 3k &#x3D; 6k(Baud) &#x3D; 6k(码元&#x2F;秒)</span><br><span class="line">(2) 采用二进制对这16个不同的码元进行编码，需要使用4个比特（loge16 &#x3D; 4)。换句话说，每个码元可以携带的信息量为4比特;采用二进制对这16个不同的码元进行编码，需要使用4个比特（loge16 &#x3D; 4)。换句话说，每个码元可以携带的信息量为4比特;</span><br><span class="line">综合（1)和(2)可知，该通信链路的最大数据传输速率&#x3D; 6k (码元&#x2F;秒)x4(比特&#x2F;码元) &#x3D;24k(比特&#x2F;秒)&#x3D;24 kbps</span><br></pre></td></tr></table></figure><p>【2011年题34】若某通信链路的数据传输速率为2400bps，采用4相位调制，则该链路的波特率是1200(波特)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(1)）采用4相位调制，可以调制出4种相位不同的基本波形（码元)。采用二进制对这4个不同的码元进行编码，需要使用2个比特(logz4 &#x3D; 2)。换句话说，每个码元可以携带的信息量为2比特;</span><br><span class="line">(2)数据传输速率&#x3D;波特率(码元传输速率)X每个码元所携带的信息量</span><br><span class="line">2400(比特&#x2F;秒)&#x3D;波特率X 2(比特&#x2F;码元)</span><br><span class="line">解得:波特率&#x3D; 1200(码元&#x2F;秒)&#x3D;1200(Baud) &#x3D; 1200(波特)</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-11-16-物理层/013.PNG" alt="013" style="zoom:80%;" /></p>]]></content>
      
      
      <categories>
          
          <category> 计算机网络 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 计算机网路 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>堆堆_数组实现</title>
      <link href="/blog/2020/11/03/%E5%A0%86%E5%A0%86-%E6%95%B0%E7%BB%84%E5%AE%9E%E7%8E%B0/"/>
      <url>/blog/2020/11/03/%E5%A0%86%E5%A0%86-%E6%95%B0%E7%BB%84%E5%AE%9E%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="堆的数组实现"><a href="#堆的数组实现" class="headerlink" title="堆的数组实现"></a>堆的数组实现</h2><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-11-03-堆堆-数组实现/001.PNG" alt="001" style="zoom:50%;" /></p><a id="more"></a><h3 id="堆的简单定义"><a href="#堆的简单定义" class="headerlink" title="堆的简单定义"></a>堆的简单定义</h3><p>堆的定义如下：n个元素的序列<code>&#123;k1,k2,ki,…,kn&#125;</code>当且仅当满足下关系时，称之为堆。</p><p><code>(ki &lt;= k2i,ki &lt;= k2i+1)</code>或者<code>(ki &gt;= k2i,ki &gt;= k2i+1)</code>, (i = 1,2,3,4…n/2)</p><p>若将和此次序列对应的一维数组（即以一维数组作此序列的存储结构）看成是一个完全二叉树，则堆的含义表明，完全二叉树中所有非终端结点的值均不大于（或不小于）其左、右孩子结点的值。由此，若序列{k1,k2,…,kn}是堆，则堆顶元素（或完全二叉树的根）必为序列中n个元素的最小值（或最大值）</p><ul><li>性质<ul><li>堆中某个节点的值总是不大于或不小于其父节点的值</li><li>堆总是一颗完全二叉树</li></ul></li></ul><h3 id="堆的实现"><a href="#堆的实现" class="headerlink" title="堆的实现"></a>堆的实现</h3><p>具体实现：<code>数组实现</code></p><ul><li>堆的向下调整：将堆变成小堆（调整的树左右子树必须是一个堆，才能调整）</li><li>堆的创建：从倒数的第一个非叶子节点的子树开始调整，一直调整到节点的根，就可以调整成堆</li><li>堆的插入：先插入一个值到数组的尾上，再进行向上调整的算法，直到满足堆</li><li>堆的删除：删除堆时删除堆顶的数据，将堆顶的数据和最后一个数据交换，然后删除数组最后一个数据，再进行向下调整算法</li><li>堆排序：结合了建堆和向下调整，先建堆然后将堆顶元素和数组最后一个元素交换，再将堆顶元素进行向下调整，直到排好序</li></ul><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//向下调整</span></span><br><span class="line"><span class="comment">//array[size]表示数组及大小</span></span><br><span class="line"><span class="comment">//root表示要调整的结点的下标</span></span><br><span class="line"><span class="comment">//前提是[root]所在结点左右子树已经满足堆的性质</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AdjustDown</span><span class="params">(<span class="keyword">int</span> <span class="built_in">array</span>[], <span class="keyword">int</span> size, <span class="keyword">int</span> root)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//int left = 2 * root + 1;</span></span><br><span class="line"><span class="comment">//int right = 2 * root + 2;</span></span><br><span class="line"><span class="keyword">int</span> min = <span class="number">2</span> * root + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (min &gt;= size)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//越界</span></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//确定那个是最小的孩子</span></span><br><span class="line"><span class="keyword">if</span> (min+<span class="number">1</span> &lt; size &amp;&amp; <span class="built_in">array</span>[min+<span class="number">1</span>] &lt; <span class="built_in">array</span>[min])</span><br><span class="line">&#123;</span><br><span class="line">min = min+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">array</span>[root] &lt;= <span class="built_in">array</span>[min])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//交换值</span></span><br><span class="line"><span class="keyword">int</span> tmp = <span class="built_in">array</span>[root];</span><br><span class="line"><span class="built_in">array</span>[root] = <span class="built_in">array</span>[min];</span><br><span class="line"><span class="built_in">array</span>[min] = tmp;</span><br><span class="line">AdjustDown(<span class="built_in">array</span>, size, min);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//建堆</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CreateHeap</span><span class="params">(<span class="keyword">int</span> <span class="built_in">array</span>[], <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//从最后一个非叶子结点开始，调整到0结束</span></span><br><span class="line"><span class="comment">//最后一个非叶子结点就是最后一个结点的双亲结点</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = (size - <span class="number">1</span> - <span class="number">1</span>) / <span class="number">2</span>; i &gt;= <span class="number">0</span>; --i)</span><br><span class="line">&#123;</span><br><span class="line">AdjustDown(<span class="built_in">array</span>, size, i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> HPDataType;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Heap</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">HPDataType* <span class="built_in">array</span>;</span><br><span class="line"><span class="keyword">int</span> size;</span><br><span class="line"><span class="keyword">int</span> capacity;</span><br><span class="line">&#125;Heap;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//初始化</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HeapCreateHeap</span><span class="params">(Heap* heap, <span class="keyword">int</span> <span class="built_in">array</span>[], <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">heap-&gt;capacity = size * <span class="number">2</span>;</span><br><span class="line">heap-&gt;size = size;</span><br><span class="line">heap-&gt;<span class="built_in">array</span> = (HPDataType*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(HPDataType) * size);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; ++i)</span><br><span class="line">&#123;</span><br><span class="line">heap-&gt;<span class="built_in">array</span>[i] = <span class="built_in">array</span>[i];</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//建堆</span></span><br><span class="line">CreateHeap(heap-&gt;<span class="built_in">array</span>, heap-&gt;size);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//小堆</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AdjustUp</span><span class="params">(<span class="keyword">int</span> <span class="built_in">array</span>[], <span class="keyword">int</span> size, <span class="keyword">int</span> child)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">while</span> (child != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> parent = (child - <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">array</span>[child] &gt;= <span class="built_in">array</span>[parent])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> tmp = <span class="built_in">array</span>[parent];</span><br><span class="line"><span class="built_in">array</span>[parent] = <span class="built_in">array</span>[child];</span><br><span class="line"><span class="built_in">array</span>[child] = tmp;</span><br><span class="line">child = parent;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//增加</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HeapInsert</span><span class="params">(Heap* heap, <span class="keyword">int</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">heap-&gt;<span class="built_in">array</span>[heap-&gt;size] = val;</span><br><span class="line">++heap-&gt;size;</span><br><span class="line">AdjustUp(heap-&gt;<span class="built_in">array</span>, heap-&gt;size, heap-&gt;size - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//删除(只能删除堆顶元素)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HeapPop</span><span class="params">(Heap* heap)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">assert(heap-&gt;size &gt; <span class="number">0</span>);</span><br><span class="line">heap-&gt;<span class="built_in">array</span>[<span class="number">0</span>] = heap-&gt;<span class="built_in">array</span>[heap-&gt;size - <span class="number">1</span>];</span><br><span class="line">--heap-&gt;size;</span><br><span class="line">AdjustDown(heap-&gt;<span class="built_in">array</span>, heap-&gt;size, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//堆排序</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HeapSort</span><span class="params">(<span class="keyword">int</span> *<span class="built_in">array</span>, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">CreateHeap(<span class="built_in">array</span>, size);</span><br><span class="line"><span class="keyword">while</span> (size--)&#123;</span><br><span class="line"><span class="keyword">int</span> tmp = <span class="built_in">array</span>[<span class="number">0</span>];</span><br><span class="line"><span class="built_in">array</span>[<span class="number">0</span>] = <span class="built_in">array</span>[size];</span><br><span class="line"><span class="built_in">array</span>[size] = tmp;</span><br><span class="line">AdjustDown(<span class="built_in">array</span>, size, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//返回堆顶元素，返回最值</span></span><br><span class="line"><span class="function">HPDataType <span class="title">HeapTop</span><span class="params">(Heap* heap)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">assert(heap-&gt;size &gt; <span class="number">0</span>);</span><br><span class="line"><span class="keyword">return</span> heap-&gt;<span class="built_in">array</span>[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><p>将一系列给定数字顺序插入一个初始为空的小顶堆H[]。随后判断一系列相关命题是否为真。命题分下列几种：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x is the root：x是根结点；</span><br><span class="line">x and y are siblings：x和y是兄弟结点；</span><br><span class="line">x is the parent of y：x是y的父结点；</span><br><span class="line">x is a child of y：x是y的一个子结点。</span><br></pre></td></tr></table></figure><p>输入格式：<br>每组测试第1行包含2个正整数N（≤ 1000）和M（≤ 20），分别是插入元素的个数、以及需要判断的命题数。下一行给出区间[−10000,10000]内的N个要被插入一个初始为空的小顶堆的整数。之后M行，每行给出一个命题。题目保证命题中的结点键值都是存在的。</p><p>输出格式：<br>对输入的每个命题，如果其为真，则在一行中输出T，否则输出F。</p><p>输入样例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">5 4</span><br><span class="line">46 23 26 24 10</span><br><span class="line">24 is the root</span><br><span class="line">26 and 23 are siblings</span><br><span class="line">46 is the parent of 23</span><br><span class="line">23 is a child of 10</span><br></pre></td></tr></table></figure><p>输出样例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">F</span><br><span class="line">T</span><br><span class="line">F</span><br><span class="line">T</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; v;</span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">upAdjust</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(i == <span class="number">1</span>) <span class="keyword">return</span> ;</span><br><span class="line">    <span class="keyword">while</span>(i != <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(v[i] &lt; v[i / <span class="number">2</span>]) &#123;</span><br><span class="line">            swap(v[i], v[i / <span class="number">2</span>]);</span><br><span class="line">            i = i / <span class="number">2</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">judge1</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(v[<span class="number">1</span>] == a) <span class="built_in">printf</span>(<span class="string">&quot;T/n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">&quot;F/n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">judge2</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> indexa = <span class="number">0</span>, indexb = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(v[i] == a) indexa = i;</span><br><span class="line">        <span class="keyword">if</span>(v[i] == b) indexb = i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(indexa &gt; indexb) swap(indexa, indexb);</span><br><span class="line">    <span class="keyword">if</span>(indexa % <span class="number">2</span> == <span class="number">0</span> &amp;&amp; indexb - indexa == <span class="number">1</span>) <span class="built_in">printf</span>(<span class="string">&quot;T/n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">&quot;F/n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">judge3</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> indexa = <span class="number">0</span>, indexb = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(v[i] == a) indexa = i;</span><br><span class="line">        <span class="keyword">if</span>(v[i] == b) indexb = i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>((<span class="number">2</span> * indexa) == indexb || (<span class="number">2</span> * indexa) + <span class="number">1</span> == indexb) <span class="built_in">printf</span>(<span class="string">&quot;T/n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">&quot;F/n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">judge4</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> indexa = <span class="number">0</span>, indexb = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(v[i] == a) indexa = i;</span><br><span class="line">        <span class="keyword">if</span>(v[i] == b) indexb = i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(indexa == indexb * <span class="number">2</span> || indexa == <span class="number">2</span> * indexb + <span class="number">1</span>) <span class="built_in">printf</span>(<span class="string">&quot;T/n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">&quot;F/n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> k, a, b;</span><br><span class="line">    <span class="keyword">char</span> c[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>, &amp;n, &amp;k);</span><br><span class="line">    v.resize(n + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;v[i]);</span><br><span class="line">        upAdjust(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; k; i++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d%s&quot;</span>, &amp;a, c);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(c, <span class="string">&quot;and&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d%s%s&quot;</span>, &amp;b, c, c);</span><br><span class="line">            judge2(a, b);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, c);</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(c, <span class="string">&quot;a&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%s%s%d&quot;</span>, c, c, &amp;b);</span><br><span class="line">                judge4(a, b);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, c);</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">strcmp</span>(c, <span class="string">&quot;root&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    judge1(a);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">scanf</span>(<span class="string">&quot;%s%d&quot;</span>, c, &amp;b);</span><br><span class="line">                    judge3(a, b);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 算法 堆 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TCP_chat_room</title>
      <link href="/blog/2020/10/26/TCP-chat-room/"/>
      <url>/blog/2020/10/26/TCP-chat-room/</url>
      
        <content type="html"><![CDATA[<h2 id="TCP-chat-room"><a href="#TCP-chat-room" class="headerlink" title="TCP_chat_room"></a>TCP_chat_room</h2><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>利用socket编程和多线程的思想，在客户端使用两个线程，一个用于接收信息，一个用于发送信息，在服务器端通过保存客户端连接的套接字，在接受到客户端发来的信息后，向其他的客户端转发消息</p><a id="more"></a><h3 id="服务器端代码"><a href="#服务器端代码" class="headerlink" title="服务器端代码"></a>服务器端代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python </span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os,sys</span><br><span class="line"><span class="comment">#conn_stat = &#123;&#125;  ###  conn:&#x27;true&#x27;  存储套接字的状态　true为运行　　false 为结束线程</span></span><br><span class="line">Host = <span class="string">&#x27;0.0.0.0&#x27;</span></span><br><span class="line">Post = <span class="number">9696</span></span><br><span class="line">address = (Host,Post)</span><br><span class="line">chat_name=&#123;&#125;</span><br><span class="line">jobs=&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_login</span>(<span class="params">conn,name</span>):</span></span><br><span class="line"><span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> chat_name:</span><br><span class="line">conn.send(<span class="string">b&#x27;OK&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">conn.send(<span class="string">&quot;昵称已经存在&quot;</span>.encode())</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">msg = <span class="string">&quot;%s 进入9696聊天室&quot;</span> %name</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> chat_name:</span><br><span class="line">chat_name[c].send(msg.encode())</span><br><span class="line">chat_name[name] = conn</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_chat</span>(<span class="params">conn,msg,name</span>):</span></span><br><span class="line">text = <span class="string">&quot;%s :%s&quot;</span>%(name,msg)</span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> chat_name:</span><br><span class="line"><span class="keyword">if</span> n != name:</span><br><span class="line">chat_name[n].send(text.encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_quit</span>(<span class="params">conn,name</span>):</span></span><br><span class="line">msg = <span class="string">&quot;%s 退出9696聊天室了&quot;</span>%name</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> chat_name:</span><br><span class="line"><span class="keyword">if</span> c == name:</span><br><span class="line">conn.send(<span class="string">b&#x27;q&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">chat_name[c].send(msg.encode())</span><br><span class="line"><span class="keyword">del</span> chat_name[name]</span><br><span class="line"><span class="comment">#conn_stat[conn] = &#x27;false&#x27;</span></span><br><span class="line">conn.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_request</span>(<span class="params">conn</span>):</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">data = conn.recv(<span class="number">1024</span>).decode().strip().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> data[<span class="number">0</span>] == <span class="string">&#x27;L&#x27;</span>:</span><br><span class="line">name = data[<span class="number">-1</span>]</span><br><span class="line">do_login(conn,name)</span><br><span class="line"><span class="keyword">elif</span> data[<span class="number">0</span>] == <span class="string">&#x27;C&#x27;</span>:</span><br><span class="line">name = data[<span class="number">-1</span>]</span><br><span class="line">msg = <span class="string">&#x27;&#x27;</span>.join(data[<span class="number">1</span>:<span class="number">-1</span>])</span><br><span class="line">do_chat(conn,msg,name)</span><br><span class="line"><span class="keyword">elif</span> data[<span class="number">0</span>] == <span class="string">&#x27;Q&#x27;</span>:</span><br><span class="line">name = data[<span class="number">-1</span>]</span><br><span class="line">do_quit(conn,name)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">sockfd = socket()</span><br><span class="line">sockfd.setsockopt(SOL_SOCKET,SO_REUSEADDR,<span class="number">1</span>)</span><br><span class="line">sockfd.bind(address)</span><br><span class="line">sockfd.listen(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">conn,addr = sockfd.accept()</span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">sockfd.close()</span><br><span class="line">sys.exit(<span class="string">&quot;退出&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">print(e)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">print(<span class="string">&quot;Connect from:&quot;</span>,addr)</span><br><span class="line">t = Thread(target=do_request,args=(conn,))</span><br><span class="line">t.start()</span><br><span class="line">jobs[conn] = t</span><br><span class="line"><span class="comment">#conn_stat[conn] = &#x27;true&#x27;</span></span><br><span class="line"><span class="comment">###回收线程　　当有线程结束，只有当新的客户端连接进来才会回收结束的线程</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> jobs:</span><br><span class="line"><span class="keyword">if</span> c._closed <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">jobs[c].join()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os,sys,signal</span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">server_addr = ((<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">9696</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">msg_recv</span>(<span class="params">sockfd</span>):</span>     <span class="comment">##接收消息</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = sockfd.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">if</span> data.decode() == <span class="string">&#x27;q&#x27;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        print(data.decode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">msg_send</span>(<span class="params">sockfd,name</span>):</span>      <span class="comment">##发送消息</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = <span class="built_in">input</span>(<span class="string">&quot;发言&gt;&gt;&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            data = <span class="string">&#x27;quit&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> data == <span class="string">&#x27;quit&#x27;</span>:  <span class="comment">##退出</span></span><br><span class="line">            msg = <span class="string">&#x27;Q %s&#x27;</span>%name</span><br><span class="line">            sockfd.send(msg.encode())</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            msg = <span class="string">&#x27;C %s %s&#x27;</span>%(data,name)</span><br><span class="line">            sockfd.send(msg.encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    sockfd = socket()<span class="comment">##创建套接字</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sockfd.connect(server_addr)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        print(<span class="string">&quot;连接失败&quot;</span>)</span><br><span class="line">        sockfd.close()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        name = <span class="built_in">input</span>(<span class="string">&quot;请输入昵称:&quot;</span>)</span><br><span class="line">        sockfd.send((<span class="string">&#x27;L &#x27;</span>+name).encode())</span><br><span class="line">        data = sockfd.recv(<span class="number">128</span>)</span><br><span class="line">        <span class="keyword">if</span> data.decode() == <span class="string">&#x27;OK&#x27;</span>:</span><br><span class="line">            print(<span class="string">&quot;你已经进入9696聊天室&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(data.decode())</span><br><span class="line"></span><br><span class="line">    t = threading.Thread(target=msg_recv, args=(sockfd, ))</span><br><span class="line">    t1 = threading.Thread(target=msg_send, args=(sockfd,name))</span><br><span class="line">    t.start()</span><br><span class="line">    t1.start()</span><br><span class="line"><span class="comment"># t=threading.Thread(target=msg_recv, args=(sockfd,) )</span></span><br><span class="line"><span class="comment"># t.start()</span></span><br><span class="line"><span class="comment"># t1=threading.Thread(target=msg_send, args=(sockfd,name) )</span></span><br><span class="line"><span class="comment"># t1.start()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
          <category> socket </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TCP</title>
      <link href="/blog/2020/10/23/TCP/"/>
      <url>/blog/2020/10/23/TCP/</url>
      
        <content type="html"><![CDATA[<h2 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h2><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/001.PNG" alt="思维导图" style="zoom: 50%;" /></p><a id="more"></a><h3 id="TCP流量控制"><a href="#TCP流量控制" class="headerlink" title="TCP流量控制"></a>TCP流量控制</h3><p>一般来说，我们总是希望数据传输快一些</p><blockquote><p>但是如果发送方吧数据发送得过快，接收方就可能来不及接收，这就会造成数据的丢失</p></blockquote><p>所谓流量控制（flow control）就是<code>让发送方的发送速率不要太快，要让接收方来得及接收</code></p><p>利用滑动窗口机制可以很方便地在TCP连接上实现对发送方的流量控制。</p><ul><li>TCP接收方利用自己的<code>接收窗口</code>的大小来限制发送方<code>发送窗口</code>的大小</li><li>TCP发送方收到接收方的<code>零窗口通知</code>后，应启动持续计时器，持续计时器超时后，向接收方发送<code>零窗口探测报文</code></li></ul><h5 id="示例分析"><a href="#示例分析" class="headerlink" title="示例分析"></a>示例分析</h5><ul><li>第一步：初始主机B的接送窗口设置为400， 并告诉A，主机A就把发送窗口的值设为400</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DATA 表示这是一个TCP数据报文段</span><br><span class="line">seq 是TCP报文首部中的序号字段</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/002.PNG" alt="002" style="zoom:50%;" /></p><ul><li>第二步：因为未达到窗口的大小，接着发送数据</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/003.PNG" alt="003" style="zoom:50%;" /></p><ul><li>假设在发送201-300数据段的过程中，数据丢失了，主机A窗口还有100字节数据可以发送</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/004.PNG" alt="004" style="zoom:50%;" /></p><ul><li>主机B对201号以前的数据进行累计确认，并将接收窗口调整为300</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ACK: 是TCP报文段首部中的标志位， 为1：表示这是一个TCP确认报文段</span><br><span class="line">ack: 是TCP报文首部字段中的确认报文段，表示201之前的数据已经接收到了</span><br><span class="line">rwnd: TCP 报文中的窗口字段</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/005.PNG" alt="005" style="zoom:50%;" /></p><ul><li>主机A在接收到确认报文段之后，将已经接收到的字段移出窗口，并且窗口前移，将窗口的大小设置为300，并开始发送301-400数据</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/006.PNG" alt="006" style="zoom:50%;" /></p><ul><li>接着发送401-500的数据， 发送后，已经到达窗口大小，不能再发送新数据了</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/007.PNG" alt="007" style="zoom:50%;" /></p><ul><li>201-300数据段的重传计时器超时了，开始重传</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/008.PNG" alt="008" style="zoom:50%;" /></p><ul><li>主机B接收到201-300的数据后，对收到501后之前的数据进行累计确认，并将接收窗口调整为100，对主机进行流量控制</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/009.PNG" alt="009" style="zoom:50%;" /></p><ul><li>主机A接收到主机B发送来的确认报文段之后，在接下来中，移动窗口，并将窗口大小改为100</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/010.PNG" alt="010" style="zoom:50%;" /></p><ul><li>清除已经发成发送的数据段，并开始发送501-600号数据</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/011.PNG" alt="011" style="zoom:50%;" /></p><ul><li>主机B接收到501-600号数据，并向A发送确认报文段，并且将接收窗口调整为了0</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/012.PNG" alt="012" style="zoom:50%;" /></p><ul><li>主机A接收到确认报文段之后，将发送窗口的值改为0</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/013.PNG" alt="013" style="zoom:50%;" /></p><ul><li>如果非0窗口的通知一直未到达，将一直阻塞下去</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/014.PNG" alt="014" style="zoom:50%;" /></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">解决方法： 为0窗口报文段设置了持续计时器，如果持续计时器超时，主机A就发送0窗口探测报文，如果主机B返回的窗口值依然为0，则重新启动持续计时器</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/015.PNG" alt="015" style="zoom:50%;" /></p><h3 id="TCP的拥塞控制"><a href="#TCP的拥塞控制" class="headerlink" title="TCP的拥塞控制"></a>TCP的拥塞控制</h3><ul><li>在某段时间，若<code>对网络中某一资源的需求超过了该资源所能提供的可用部分，网路性能就要被破坏</code>，这种情况叫做<code>拥塞（congestion）</code></li></ul><blockquote><p>在计算机网络中的链路容量（即带宽），交换结点中 的缓存和处理机等，都是网络的资源</p></blockquote><ul><li>若出现拥塞而不进行控制，整个网络的吞吐量将随负荷的增大而下降</li></ul><p>下图是吞吐量和输入负载的曲线</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/016.PNG" alt="016" style="zoom:50%;" /></p><h5 id="拥塞控制的四种算法"><a href="#拥塞控制的四种算法" class="headerlink" title="拥塞控制的四种算法"></a>拥塞控制的四种算法</h5><ul><li>慢开始（slow-start）</li><li>拥塞控制（congestion avoidance）</li><li>快重传（fast retransmit）</li><li>快恢复（fast recovery）</li></ul><p><strong>慢开始和拥塞控制的使用</strong></p><p>实现算法所必须要的东西</p><ul><li>发送方维护一个叫做<code>拥塞窗口cwnd</code>的状态变量，其值<code>取决于网络的拥塞控制</code>，并且<code>动态变化</code><ul><li>拥塞窗口<code>cwnd的维护原则</code>：只要网络没有出现拥塞，拥塞窗口就在增大一些，但是只要网络出现拥塞，拥塞窗口就减少一些</li><li>判断出现网络拥塞的依据：就是没有按时收到应当到达的确认报文（即发生<code>超时重传</code>）</li></ul></li><li>发送方将拥塞窗口作为发送窗口(swnd)，即swnd = cwnd</li><li>维护一个慢开始门限ssthresh状态变量：<ul><li>cwnd &lt; ssthresh, 使用慢开始算法</li><li>cwnd &gt; ssthresh, 停止使用慢开始算法而改用拥塞避免算法</li><li>cwnd = ssthresh， 两者都可以使用</li></ul></li></ul><p>例子</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">刚开始执行慢开始算法，达到初始的ssthresh后改用拥塞避免算法，在24号点假设出现了拥塞，更新cwnd的值和ssthresh的值并重新执行算法</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/017.PNG" alt="017"></p><ul><li>慢开始是指一开始向网络注入的报文段少，并不是指拥塞串口cwnd增长速度慢</li><li>拥塞控制并非指完全能够避免拥塞，而是指在拥塞避免阶段将拥塞窗口控制为按线性规律增长，使网络比较不容易出现拥塞</li></ul><p><strong>快重传和快恢复</strong></p><p>慢开始和拥塞控制算法是1988年提出的TCP拥塞控制算法（TCP Tahoe版本）</p><p>1990年又增加了两个新的拥塞控制算法（<code>改进TCP性能</code>）,就是快重传和快恢复（TCP RENO版本）</p><blockquote><p>产生原因： 有时，个别报文段会在网络中丢失，但是实际上网络并未发送拥塞，这将导致发送方超时重传，并误以为网络发生了拥塞，发送方将拥塞窗口cwnd又设置为最小值1，并错误的启动慢开始算法，因为降低了传输效率</p></blockquote><p>使用快重传算法可以<code>让发送方尽早知道发生了个别报文段的丢失</code></p><p>所谓快重传，就是使发送方尽快进行重传，而不是等超时重传计时器超时再重传</p><ul><li>要求接受方不要等待自己发送数据时才进行捎带确认，而是要立刻发送 确认</li><li>即时收到了失序的报文段也要立刻发出对已收到报文段的重复确认</li><li>发送放一旦收到3个连续的重复确认，就将相应的报文段立刻重传，而不是等待该报文的超时重传计时器超时在重传</li></ul><p>如下图所示</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/018.PNG" alt="018" style="zoom:50%;" /></p><ul><li>发送方一旦收到3个重复确认，就知道现在只是丢失了可别的报文段，于是不启动慢开始算法，而执行<code>快恢复算法</code><ul><li>发送方将慢开始门限ssthresh值和拥塞串口cwnd值调整为当前窗口的一半，开始执行拥塞避免算法，也有的可以增大一点在加3</li></ul></li></ul><p>下面图的后半部分就是快重传和快恢复算法</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/019.PNG" alt="019"></p><h3 id="TCP的超时重传时间的选择"><a href="#TCP的超时重传时间的选择" class="headerlink" title="TCP的超时重传时间的选择"></a>TCP的超时重传时间的选择</h3><ul><li>超时重传时间的选择是TCP最复杂的问题之一</li></ul><blockquote><p>RTT: 往返时间</p><p>RTO：超时重传时间</p></blockquote><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/020.PNG" alt="020" style="zoom:50%;" /></p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/021.PNG" alt="021" style="zoom:50%;" /></p><p>以上情况是RTO过小和过大的情况，正确情况如下</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/022.PNG" alt="022" style="zoom:50%;" /></p><p>但是在现实的网络环境中，每次的时间都不是确定的，于是不能直接使用某次测量得到的RTT样本来计算超时重传时间RTO，可以利用每次测量得到的RTT样本，计算加权平均往返时间RTTs</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">第一次：</span><br><span class="line">RTTs1 &#x3D; RTT1</span><br><span class="line">新的RTTs &#x3D; (1 - a) * 旧的RTTs + a * 新的RTT样本</span><br><span class="line">a的值推荐为1&#x2F;8</span><br><span class="line"></span><br><span class="line">RTO &#x3D; RTTs + 4 * RTTd</span><br></pre></td></tr></table></figure><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/023.PNG" alt="023" style="zoom:50%;" /></p><p>这是新的标准</p><h5 id="往返时间RTT的测量比较复杂"><a href="#往返时间RTT的测量比较复杂" class="headerlink" title="往返时间RTT的测量比较复杂"></a>往返时间RTT的测量比较复杂</h5><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/024.PNG" alt="024"></p><ul><li>针对出现超时重传时无法侧准往返时间RTT的问题，<code>Karn</code>提出了一个算法：<code>在计算加权平均往返时间RTTs时，只要报文段重传了，就不采用其往返时间RTT样本</code>。也就是出现重传时，不重新计算RTTs，进而超时重传时间RTO也不会重新计算</li><li>再优化: 报文段每重传一次，就把超时重传时间RTO增加一些</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/025.PNG" alt="025"></p><h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/026.PNG" alt="026"></p><h3 id="TCP的可靠传输的实现"><a href="#TCP的可靠传输的实现" class="headerlink" title="TCP的可靠传输的实现"></a>TCP的可靠传输的实现</h3><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/027.PNG" alt="027" style="zoom:50%;" /></p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/028.PNG" alt="028" style="zoom:50%;" /></p><h3 id="TCP三次握手"><a href="#TCP三次握手" class="headerlink" title="TCP三次握手"></a>TCP三次握手</h3><ul><li>TCP是面向连接的协议，它基于运输连接来传送TCP报文段</li><li>TCP运输连接的建立和释放是每一次面向连接的通行中必不可少的过程</li><li>TCP运输连接有以下三个阶段<ul><li>建立TCP连接</li><li>数据传送</li><li>释放TCP连接</li></ul></li><li>TCP的运输连接管理就是使运输连接的建立和释放都能正常的进行</li><li>TCP连接的建立要解决以下三个问题<ul><li>使TCP双方能够知道对方的存在</li><li>使TCP双方能够协商一些参数（如最大窗口值，是否使用窗口扩大选项和时间戳选项以及服务质量等）</li><li>使TCP双方能够运输实体资源（如缓存大小，连接表中的项目等）进行分配</li></ul></li><li>三次握手建立过程</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/029.PNG" alt="029"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SYN: 同部位，如果有SYN，该数据报不发送数据，但是要一个序号</span><br></pre></td></tr></table></figure><ul><li>为什么二次握手不可以</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/030.PNG" alt="030" style="zoom:50%;" /></p><h3 id="TCP四次挥手"><a href="#TCP四次挥手" class="headerlink" title="TCP四次挥手"></a>TCP四次挥手</h3><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/032.PNG" alt="032" style="zoom:50%;" /></p><p>为什么还需要时间等待</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/033.PNG" alt="033" style="zoom:50%;" /></p><h3 id="TCP首部格式"><a href="#TCP首部格式" class="headerlink" title="TCP首部格式"></a>TCP首部格式</h3><ul><li>为了实现可靠传输，TCP采用了<code>面向字节流</code>的方式</li><li>但TCP在发送数据时，是从发送缓存中取出一部分后全部字节并给其添加一个首部使之成为TCP报文段后进行发送<ul><li>一个TCP报文段由<code>首部</code>和<code>数据载荷</code>两部分构成</li><li>TCP的全部功能都提现在他首部中各字段的作用</li></ul></li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-23-TCP/031.png" alt="031" style="zoom:50%;" /></p><ul><li><p><strong>源端口和目的端口</strong> 各占2个字节，分别写入源端口和目的端口</p></li><li><p>序号： 占32比特，取值范围[0, 2^32 - 1]， 序号增加到最后一个后，下一个序号就又回到0</p></li><li><p>确认号： 占32比特，取值范围[0, 2^32 - 1]， 确认号增加到最后一个后，下一个确认号就又回到0，<code>指出期望收到对方下一个TCP报文段的数据载荷的第一个字节的序号</code></p></li><li><p>确认标志位ACK： 取值为1时确认号字段才有效；取值为0时确认号字段无效，<code>TCP规定，在建立连接后所有传送的TCP报文段都需要把ACK置1</code></p></li><li><p>数据便宜：占4比特，并以4字节为单位，<code>用来指出TCP报文段的数据载荷的起始处距离TCP报文段的起始处有多远，这个字段实际上是指出TCP报文段的首部长度</code></p></li></ul><p>首部固定长度为20字节，因此数据偏移字段的最小值为（0101）</p><p>首部最大长度为60字节，因此数据偏移字段的最大值为（1111）</p><ul><li>保留：占6比特，保留位今后使用，但目前应置为0</li><li>窗口： 占16比特，以字节为单位。<code>指出发送本报文段的一方的接收窗口</code></li></ul><p>窗口值作为接收方让发送方设置器发送窗口的依据，这里以接收能力来控制发送方的发送能力，称为流量控制</p><ul><li>校验和： 占16比特，检查范围包括TCP报文段的首部和数据载荷两部分。在计算校验和时，要在TCP报文段的前面加上12字节的伪首部</li><li>同步标志位SYN： 在TCP链接建立时用来同步序号</li><li>终止标志位FIN：用来释放TCP连接</li><li>复位标志位RST：用来复位TCP链接</li></ul><p>当RST = 1时，表示TCP连接出现了异常，必须释放连接，然后在重新建立连接。RST置1还用来拒绝一个非法的报文段或拒绝打开一个TCP连接</p><ul><li>推送标志位PSH： 接收方的TCP收到该标志位为1的报文段会<code>尽快上交应用进程</code>，而不必等到接收缓存都填满后再向上交互</li><li>紧急标志位URG：取值为1时紧急指针字段有效；取值为0时紧急指针无效</li><li>紧急指针：占16比特，以字节为单位，用来指明紧急数据的长度</li></ul><p>当发送方有紧急数据时，可将紧急数据插队到发送缓存的最前面，并立刻封装一个TCP报文段中进行发送。紧急指针会指出本报文段数据载荷部分包含了多长的紧急数据，紧急数据之后是普通数据</p><ul><li>选项<ul><li>最大报文段长度MSS选项：TCP报文段数据载荷部分的最大长度</li><li>窗口扩大选项：为了扩大窗口（提高吞吐率）</li><li>时间戳选项：<ul><li>用来计算往返时间RTT</li><li>用来处理序号超范围的情况，又称为防止序号绕回PAWS</li></ul></li><li>选择确认选项</li></ul></li><li>填充：由于选项的长度可变，因此使用填充来确保报文段首部能被4整除</li></ul>]]></content>
      
      
      <categories>
          
          <category> 计算机网络 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 计算机网络 TCP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UDP_chat_room</title>
      <link href="/blog/2020/10/20/UDP-chat-room/"/>
      <url>/blog/2020/10/20/UDP-chat-room/</url>
      
        <content type="html"><![CDATA[<h2 id="UDP-chat-room"><a href="#UDP-chat-room" class="headerlink" title="UDP_chat_room"></a>UDP_chat_room</h2><blockquote><p>转载 链接：<a href="https://www.jianshu.com/p/b3ce5264dda4">https://www.jianshu.com/p/b3ce5264dda4</a></p></blockquote><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-20-UDP-chat-room/001.png" alt="001" style="zoom:50%;" /></p><a id="more"></a><p>使用Python socket编程实现简单的聊天室功能。</p><p>服务器和客户端使用UDP编程，客户端两个线程一个负责接收，一个负责发送。</p><p>服务器：接收消息并保存地址，如果触发‘EXIT’关键字则从地址表中移除该地址</p><p>服务端</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- encoding = utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line"><span class="comment"># 1. 创建socket对象</span></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 绑定端口</span></span><br><span class="line">addr = (<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9999</span>)</span><br><span class="line">s.bind(addr)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;upd server is running on %s:%s...&quot;</span> % (addr[<span class="number">0</span>], addr[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存所有连接</span></span><br><span class="line">user = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 因为是UDP，所以不需要accept，进入循环处理链接</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">data, addr = s.recvfrom(<span class="number">1024</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> addr <span class="keyword">in</span> user:</span><br><span class="line"><span class="keyword">for</span> address <span class="keyword">in</span> user:</span><br><span class="line">s.sendto(data + <span class="string">&#x27; 进入聊天室...&#x27;</span>.encode(), address)</span><br><span class="line">user[addr] = data.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;EXIT&#x27;</span> <span class="keyword">in</span> data.decode(<span class="string">&#x27;utf-8&#x27;</span>):</span><br><span class="line">name = user[addr]</span><br><span class="line">user.pop(addr)</span><br><span class="line"><span class="keyword">for</span> address <span class="keyword">in</span> user:</span><br><span class="line">s.sendto((name + <span class="string">&#x27;离开了聊天室...&#x27;</span>).encode(), address)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">print(<span class="string">&#x27;&quot;%s&quot; from %s:%s&#x27;</span> % (data.decode(<span class="string">&#x27;utf-8&#x27;</span>), addr[<span class="number">0</span>], addr[<span class="number">1</span>]))</span><br><span class="line"><span class="keyword">for</span> address <span class="keyword">in</span> user:</span><br><span class="line"><span class="keyword">if</span> address != addr:</span><br><span class="line">s.sendto(data, address)</span><br><span class="line"><span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">logging.warning(<span class="string">&#x27;someone left unexcept&#x27;</span>)</span><br><span class="line"></span><br><span class="line">s.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">main()</span><br></pre></td></tr></table></figure><p>客户端：两个线程，并设置接收线程为守护线程</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recv</span>(<span class="params">sock, addr</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    一个UDP连接在接收消息前必须要让系统知道所占端口</span></span><br><span class="line"><span class="string">    也就是需要send一次，否则win下会报错</span></span><br><span class="line"><span class="string">    “   data=sock.recv(1024)</span></span><br><span class="line"><span class="string">        OSError: [WinError 10022] 提供了一个无效的参数。   ”</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    sock.sendto(name.encode(<span class="string">&#x27;utf-8&#x27;</span>), addr)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">        print(data.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>(<span class="params">sock, addr</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        string = <span class="built_in">input</span>()</span><br><span class="line">        message = name + <span class="string">&#x27; : &#x27;</span> + string</span><br><span class="line">        data = message.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        sock.sendto(data, addr)</span><br><span class="line">        <span class="keyword">if</span> string == <span class="string">&#x27;EXIT&#x27;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">    server = (<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9999</span>)</span><br><span class="line"></span><br><span class="line">    tr = threading.Thread(target=recv, args=(s, server), daemon=<span class="literal">True</span>)</span><br><span class="line">    ts = threading.Thread(target=send, args=(s, server))</span><br><span class="line">    tr.start()</span><br><span class="line">    ts.start()</span><br><span class="line">    ts.join()</span><br><span class="line">    s.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    print(<span class="string">&quot;-----欢迎来到聊天室,退出聊天室请输入&#x27;EXIT&#x27;-----&quot;</span>)</span><br><span class="line">    name = <span class="built_in">input</span>(<span class="string">&#x27;请输入你的名称:&#x27;</span>)</span><br><span class="line">    print(<span class="string">&#x27;-----------------%s------------------&#x27;</span> % name)</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
          <category> socket </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python socket编程</title>
      <link href="/blog/2020/10/19/python-socket%E7%BC%96%E7%A8%8B/"/>
      <url>/blog/2020/10/19/python-socket%E7%BC%96%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="socket编程"><a href="#socket编程" class="headerlink" title="socket编程"></a>socket编程</h2><blockquote><p>转载 <a href="https://www.liujiangblog.com/course/python/76">https://www.liujiangblog.com/course/python/76</a></p></blockquote><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-19-python-socket编程/002.PNG" alt="002"></p><a id="more"></a><h3 id="流程图—重点"><a href="#流程图—重点" class="headerlink" title="流程图—重点"></a>流程图—重点</h3><p>socket是基于C/S架构的，也就是说进行socket网络编程，通常需要编写两个py文件，一个服务端，一个客户端。</p><p>首先，导入Python中的socket模块： import socket</p><p>Python中的socket通信逻辑如下图所示（图片来自网络）：</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-19-python-socket编程/001.png" alt="001"></p><p>这张逻辑图，是整个socket编程中的重点的重点，你必须将它理解、吃透，然后刻在脑海里，真正成为自己记忆的一部分！很多人说怎么都学不会socket编程，归根到底的原因就是没有“死记硬背”知识点。</p><p>在Python中，<code>import socket</code>后，用<code>socket.socket()</code>方法来创建套接字，语法格式如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sk = socket.socket([family[, <span class="built_in">type</span>[, proto]]])</span><br></pre></td></tr></table></figure><p>参数说明：</p><ul><li>family: 套接字家族，可以使<code>AF_UNIX</code>或者<code>AF_INET</code>。</li><li>type: 套接字类型，根据是面向连接的还是非连接分为<code>SOCK_STREAM</code>或<code>SOCK_DGRAM</code>，也就是TCP和UDP的区别。</li><li>protocol: 一般不填默认为0。</li></ul><blockquote><p>直接socket.socket(), 则全部使用默认值</p></blockquote><p>具体参数定义：</p><div class="table-container"><table><thead><tr><th><strong>socket类型</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td>socket.AF_UNIX</td><td>只能够用于单一的Unix系统进程间通信</td></tr><tr><td>socket.AF_INET</td><td>IPv4</td></tr><tr><td>socket.AF_INET6</td><td>IPv6</td></tr><tr><td>socket.SOCK_STREAM</td><td>流式socket , for TCP</td></tr><tr><td>socket.SOCK_DGRAM</td><td>数据报式socket , for UDP</td></tr><tr><td>socket.SOCK_RAW</td><td>原始套接字，普通的套接字无法处理ICMP、IGMP等网络报文，而SOCK_RAW可以；其次，SOCK_RAW也可以处理特殊的IPv4报文；此外，利用原始套接字，可以通过IP_HDRINCL套接字选项由用户构造IP头。</td></tr><tr><td>socket.SOCK_SEQPACKET</td><td>可靠的连续数据包服务</td></tr><tr><td>创建TCP Socket：</td><td>s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</td></tr><tr><td>创建UDP Socket：</td><td>s=socket.socket(socket.AF_INET,socket.SOCK_DGRAM)</td></tr></tbody></table></div><p>通过<code>s = socket.socket()</code>方法，我们可以获得一个socket对象s，也就是通常说的获取了一个“套接字”，该对象具有一下方法：</p><div class="table-container"><table><thead><tr><th><strong>方法</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td><strong>服务器端方法</strong></td><td></td></tr><tr><td><strong>s.bind()</strong></td><td>绑定地址（host,port）到套接字，在AF_INET下,以元组（host,port）的形式表示地址。</td></tr><tr><td><strong>s.listen(backlog)</strong></td><td>开始监听。backlog指定在拒绝连接之前，操作系统可以挂起的最大连接数量。该值至少为1，大部分应用程序设为5就可以了。这个不是最大连接数。</td></tr><tr><td><strong>s.accept()</strong></td><td>被动接受客户端连接,(阻塞式)等待连接的到来，并返回（conn,address）二元元组,其中conn是一个通信对象，可以用来接收和发送数据。address是连接客户端的地址。</td></tr><tr><td><strong>客户端方法</strong></td><td></td></tr><tr><td><strong>s.connect(address)</strong></td><td>客户端向服务端发起连接。一般address的格式为元组（hostname,port），如果连接出错，返回socket.error错误。</td></tr><tr><td>s.connect_ex()</td><td>connect()函数的扩展版本,出错时返回出错码,而不是抛出异常</td></tr><tr><td><strong>公共方法</strong></td><td></td></tr><tr><td><strong>s.recv(bufsize)</strong></td><td>接收数据，数据以bytes类型返回，bufsize指定要接收的最大数据量。</td></tr><tr><td><strong>s.send()</strong></td><td>发送数据。返回值是要发送的字节数量。</td></tr><tr><td><strong>s.sendall()</strong></td><td>完整发送数据。将数据发送到连接的套接字，但在返回之前会尝试发送所有数据。成功返回None，失败则抛出异常。</td></tr><tr><td>s.recvform()</td><td>接收UDP数据，与recv()类似，但返回值是（data,address）。其中data是包含接收的数据，address是发送数据的套接字地址。</td></tr><tr><td>s.sendto(data,address)</td><td>发送UDP数据，将数据data发送到套接字，address是形式为（ipaddr，port）的元组，指定远程地址。返回值是发送的字节数。</td></tr><tr><td><strong>s.close()</strong></td><td>关闭套接字，必须执行。</td></tr><tr><td>s.getpeername()</td><td>返回连接套接字的远程地址。返回值通常是元组（ipaddr,port）。</td></tr><tr><td>s.getsockname()</td><td>返回套接字自己的地址。通常是一个元组(ipaddr,port)</td></tr><tr><td>s.setsockopt(level,optname,value)</td><td>设置给定套接字选项的值。</td></tr><tr><td>s.getsockopt(level,optname[.buflen])</td><td>返回套接字选项的值。</td></tr><tr><td>s.settimeout(timeout)</td><td>设置套接字操作的超时期，timeout是一个浮点数，单位是秒。值为None表示没有超时期。一般，超时期应该在刚创建套接字时设置，因为它们可能用于连接的操作（如connect()）</td></tr><tr><td>s.gettimeout()</td><td>返回当前超时期的值，单位是秒，如果没有设置超时期，则返回None。</td></tr><tr><td>s.fileno()</td><td>返回套接字的文件描述符。</td></tr><tr><td>s.setblocking(flag)</td><td>如果flag为0，则将套接字设为非阻塞模式，否则将套接字设为阻塞模式（默认值）。非阻塞模式下，如果调用recv()没有发现任何数据，或send()调用无法立即发送数据，那么将引起socket.error异常。</td></tr><tr><td>s.makefile()</td><td>创建一个与该套接字相关连的文件</td></tr></tbody></table></div><p><strong>注意事项：</strong></p><ol><li>Python3以后，socket传递的都是<strong>bytes类型</strong>的数据，字符串需要先转换一下，<code>string.encode()</code>即可；另一端接收到的bytes数据想转换成字符串，只要<code>bytes.decode()</code>一下就可以。</li><li>在正常通信时，<code>accept()</code>和<code>recv()</code>方法都是阻塞的。所谓的阻塞，指的是程序会暂停在那，一直等到有数据过来。</li></ol><h3 id="socket编程思路"><a href="#socket编程思路" class="headerlink" title="socket编程思路"></a>socket编程思路</h3><p><strong>服务端：</strong></p><ol><li>创建套接字，绑定套接字到本地IP与端口：socket.socket(socket.AF_INET,socket.SOCK_STREAM) , s.bind()</li><li>开始监听连接：s.listen()</li><li>进入循环，不断接受客户端的连接请求：s.accept()</li><li>接收传来的数据，或者发送数据给对方：s.recv() , s.sendall()</li><li>传输完毕后，关闭套接字：s.close()</li></ol><p><strong>客户端:</strong></p><ol><li>创建套接字，连接服务器地址：socket.socket(socket.AF_INET,socket.SOCK_STREAM) , s.connect()</li><li>连接后发送数据和接收数据：s.sendall(), s.recv()</li><li>传输完毕后，关闭套接字：s.close()</li></ol><p>Python的socket编程，通常可分为TCP和UDP编程两种，前者是带连接的可靠传输服务，每次通信都要握手，结束传输也要挥手，数据会被检验，是使用最广的通用模式；后者是不带连接的传输服务，简单粗暴，不加控制和检查的一股脑将数据发送出去的方式，但是传输速度快，通常用于安全和可靠等级不高的业务场景，比如文件下载。</p><h3 id="TCP编程"><a href="#TCP编程" class="headerlink" title="TCP编程"></a>TCP编程</h3><p><strong>服务器端：</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">ip_port = (<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9999</span>)</span><br><span class="line"></span><br><span class="line">sk = socket.socket()            <span class="comment"># 创建套接字</span></span><br><span class="line">sk.bind(ip_port)                <span class="comment"># 绑定服务地址</span></span><br><span class="line">sk.listen(<span class="number">5</span>)                    <span class="comment"># 监听连接请求</span></span><br><span class="line">print(<span class="string">&#x27;启动socket服务，等待客户端连接...&#x27;</span>)</span><br><span class="line">conn, address = sk.accept()     <span class="comment"># 等待连接，此处自动阻塞</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:     <span class="comment"># 一个死循环，直到客户端发送‘exit’的信号，才关闭连接</span></span><br><span class="line">    client_data = conn.recv(<span class="number">1024</span>).decode()      <span class="comment"># 接收信息</span></span><br><span class="line">    <span class="keyword">if</span> client_data == <span class="string">&quot;exit&quot;</span>:       <span class="comment"># 判断是否退出连接</span></span><br><span class="line">        exit(<span class="string">&quot;通信结束&quot;</span>)</span><br><span class="line">    print(<span class="string">&quot;来自%s的客户端向你发来信息：%s&quot;</span> % (address, client_data))</span><br><span class="line">    conn.sendall(<span class="string">&#x27;服务器已经收到你的信息&#x27;</span>.encode())    <span class="comment"># 回馈信息给客户端</span></span><br><span class="line">conn.close()    <span class="comment"># 关闭连接</span></span><br></pre></td></tr></table></figure><p><strong>客户端：</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">ip_port = (<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9999</span>)</span><br><span class="line"></span><br><span class="line">s = socket.socket()     <span class="comment"># 创建套接字</span></span><br><span class="line"></span><br><span class="line">s.connect(ip_port)      <span class="comment"># 连接服务器</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:     <span class="comment"># 通过一个死循环不断接收用户输入，并发送给服务器</span></span><br><span class="line">    inp = <span class="built_in">input</span>(<span class="string">&quot;请输入要发送的信息： &quot;</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> inp:     <span class="comment"># 防止输入空信息，导致异常退出</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    s.sendall(inp.encode())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> inp == <span class="string">&quot;exit&quot;</span>:   <span class="comment"># 如果输入的是‘exit’，表示断开连接</span></span><br><span class="line">        print(<span class="string">&quot;结束通信！&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    server_reply = s.recv(<span class="number">1024</span>).decode()</span><br><span class="line">    print(server_reply)</span><br><span class="line"></span><br><span class="line">s.close()       <span class="comment"># 关闭连接</span></span><br></pre></td></tr></table></figure><p>上面这个例子，基本能够展示出socket通信的机制。套接字的创建和关闭，服务器的绑定和监听，客户端的连接，这些都是固定套路，没什么难点。关键之处在于循环内部的收发逻辑，这里才是重点，需要根据你自己的业务需求，正确编写。这个过程中，一定要注意，收发是一一对应的，有发就要有收，并且recv()方法默认是阻塞的。</p><p>大家可以在自己的环境中测试上面的例子，并加入更多的内容，不断地进行尝试。然而试过之后，你们会发现，虽然服务器和客户端在一对一的情况下，工作良好，但是，如果有多个客户端同时连接同一个服务器呢？结果可能不太令人满意，因为服务器无法同时对多个客户端提供服务。为什么会这样呢？因为Python的socket模块，默认情况下创建的是单进程单线程，同时只能处理一个连接请求，如果要实现多用户服务，那么需要使用多线程机制。</p><p>下面我们使用Python内置的threading模块，配合socket模块创建多线程服务器。客户端的代码不需要修改，可以继续使用。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> threading        <span class="comment"># 导入线程模块</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">link_handler</span>(<span class="params">link, client</span>):</span>     </span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    该函数为线程需要执行的函数，负责具体的服务器和客户端之间的通信工作</span></span><br><span class="line"><span class="string">    :param link: 当前线程处理的连接</span></span><br><span class="line"><span class="string">    :param client: 客户端ip和端口信息，一个二元元组</span></span><br><span class="line"><span class="string">    :return: None</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    print(<span class="string">&quot;服务器开始接收来自[%s:%s]的请求....&quot;</span> % (client[<span class="number">0</span>], client[<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:     <span class="comment"># 利用一个死循环，保持和客户端的通信状态</span></span><br><span class="line">        client_data = link.recv(<span class="number">1024</span>).decode()</span><br><span class="line">        <span class="keyword">if</span> client_data == <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">            print(<span class="string">&quot;结束与[%s:%s]的通信...&quot;</span> % (client[<span class="number">0</span>], client[<span class="number">1</span>]))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        print(<span class="string">&quot;来自[%s:%s]的客户端向你发来信息：%s&quot;</span> % (client[<span class="number">0</span>], client[<span class="number">1</span>], client_data))</span><br><span class="line">        link.sendall(<span class="string">&#x27;服务器已经收到你的信息&#x27;</span>.encode())</span><br><span class="line">    link.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ip_port = (<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9999</span>)</span><br><span class="line">sk = socket.socket()            <span class="comment"># 创建套接字</span></span><br><span class="line">sk.bind(ip_port)                <span class="comment"># 绑定服务地址</span></span><br><span class="line">sk.listen(<span class="number">5</span>)                    <span class="comment"># 监听连接请求</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;启动socket服务，等待客户端连接...&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:     <span class="comment"># 一个死循环，不断的接受客户端发来的连接请求</span></span><br><span class="line">    conn, address = sk.accept()  <span class="comment"># 等待连接，此处自动阻塞</span></span><br><span class="line">    <span class="comment"># 每当有新的连接过来，自动创建一个新的线程，</span></span><br><span class="line">    <span class="comment"># 并将连接对象和访问者的ip信息作为参数传递给线程的执行函数</span></span><br><span class="line">    t = threading.Thread(target=link_handler, args=(conn, address))</span><br><span class="line">    t.start()</span><br></pre></td></tr></table></figure><p>启动这个多线程服务器，然后多运行几个客户端，可以很明显地看到，服务器能够同时与多个客户端通信，基本达到我们的目的。</p><h3 id="UDP编程"><a href="#UDP编程" class="headerlink" title="UDP编程"></a>UDP编程</h3><p>相对TCP编程，UDP编程就简单多了，当然可靠性和安全性也差很多。由于UDP没有握手和挥手的过程，因此accept()和connect()方法都不需要。下面是一个简单的例子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">ip_port = (<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9999</span>)</span><br><span class="line">sk = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, <span class="number">0</span>)</span><br><span class="line">sk.bind(ip_port)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    data = sk.recv(<span class="number">1024</span>).strip().decode()</span><br><span class="line">    print(data)</span><br><span class="line">    <span class="keyword">if</span> data == <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">        print(<span class="string">&quot;客户端主动断开连接！&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">sk.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 客户端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">ip_port = (<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9999</span>)</span><br><span class="line"></span><br><span class="line">sk = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    inp = <span class="built_in">input</span>(<span class="string">&#x27;发送的消息：&#x27;</span>).strip()</span><br><span class="line">    sk.sendto(inp.encode(), ip_port)</span><br><span class="line">    <span class="keyword">if</span> inp == <span class="string">&#x27;exit&#x27;</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">sk.close()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
          <category> socket </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Introduction to Statistical learning and Supervised Learning</title>
      <link href="/blog/2020/10/19/Introduction-to-Statistical-learning-and-Supervised-Learning/"/>
      <url>/blog/2020/10/19/Introduction-to-Statistical-learning-and-Supervised-Learning/</url>
      
        <content type="html"><![CDATA[<h2 id="Introduction-to-Statistical-learning-and-Supervised-Learning"><a href="#Introduction-to-Statistical-learning-and-Supervised-Learning" class="headerlink" title="Introduction to Statistical learning and Supervised Learning"></a>Introduction to Statistical learning and Supervised Learning</h2><h3 id="本节概述"><a href="#本节概述" class="headerlink" title="本节概述"></a>本节概述</h3><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-19-Introduction-to-Statistical-learning-and-Supervised-Learning/001.PNG" alt="001"></p><a id="more"></a><h3 id="统计学习"><a href="#统计学习" class="headerlink" title="统计学习"></a>统计学习</h3><h5 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h5><p>统计学习是关于计算机基于数据构建概率模型并运用模型对数据进行预测和分析的一门学科，在如今的机器学习中，大多数算法也是根据数据来预测，所以也可以叫做机器学习方法</p><h5 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h5><p>统计学习研究的对象是数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">特征抽取</span><br><span class="line">data-------&gt;模型</span><br></pre></td></tr></table></figure><h5 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h5><p>对数据进行预测和分析，使得计算机更加的智能化</p><h5 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h5><p>统计学习的方法是基于<code>数据</code>构建<code>概率统计模型</code>从而对数据进行预测和分析</p><p>实现统计学习方法的步骤如下：</p><ul><li>得到一个有限的训练数据集合</li><li>确定包含所有可能的模型的假设空间，即学习模型的集合</li><li>确定模型选择的准则，即学习的策略</li><li>实现求解最优模型的算法，即学习的算法</li><li>通过学习方法选择最优模型</li><li>利用学习的最优模型对新数据进行预测和分析</li></ul><h5 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h5><p>包括三方面</p><ul><li>统计学习方法</li><li>统计学习理论</li><li>停机学习应用</li></ul><h5 id="重要性"><a href="#重要性" class="headerlink" title="重要性"></a>重要性</h5><ul><li>处理海量数据</li><li>计算机智能化</li></ul><h3 id="统计学习分类"><a href="#统计学习分类" class="headerlink" title="统计学习分类"></a>统计学习分类</h3><h5 id="基本分类"><a href="#基本分类" class="headerlink" title="基本分类"></a>基本分类</h5><h6 id="监督学习"><a href="#监督学习" class="headerlink" title="监督学习"></a>监督学习</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">监督学习（supervised learning）是指从标注数据中学习预测模型的机器学习问题</span><br><span class="line">已知输入和输出，训练模型， 得到最优模型，根据训练得到的模型预测其他数据</span><br></pre></td></tr></table></figure><ul><li>输入空间，特征空间，输出空间</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">将输入与输出所有可能取值的结合叫做输入空间和输出空间，可以是有限元素的集合，也可以是整个欧式空间</span><br><span class="line">每个具体的输入是一个实例，由特征向量表示。所有特征向量存在的空间称为特征空间</span><br></pre></td></tr></table></figure><p><code>输入变量</code>与<code>输出变量</code>可以是<code>连续</code>的也可以是<code>离散</code>的</p><ul><li>联合概率分布</li></ul><p>监督学习假设<code>输入变量X</code>与<code>输入变量Y</code>符合联合概率分布<code>P(X, Y)</code></p><ul><li>假设空间</li></ul><blockquote><p>监督学习的目的在于学习一个由输入到输出的映射，这一映射有模型来表示</p></blockquote><p>假设空间就是这些模型的集合</p><ul><li>图形表示</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-19-Introduction-to-Statistical-learning-and-Supervised-Learning/002.PNG" alt="002"></p><h6 id="无监督学习"><a href="#无监督学习" class="headerlink" title="无监督学习"></a>无监督学习</h6><p>无监督学习是指从<code>无标注数据</code>中学习预测模型的机器学习问题</p><blockquote><p>无监督学习的本质是学习数据中的统计规律或潜在结构</p></blockquote><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-19-Introduction-to-Statistical-learning-and-Supervised-Learning/003.PNG" alt="003"></p><h6 id="强化学习"><a href="#强化学习" class="headerlink" title="强化学习"></a>强化学习</h6><p>强化学习（reinforcement learning） 是指智能系统在于环境的连续互动中学习最优行为策略的机器学习问题</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-19-Introduction-to-Statistical-learning-and-Supervised-Learning/004.PNG" alt="004"></p><h6 id="半监督学习与主动学习"><a href="#半监督学习与主动学习" class="headerlink" title="半监督学习与主动学习"></a>半监督学习与主动学习</h6><p><code>半监督学习 Csemi-supervised earning)</code> 是指利用 标注数据和未标注数据学习预</p><p>测模型的机器学习问题。通常有少量标注数据、大量未标注数据，因为标注数据的构</p><p>建往往需要人工，成本较高，未标注数据的收集不需太多成本。半监督学习旨在利用</p><p>未标注数据中的信息，辅助标注数据，进行监督学习，以较低的成本达到较好的学习</p><p>效果。</p><p><code>主动学习 Cactiv earning)</code>是指机器不断主动给出实例让教师进行标注，然后利</p><p>用标注数据学习预测模型的机器学习问题。通常的监督学习使用给定的标注数据，往</p><p>往是随机得到的 ，可以看作是”被动学习” 主动学习的目标是找出对学习最有帮助的</p><p>实例让教师标注，以较小的标注代价，达到较好的学习效果</p><p>半监督学习和主动学习更接近监督学习。</p><h5 id="按模型分类"><a href="#按模型分类" class="headerlink" title="按模型分类"></a>按模型分类</h5><h6 id="概率模型和非概率模型"><a href="#概率模型和非概率模型" class="headerlink" title="概率模型和非概率模型"></a>概率模型和非概率模型</h6><p>在监督学习中，概率模型是生成模型，非概率模型是判别模型</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">概率模型举例： 决策树，朴素贝叶斯，隐马尔可夫模型，条件随机场，概率潜在语义分析，潜在狄利克雷分配，高斯混合</span><br><span class="line">非概率模型： 感知机，支持向量机，k近邻，潜在语义分析，神经网络</span><br></pre></td></tr></table></figure><h6 id="线性模型和非线性模型"><a href="#线性模型和非线性模型" class="headerlink" title="线性模型和非线性模型"></a>线性模型和非线性模型</h6><p>看模型函数是否是线性的</p><h6 id="参数化模型与非参数化模型"><a href="#参数化模型与非参数化模型" class="headerlink" title="参数化模型与非参数化模型"></a>参数化模型与非参数化模型</h6><p><code>统计学习模型</code>又可以分为<code>参数化模型 (parametric model)</code>和`非参数化模型 (non</p><p>parametric model) <code>。参数化模型假设模型参数的</code>维度`固定，模型可以由有限维参数完</p><p>全刻画:非参数化模型假设模型参数的<code>维度不固定</code>或者说无穷大，随着训练数据量的</p><p>增加而不断增大。</p><h5 id="按算法分类"><a href="#按算法分类" class="headerlink" title="按算法分类"></a>按算法分类</h5><ul><li>在线学习</li></ul><p>在线学习是指每次接受 个样本，进行预测，之后学习模型，并不断重复该操作的机器学习。</p><ul><li>批量学习</li></ul><p>批量学习 次接受所有数据，学习模型，之后进行预测。有些实际应用的场景要求学习必须是在线的</p><h5 id="按技巧分类"><a href="#按技巧分类" class="headerlink" title="按技巧分类"></a>按技巧分类</h5><ul><li>贝叶斯学习</li></ul><p>在概率模型的学习和推理中，利用<code>贝叶斯定理</code>，计算在给定数据条件下模型的条件概率，即<code>后验概率</code>，并应用这个原理进行模型的估计，以及对数据的预测。将模型、未观测要素及其参数用变量表示，使用模型的<code>先验分布</code>是贝叶斯学习的特点。</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-19-Introduction-to-Statistical-learning-and-Supervised-Learning/005.PNG" alt="005"></p><ul><li>核方法</li></ul><h3 id="统计学习方法三要素"><a href="#统计学习方法三要素" class="headerlink" title="统计学习方法三要素"></a>统计学习方法三要素</h3><h5 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h5><p>模型就是所要学习的条件概率分布或决策函数</p><h5 id="策略"><a href="#策略" class="headerlink" title="策略"></a>策略</h5><h6 id="损失函数和风险函数"><a href="#损失函数和风险函数" class="headerlink" title="损失函数和风险函数"></a>损失函数和风险函数</h6><ul><li>0-1损失函数</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-19-Introduction-to-Statistical-learning-and-Supervised-Learning/006.PNG" alt="005"></p><ul><li>平方损失函数</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-19-Introduction-to-Statistical-learning-and-Supervised-Learning/007.PNG" alt="007"></p><ul><li>绝对损失函数</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-19-Introduction-to-Statistical-learning-and-Supervised-Learning/008.PNG" alt="008"></p><ul><li>对数损失函数</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-19-Introduction-to-Statistical-learning-and-Supervised-Learning/009.PNG" alt="009"></p><p>损失函数值越小，模型就越好。由于模型的输入，输出（X，Y）是随机变量，遵循联合分布P(X, Y)，所以损失函数的期望是</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-19-Introduction-to-Statistical-learning-and-Supervised-Learning/010.PNG" alt="010"></p><p>这是理论上模型f(X)关于联合分布P(X, Y)的平均意义下的损失，称为<code>风险函数</code>或<code>期望损失</code></p><blockquote><p>由于联合分布位置，所以不能直接计算</p></blockquote><p>模型f(X)关于训练数据集的平均损失称为<code>经验风险</code>或<code>经验损失</code></p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-19-Introduction-to-Statistical-learning-and-Supervised-Learning/011.PNG" alt="011"></p><p><code>注意</code>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">根据大数定律 当样本容量 趋于无穷时，经验风险趋于期望风险。所以一个很自然的想法是用经验风险估计期望风险。</span><br><span class="line">但是，由于现实中训练样本数目有限，甚至很小，所以用经验风险估计期望风险常常井不理想，要对经验风险进行 定的矫正。这就关系到监督学习的两个基本策略验风险最小化和结构风险最小化。</span><br></pre></td></tr></table></figure><h6 id="经验风险最小化与结构风险最小化"><a href="#经验风险最小化与结构风险最小化" class="headerlink" title="经验风险最小化与结构风险最小化"></a>经验风险最小化与结构风险最小化</h6><p>在假设空间，损失函数以及训练数据集确定的情况下，经验风险函数就可以确定。</p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-19-Introduction-to-Statistical-learning-and-Supervised-Learning/012.PNG" alt="012"></p><p>从经验风险最小化来看，经验风险最小的模型是最优的模型。—&gt; 风险最小化求最优模型就是求解最优化问题</p><blockquote><p>当样本容量很小时，经验风险最小化学习的效果未必很好，会产生<code>过拟合</code>问题，为了防止过拟合，提出了结构风险最小化</p></blockquote><p>结构风险在经验风险上加上<code>模型复杂度的正则化项或罚项</code></p><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-19-Introduction-to-Statistical-learning-and-Supervised-Learning/013.PNG" alt="013    "></p><blockquote><p>为什么经验风险容易过拟合？ 为什么结构风险可以解决过拟合？</p></blockquote><h5 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h5><p>算法是指学习模型的具体计算方法</p><h3 id="模型评估与模型选择"><a href="#模型评估与模型选择" class="headerlink" title="模型评估与模型选择"></a>模型评估与模型选择</h3><p>当假设空间含有不同复杂度(例如，不同的参数个数)的模型时，就要面临模型选（model selection) 的问题。我们希望选择或学习 个合适的模型。如果在假设空间中存在”真”模型，那么所选择的模型应该逼近真模型。具体地所选择的模型要与真模型的参数个数相同，所选择的模型的参数向量与真模型的参数向量相近。如果一味追求提高对训练数据的预测能力，所选模型的复杂度则往往会比真模型更高</p><blockquote><p>过拟合是指学习时选择的模型所包含的参数过多，以至出现这模型对己知数据预测得很好，但对未知数据预测得很差的现象。</p></blockquote><p>正则化和交叉验证就是为了解决过拟合</p><h3 id="正则化与交叉验证"><a href="#正则化与交叉验证" class="headerlink" title="正则化与交叉验证"></a>正则化与交叉验证</h3><h5 id="正则化"><a href="#正则化" class="headerlink" title="正则化"></a>正则化</h5><p>模型选择的典型方法是<code>正则化 regularization)</code>。正则化是结构风险最小化策略的实现，是在经验风险上加 个<code>正则化项 (regularizer )</code>或<code>罚项(Cpena ty term)</code> 。正则化项一般是模型复杂度的单调递增函数，模型越复杂，正则化值就越大。比如 正则化项可以是<code>模型参数向量的范数</code>。</p><ul><li>L1范式</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-19-Introduction-to-Statistical-learning-and-Supervised-Learning/014.PNG" alt="014"></p><ul><li>L2范式</li></ul><p><img src="https://guixu40.github.io/images_bed/images_blog/2020-10-19-Introduction-to-Statistical-learning-and-Supervised-Learning/015.PNG" alt="015"></p><p>从<code>贝叶斯估计</code>的角度来看，正则化项对应于模型的<code>先验概率</code>。可以假设复杂的模型有较小的先验概率，简单的模型有较大的先验概率</p><h5 id="交叉验证"><a href="#交叉验证" class="headerlink" title="交叉验证"></a>交叉验证</h5><p>如果给定的样本数据充足，进行模型选择的 种简单方法是随机地将数据集切分成 部分，分别为训练集 (training set) 、验证集( validation set) 和测试集 (testset) 。训练集用来训练模型，验证集用于模型的选择，而测试集用于最终对学习方法的评估。在学习到的不同复杂度的模型中，选择对验证集有最小预测误差的模型。由于验证集有足够多的数据，用它对模型进行选择也是有效的。</p><ul><li>简单交叉验证</li></ul><p>简单交叉验证方法是:首先随机地将己给数据分为两部分， 部分作为训练集，另一部分作为测试集(例如， 70% 的数据为训练集， 30% 的数据为测试集) ;然后用训练集在各种条件下(例如，不同的参数个数)训练模型，从而得到不同的模型:在测试集上评价各个模型的测试误差，选出测试误差最小的模型。</p><ul><li>S折交叉验证</li></ul><p>应用最多的是 折交叉验证 （S-fold cross validation) ，方法如下:首先随机地将已给数据切分为 互不相交、大小相同的子集 ;然后利用 S-l 个子集的数据训练模型，利用 余下的子集测试模型 :将这 过程对可能的 种选择重复进行;最后选出S次评测中平均测试误差最小的模型。</p><ul><li>留一交叉验证</li></ul><p>S折交叉验证的特殊情形是 = 称为留一交叉验证( Oeave-one-out cross validation) ，往往在数据缺乏的情况下使用。这里 是给定数据集的容量。</p><h3 id="泛化能力"><a href="#泛化能力" class="headerlink" title="泛化能力"></a>泛化能力</h3><p>学习方法的泛化能力是指由该方法学习到的模型对未知数据的预测能力，泛化误差就是模型的期望风险</p><h3 id="生成模型与判别模型"><a href="#生成模型与判别模型" class="headerlink" title="生成模型与判别模型"></a>生成模型与判别模型</h3><h3 id="监督学习应用"><a href="#监督学习应用" class="headerlink" title="监督学习应用"></a>监督学习应用</h3><ul><li>分类问题</li><li>标注问题</li><li>回归问题</li></ul>]]></content>
      
      
      <categories>
          
          <category> 机器学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 机器学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/blog/2020/10/18/hello-world/"/>
      <url>/blog/2020/10/18/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
